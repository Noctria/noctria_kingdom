FILE=docs/governance/king_ops_prompt.yaml

# --- QAセクションに ruff を明記 ---
yq -i '.qa.static_analysis = {
  "tool":"ruff",
  "config":".ruff.toml",
  "policy":"すべての新規/修正コードは ruff check --fix を通過必須",
  "ci_job":"PYTHONPATH=. ruff check src/ tests/"
}' $FILE

FILE=docs/governance/king_ops_prompt.yaml

# ========== Cost Optimization（新設） ==========
yq -i '.cost_optimization = {
  "policy_version":"v1",
  "model_tiering":{
    "default":"mini",
    "tiers":[
      {"name":"mini","use_for":["日次レポート初稿","軽量分類","要約"],"max_ctx_tokens":8000},
      {"name":"standard","use_for":["RAG+要約","生成→校正"],"gate":"quality.slo_ok == true OR fallback_needed"},
      {"name":"premium","use_for":["精密説明","高リスク決裁案"],"gate":"only_if(decision.critical==true OR qa_blocker==true)"}
    ],
    "fallback_rules":[
      {"from":"mini","to":"standard","when":"quality_score<target OR parse_error>=1"},
      {"from":"standard","to":"premium","when":"critical_decision AND reviewer_requests=='escalate'"}
    ]
  },
  "prompt_diet":{
    "shared_header_id":"KING_HDR_001",
    "max_history_turns":6,
    "history_summarization":"auto_when(turns>6 OR tokens>4k)",
    "rag":{
      "max_chunks":6,
      "min_score":0.75,
      "dedupe_by":"content_hash"
    }
  },
  "caching":{
    "enabled":true,
    "key":"hash(model,shared_header_id,instruction,user_query,rag_chunk_ids)",
    "ttl_minutes":1440,
    "version_stamp":"data_snapshot_id|git_sha"
  },
  "streaming_and_cutoff":{
    "enabled":true,
    "soft_token_cap":800,
    "hard_token_cap":1200,
    "on_cap_reached":"finish_with_summary"
  },
  "retry_and_escalate":{
    "max_retries":1,
    "cheap_retry_on":"rate_limit|transient_error|parse_error",
    "escalate_if":"critical_request AND (parse_error OR qos_below_target)"
  },
  "offline_precompute":{
    "embeddings":"precompute_on_commit",
    "templates":"local_cache",
    "btft_reports":"batch_generate_offline"
  },
  "budgets":{
    "per_run_tokens_max": 40000,
    "per_day_jpy_max": 1200,
    "per_month_jpy_max": 25000,
    "action_on_exceed":[ "warn", "switch_to_mini", "require_human_ack"]
  },
  "observability":{
    "metrics":[
      "llm_prompt_tokens_total","llm_completion_tokens_total","llm_invocations_total",
      "llm_cache_hit_ratio","llm_cost_jpy_total","llm_cost_jpy_per_report"
    ],
    "logs":"logs/llm/*.jsonl",
    "sampling":"100% for critical, 20% for normal"
  },
  "governance":{
    "change_control":"アップグレード/モデル切替は change_management 経由",
    "reviewer":"king",
    "notes":"節約で品質が落ちた場合は decision_registry に根拠付きで例外記録"
  }
}' $FILE

# ========== Scripts/CIへのフック（任意：既存に追記） ==========
yq -i '.scripts.cost_report = "scripts/report_llm_costs.py --from today-7d --to today --out reports/costs"' $FILE
yq -i '.testing.cost_guards = [
  {"id":"COST01","target":"1レポート当たりコスト","expect":"llm_cost_jpy_per_report ≤ 120"},
  {"id":"COST02","target":"キャッシュ","expect":"llm_cache_hit_ratio ≥ 0.25"}
]' $FILE

# 既存の observability にメトリクス名を追記（存在すればマージ）
yq -i '
  .observability.metrics.api += ["llm_invocations_total","llm_prompt_tokens_total","llm_completion_tokens_total"] |
  .observability.metrics.btft += ["llm_cost_jpy_total"]
' $FILE


FILE=docs/governance/king_ops_prompt.yaml

yq -i '.guidelines.prompt_basics = {
  "scope":"全AIエージェント共通",
  "structure":[
    "1. Role: AIエージェントの役割を明示する（例: 戦略生成AI, 評価AI, リスク管理AIなど）",
    "2. Goal: 今回のタスクの目的を一文で定義",
    "3. Constraints: 出力形式や数値制約などを列挙",
    "4. Input: 必要な文脈/データ/ログを提示",
    "5. Output: 期待する形式を明記（JSON/Markdown/表など）",
    "6. Evaluation: 成功基準や判定条件を簡潔に明示"
  ],
  "principles":[
    "全AIは再現可能な形式で出力すること",
    "無関係な情報や過剰な推測は返さないこと",
    "失敗や曖昧な場合は fallback（警告＋簡易出力）で応答すること",
    "出力は後続の自動処理に適合すること（例: JSONなら必ずvalid JSON）"
  ]
}' $FILE

FILE=docs/governance/king_ops_prompt.yaml

# ========== 進捗の定量化（スコアカード＋個別メトリクス定義） ==========
yq -i '.progress = {
  "scorecard":{
    "weights":{"quality":0.45,"speed":0.25,"cost":0.15,"governance":0.15},
    "composite_formula":"S = 0.45*Q + 0.25*S + 0.15*C + 0.15*G  # 各カテゴリは0〜1で正規化"
  },
  "metrics":[
    {"id":"Q1","name":"ECE改善率","source":"obs_codex_kpi_latest","window_runs":5,"compute":"max(0, (ece_base - ece_latest)/max(ece_base,1e-6))","target":0.05,"direction":"up"},
    {"id":"Q2","name":"Brier改善率","source":"obs_codex_kpi_latest","window_runs":5,"compute":"max(0, (brier_base - brier_latest)/max(brier_base,1e-6))","target":0.02,"direction":"up"},
    {"id":"Q3","name":"頑健性達成度","source":"adversarial_tests","window_runs":5,"compute":"clip((adv_latest-0.40)/0.10,0,1)","target":0.0,"direction":"up"},
    {"id":"S1","name":"MTTA（警報応答）中央値","source":"decision_registry","window_days":7,"compute":"median(minutes_to_ack)","target":15,"direction":"down"},
    {"id":"S2","name":"MTTR（是正完了）中央値","source":"decision_registry","window_days":30,"compute":"median(hours_to_close)","target":24,"direction":"down"},
    {"id":"S3","name":"日次レポート準時率","source":"docs/reports/daily","window_days":14,"compute":"on_time_count/total","target":0.95,"direction":"up"},
    {"id":"C1","name":"1kリクエストあたりAPI原価","source":"billing/api","window_days":30,"compute":"cost_usd/requests*1000","target":-1,"direction":"down"},
    {"id":"C2","name":"GPU時間/週","source":"billing/compute","window_days":7,"compute":"gpu_hours","target":-1,"direction":"down"},
    {"id":"C3","name":"LLMキャッシュヒット率","source":"llm/telemetry","window_days":7,"compute":"cache_hits/total_calls","target":0.50,"direction":"up"},
    {"id":"G1","name":"変更成功率","source":"change_management","window_days":30,"compute":"changes_passed/changes_total","target":0.80,"direction":"up"},
    {"id":"G2","name":"回帰テスト合格率","source":"testing/ci_or_local","window_days":7,"compute":"passed/total","target":0.98,"direction":"up"},
    {"id":"G3","name":"双方向リンク充足率","source":"decision_registry","window_days":30,"compute":"bi_links_ok/decisions_with_change","target":1.0,"direction":"up"}
  ],
  "normalization":{
    "up":"score = clamp(value/target,0,1)",
    "down":"score = clamp(target/max(value,1e-6),0,1)",
    "note":"target=-1 は純モニタ（スコア計算から除外）"
  },
  "category_map":{
    "quality":["Q1","Q2","Q3"],
    "speed":["S1","S2","S3"],
    "cost":["C1","C2","C3"],
    "governance":["G1","G2","G3"]
  },
  "reporting":{
    "cadence":{"weekly":"Sun 10:30 JST","monthly":"MonthEnd 16:00 JST"},
    "artifacts":{"weekly_md":"docs/reports/weekly/progress/{YYYY}-W{WW}.md","monthly_md":"docs/reports/monthly/progress/{YYYY-MM}.md","json":"reports/progress/progress_{YYYYMMDD}.json"},
    "dashboard":"docs/reports/progress/index.md"
  },
  "alerts":{
    "degradation_rules":[
      {"when":"composite_drop_pct>=10% vs last4w avg","then":"raise WARN in daily"},
      {"when":"any_metric_below_floor:true","then":"raise CRITICAL & open decision"}
    ],
    "floors":{"Q1":0.02,"Q2":0.005,"G2":0.95}
  }
}' $FILE

# ========== スクリプト定義（生成／公開） ==========
yq -i '.scripts.calculate_progress = "進捗メトリクスを収集→正規化→合成スコア算出し JSON/MD を生成"' $FILE
yq -i '.scripts.publish_progress = "進捗レポートを docs/reports/progress/ に公開（週次・月次）"' $FILE

# ========== ドキュメント配置を追記 ==========
yq -i '.doc_ops.file_locations.progress_root = "docs/reports/progress/"' $FILE
yq -i '.doc_ops.file_locations.progress_json = "reports/progress/"' $FILE

# ========== decision_registry 連携（自動参照） ==========
yq -i '.decision_registry.progress_linking = {
  "attach_weekly_progress_to_decision":"最新週次の composite_score とカテゴリ別スコアを Decision の参照欄に自動追記",
  "open_decision_on_drop":"compositeが前週比-10%以下で自動的にWARN Decision起票（ドラフト）"
}' $FILE

# ========== 週次スライドへの要約差し込み ==========
yq -i '.weekly_slide_deck.variables.progress_summary = "Score={score:.2f} / Q={Q:.2f} S={S:.2f} C={C:.2f} G={G:.2f}（vs先週 {delta_sign}{delta:.02f}）"' $FILE


