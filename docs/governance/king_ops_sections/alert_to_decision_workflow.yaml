# =======================================================
# è­¦å ±â†’Decision Logâ†’Change Draft é€£çµãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# =======================================================
alert_to_decision_workflow:
  objectives:
    - "è­¦å ±ç™ºç”Ÿã‹ã‚‰ Decision Log èµ·ç¥¨ã¾ã§ã®å¹³å‡æ™‚é–“(MTTA)ã‚’çŸ­ç¸®"
    - "CRITICAL ã¯ Decision Log ã¨ Change Draft ã‚’åŒä¸€æ—¥å†…ã«å¿…ãšä½œæˆ"
    - "è¨¼è·¡(links/artifacts)ã®å®Œå…¨æ€§ 100% ã‚’ç¶­æŒ"

  kpi_for_pm:
    mtta_minutes_target: { warn: 60, critical: 15 }
    mttr_hours_target: { warn: 24, critical: 24 }
    # è¿½åŠ : åˆ†å¸ƒã‚’ç›£è¦–ï¼ˆä¸­å¤®å€¤ã¨90%ç‚¹ï¼‰
    targets_distribution:
      mtta_p50_min: { warn: 30, critical: 10 }
      mtta_p90_max: { warn: 60, critical: 15 }
      mttr_p90_max_hours: { warn: 24, critical: 24 }

  triggers:
    - when: "WARN"
      actions:
        - "document_templates.decision_log ã‚’ã‚³ãƒ”ãƒšã—ã€å½“æ—¥ä¸­ã«èµ·ç¥¨"
        - "daily ã®ã€ğŸ“£ ç‹ã®è¨“ç¤ºã€ã¸æœ€å¤§3ç‚¹ã®æ˜¯æ­£æ¡ˆã‚’åæ˜ "
      decision_id_pattern: "{YYYYMMDD}-{metric}-warn-{suffix}"
      required_fields:
        - level
        - metric
        - latest_value
        - baseline_value
        - deviation_signed
        - triage_category
        - orders
        - success_criteria_line
        - next_check_date
      required_artifacts:
        - "reliability.pngï¼ˆè©²å½“runï¼‰"
        - "runsãƒ†ãƒ¼ãƒ–ãƒ«ã®æŠœç²‹ï¼ˆlast5ï¼‰: dailyã«åŸ‹è¾¼ or ãƒªãƒ³ã‚¯"

    - when: "CRITICAL"
      actions:
        - "document_templates.decision_log ã¨ document_templates.change_draft ã‚’å³æ™‚èµ·ç¥¨ï¼ˆåŒæ—¥ï¼‰"
        - "cadence.daily ã®è‡¨æ™‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹å‚¬ï¼ˆæœ€çŸ­æ ï¼‰"
        - "å¿…è¦ã«å¿œã˜ã¦ã‚»ãƒ¼ãƒ•ãƒ¢ãƒ¼ãƒ‰æ˜¯éã‚’ Noctus ã¨å”è­°"
      decision_id_pattern: "{YYYYMMDD}-{metric}-critical-{suffix}"
      required_fields:
        - level
        - metric
        - consecutive_or_dash
        - orders
        - success_criteria_line
        - next_check_date
      required_artifacts:
        - "æ¤œçŸ¥ãƒ­ã‚°ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥ãƒ†ãƒ³ãƒ—ãƒ¬ filledï¼‰"
        - "å¤±æ•—/å›å¸°ãƒ­ã‚°ï¼ˆã‚ã‚‹å ´åˆï¼‰"
        - "å¤‰æ›´æ¡ˆã®å—å…¥åŸºæº–ï¼ˆChange draft ã® acceptanceï¼‰"

  defaults:
    decision_suffix_rule: "a1, a2, â€¦ ã®é€£ç•ªã€‚1æ—¥ã«åŒä¸€æŒ‡æ¨™ã§è¤‡æ•°ãªã‚‰ a2, a3 ã‚’ä»˜ã™ã€‚"
    change_slug_rule: "çŸ­ã„è¦ç´„ï¼ˆè‹±å°æ–‡å­—ãƒ»ãƒã‚¤ãƒ•ãƒ³ï¼‰ä¾‹: calib-bins12, rollback-priorT"
    timezone: "UTC"

  # è¿½åŠ : çŠ¶æ…‹ã¨é·ç§»ã®ã‚¬ãƒ¼ãƒ‰
  states:
    allowed: ["alerted","decision_open","change_open","monitoring","closed","rolled_back"]
    transitions:
      - from: alerted
        to: decision_open
        guard: "MTTA <= target & required_fields/artifacts ã‚’æº€ãŸã™"
      - from: decision_open
        to: change_open
        when: "CRITICAL"
      - from: { any: true }
        to: monitoring
        guard: "orders å®Ÿè¡Œé–‹å§‹ & æ¤œè¨¼ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦è¨­å®šæ¸ˆ"
      - from: monitoring
        to: closed
        guard: "success_criteria é”æˆ"
      - from: monitoring
        to: rolled_back
        guard: "rollback_triggers æº€ãŸã™"

  # è¿½åŠ : è‡ªå‹•ãƒ•ãƒƒã‚¯ï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚„CIã‹ã‚‰å‘¼ã³å‡ºã—ï¼‰
  automation_hooks:
    on_alert_created:
      - "scripts.generate_change_from_decision  # CRITICALã®ã¿"
      - "scripts.link_decisions_changes         # åŒæ–¹å‘ãƒªãƒ³ã‚¯è£œå®Œ"
      - "create_pr_snippet: decisions/changes ã‚’PRèª¬æ˜æ–‡ã«è²¼ã‚‹"
    on_decision_opened:
      - "scripts.reconcile_daily_with_decisions --date {today}"
    on_change_opened:
      - "scripts.validate_daily_report --block-on missing_required_sections"
    on_closure:
      - "scripts.link_decisions_changes"
      - "scripts.publish_daily_report --dry-run=false"

  # è¿½åŠ : å¤±æ•—æ™‚æ‰±ã„ã¨ãƒªãƒˆãƒ©ã‚¤
  failure_handling:
    retry:
      max_attempts: 3
      backoff_minutes: [2, 5, 10]
    on_retry_exhausted:
      escalate_to: ["human_pm","king"]
      create_issue: true
      annotate_daily: true

  # è¿½åŠ : å¯è¦³æ¸¬æ€§ï¼ˆåé›†ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼‰
  observability:
    metrics:
      - name: workflow_mtta_minutes
        labels: [level]
      - name: workflow_mttr_hours
        labels: [level]
      - name: workflow_slo_breach_count
        labels: [type]   # mtta|mttr|artifacts_missing|lint_fail
      - name: workflow_auto_generated_docs
        labels: [type]   # decision|change
    logs:
      path: "docs/audit/{YYYY}/{YYYYMMDD}.log"
      entries:
        - "who: <actor> | action: open_decision | id: <decision_id> | at: <UTC>"
        - "who: <actor> | action: open_change | id: <change_id> | at: <UTC>"
        - "who: <actor> | action: link | d: <decision_id> | c: <change_id> | at: <UTC>"

  # è¿½åŠ : Lint/ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  lint:
    required_sections_decision:
      - "Facts"
      - "Decision"
      - "Evidence"
      - "Orders"
      - "Verification"
      - "Follow-up"
    required_sections_change:
      - "Problem"
      - "Objective"
      - "Scope"
      - "Impact Assessment"
      - "Rollout Plan"
      - "Rollback Plan"
      - "Approvals"
      - "Execution Log"
      - "Summary"
    block_on_missing: true

  acceptance_checklist:
    - "WARN: MTTA â‰¤ 60åˆ†, åŒæ—¥ä¸­ã« Decision Log èµ·ç¥¨"
    - "CRITICAL: MTTA â‰¤ 15åˆ†, åŒæ—¥ä¸­ã« Decision Log ã¨ Change Draft ã‚’èµ·ç¥¨"
    - "Daily ã«ã€ğŸ”” è­¦å ±ã€ã€ğŸ“£ ç‹ã®è¨“ç¤ºã€ã€å‚ç…§ã€ã®3ç¯€ãŒåæ˜ ã•ã‚Œã¦ã„ã‚‹"
    - "å¿…é ˆã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆï¼ˆç”»åƒ/ãƒ­ã‚°/ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ãŒæ·»ä»˜ or ãƒªãƒ³ã‚¯æ¸ˆã¿"
    - "lint é€šéï¼ˆå¿…é ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³/ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰/ãƒªãƒ³ã‚¯ï¼‰"
