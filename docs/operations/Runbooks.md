# ğŸ§­ Runbooks â€” Noctria Kingdom Operations

**Version:** 1.0  
**Status:** Draft â†’ Adopted (when merged)  
**Last Updated:** 2025-08-12 (JST)

> ç›®çš„ï¼šæœ¬ç•ª/æ¤œè¨¼ç’°å¢ƒã§ã®**æ—¥æ¬¡é‹ç”¨ãƒ»éšœå®³å¯¾å¿œãƒ»å¤‰æ›´é©ç”¨**ã‚’ã€èª°ãŒèª­ã‚“ã§ã‚‚åŒã˜å“è³ªã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚  
> é–¢é€£ï¼š`../governance/Vision-Governance.md`, `../architecture/Architecture-Overview.md`, `../observability/Observability.md`, `../operations/Airflow-DAGs.md`, `../operations/Config-Registry.md`, `../security/Security-And-Access.md`

---

## 1. å¯¾è±¡ç¯„å›²ã¨å‰æ
- å¯¾è±¡ï¼šAirflowã€GUI(FastAPI)ã€æˆ¦ç•¥å®Ÿè¡Œ(Doå±¤)ã€å­¦ç¿’/è©•ä¾¡(Plan/Check/Act) ã®æ—¥æ¬¡é‹ç”¨ã¨éšœå®³å¯¾å¿œ
- å¯¾å¿œç’°å¢ƒï¼š`prod` / `stg` / `dev`
- å‰æï¼š
  - ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã¯ `Security-And-Access.md` ã®æœ€å°æ¨©é™ã‚’æº€ãŸã™ã“ã¨
  - è¨­å®šå€¤ã¯ `../operations/Config-Registry.md` ã‚’æ­£ã¨ã—ã¦å¤‰æ›´ã™ã‚‹ã“ã¨
  - é‡è¦åˆ¤æ–­ã¯ `../governance/Vision-Governance.md` ã® RACI / ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã«å¾“ã†ã“ã¨

---

## 2. ã‚µãƒãƒªï¼ˆé‹ç”¨ãƒ•ãƒ­ãƒ¼ï¼‰
```mermaid
flowchart LR
  A[Start of Day] --> H[Health Checks]
  H --> D[Airflow Jobs]
  D --> T[Trading Window]
  T --> C[Close & KPIs]
  C --> R[Review & Hand-off]
  R -->|incidents?| I[Incident Playbooks]
```

---

## 3. æ—¥æ¬¡é‹ç”¨ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆSoD / EoDï¼‰

### 3.1 Start of Dayï¼ˆSoD, å¸‚å ´å‰ï¼‰
- [ ] Airflow `scheduler` / `webserver` / `worker` ãŒèµ·å‹•ï¼ˆ`/health` 200ï¼‰  
- [ ] GUI `/healthz` ãŒ 200  
- [ ] æ©Ÿå¯†æƒ…å ±ã®æœŸé™ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³/è¨¼æ˜æ›¸ï¼‰ã«è­¦å‘Šãªã—  
- [ ] å‰æ—¥ã® `exec_result` / `risk_event` ã®å–ã‚Šè¾¼ã¿æ¸ˆã¿  
- [ ] **å–å¼•æŠ‘åˆ¶ãƒ•ãƒ©ã‚°** (`global_trading_pause`) = `false` ã‚’ç¢ºèªï¼ˆæœ¬ç•ªã®ã¿ï¼‰

### 3.2 End of Dayï¼ˆEoD, å¸‚å ´å¾Œï¼‰
- [ ] `pdca_check_flow` å®Ÿè¡Œå®Œäº†ï¼ˆKPIç”Ÿæˆï¼‰  
- [ ] `pdca_summary` ç”Ÿæˆ â†’ GUIã«åæ˜   
- [ ] å¤±æ•—DAGã®å†å®Ÿè¡Œã¯ **3å›ã¾ã§**ã€‚è¶…ãˆãŸã‚‰ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆæ‰±ã„  
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå®Œäº†ç¢ºèª  
- [ ] æ¬¡å–¶æ¥­æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆ/ç¥æ—¥è¨­å®šã‚’ç¢ºèªï¼ˆConfig-Registryï¼‰

---

## 4. ã‚¹ã‚¿ãƒƒã‚¯èµ·å‹•/åœæ­¢ï¼ˆæ¨™æº–æ‰‹é †ï¼‰
> å®Ÿã‚³ãƒãƒ³ãƒ‰ã¯ç’°å¢ƒã«åˆã‚ã›ã¦ `compose`/`systemd` ã‚’é¸æŠã€‚ä»¥ä¸‹ã¯ä¾‹ã€‚

```bash
# èµ·å‹•
docker compose -f deploy/prod/docker-compose.yml up -d airflow-scheduler airflow-webserver airflow-worker gui

# åœæ­¢ï¼ˆè¨ˆç”»åœæ­¢æ™‚ï¼‰
docker compose -f deploy/prod/docker-compose.yml stop gui
docker compose -f deploy/prod/docker-compose.yml stop airflow-worker airflow-webserver airflow-scheduler

# ãƒ­ã‚°
docker compose -f deploy/prod/docker-compose.yml logs -f airflow-scheduler
```

---

## 5. Airflow é‹ç”¨ï¼ˆDAGæ“ä½œã®å®šçŸ³ï¼‰
- DAG ä¸€è¦§/ä¾å­˜ã¯ `../operations/Airflow-DAGs.md` ã‚’å‚ç…§
- åŸå‰‡ï¼š
  - **å†å®Ÿè¡Œã¯ idempotent** ã«è¨­è¨ˆï¼ˆå‰¯ä½œç”¨ãŒã‚ã‚‹å ´åˆã¯ Runbook ã«æ˜è¨˜ï¼‰
  - å¤±æ•—æ™‚ã®**è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤å›æ•°**ã¨**æ‰‹å‹•å†å®Ÿè¡Œæ‰‹é †**ã‚’çµ±ä¸€

```bash
# DAGã®æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–
airflow dags pause  train_prometheus_obs8
airflow dags unpause pdca_check_flow

# ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«ï¼ˆUTCåŸºæº–ï¼‰
airflow dags backfill -s 2025-08-01 -e 2025-08-12 pdca_check_flow

# å¤±æ•—ã‚¿ã‚¹ã‚¯ã®ã‚¯ãƒªã‚¢ï¼ˆä¾å­˜å«ã‚€ï¼‰
airflow tasks clear -t <task_id> -s 2025-08-12 -e 2025-08-12 -y pdca_check_flow
```

---

## 6. å–å¼•ã®ä¸€æ™‚åœæ­¢/å†é–‹ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«æŠ‘åˆ¶ï¼‰
**ç›®çš„**ï¼šç•°å¸¸æ¤œçŸ¥ãƒ»å¸‚å ´æ€¥å¤‰æ™‚ã«**å…¨æˆ¦ç•¥ã®ç™ºæ³¨ã‚’å³æ™‚åœæ­¢**ã™ã‚‹ã€‚

```bash
# æŠ‘åˆ¶ãƒ•ãƒ©ã‚° ON
./ops/tools/toggle_trading_pause.sh --env prod --on

# æŠ‘åˆ¶ãƒ•ãƒ©ã‚° OFFï¼ˆå†é–‹ï¼‰
./ops/tools/toggle_trading_pause.sh --env prod --off
```

- åæ˜ å…ˆï¼š`Config-Registry.md` ã® `risk_policy.global_trading_pause`  
- GUI ã§ã‚‚ `/ops/pause` ã‹ã‚‰åˆ‡æ›¿å¯ï¼ˆæ¨©é™å¿…è¦ï¼‰

---

## 7. æ–°è¦æˆ¦ç•¥ã®æœ¬ç•ªå°å…¥ï¼ˆDeploy/Adoptï¼‰
**å‰æ**ï¼š`Strategy-Lifecycle.md` ã®æ‰¿èªæ¸ˆã¿ã€`Noctus` ãƒªã‚¹ã‚¯å¯©æŸ»OKã€`Hermes` èª¬æ˜æ–‡ã‚ã‚Šã€‚

1. ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã§ 3 å–¶æ¥­æ—¥ A/B æ¤œè¨¼ï¼ˆ`pdca_recheck.py` â†’ KPIæ¯”è¼ƒï¼‰  
2. King æ‰¿èªå¾Œã€æœ¬ç•ªã« **ä½ãƒ­ãƒƒãƒˆ** ã§æ®µéšå°å…¥ï¼ˆ7â†’30â†’100%ï¼‰  
3. `pdca_push.py` ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¡ç”¨ â†’ `Release-Notes.md` æ›´æ–°  
4. ç›£è¦–ï¼ˆLookback 24hï¼‰ã¯ã€Œå¼·åŒ–ãƒ¢ãƒ¼ãƒ‰ã€ï¼ˆé–¾å€¤åŠåˆ†ï¼‰  
5. é‡å¤§ç•°å¸¸ãŒã‚ã‚Œã° **Â§6 ã®æŠ‘åˆ¶** ã§å³åœæ­¢ â†’ ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã¸

---

## 8. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆæ®µéšçš„å¾©å¸°ï¼‰
- å³æ™‚åœæ­¢ï¼šÂ§6 ã®æŠ‘åˆ¶ãƒ•ãƒ©ã‚° ON  
- æ®µéšãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼š
  1) æœ€æ–°æˆ¦ç•¥ã‚’ç„¡åŠ¹åŒ– â†’ ç›´å‰å®‰å®šç‰ˆã«åˆ‡æ›¿  
  2) å½±éŸ¿ãƒ‡ãƒ¼ã‚¿ã‚’é™¤å¤–ãƒ•ãƒ©ã‚°ã§ãƒãƒ¼ã‚­ãƒ³ã‚°  
  3) KPI ã‚’å†é›†è¨ˆã—å›å¾©ã‚’ç¢ºèª  
- å®Œäº†å¾Œã€`Incident-Postmortems.md` ã«ç™ºç”Ÿã‹ã‚‰å¾©å¸°ã¾ã§ã‚’è¨˜éŒ²

---

## 9. éšœå®³å¯¾å¿œãƒ—ãƒ¬ã‚¤ãƒ–ãƒƒã‚¯ï¼ˆç¨®é¡åˆ¥ï¼‰

### 9.1 Airflow ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©åœæ­¢
ç—‡çŠ¶ï¼šDAGãŒèµ°ã‚‰ãªã„ã€Web UIã« `scheduler down`  
å¯¾å‡¦ï¼š
1) `systemctl status airflow-scheduler` / ã‚³ãƒ³ãƒ†ãƒŠãƒ­ã‚°ç¢ºèª  
2) DB æ¥ç¶š/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã®æ­»æ´»ç¢ºèª  
3) `airflow db check` â†’ å¤±æ•—ãªã‚‰ `airflow db migrate` / å†èµ·å‹•  
4) å†é–‹å¾Œã«ã€å¤±æ•—æœŸé–“ã‚’ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«ï¼ˆÂ§5ï¼‰

### 9.2 ç™ºæ³¨é…å»¶/ç´„å®šç•°å¸¸ï¼ˆDoå±¤ï¼‰
ç—‡çŠ¶ï¼š`exec_result.json` ãŒé…å»¶/ç•°å¸¸å€¤  
å¯¾å‡¦ï¼š
1) ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ç–é€š `broker_adapter` ãƒ­ã‚°ç¢ºèª  
2) ã‚¹ãƒªãƒƒãƒšãƒ¼ã‚¸é–¾å€¤ > å®Ÿç¸¾ï¼Ÿ ã‚ªãƒ¼ãƒãƒ¼ãªã‚‰è‡ªå‹•åœæ­¢ãƒˆãƒªã‚¬  
3) é€£æ•—é–¾å€¤è¶…éâ†’ `risk_event.json` â†’ æŠ‘åˆ¶ãƒ•ãƒ©ã‚°ONï¼ˆÂ§6ï¼‰

### 9.3 KPI æœªç”Ÿæˆï¼ˆCheckå±¤ï¼‰
ç—‡çŠ¶ï¼šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒæ›´æ–°ã•ã‚Œãªã„  
å¯¾å‡¦ï¼š
1) `pdca_check_flow` å¤±æ•—ã‚¿ã‚¹ã‚¯ã‚’ã‚¯ãƒªã‚¢â†’å†å®Ÿè¡Œ  
2) åŸå› ãŒãƒ‡ãƒ¼ã‚¿æ¬ æãªã‚‰ `Plan-Layer` ã®ãƒªã‚«ãƒãƒªæ‰‹é †ã¸  
3) å¾©æ—§å¾Œã€`pdca_summary` ã‚’æ‰‹å‹•å®Ÿè¡Œ

---

## 10. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— & ãƒªã‚¹ãƒˆã‚¢
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¯¾è±¡ï¼š
  - `pdca_logs/**/*.json`ï¼ˆç›£æŸ»ãƒ»è©•ä¾¡ãƒ»KPIï¼‰
  - æˆ¦ç•¥ãƒªãƒªãƒ¼ã‚¹ãƒ¡ã‚¿ï¼ˆ`strategy_release.json`ï¼‰
  - å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ï¼ˆ`/models/**`ï¼‰
  - è¨­å®šï¼ˆ`Config-Registry`ï¼‰
- é »åº¦ï¼šæ—¥æ¬¡ï¼ˆEoDï¼‰ï¼Œé‡è¦DAGå®Ÿè¡Œå¾Œã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
- ãƒªã‚¹ãƒˆã‚¢æ‰‹é †ï¼ˆæ¦‚ç•¥ï¼‰ï¼š
  1) å¯¾è±¡æ—¥ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ãƒã‚¦ãƒ³ãƒˆ  
  2) ç›£æŸ»ãƒ­ã‚°â†’`exec_result`å†æ§‹æˆï¼ˆå¿…è¦æ™‚ï¼‰  
  3) `pdca_check_flow` ã‚’ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«å®Ÿè¡Œ

---

## 11. æ©Ÿå¯†/ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆé‹ç”¨è¦³ç‚¹ï¼‰
- ç§˜å¯†ã¯ **ç’°å¢ƒå¤‰æ•° or Vault**ã€‚å¹³æ–‡ãƒ•ã‚¡ã‚¤ãƒ«ç¦æ­¢  
- ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã¯ **æœ€å°æ¨©é™**ï¼‹**ç›£æŸ»ãƒ­ã‚°**ã‚’æœ‰åŠ¹åŒ–  
- é‹ç”¨è€…ã®æ¨©é™å¤‰æ›´ã¯ `Security-And-Access.md` ã®ç”³è«‹ãƒ•ãƒ­ãƒ¼å¿…é ˆ

---

## 12. ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
- å®šä¾‹ï¼šæ¯é€± ç«æ›œ 02:00â€“03:00 JSTï¼ˆæœ¬ç•ªï¼‰  
- å†…å®¹ï¼šOSãƒ‘ãƒƒãƒ/ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ/DBãƒ¡ãƒ³ãƒ†  
- å½±éŸ¿ï¼šå–å¼•åœæ­¢â†’GUIãƒãƒŠãƒ¼è¡¨ç¤ºâ†’å®Œäº†å¾Œã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯å¿…é ˆ

---

## 13. å¤‰æ›´ç®¡ç†ï¼ˆé‹ç”¨æ‰‹é †ã¸ã®åæ˜ ï¼‰
- é‡è¦å¤‰æ›´ã¯ **å¿…ãšåŒä¸€PRã§ Runbooks ã‚’æ›´æ–°**  
- æ‰¿èªãƒ•ãƒ­ãƒ¼ï¼š`Vision-Governance.md` ã® RACI ã«å¾“ã†  
- æ¡ç”¨å¾Œï¼š`Release-Notes.md` ã¨ `CHANGELOG` ã‚’æ›´æ–°

---

## 14. ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆé–¾å€¤ï¼ˆè¦ç‚¹ï¼‰
- ä¸»è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨é–¾å€¤ã¯ `../observability/Observability.md` ã‚’æ­£ã¨ã™ã‚‹  
- ä»£è¡¨ï¼š
  - **DAG å¤±æ•—ç‡**ï¼š> 5%ï¼ˆ5åˆ†é–“ï¼‰ â†’ Pager  
  - **ã‚¹ãƒªãƒƒãƒšãƒ¼ã‚¸**ï¼šé–¾å€¤è¶…é 3 å›/10 åˆ† â†’ å–å¼•æŠ‘åˆ¶  
  - **é€£æ•—æ•°**ï¼šãƒãƒªã‚·ãƒ¼è¶…é â†’ å–å¼•æŠ‘åˆ¶ï¼‹ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆèµ·ç¥¨

---

## 15. ãƒ†ãƒ³ãƒ—ãƒ¬ & ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ

### 15.1 æ‰‹é †ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆæ–°è¦Runbookæ¡é …ï¼‰
```md
## {æ‰‹é †å}
- ç›®çš„:
- å‰æ:
- æ‰‹é †:
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯:
- æ¤œè¨¼/å®Œäº†æ¡ä»¶:
- ç›£æŸ»ãƒ­ã‚°/ä¿å­˜å…ˆ:
```

### 15.2 ã‚ˆãä½¿ã†ã‚³ãƒãƒ³ãƒ‰é›†
```bash
# Airflow å¥å…¨æ€§
curl -s http://localhost:8080/health

# ç›´è¿‘å¤±æ•—ã‚¿ã‚¹ã‚¯ä¸€è¦§
airflow tasks list pdca_check_flow --tree
airflow tasks failed --since 1d

# GUI å¥å…¨æ€§
curl -s http://localhost:8000/healthz
```

### 15.3 é€£çµ¡ãƒ»ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé‹ç”¨è¡¨ï¼‰
| ç¨®åˆ¥ | é€£çµ¡å…ˆ | å½¹å‰² |
|---|---|---|
| On-call Ops | #ops-oncall | ä¸€æ¬¡å¯¾å¿œ |
| Risk Duty (Noctus) | #risk-duty | ãƒªã‚¹ã‚¯åˆ¤æ–­ |
| Council | #council | é‡è¦æ±ºå®š |
| King | #king | æœ€çµ‚æ‰¿èª |

---

## 16. æ—¢çŸ¥ã®èª²é¡Œï¼ˆKnown Issuesï¼‰
- Airflow ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«ã§é«˜é »åº¦ I/O ãŒç™ºç”Ÿ â†’ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ IOPS åˆ¶é™ã«æ³¨æ„
- ä¸€éƒ¨ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã®ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒå³æ ¼ â†’ å¤œé–“ã«ã¾ã¨ã‚ã¦æ¤œè¨¼

---

## 17. å¤‰æ›´å±¥æ­´ï¼ˆChangelogï¼‰
- **2025-08-12**: åˆç‰ˆä½œæˆï¼ˆSoD/EoD, æŠ‘åˆ¶/å°å…¥/ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯, éšœå®³, ç›£è¦–, ãƒ†ãƒ³ãƒ—ãƒ¬ï¼‰

