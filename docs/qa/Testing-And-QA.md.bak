# âœ… Testing & QA â€” Noctria Kingdom

**Version:** 1.2  
**Status:** Adopted  
**Last Updated:** 2025-08-14 (JST)

> ç›®çš„ï¼šNoctria ã® **PDCA / AI / å®Ÿè¡Œ / é‹ç”¨** ã‚’æ¬ é™¥ã‹ã‚‰å®ˆã‚Šã€**å®‰å…¨ãƒ»å†ç¾æ€§ãƒ»èª¬æ˜è²¬ä»»**ã‚’æº€ãŸã™ãŸã‚ã®ãƒ†ã‚¹ãƒˆ/QA æ¨™æº–ã‚’å®šç¾©ã™ã‚‹ã€‚  
> å‚ç…§ï¼š`../governance/Vision-Governance.md` / `../architecture/Architecture-Overview.md` / `../architecture/Plan-Layer.md` / `../operations/Runbooks.md` / `../operations/Config-Registry.md` / `../operations/Airflow-DAGs.md` / `../observability/Observability.md` / `../security/Security-And-Access.md` / `../apis/API.md` / `../apis/Do-Layer-Contract.md`

---

## 1. ã‚¹ã‚³ãƒ¼ãƒ— & ã‚´ãƒ¼ãƒ«
- **ã‚¹ã‚³ãƒ¼ãƒ—**ï¼šã‚³ãƒ¼ãƒ‰ï¼ˆPython / Configs / DAGsï¼‰ã€**å¥‘ç´„**ï¼ˆJSON Schema / APIï¼‰ã€**ãƒ‡ãƒ¼ã‚¿å“è³ª**ã€**ãƒ¢ãƒ‡ãƒ«å†ç¾æ€§**ã€**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ / ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹**ã€**ç›£è¦– / ãƒ«ãƒ¼ãƒ«**ã€**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**ã€**DecisionEngine**ï¼ˆæœ€å°ç‰ˆï¼‰ã€‚  
- **ã‚´ãƒ¼ãƒ«**ï¼š
  1) **Shift-left**ï¼šPR æ™‚ç‚¹ã§é‡å¤§æ¬ é™¥ã‚’æ¤œå‡ºï¼ˆå¥‘ç´„/ã‚¹ã‚­ãƒ¼ãƒ/é™çš„è§£æï¼‰ã€‚  
  2) **Reproducibility**ï¼šå­¦ç¿’ãƒ»æ¨è«–ãƒ»è©•ä¾¡ã‚’ **å›ºå®šã‚·ãƒ¼ãƒ‰**ã¨**ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³å€¤**ã§å†ç¾ã€‚  
  3) **Safety**ï¼š`risk_policy` è¶…éãªã—ã€**ç›£æŸ»/èª¬æ˜**ã®è¨¼è·¡ãŒæ®‹ã‚‹ã€‚  
  4) **Quality Gates**ï¼šæ•°å€¤ã—ãã„å€¤ã§**è‡ªå‹•åˆå¦**ï¼ˆÂ§5ãƒ»Â§15ï¼‰ã€‚  
  5) **Traceable by Design**ï¼š`trace_id` ãŒ **Planâ†’Inferâ†’Decisionâ†’Doâ†’Exec** ã®å…¨å±¤ã‚’è²«é€šï¼ˆE2Eã§æ¤œè¨¼ï¼‰ã€‚

---

## 2. ãƒ†ã‚¹ãƒˆãƒ»ãƒ”ãƒ©ãƒŸãƒƒãƒ‰ï¼ˆå…¨ä½“åƒï¼‰
```mermaid
flowchart TB
  U["Unit Tests"] --> C["Contract Tests"]
  C --> I["Integration Tests"]
  I --> E["E2E (PDCA)"]
  E --> P["Perf / Resilience"]
  U -.-> DQ["Data Quality"]
  E -.-> OBS["Observability Rules"]
```

---

## 3. ãƒ†ã‚¹ãƒˆç¨®åˆ¥ & æœ€ä½åŸºæº–

### 3.1 Unitï¼ˆpytestï¼‰
- ç›®çš„ï¼šç´”ç²‹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç‰¹å¾´é‡ã€ãƒ­ãƒƒãƒˆè¨ˆç®—ã€ä¸¸ã‚/æ¡ã€æ™‚åˆ»è¦ç´„ï¼‰ã€‚  
- åŸºæº–ï¼š**ã‚«ãƒãƒ¬ãƒƒã‚¸ 80%**ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯é ˜åŸŸï¼‰ã€‚  
```bash
pytest -q tests/unit
```

### 3.2 Contractï¼ˆJSON Schema / APIï¼‰
- å¯¾è±¡ï¼š`order_request / exec_result / risk_event / kpi_summary / risk_policy`ï¼ˆ`docs/schemas/*.schema.json`ï¼‰ã€‚  
- åŸºæº–ï¼š**ã‚¹ã‚­ãƒ¼ãƒé©åˆ 100%**ï¼‹**å¾Œæ–¹äº’æ›ãƒã‚§ãƒƒã‚¯**ï¼ˆå¿…é ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å‰Šé™¤ã¯ Failï¼‰ã€‚  
```bash
python -m jsonschema -i samples/exec_result_ok.json docs/schemas/exec_result.schema.json
pytest -q tests/contract
```

### 3.3 Integrationï¼ˆAdapter / Tasks / DB / Filesï¼‰
- å¯¾è±¡ï¼š`broker_adapter.py`, `order_execution.py`, Plan/Check ã‚¿ã‚¹ã‚¯ã€‚  
- åŸºæº–ï¼š**FILLED / PARTIAL / REJECTED** ã® 3 ã‚±ãƒ¼ã‚¹å†ç¾ã€ä¸¸ã‚ãƒ»æ¡ãƒ»TickSize åˆè‡´ï¼ˆ`Do-Layer-Contract.md Â§5.3`ï¼‰ã€‚  
```bash
pytest -q tests/integration -m "not slow"
```

### 3.4 E2Eï¼ˆæœ€å°æœ¬æµãƒ»ç›£æŸ»/èª¬æ˜/ãƒˆãƒ¬ãƒ¼ã‚¹ï¼‰
- å¯¾è±¡ï¼š`pdca_plan_workflow â†’ do_layer_flow â†’ pdca_check_flow â†’ pdca_act_flow`ã€‚  
- åˆæ ¼ï¼š
  - `audit_order.json` ç”Ÿæˆ  
  - `kpi_summary.json` æ›´æ–°  
  - Hermes èª¬æ˜ãŒç©ºã§ãªã„  
  - **trace_id ãŒå…¨ã‚¤ãƒ™ãƒ³ãƒˆã«å­˜åœ¨**ã—ã€`obs_plan_runs / obs_infer_calls / obs_decisions / obs_exec_events / obs_alerts` ã« **åŒä¸€ trace_id** ãŒé€£é–  
  - `obs_trace_timeline` ãƒ“ãƒ¥ãƒ¼ã§ **Pâ†’Dâ†’Decisionâ†’Exec** ã®æ™‚ç³»åˆ—ãŒå¯è¦–ï¼ˆæœ€ä½ 1 é€£é–ï¼‰
```bash
pytest -q tests/e2e --maxfail=1
```

### 3.5 Data Qualityï¼ˆPlanï¼‰
- é …ç›®ï¼šæ¬ æ / å¤–ã‚Œ / æ™‚é–“æ•´åˆ / ç¥æ—¥ã€‚  
- åŸºæº–ï¼šæ¬ ææ¯” â‰¤ 1%/æ—¥ã€é‡è¤‡ãƒãƒ¼ 0ã€UTC æ•´åˆ OKã€çµ±è¨ˆã®åˆ†æ•£å¤‰å‹•ãŒç¯„å›²å†…ã€‚  
```bash
pytest -q tests/data_quality
```

### 3.6 ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ™ãƒ¼ã‚¹ï¼ˆHypothesisï¼‰
- ä¾‹ï¼šãƒ­ãƒƒãƒˆã¯ `qty>=0` ã‹ã¤ **å¢ƒç•Œè¶Šãˆãªã—**ã€æ¥µç«¯å…¥åŠ›ã§ã‚‚ NaN ã‚’å‡ºã•ãªã„ã€‚  
```python
from hypothesis import given, strategies as st
@given(st.floats(min_value=-1, max_value=1))
def test_lot_never_exceeds_policy(sig):
    qty = to_lot(sig, policy)
    assert 0.0 <= qty <= policy.max_position_qty
```

### 3.7 å†ç¾æ€§ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³/ã‚·ãƒ¼ãƒ‰å›ºå®šï¼‰
- å°åŒºé–“ã§å­¦ç¿’ãƒ»æ¨è«–ãƒ»è©•ä¾¡ â†’ **å‡ºåŠ›ãƒãƒƒã‚·ãƒ¥ä¸€è‡´**ï¼ˆGit SHA / seed / ä¾å­˜ã¨çªåˆï¼‰ã€‚  
```bash
pytest -q tests/repro  # /tests/golden/** ã¨æ¯”è¼ƒ
```

### 3.8 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ / ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹
- ç›®çš„ï¼šDo å±¤ p95 < 500msã€éšœå®³æ™‚ã®**å®‰å…¨åœæ­¢**ã€‚  
- ãƒ„ãƒ¼ãƒ«ï¼š`k6` / `locust`ã€æ•…éšœæ³¨å…¥ï¼ˆé…å»¶ / æ¥ç¶šåˆ‡æ–­ / 429ï¼‰ã€‚  
```bash
k6 run tests/perf/do_orders_p95.js
pytest -q tests/resilience -m fault_injection
```

### 3.9 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- SAST / ä¾å­˜è„†å¼±æ€§ / ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³ï¼ˆPII/Secrets ãƒ­ã‚°ç¦æ­¢ã‚‚æ¤œæŸ»ï¼‰ã€‚  
```bash
bandit -q -r src
pip-audit -r requirements.txt
gitleaks detect --no-banner
```

### 3.10 ç›£è¦–ãƒ»ãƒ«ãƒ¼ãƒ«ï¼ˆObservabilityï¼‰
- Prometheus Rules / Loki ã‚¯ã‚¨ãƒªã®é™çš„æ¤œè¨¼ & ãƒªãƒãƒ¼ã‚µãƒ«ã€‚  
```bash
promtool check rules deploy/alerts/noctria.rules.yml
pytest -q tests/observability
```

### 3.11 API ä½µèµ°æ€§ & Idempotency
- åŒä¸€ `Idempotency-Key` å†é€ â†’ **é‡è¤‡å®Ÿè¡Œãªã—**ã€24h ä¿æŒã®æ¤œè¨¼ã€‚  
- PATCH ã¯ `If-Match` å¿…é ˆï¼ˆETag ç«¶åˆ 412 ã‚’æœŸå¾…ï¼‰ã€‚  
```bash
pytest -q tests/api_idempotency
```

### 3.12 Streaming / Webhook
- SSEï¼š`Last-Event-ID` å†æ¥ç¶šã§æ¬ è½ã‚¤ãƒ™ãƒ³ãƒˆãŒè£œå®Œã€‚  
- Webhookï¼šHMAC ç½²åæ¤œè¨¼ï¼ˆæ™‚åˆ»ä¹–é›¢ Â±5mï¼‰ã§ Fail/Pass ã‚’ç¢ºèªã€‚  
```bash
pytest -q tests/streaming_webhooks
```

### 3.13 DecisionEngineï¼ˆRoyalDecision, æœ€å°ç‰ˆï¼‰
- **æ¤œè¨¼é …ç›®**ï¼š
  - é‡ã¿ãƒ»é–¾å€¤ãƒ»ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆæ¯”ç‡ãŒ **å¤–éƒ¨è¨­å®š**ï¼ˆ`configs/profiles.yaml`ï¼‰ã¨ä¸€è‡´  
  - åŒä¸€å…¥åŠ›ã§ **æ±ºå®šã®å†ç¾æ€§**ï¼ˆseed å›ºå®šï¼‰  
  - **å˜èª¿æ€§**ï¼šã‚ã‚‹åŠ©è¨€ã®ä¿¡é ¼åº¦ãŒä¸ŠãŒã‚‹ã¨åˆæˆã‚¹ã‚³ã‚¢ãŒéæ¸›å°‘  
  - å‡ºåŠ›ã« `trace_id` ã‚’ä»˜ä¸ã— **obs_decisions** ã¸è¨˜éŒ²  
```bash
pytest -q tests/decision_engine
```

---

## 4. ç’°å¢ƒãƒãƒˆãƒªã‚¯ã‚¹ & ã‚²ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
| ç¨®åˆ¥ | dev | stg | prod |
|---|---:|---:|---:|
| Lint / SAST / Contract | âœ… | âœ… | âœ… |
| Unit / Integration | âœ… | âœ… | âœ… |
| E2Eï¼ˆã‚·ãƒ£ãƒ‰ãƒ¼/ä½ãƒ­ãƒƒãƒˆï¼‰ | â­• | âœ… | ğŸ”¸ï¼ˆã‚«ãƒŠãƒªã‚¢ã®ã¿ï¼‰ |
| Perf / Resilience | â­• | âœ… | ğŸ”¸ï¼ˆäº‹å‰æ²ç¤ºï¼‰ |
| Observability Rehearsal | âœ… | âœ… | âœ… |
| Security (gitleaks/pip-audit) | âœ… | âœ… | âœ… |

> ğŸ”¸=æœ¬ç•ªã¯**äº‹å‰å‘ŠçŸ¥ï¼†æ™‚é–“å¸¯åˆ¶é™**ã€‚æ˜‡æ ¼ã¯ `Strategy-Lifecycle.md` ã® **G2/G3/G4** ã‚’æº€ãŸã™ã“ã¨ã€‚

---

## 5. CI/CDï¼ˆæ¨å¥¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ & ã‚²ãƒ¼ãƒˆï¼‰
```mermaid
flowchart LR
  A["PR Open"] --> L["Lint / Format / SAST"]
  L --> S["Schema / Contract"]
  S --> U["Unit"]
  U --> I["Integration (Docker test stack)"]
  I --> B["Build images + SBOM + Vuln Scan"]
  B --> E["E2E (stg, shadow/low-lot)"]
  E --> G["Gates: KPI / Alerts / SLA"]
  G -->|pass| D["Deploy stg"]
  D --> C["Canary prod (7%)"]
  C --> R["Promote 30% â†’ 100%"]
  G -->|fail| X["Block + Report"]
```

**ã‚²ãƒ¼ãƒˆæ¡ä»¶ï¼ˆä¾‹ï¼‰**
- `do_order_latency_seconds` **p95 â‰¤ 0.5s**ï¼ˆstgï¼‰  
- `do_slippage_pct` **p90 â‰¤ 0.3%**ï¼ˆstg, 10mï¼‰  
- `kpi_win_rate`ï¼ˆ7dï¼‰â‰¥ **0.50**ã€`kpi_max_dd_pct`ï¼ˆ7dï¼‰â‰¤ **8%**  
- **é‡å¤§ã‚¢ãƒ©ãƒ¼ãƒˆ 0 ä»¶**ï¼ˆ`Observability.md Â§5`ï¼‰  
- **å¥‘ç´„ãƒ†ã‚¹ãƒˆ 100%**ã€**Secrets æ¼ãˆã„ 0**ï¼ˆgitleaksï¼‰  
- **ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³å·®åˆ† 0**ï¼ˆè¨±å®¹ Îµ ä»¥å†…ï¼‰

**PR ãƒ©ãƒ™ãƒ«ã§è¿½åŠ ã‚²ãƒ¼ãƒˆ**  
- `breaking-contract`ï¼šå¾Œæ–¹äº’æ›ãƒ†ã‚¹ãƒˆå¼·åŒ– + äº’æ›ãƒ¬ãƒãƒ¼ãƒˆå¿…é ˆ  
- `perf-sensitive`ï¼šPerf/Resilience ã‚’å¿…é ˆã«æ˜‡æ ¼  
- `security-impact`ï¼šSAST/ä¾å­˜ç›£æŸ»ã‚’å³æ ¼ãƒ¢ãƒ¼ãƒ‰

---

## 6. ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œï¼ˆé–‹ç™ºè€…å‘ã‘ï¼‰
```bash
# äº‹å‰
python -m venv .venv && source .venv/bin/activate
pip install -r requirements-dev.txt

# ã¾ã¨ã‚å®Ÿè¡Œ
make test          # lint + unit + contract
make test-full     # + integration + e2e (ãƒ­ãƒ¼ã‚«ãƒ«æœ€å°)
make schemas-check # JSON Schema é™çš„æ¤œè¨¼

# Docker ãƒ†ã‚¹ãƒˆã‚¹ã‚¿ãƒƒã‚¯ï¼ˆä»»æ„ï¼‰
docker compose -f deploy/test/docker-compose.yml up -d
pytest -q tests/integration
```

**Makefileï¼ˆæŠœç²‹ï¼‰**
```make
test: lint schemas unit
test-full: test integration e2e
lint:
	ruff check src tests
	black --check src tests
schemas:
	python tools/validate_schemas.py
unit:
	pytest -q tests/unit
integration:
	docker compose -f deploy/test/docker-compose.yml up -d
	pytest -q tests/integration
e2e:
	pytest -q tests/e2e -m "smoke"
```

---

## 7. ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ & ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
- **ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**ï¼š`tests/fixtures/{plan,do,check,models,decision}/**`  
- **ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³**ï¼š`tests/golden/**`ï¼ˆå‡ºåŠ›ãƒãƒƒã‚·ãƒ¥ç”¨ï¼‰  
- **åˆæˆãƒ‡ãƒ¼ã‚¿**ï¼šæ¥µç«¯å€¤/æ¬ æ/ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’å†ç¾ã—ãŸç–‘ä¼¼ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ã‚’åŒæ¢±  
- **ã‚·ãƒ¼ãƒ‰**ï¼š`[1337, 1729, 31415]` ã‚’åŸºæœ¬ï¼ˆ`ModelCard-Prometheus-PPO.md` ã¨æ•´åˆï¼‰  
- **ãƒ‡ãƒ¼ã‚¿è²¬å‹™**ï¼šPII/Secrets ã‚’å«ã‚ãªã„ï¼ˆ`Security-And-Access.md`ï¼‰

---

## 8. Airflow QAï¼ˆå¿…é ˆãƒã‚§ãƒƒã‚¯ï¼‰
- **DAG Import**ï¼š`airflow dags list` ãŒã‚¼ãƒ­ã‚¨ãƒ©ãƒ¼  
- **SLA**ï¼š`airflow_dag_sla_miss_total` ãŒé–¾å€¤ä»¥ä¸‹  
- **Dry Runs**ï¼šä»£è¡¨ã‚¿ã‚¹ã‚¯ `--dry-run` ãŒå®Œäº†  
- **Backfill å°åŒºé–“**ï¼šUTC 1 æ—¥ã§æˆåŠŸã€**idempotent**  
```bash
airflow dags list
airflow tasks test pdca_plan_workflow generate_features 2025-08-12
airflow dags backfill -s 2025-08-11 -e 2025-08-12 pdca_check_flow
```

---

## 9. Do-Layer å¥‘ç´„ãƒ†ã‚¹ãƒˆï¼ˆ3ãƒ‘ã‚¿ãƒ¼ãƒ³æœ€ä½ï¼‰
```json
// FILLEDï¼ˆæœŸå¾…ï¼‰
{"status":"FILLED","filled_qty":0.5,"avg_price":59001.0,"fees":0.12}
```
```json
// PARTIALï¼ˆä¸­æ–­ã§ã‚‚ filled_qty>0ï¼‰
{"status":"CANCELLED","filled_qty":0.3,"avg_price":59010.0}
```
```json
// REJECTEDï¼ˆè¶Šå¢ƒ/æŠ‘åˆ¶ï¼‰
{"error":{"code":"RISK_BOUNDARY_EXCEEDED"}}
```
- ã‚¹ã‚­ãƒ¼ãƒé©åˆ + ä¸¸ã‚/æ¡ + `audit_order.json` ç”Ÿæˆã®æœ‰ç„¡ã§åˆ¤å®šï¼ˆ`Do-Layer-Contract.md`ï¼‰ã€‚  
- **Idempotency**ï¼šåŒä¸€ `Idempotency-Key` å†é€ã§**é‡è¤‡ãªã—**ï¼ˆ24h ä¿æŒï¼‰ã€‚

---

## 10. KPI ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ QAï¼ˆCheck/Actï¼‰
- **å…¥åŠ›**ï¼š`/data/execution_logs/*.json`ï¼ˆç–‘ä¼¼ãƒ‡ãƒ¼ã‚¿ï¼‰  
- **å‡ºåŠ›**ï¼š`kpi_summary.json` ã® **ã‚¹ã‚­ãƒ¼ãƒ/å€¤åŸŸ/æ›´æ–°æ™‚åˆ»** ã‚’æ¤œè¨¼ã€‚  
- **Hermes**ï¼šèª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆãŒ**ç©º/ä¸æ•´åˆ**ã§ãªã„ã€‚  
- **Schema Version**ï¼š`kpi_summary.schema.json` ã« `schema_version` ã‚’ä»˜ä¸ãƒ»ç…§åˆã€‚

---

## 11. ãƒ¢ãƒ‡ãƒ« QAï¼ˆPrometheus / Veritasï¼‰
- **æ¨è«–å®‰å®šæ€§**ï¼šåŒä¸€å…¥åŠ› â†’ **åŒä¸€å‡ºåŠ›**ï¼ˆè¨±å®¹ Îµï¼‰  
- **å­¦ç¿’å†ç¾**ï¼šå°åŒºé–“å­¦ç¿’ â†’ æŒ‡æ¨™ Â±Î”ï¼ˆé–¾å€¤ 3%ï¼‰  
- **éå­¦ç¿’**ï¼šTrain/Test ä¹–é›¢ãŒ**è¨­å®šç¯„å›²å†…**  
- **å®‰å…¨**ï¼šã‚¢ã‚¯ã‚·ãƒ§ãƒ³â†’ãƒ­ãƒƒãƒˆå¤‰æ›ã§ **å¢ƒç•Œè¶Šãˆãªã—**ï¼ˆNoctus ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰  
- **ãƒ‰ãƒªãƒ•ãƒˆ**ï¼š`action_mean/std`, `turnover`, `hit_rate` ç›£è¦–ã¨**å†å­¦ç¿’ãƒˆãƒªã‚¬æ¡ä»¶**ã‚’å®šç¾©

---

## 12. ãƒªãƒªãƒ¼ã‚¹ãƒ»ã‚²ãƒ¼ãƒ†ã‚£ãƒ³ã‚° & æ®µéšå°å…¥
- **ã‚«ãƒŠãƒªã‚¢**ï¼š`Strategy-Lifecycle.md Â§4.4`ï¼ˆ7%â†’30%â†’100%ã€Safemode ONï¼‰ã€‚  
- **æ˜‡æ ¼**ï¼šÂ§5 ã®ã‚²ãƒ¼ãƒˆã‚’ **é€£ç¶šå–¶æ¥­æ—¥**ã‚¯ãƒªã‚¢ã€é‡å¤§ã‚¢ãƒ©ãƒ¼ãƒˆ 0ã€‚  
- **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**ï¼š`Runbooks.md Â§8`ï¼ˆ`risk_event` ã§å³æ™‚åœæ­¢æ¤œè¨ï¼‰ã€‚

---

## 13. ãƒã‚°ç®¡ç† & å„ªå…ˆåº¦
| Severity | å®šç¾© | ä¾‹ | ç›®æ¨™å¿œç­” |
|---|---|---|---|
| S1 | å®‰å…¨/è²¡å‹™ã«é‡å¤§ | é€£ç¶šç™ºæ³¨ / å¢ƒç•Œç„¡è¦– / ç›£æŸ»æ¬ è½ | å³æ™‚å¯¾å¿œãƒ»æŠ‘åˆ¶ ON |
| S2 | æœ¬ç•ªå½±éŸ¿å¤§ | p95>0.5s æŒç¶šã€DAG åœæ­¢ | å½“æ—¥å†…ä¿®æ­£/å›é¿ |
| S3 | å½±éŸ¿ä¸­ | ä¸€éƒ¨æˆ¦ç•¥ã®ã¿åŠ£åŒ– | æ¬¡ãƒªãƒªãƒ¼ã‚¹ |
| S4 | ä½ | UI/æ–‡è¨€/è»½å¾®ãƒ­ã‚° | ãƒãƒƒã‚¯ãƒ­ã‚° |

**Flaky å¯¾å¿œ**ï¼šå†ç¾æ€§ãªã—ã‚’ 2 å›æ¤œå‡ºâ†’**quarantine** ãƒ©ãƒ™ãƒ«ä»˜ä¸ã€å°‚ç”¨ã‚¸ãƒ§ãƒ–ã§éš”é›¢ãƒ†ã‚¹ãƒˆã€‚  
**å†è©¦è¡Œæ–¹é‡**ï¼šãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç³»ã®ã¿æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã€ãƒ“ã‚¸ãƒã‚¹ NG ã¯**å†è©¦è¡Œç¦æ­¢**ã€‚

---

## 14. ãƒ†ãƒ³ãƒ—ãƒ¬ & ä¾‹

### 14.1 ãƒ†ã‚¹ãƒˆè¨ˆç”»ãƒ†ãƒ³ãƒ—ãƒ¬
```md
# Test Plan â€” {Feature/Change}
- èƒŒæ™¯/ç›®çš„:
- å½±éŸ¿ç¯„å›²:
- ãƒ†ã‚¹ãƒˆå¯¾è±¡/é™¤å¤–:
- ãƒ†ã‚¹ãƒˆç¨®åˆ¥: Unit / Contract / Integration / E2E / Perf / Sec / Obs / Decision
- ãƒ‡ãƒ¼ã‚¿/ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£:
- åˆæ ¼åŸºæº–ï¼ˆãƒ¡ãƒˆãƒªã‚¯ã‚¹/ã—ãã„å€¤ï¼‰:
- ãƒªã‚¹ã‚¯/ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯:
- å®Ÿæ–½è€…/ãƒ¬ãƒ“ãƒ¥ãƒ¼/æ‰¿èª:
```

### 14.2 pytest.iniï¼ˆä¾‹ï¼‰
```ini
[pytest]
addopts = -q -ra --maxfail=1
testpaths = tests
markers =
    slow: é•·æ™‚é–“
    fault_injection: æ•…éšœæ³¨å…¥
    smoke: ã‚¹ãƒ¢ãƒ¼ã‚¯
    quarantine: ä¸å®‰å®šãƒ†ã‚¹ãƒˆ
```

### 14.3 pre-commitï¼ˆæŠœç²‹ï¼‰
```yaml
repos:
  - repo: https://github.com/psf/black
    rev: 24.4.2
    hooks: [{id: black}]
  - repo: https://github.com/charliermarsh/ruff-pre-commit
    rev: v0.5.0
    hooks: [{id: ruff}]
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.18.2
    hooks: [{id: gitleaks}]
```

---

## 15. ã‚«ãƒãƒ¬ãƒƒã‚¸ & å“è³ªåŸºæº–ï¼ˆQuality Gatesï¼‰
- **ãƒ©ã‚¤ãƒ³**ï¼šç·åˆ 75% ä»¥ä¸Šã€ã‚³ã‚¢ï¼ˆPlan / Do / Noctus / Decisionï¼‰**80% ä»¥ä¸Š**ã€‚  
- **Lint**ï¼š`ruff / black` ã‚¼ãƒ­ã‚¨ãƒ©ãƒ¼ã€‚`mypy --strict` åˆæ ¼ï¼ˆå‹ã‚¨ãƒ©ãƒ¼ 0ï¼‰ã€‚  
- **å¥‘ç´„**ï¼šã‚¹ã‚­ãƒ¼ãƒ 100% æº–æ‹ ã€**å¾Œæ–¹äº’æ› OK**ã€‚  
- **Perf**ï¼šDo å±¤ p95 < **0.5s**ï¼ˆstgï¼‰ã€‚  
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**ï¼š`gitleaks` 0 ä»¶ã€`pip-audit` High ä»¥ä¸Š 0 ä»¶ã€‚  
- **å†ç¾æ€§**ï¼šã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³å·®åˆ† 0ï¼ˆè¨±å®¹ Îµ ã¯æ©Ÿèƒ½åˆ¥ã«æ˜è¨˜ï¼‰ã€‚  
- **ãƒˆãƒ¬ãƒ¼ã‚¹**ï¼šE2E ã§ **trace_id è²«é€šç‡ 100%**ï¼ˆä¸»è¦ãƒ†ãƒ¼ãƒ–ãƒ«é€£é–ã§ç…§åˆï¼‰ã€‚

> ã„ãšã‚Œã‹ 1 ã¤ã§ã‚‚ **Fail â†’ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ–ãƒ­ãƒƒã‚¯**ã€‚ä¾‹å¤–ã¯ `ADR` ã«ã‚ˆã‚‹æ‰¿èªãŒå¿…è¦ã€‚

---

## 16. å¤‰æ›´ç®¡ç†ï¼ˆDocs as Codeï¼‰
- ä»•æ§˜å¤‰æ›´ã¯ **åŒä¸€ PR**ã§æœ¬æ›¸ã¨é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆ`API / Do-Layer-Contract / Runbooks / Config-Registry / Observability / Architecture`ï¼‰ã‚’æ›´æ–°ã€‚  
- é‡è¦ãª QA å¤‰æ›´ã¯ `adrs/` ã«è¨˜éŒ²ï¼ˆDecision / Rollout / Consequencesï¼‰ã€‚

---

## 17. æ—¢çŸ¥ã®åˆ¶ç´„ / TODO
- æœ¬ç•ªã§ã®**æ•…éšœæ³¨å…¥**ã¯é™å®šçš„ï¼ˆæ™‚é–“å¸¯åˆ¶ç´„ãƒ»å½±éŸ¿æœ€å°åŒ–ï¼‰ã€‚  
- å–å¼•æ‰€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®**å‹•çš„è¿½éš**ï¼ˆè‡ªå‹•æ¤œå‡ºâ†’ãƒ†ã‚¹ãƒˆã®ã—ãã„å€¤æ›´æ–°ï¼‰ã‚’å¼·åŒ–äºˆå®šã€‚

---

## 18. å¤‰æ›´å±¥æ­´ï¼ˆChangelogï¼‰
- **2025-08-14**: v1.2  
  - **trace_id ã® E2E æ¤œè¨¼**ï¼ˆobs_decisions / obs_exec_events / timelineï¼‰ã‚’è¿½åŠ ã€‚  
  - **DecisionEngine ãƒ†ã‚¹ãƒˆ**ï¼ˆå¤–éƒ¨è¨­å®šãƒ»å˜èª¿æ€§ãƒ»å†ç¾æ€§ï¼‰ã‚’è¿½åŠ ã€‚  
  - Mermaid å›³ã‚’ GitHub äº’æ›ã®æœ€å°æ§‹æˆã«èª¿æ•´ã€‚  
- **2025-08-12**: v1.1  
  - Idempotency / If-Match / SSE / Webhookã€Flaky å¯¾å¿œã€ã‚²ãƒ¼ãƒˆæ‹¡å……ã€‚  
- **2025-08-12**: v1.0 åˆç‰ˆï¼ˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰ / åŸºæº– / CI / Airflow / Do å¥‘ç´„ / ãƒ¢ãƒ‡ãƒ« / ç›£è¦– / ã‚²ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰

<!-- AUTOGEN:CHANGELOG START -->

### ğŸ›  Updates since: `2025-08-13 18:16 UTC`

- `4715c7b` 2025-08-15T05:12:32+09:00 â€” **Update update_docs_from_index.py** _(by Noctoria)_
  - `scripts/update_docs_from_index.py`
- `c20a9bd` 2025-08-15T04:58:31+09:00 â€” **Create update_docs_from_index.py** _(by Noctoria)_
  - `scripts/update_docs_from_index.py`
- `969f987` 2025-08-15T04:36:32+09:00 â€” **Update pdca_summary.py** _(by Noctoria)_
  - `noctria_gui/routes/pdca_summary.py`
- `a39c7db` 2025-08-15T04:14:15+09:00 â€” **Update observability.py** _(by Noctoria)_
  - `src/plan_data/observability.py`
- `09a3e13` 2025-08-15T03:51:14+09:00 â€” **Update Aurus_Singularis.py** _(by Noctoria)_
  - `src/strategies/veritas_generated/Aurus_Singularis.py`
- `aea152c` 2025-08-15T03:34:12+09:00 â€” **Update strategy_detail.py** _(by Noctoria)_
  - `noctria_gui/routes/strategy_detail.py`
- `3bc997c` 2025-08-15T03:23:40+09:00 â€” **Update strategy_detail.py** _(by Noctoria)_
  - `noctria_gui/routes/strategy_detail.py`
- `482da8a` 2025-08-15T03:02:26+09:00 â€” **Update pdca_recheck.py** _(by Noctoria)_
  - `noctria_gui/routes/pdca_recheck.py`
- `feef06f` 2025-08-15T02:33:44+09:00 â€” **Update docker-compose.yaml** _(by Noctoria)_
  - `airflow_docker/docker-compose.yaml`
- `e4e3005` 2025-08-15T02:15:13+09:00 â€” **Update __init__.py** _(by Noctoria)_
  - `noctria_gui/__init__.py`
- `4b38d3b` 2025-08-15T01:48:52+09:00 â€” **Update path_config.py** _(by Noctoria)_
  - `src/core/path_config.py`
- `00fc537` 2025-08-15T01:44:12+09:00 â€” **Create kpi_minidemo.py** _(by Noctoria)_
  - `src/plan_data/kpi_minidemo.py`
- `daa5865` 2025-08-15T01:37:54+09:00 â€” **Update Aurus_Singularis.py** _(by Noctoria)_
  - `src/strategies/veritas_generated/Aurus_Singularis.py`
- `5e52eca` 2025-08-15T01:35:28+09:00 â€” **Update Aurus_Singularis.py** _(by Noctoria)_
  - `src/strategies/veritas_generated/Aurus_Singularis.py`
- `e320246` 2025-08-15T01:34:39+09:00 â€” **Update Aurus_Singularis.py** _(by Noctoria)_
  - `src/strategies/veritas_generated/Aurus_Singularis.py`
- `de39f94` 2025-08-15T01:33:29+09:00 â€” **Create Aurus_Singularis.py** _(by Noctoria)_
  - `src/strategies/veritas_generated/Aurus_Singularis.py`
- `e4c82d5` 2025-08-15T01:16:27+09:00 â€” **Update pdca_recheck.py** _(by Noctoria)_
  - `noctria_gui/routes/pdca_recheck.py`
- `47a5847` 2025-08-15T01:06:11+09:00 â€” **Update main.py** _(by Noctoria)_
  - `noctria_gui/main.py`
- `15188ea` 2025-08-15T00:59:08+09:00 â€” **Update __init__.py** _(by Noctoria)_
  - `noctria_gui/__init__.py`
- `1b4c2ec` 2025-08-15T00:41:34+09:00 â€” **Create statistics_routes.py** _(by Noctoria)_
  - `noctria_gui/routes/statistics_routes.py`
- `49795a6` 2025-08-15T00:34:44+09:00 â€” **Update pdca_recheck.py** _(by Noctoria)_
  - `noctria_gui/routes/pdca_recheck.py`
- `4d7dd70` 2025-08-15T00:28:18+09:00 â€” **Update act_service.py** _(by Noctoria)_
  - `src/core/act_service.py`
- `1d38c3c` 2025-08-14T22:21:33+09:00 â€” **Create policy_engine.py** _(by Noctoria)_
  - `src/core/policy_engine.py`
- `dcdd7f4` 2025-08-14T22:15:59+09:00 â€” **Update airflow_client.py** _(by Noctoria)_
  - `src/core/airflow_client.py`
- `e66ac97` 2025-08-14T22:08:25+09:00 â€” **Update pdca_recheck.py** _(by Noctoria)_
  - `noctria_gui/routes/pdca_recheck.py`
- `6c49b8e` 2025-08-14T21:58:17+09:00 â€” **Update pdca_summary.py** _(by Noctoria)_
  - `noctria_gui/routes/pdca_summary.py`
- `e0b9eaa` 2025-08-14T21:53:00+09:00 â€” **Update pdca_summary_service.py** _(by Noctoria)_
  - `src/plan_data/pdca_summary_service.py`
- `368203e` 2025-08-14T21:44:48+09:00 â€” **Update pdca_summary.py** _(by Noctoria)_
  - `noctria_gui/routes/pdca_summary.py`
- `cc9da23` 2025-08-14T21:32:42+09:00 â€” **Update pdca_routes.py** _(by Noctoria)_
  - `noctria_gui/routes/pdca_routes.py`
- `434d2e2` 2025-08-14T21:23:55+09:00 â€” **Update pdca_routes.py** _(by Noctoria)_
  - `noctria_gui/routes/pdca_routes.py`
- `d0df823` 2025-08-14T21:18:54+09:00 â€” **Update decision_registry.py** _(by Noctoria)_
  - `src/core/decision_registry.py`
- `1eaed26` 2025-08-14T21:08:01+09:00 â€” **Update pdca_routes.py** _(by Noctoria)_
  - `noctria_gui/routes/pdca_routes.py`
- `b557920` 2025-08-14T21:03:59+09:00 â€” **Update strategy_evaluator.py** _(by Noctoria)_
  - `src/core/strategy_evaluator.py`
- `0c7a12f` 2025-08-14T21:00:00+09:00 â€” **Create decision_registry.py** _(by Noctoria)_
  - `src/core/decision_registry.py`
- `2f034a5` 2025-08-14T20:58:16+09:00 â€” **Update pdca_summary.html** _(by Noctoria)_
  - `noctria_gui/templates/pdca_summary.html`
- `28bb890` 2025-08-14T20:51:37+09:00 â€” **Update pdca_routes.py** _(by Noctoria)_
  - `noctria_gui/routes/pdca_routes.py`
- `307da2d` 2025-08-14T20:49:15+09:00 â€” **Create act_service.py** _(by Noctoria)_
  - `src/core/act_service.py`
- `bf993f3` 2025-08-14T20:41:12+09:00 â€” **Update pdca_summary.html** _(by Noctoria)_
  - `noctria_gui/templates/pdca_summary.html`
- `4b7ca22` 2025-08-14T20:35:18+09:00 â€” **Update pdca_routes.py** _(by Noctoria)_
  - `noctria_gui/routes/pdca_routes.py`
- `3880c7b` 2025-08-14T20:32:42+09:00 â€” **Update pdca_summary.html** _(by Noctoria)_
  - `noctria_gui/templates/pdca_summary.html`
- `074b6cf` 2025-08-14T20:24:03+09:00 â€” **Update pdca_routes.py** _(by Noctoria)_
  - `noctria_gui/routes/pdca_routes.py`
- `46d639d` 2025-08-14T20:17:49+09:00 â€” **Update strategy_evaluator.py** _(by Noctoria)_
  - `src/core/strategy_evaluator.py`
- `f63e897` 2025-08-14T20:12:50+09:00 â€” **Update veritas_recheck_dag.py** _(by Noctoria)_
  - `airflow_docker/dags/veritas_recheck_dag.py`
- `7c3785e` 2025-08-14T20:08:26+09:00 â€” **Create veritas_recheck_all_dag.py** _(by Noctoria)_
  - `airflow_docker/dags/veritas_recheck_all_dag.py`
- `49fe520` 2025-08-14T15:41:00+09:00 â€” **main.py ã‚’æ›´æ–°** _(by Noctoria)_
  - `noctria_gui/main.py`
- `3648612` 2025-08-14T15:35:27+09:00 â€” **pdca_routes.py ã‚’æ›´æ–°** _(by Noctoria)_
  - `noctria_gui/routes/pdca_routes.py`
- `f7f1972` 2025-08-14T06:32:19+09:00 â€” **Update base_hud.html** _(by Noctoria)_
  - `noctria_gui/templates/base_hud.html`
- `eae18c6` 2025-08-14T06:21:35+09:00 â€” **Update pdca_summary.html** _(by Noctoria)_
  - `noctria_gui/templates/pdca_summary.html`
- `1d6047c` 2025-08-14T06:10:33+09:00 â€” **Update pdca_summary.html** _(by Noctoria)_
  - `noctria_gui/templates/pdca_summary.html`
- `3c55ed0` 2025-08-14T06:04:20+09:00 â€” **Create dammy** _(by Noctoria)_
  - `noctria_gui/static/vendor/dammy`
- `7b4624d` 2025-08-14T05:45:03+09:00 â€” **Update pdca_summary.html** _(by Noctoria)_
  - `noctria_gui/templates/pdca_summary.html`
- `35e4c50` 2025-08-14T04:49:16+09:00 â€” **Update main.py** _(by Noctoria)_
  - `noctria_gui/main.py`
- `6c88b9f` 2025-08-14T04:31:58+09:00 â€” **Update pdca_summary.html** _(by Noctoria)_
  - `noctria_gui/templates/pdca_summary.html`
- `1a0b00e` 2025-08-14T04:29:17+09:00 â€” **Update pdca_summary.py** _(by Noctoria)_
  - `noctria_gui/routes/pdca_summary.py`
- `2b51ef9` 2025-08-14T04:27:11+09:00 â€” **Create pdca_summary_service.py** _(by Noctoria)_
  - `src/plan_data/pdca_summary_service.py`
- `6ff093a` 2025-08-14T04:24:34+09:00 â€” **Update main.py** _(by Noctoria)_
  - `noctria_gui/main.py`
- `7e2e056` 2025-08-14T04:20:51+09:00 â€” **Create pdca_control.html** _(by Noctoria)_
  - `noctria_gui/templates/pdca_control.html`
- `cf248ee` 2025-08-14T04:15:18+09:00 â€” **Update pdca_recheck.py** _(by Noctoria)_
  - `noctria_gui/routes/pdca_recheck.py`
- `d8e0d6e` 2025-08-14T04:12:02+09:00 â€” **Create airflow_client.py** _(by Noctoria)_
  - `src/core/airflow_client.py`

<!-- AUTOGEN:CHANGELOG END -->
<!-- AUTODOC:BEGIN mode=git_log path_globs="tests/**/*.py;docs/qa/*.md" title="ãƒ†ã‚¹ãƒˆ/QA æ›´æ–°å±¥æ­´ï¼ˆæœ€è¿‘30ï¼‰" limit=30 since=2025-08-01 -->
(è‡ªå‹•ç½®æ›)
<!-- AUTODOC:END -->
