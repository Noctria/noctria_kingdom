flowchart TD

%% --- 1. GUI/API/外部連携（最上段） ---
subgraph GUI_API["GUI・API・外部連携"]
  direction TB
  DASHBOARD["dashboard.py\n統治ダッシュボード"]
  PDCA_PANEL["pdca.py\nPDCA管理"]
  AI_PANEL["ai_routes.py\nAI一覧・詳細"]
  TRIGGER_PANEL["trigger.py\n王命/統治コマンド"]
  API["外部API/バッチ\n自動統治連携"]
end

%% --- 2. 中央統治AIクラスタ（王・臣下AI） ---
subgraph KINGDOM["中央統治AIクラスタ"]
  direction TB
  NOCTRIA["king_noctria.py\n王Noctria（最終意思決定AI）"]
  HERMES["hermes_cognitor.py\nHermes（LLM生成/説明AI）"]
  VERITAS["veritas_machina.py\nVeritas（ML評価AI）"]
  AURUS["aurus.py\n市場設計AI"]
  LEVIA["levia.py\n高速実行AI"]
  NOCTUS["noctus.py\nリスク管理AI"]
  PROMETHEUS["prometheus.py\n未来予測AI"]
end

%% --- 3. Airflow DAG Cluster（実行基盤） ---
subgraph DAGS["Airflow DAG群"]
  direction TB
  GEN_DAG["veritas_generate_dag.py\n戦略生成DAG"]
  EVAL_DAG["veritas_eval_dag.py\n一括評価DAG"]
  RECHECK_DAG["veritas_recheck_dag.py\n再評価DAG"]
  ACT_DAG["veritas_act_record_dag.py\nAct記録DAG"]
  PUSH_DAG["veritas_push_dag.py\nPush採用DAG"]
  REPLAY_DAG["veritas_replay_dag.py\nReplay再現DAG"]
end

%% --- 4. データ/ログ/サマリ層（下段） ---
subgraph DATA["データ・ログ・サマリ層"]
  direction TB
  STRATEGY_JSON["hermes_generated\nHermes戦略json"]
  EVALRES_JSON["data/stats/*.json\n評価結果json"]
  ACTLOG_JSON["act_logs/adopted\n採用ログjson"]
  RECHECK_JSON["act_logs/rechecked\n再評価ログ"]
  REPLAY_JSON["act_logs/replayed\n再送ログ"]
  PLAN_SUMMARY_JSON["pdca_plan_summary.json\nPlanサマリ"]
  ORACLE_FORECAST_JSON["oracle_forecast.json\n未来予測json"]
end

%% --- 5. Plan Data & LLM API層（最下段・左側） ---
subgraph PLAN_LLM["分析・プロンプト・LLM API"]
  direction TB
  PLAN_COLLECT["plan_data/collector.py\nデータ収集"]
  PLAN_FEATURE["plan_data/features.py\n特徴量生成"]
  PLAN_STAT["plan_data/statistics.py\n指標/集計"]
  PLAN_ANALYZER["plan_data/analyzer.py\n要因分析"]
  PLAN_ANOMALY["plan_data/anomaly_detector.py\n異常検知"]
  LLM_PROMPT["llm/llm_prompt_builder.py\nプロンプト生成"]
  LLM_EVALAPI["llm/veritas_eval_api.py\n評価API"]
  PLAN_PDCA_BATCH["plan_data/run_pdca_plan_workflow.py\nPDCAバッチ"]
end

%% === レイヤー間接続（上→下順に整理） ===

%% 1. GUI/API層→中央統治AI
DASHBOARD --> NOCTRIA
PDCA_PANEL --> NOCTRIA
AI_PANEL --> NOCTRIA
TRIGGER_PANEL --> NOCTRIA
API --> NOCTRIA

%% 2. Noctria王→臣下AI
NOCTRIA --> HERMES
NOCTRIA --> VERITAS
NOCTRIA --> AURUS
NOCTRIA --> LEVIA
NOCTRIA --> NOCTUS
NOCTRIA --> PROMETHEUS

%% 3. 各AI→DAG
HERMES --> GEN_DAG
VERITAS --> EVAL_DAG
VERITAS --> RECHECK_DAG
NOCTRIA --> RECHECK_DAG
NOCTRIA --> REPLAY_DAG
NOCTRIA --> PUSH_DAG
AURUS --> GEN_DAG
AURUS --> EVAL_DAG
LEVIA --> GEN_DAG
LEVIA --> EVAL_DAG
NOCTUS --> GEN_DAG
NOCTUS --> EVAL_DAG
PROMETHEUS --> GEN_DAG
PROMETHEUS --> EVAL_DAG

%% 4. DAG→データ層
GEN_DAG --> STRATEGY_JSON
EVAL_DAG --> EVALRES_JSON
RECHECK_DAG --> RECHECK_JSON
ACT_DAG --> ACTLOG_JSON
PUSH_DAG --> ACTLOG_JSON
REPLAY_DAG --> REPLAY_JSON

%% 5. データ層→王・GUI
STRATEGY_JSON --> NOCTRIA
EVALRES_JSON --> NOCTRIA
RECHECK_JSON --> NOCTRIA
ACTLOG_JSON --> NOCTRIA
REPLAY_JSON --> NOCTRIA
PLAN_SUMMARY_JSON --> DASHBOARD
ORACLE_FORECAST_JSON --> NOCTRIA

%% 6. Plan Data & LLM連携
PLAN_COLLECT --> PLAN_FEATURE
PLAN_FEATURE --> PLAN_STAT
PLAN_STAT --> PLAN_ANALYZER
PLAN_STAT --> PLAN_ANOMALY
PLAN_ANALYZER --> LLM_PROMPT
PLAN_ANOMALY --> LLM_PROMPT
LLM_PROMPT --> HERMES
LLM_EVALAPI --> VERITAS
PLAN_PDCA_BATCH --> PLAN_SUMMARY_JSON

%% 7. PROMETHEUS→未来予測json
PROMETHEUS --> ORACLE_FORECAST_JSON

%% 8. Noctria統治履歴→ダッシュボード
NOCTRIA -- 統治履歴/全意思決定 --> DASHBOARD
NOCTRIA -- 統治履歴/全意思決定 --> PDCA_PANEL
