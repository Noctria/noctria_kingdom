flowchart TD 

%% --- Veritas PDCA/Replayãƒ©ã‚¤ãƒ³ï¼ˆMaster DAGå®Œå…¨å‰Šé™¤ï¼‰ ---
subgraph Veritas_Master[Veritas PDCA/Replayãƒ©ã‚¤ãƒ³]
  VPDCA["veritas_pdca_dag.py<br>ğŸ” PDCAè‡ªå‹•ãƒ«ãƒ¼ãƒ—"]
  VG["veritas_generate_dag.py<br>ğŸ”¨ æˆ¦ç•¥ç”Ÿæˆ"]
  VE["veritas_eval_dag.py<br>ğŸ“ æˆ¦ç•¥ä¸€æ‹¬è©•ä¾¡"]
  VA["veritas_act_record_dag.py<br>ğŸ—’ï¸ Actï¼ˆæ¡ç”¨ï¼‰è¨˜éŒ²"]
  VS["veritas_eval_single_dag.py<br>ğŸ•¹ï¸ å˜ä½“å†è©•ä¾¡"]
  VR["veritas_recheck_dag.py<br>ğŸ” æˆ¦ç•¥å†è©•ä¾¡"]
  VPUSH["veritas_push_dag.py<br>â¬†ï¸ æˆ¦ç•¥Push"]
  VREPLAY["veritas_replay_dag.py<br>ğŸ” ãƒ­ã‚°ã‹ã‚‰å†é€"]
end

%% --- Kingdom AIå±¤ ---
subgraph Kingdomçµ±æ²»AI[Noctria Kingdom çµ±æ²»å±¤]
  RC["noctria_kingdom_royal_council_dag.py<br>ğŸ‘‘ å¾¡å‰ä¼šè­°DAG"]
  KING["king_noctria.py<br>çµ±åˆAI"]
end

%% --- ã‚¹ãƒˆãƒ©ãƒ†ã‚¸AI/DAGç¾¤ ---
subgraph æˆ¦ç•¥AIç¾¤[å„æˆ¦ç•¥AIãƒ»æœªæ¥äºˆæ¸¬ãƒ»ãƒªã‚¹ã‚¯DAG]
  PA["prometheus_strategy_dag.py<br>ğŸ”® æœªæ¥äºˆæ¸¬"]
  AA["aurus_strategy_dag.py<br>ğŸ¯ ç·åˆåˆ†æ"]
  LA["levia_strategy_dag.py<br>âš¡ ã‚¹ã‚­ãƒ£ãƒ«ãƒ”ãƒ³ã‚°"]
  NA["noctus_strategy_dag.py<br>ğŸ›¡ï¸ ãƒªã‚¹ã‚¯è©•ä¾¡"]
end

%% --- LLMå±¤ ---
subgraph LLMå±¤[Noctria LLMå±¤]
  LLM_MAIN["main.py<br>ğŸšª LLMã‚µãƒ¼ãƒï¼ˆè©•ä¾¡APIï¼‰"]
  LLM_SERVER["veritas_llm_server.py<br>ğŸ§  LLMç”Ÿæˆã‚µãƒ¼ãƒ"]
  LLM_PROMPT["llm_prompt_builder.py<br>ğŸ“œ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ“ãƒ«ãƒ€ãƒ¼"]
  LLM_EVALAPI["veritas_eval_api.py<br>ğŸ“„ è©•ä¾¡ãƒ­ã‚°API"]
end

%% --- Plan Dataå±¤ï¼ˆåˆ†é›¢æ§‹æˆåæ˜ +Airflowå®šæ™‚ãƒãƒƒãƒè¿½åŠ ï¼‰---
subgraph PlanData["src/plan_dataï¼ˆPDCA-Planæ ¹æ‹ /åˆ†æã‚¯ãƒ©ã‚¹ã‚¿ï¼‰"]
  PLAN_COLLECT["collector.py<br>ãƒ‡ãƒ¼ã‚¿åé›†ãƒ»çµ±åˆ"]
  PLAN_FEATURE["features.py<br>ç‰¹å¾´é‡ç”Ÿæˆ"]
  PLAN_STAT["statistics.py<br>æŒ‡æ¨™/é›†è¨ˆ"]
  PLAN_ANALYZER["analyzer.py<br>è¦å› åˆ†æãƒ»ç‰¹å¾´æŠ½å‡º"]
  PLAN_PROMPT["llm_plan_prompt.py<br>LLMç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ"]
  PLAN_ANOMALY["anomaly_detector.py<br>ç•°å¸¸æ¤œçŸ¥"]
  PLAN_PDCA_DAG["pdca_plan_summary_dag.py<br>ğŸ—“ï¸ PDCA-Planã‚µãƒãƒªãƒ¼<br>Airflowå®šæ™‚ãƒãƒƒãƒ"]
  PLAN_PDCA_BATCH["run_pdca_plan_workflow.py<br>ğŸ› ï¸ ã‚µãƒãƒªãƒ¼è‡ªå‹•ç”Ÿæˆãƒãƒƒãƒ"]
end

%% --- GUI/APIå±¤ ---
subgraph GUI_API[GUIãƒ»APIãƒ»å¤–éƒ¨é€£æº]
  GUI["FastAPI/Streamlit<br>ğŸ–¥ï¸ GUIãƒ»REST API<br><u>src/core/dag_trigger.py<br>Airflow DAGãƒˆãƒªã‚¬ãƒ¼é€£æº</u>"]
  API["å¤–éƒ¨APIãƒˆãƒªã‚¬ãƒ¼<br>ğŸ”— API Endpoint"]
end

%% --- ãƒ‡ãƒ¼ã‚¿ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«å±¤ ---
subgraph DATA["ãƒ‡ãƒ¼ã‚¿/æˆæœç‰©ã‚¹ãƒˆã‚¢"]
  GIT["GitHub<br>ğŸ“¦ æˆ¦ç•¥ãƒªãƒã‚¸ãƒˆãƒª"]
  ACTLOG["PDCA/Actãƒ­ã‚°<br>ğŸ“œ"]
  STRATJSON["æˆ¦ç•¥ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤<br>ğŸ—‚ï¸"]
  EVALRES["è©•ä¾¡çµæœ<br>ğŸ“Š"]
  PLAN_SUMMARY_JSON["pdca_plan_summary.json<br>ğŸ“ Planã‚µãƒãƒªãƒ¼"]
end

%% --- Master/PDCA/Replayãƒ•ãƒ­ãƒ¼ ---
VPDCA -- "æˆ¦ç•¥ç”Ÿæˆ" --> VG
VPDCA -- "è©•ä¾¡" --> VE
VPDCA -- "æ¡ç”¨è¨˜éŒ²" --> VA
VPDCA -- "GitHubPush" --> VPUSH

%% --- Veritasè©•ä¾¡å¾Œã®æµã‚Œ ---
VG -- "æˆ¦ç•¥ãƒ•ã‚¡ã‚¤ãƒ«" --> STRATJSON
STRATJSON -- "è©•ä¾¡å¯¾è±¡" --> VE
VE -- "è©•ä¾¡æ¸ˆæˆ¦ç•¥" --> EVALRES
EVALRES -- "è©•ä¾¡çµæœ" --> VA
VA -- "æ¡ç”¨æˆ¦ç•¥æƒ…å ±" --> ACTLOG
ACTLOG -- "Act/å±¥æ­´" --> RC
VA -- "Pushè¦æ±‚" --> VPUSH
VPUSH -- "GitHubã‚³ãƒŸãƒƒãƒˆ" --> GIT
GIT -- "ãƒªãƒã‚¸ãƒˆãƒªçŠ¶æ…‹" --> RC

%% --- Actãƒ­ã‚°/PDCAå±¥æ­´ã‚‚å¾¡å‰ä¼šè­°ã¸ -->
VS -- "å†è©•ä¾¡æƒ…å ±" --> ACTLOG
VR -- "å†è©•ä¾¡æƒ…å ±" --> ACTLOG

%% --- å†é€DAGã®æµã‚Œï¼ˆReplayï¼‰ ---
VREPLAY -- "PDCAãƒ­ã‚°ã‹ã‚‰å†é€å‘½ä»¤" --> ACTLOG

%% --- å¾¡å‰ä¼šè­°/çµ±åˆAIãƒ•ãƒ­ãƒ¼ ---
RC --> KING

%% --- ã‚¹ãƒˆãƒ©ãƒ†ã‚¸AIç¾¤ã¨çµ±åˆAIã®é€£æºã‚¤ãƒ¡ãƒ¼ã‚¸ ---
KING -- "æˆ¦ç•¥åˆ¤æ–­/æœ€çµ‚æ„æ€æ±ºå®š" --> PA
KING -- "æˆ¦ç•¥åˆ¤æ–­/æœ€çµ‚æ„æ€æ±ºå®š" --> AA
KING -- "æˆ¦ç•¥åˆ¤æ–­/æœ€çµ‚æ„æ€æ±ºå®š" --> LA
KING -- "æˆ¦ç•¥åˆ¤æ–­/æœ€çµ‚æ„æ€æ±ºå®š" --> NA

%% --- GUIâ‡”PDCAé€£æº --- 
GUI -- "DAGãƒˆãƒªã‚¬/å¯è¦–åŒ–" --> VPDCA
API -- "ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å…¥åŠ›" --> VPDCA

%% --- GUIãƒ»APIâ‡”æˆæœç‰© ---
GUI -- "å±¥æ­´DL/CSV" --> ACTLOG
GUI -- "è©•ä¾¡ãƒ‡ãƒ¼ã‚¿é–²è¦§" --> EVALRES

%% --- LLMå±¤é€£æº ---
LLM_SERVER -- "ãƒ†ãƒ³ãƒ—ãƒ¬èª­è¾¼" --> LLM_PROMPT
VG -- "æˆ¦ç•¥ç”ŸæˆæŒ‡ç¤º<br>/generate" --> LLM_SERVER
GUI -- "æˆ¦ç•¥è‡ªå‹•ç”Ÿæˆ<br>/generate" --> LLM_SERVER
LLM_SERVER -- "ç”Ÿæˆçµæœ" --> VG
LLM_EVALAPI -- "è©•ä¾¡ãƒ­ã‚°API<br>/veritas/eval_logs" --> LLM_MAIN
LLM_MAIN -- "è©•ä¾¡ãƒ­ã‚°å–å¾—" --> GUI
LLM_MAIN -- "veritas_eval_result.json" --- EVALRES
LLM_EVALAPI -- "veritas_eval_result.json" --- EVALRES

%% --- PlanDataå±¤é€£æºï¼ˆåˆ†é›¢æ§‹æˆ+Airflowå®šæ™‚ãƒãƒƒãƒï¼‰---
PLAN_COLLECT -- "ç”Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆæ™‚ç³»åˆ—DFï¼‰" --> PLAN_FEATURE
PLAN_FEATURE -- "ç‰¹å¾´é‡ä»˜ä¸DF" --> PLAN_STAT
PLAN_STAT -- "åˆ†æçµæœ" --> PLAN_ANALYZER
PLAN_ANALYZER -- "è¦å› æŠ½å‡º/ç‰¹å¾´åˆ†æ" --> PLAN_PROMPT
PLAN_STAT -- "ç•°å¸¸å€¤ãƒ»ãƒ‰ãƒªãƒ•ãƒˆåˆ†æ" --> PLAN_ANOMALY
PLAN_ANOMALY -- "ç•°å¸¸/é€¸è„±æƒ…å ±" --> PLAN_PROMPT

%% --- PDCA-Planã‚µãƒãƒªãƒ¼è‡ªå‹•ç”Ÿæˆï¼ˆAirflow/ãƒãƒƒãƒï¼‰ ---
PLAN_PDCA_DAG -- "run_pdca_plan_workflow.pyå®Ÿè¡Œ" --> PLAN_PDCA_BATCH
PLAN_PDCA_BATCH -- "Planã‚µãƒãƒªãƒ¼å‡ºåŠ›" --> PLAN_SUMMARY_JSON
PLAN_SUMMARY_JSON -- "å¯è¦–åŒ–/åˆ†æ" --> GUI

%% --- ä¾å­˜ï¼ˆç‚¹ç·šï¼‰ ---
LLM_SERVER -.-> LLM_PROMPT

classDef pdca fill:#f9f9cc,stroke:#e9c900,stroke-width:2px;
class VPDCA,VPUSH,VR,VREPLAY pdca;

classDef gui fill:#d8eafd,stroke:#2c6faa,stroke-width:2px;
class GUI,API gui;

classDef data fill:#e2ffd8,stroke:#09a509,stroke-width:1.5px;
class GIT,ACTLOG,STRATJSON,EVALRES,PLAN_SUMMARY_JSON data;

classDef llm fill:#f1e8ff,stroke:#9651ed,stroke-width:2px;
class LLM_MAIN,LLM_SERVER,LLM_PROMPT,LLM_EVALAPI llm;
