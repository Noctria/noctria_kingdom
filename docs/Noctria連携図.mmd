flowchart TD

%% =======================
%% Kingdomãƒ»AIãƒ»DAGå…¨ä½“å±¤
%% =======================

subgraph Kingdomçµ±æ²»AI[Noctria Kingdom çµ±æ²»å±¤]
  RC["noctria_kingdom_royal_council_dag.py<br>ğŸ‘‘ å¾¡å‰ä¼šè­°DAG"]
  KING["king_noctria.py<br>çµ±åˆAI"]
end

subgraph æˆ¦ç•¥AIç¾¤[å„æˆ¦ç•¥AIãƒ»æœªæ¥äºˆæ¸¬ãƒ»ãƒªã‚¹ã‚¯DAG]
  PA["prometheus_strategy_dag.py<br>ğŸ”® æœªæ¥äºˆæ¸¬"]
  AA["aurus_strategy_dag.py<br>ğŸ¯ ç·åˆåˆ†æ"]
  LA["levia_strategy_dag.py<br>âš¡ ã‚¹ã‚­ãƒ£ãƒ«ãƒ”ãƒ³ã‚°"]
  NA["noctus_strategy_dag.py<br>ğŸ›¡ï¸ ãƒªã‚¹ã‚¯è©•ä¾¡"]
  HA["hermes_strategy_dag.py<br>ğŸ¦‰ LLMæ ¹æ‹ èª¬æ˜"]
end

%% -------- PDCA/Replay/Actãƒ©ã‚¤ãƒ³ --------
subgraph Veritas_Master[Veritas PDCA/Replayãƒ©ã‚¤ãƒ³]
  VPDCA["veritas_pdca_dag.py<br>ğŸ” PDCAè‡ªå‹•ãƒ«ãƒ¼ãƒ—"]
  VG["veritas_generate_dag.py<br>ğŸ”¨ æˆ¦ç•¥ç”Ÿæˆ"]
  VE["veritas_eval_dag.py<br>ğŸ“ æˆ¦ç•¥ä¸€æ‹¬è©•ä¾¡"]
  VA["veritas_act_record_dag.py<br>ğŸ—’ï¸ Actï¼ˆæ¡ç”¨ï¼‰è¨˜éŒ²"]
  VS["veritas_eval_single_dag.py<br>ğŸ•¹ï¸ å˜ä½“å†è©•ä¾¡"]
  VR["veritas_recheck_dag.py<br>ğŸ” æˆ¦ç•¥å†è©•ä¾¡"]
  VPUSH["veritas_push_dag.py<br>â¬†ï¸ æˆ¦ç•¥Push"]
  VREPLAY["veritas_replay_dag.py<br>ğŸ” ãƒ­ã‚°ã‹ã‚‰å†é€"]
end

%% -------- Hermes LLMå±¤ --------
subgraph Hermes_LLM[Hermes Cognitor LLMç”Ÿæˆå±¤]
  HGEN["src/hermes/strategy_generator.py<br>ğŸ¦‰ LLMæˆ¦ç•¥ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ"]
end

subgraph LLMå±¤[Noctria LLMå±¤]
  LLM_MAIN["main.py<br>ğŸšª LLMã‚µãƒ¼ãƒï¼ˆè©•ä¾¡APIï¼‰"]
  LLM_SERVER["veritas_llm_server.py<br>ğŸ§  LLMç”Ÿæˆã‚µãƒ¼ãƒ"]
  LLM_PROMPT["llm_prompt_builder.py<br>ğŸ“œ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ“ãƒ«ãƒ€ãƒ¼"]
  LLM_EVALAPI["veritas_eval_api.py<br>ğŸ“„ è©•ä¾¡ãƒ­ã‚°API"]
end

%% -------- PlanDataå±¤ --------
subgraph PlanData["src/plan_dataï¼ˆPDCA-Planæ ¹æ‹ /åˆ†æã‚¯ãƒ©ã‚¹ã‚¿ï¼‰"]
  PLAN_COLLECT["collector.py<br>ãƒ‡ãƒ¼ã‚¿åé›†ãƒ»çµ±åˆ"]
  PLAN_FEATURE["features.py<br>ç‰¹å¾´é‡ç”Ÿæˆ"]
  PLAN_STAT["statistics.py<br>æŒ‡æ¨™/é›†è¨ˆ"]
  PLAN_ANALYZER["analyzer.py<br>è¦å› åˆ†æãƒ»ç‰¹å¾´æŠ½å‡º"]
  PLAN_PROMPT["llm_plan_prompt.py<br>LLMç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ"]
  PLAN_ANOMALY["anomaly_detector.py<br>ç•°å¸¸æ¤œçŸ¥"]
  PLAN_PDCA_DAG["pdca_plan_summary_dag.py<br>ğŸ—“ï¸ PDCA-Planã‚µãƒãƒªãƒ¼<br>Airflowå®šæ™‚ãƒãƒƒãƒ"]
  PLAN_PDCA_BATCH["run_pdca_plan_workflow.py<br>ğŸ› ï¸ ã‚µãƒãƒªãƒ¼è‡ªå‹•ç”Ÿæˆãƒãƒƒãƒ"]
end

%% -------- ãƒ‡ãƒ¼ã‚¿/æˆæœç‰©å±¤ --------
subgraph DATA["ãƒ‡ãƒ¼ã‚¿/æˆæœç‰©ã‚¹ãƒˆã‚¢"]
  GIT["GitHub<br>ğŸ“¦ æˆ¦ç•¥ãƒªãƒã‚¸ãƒˆãƒª"]
  ACTLOG["PDCA/Actãƒ­ã‚°<br>ğŸ“œ"]
  STRATJSON["æˆ¦ç•¥ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤<br>ğŸ—‚ï¸"]
  HERMES_STRAT["hermes_generated<br>ğŸ¦‰ Hermesæˆ¦ç•¥ç¾¤"]
  EVALRES["è©•ä¾¡çµæœ<br>ğŸ“Š"]
  PLAN_SUMMARY_JSON["pdca_plan_summary.json<br>ğŸ“ Planã‚µãƒãƒªãƒ¼"]
end

%% ========================
%% GUI + APIå±¤ (FastAPI)
%% ========================

subgraph GUI_Main["noctria_gui/main.py<br>ğŸ–¥ï¸ ä¸­æ¢GUIãƒ«ãƒ¼ãƒˆçµ±åˆ"]
  direction TB
  HOME["home_routes -> home.html"]
  DASHBOARD["dashboard -> dashboard.html"]
  KINGHIST["king_routes -> king_history.html"]
  TRIGGER["trigger -> trigger.html"]
  UPLOAD["upload -> upload_strategy.html"]
  UPLOAD_HISTORY["upload_history -> upload_history.html"]
  ACT_HISTORY["act_history -> act_history.html"]
  ACT_HISTORY_DETAIL["act_history_detail -> act_history_detail.html"]
  LOGS["logs_routes -> logs_dashboard.html"]
  PDCA["pdca -> pdca_dashboard.html"]
  PDCA_RECHECK["pdca_recheck -> pdca_history.html"]
  PDCA_ROUTES["pdca_routes"]
  PDCA_SUMMARY["pdca_summary"]
  PUSH["push"]
  STRATEGY_ROUTES["strategy_routes -> strategy_compare.html"]
  STRATEGY_DETAIL["strategy_detail -> strategy_detail.html"]
  STRATEGY_HEATMAP["strategy_heatmap -> strategy_heatmap.html"]
  STAT_DETAIL["statistics_detail -> statistics_detail.html"]
  STAT_RANKING["statistics_ranking -> statistics_ranking.html"]
  STAT_SCOREBOARD["statistics_scoreboard -> statistics_scoreboard.html"]
  STAT_TAG_RANKING["statistics_tag_ranking -> statistics_tag_ranking.html"]
  STAT_COMPARE["statistics_compare -> statistics_compare.html"]
  TAG_SUMMARY["tag_summary -> tag_summary.html"]
  TAG_SUMMARY_DETAIL["tag_summary_detail -> tag_summary_detail.html"]
  TAG_HEATMAP["tag_heatmap -> tag_heatmap.html"]
  PATH_CHECKER["path_checker"]
  PROMETHEUS_ROUTES["prometheus_routes"]
  HERMES["hermes.py<br>Hermes LLMæˆ¦ç•¥API"]
end

subgraph Services["noctria_gui/services<br>å„ç¨®ã‚µãƒ¼ãƒãƒ­ã‚¸ãƒƒã‚¯"]
  direction TB
  ACT_LOG_SERVICE["act_log_service.py"]
  DASHBOARD_SERVICE["dashboard_service.py"]
  PUSH_HISTORY_SERVICE["push_history_service.py"]
  STATISTICS_SERVICE["statistics_service.py"]
  STRATEGY_HANDLER["strategy_handler.py"]
  TAG_SUMMARY_SERVICE["tag_summary_service.py"]
  UPLOAD_ACTIONS["upload_actions.py"]
end

%% ========================
%% GUI Main <-> å„ãƒ«ãƒ¼ãƒˆé€£æº
%% ========================
GUI_Main -->|include_router| HOME
GUI_Main --> DASHBOARD
GUI_Main --> KINGHIST
GUI_Main --> TRIGGER
GUI_Main --> UPLOAD
GUI_Main --> UPLOAD_HISTORY
GUI_Main --> ACT_HISTORY
GUI_Main --> ACT_HISTORY_DETAIL
GUI_Main --> LOGS
GUI_Main --> PDCA
GUI_Main --> PDCA_RECHECK
GUI_Main --> PDCA_ROUTES
GUI_Main --> PDCA_SUMMARY
GUI_Main --> PUSH
GUI_Main --> STRATEGY_ROUTES
GUI_Main --> STRATEGY_DETAIL
GUI_Main --> STRATEGY_HEATMAP
GUI_Main --> STAT_DETAIL
GUI_Main --> STAT_RANKING
GUI_Main --> STAT_SCOREBOARD
GUI_Main --> STAT_TAG_RANKING
GUI_Main --> STAT_COMPARE
GUI_Main --> TAG_SUMMARY
GUI_Main --> TAG_SUMMARY_DETAIL
GUI_Main --> TAG_HEATMAP
GUI_Main --> PATH_CHECKER
GUI_Main --> PROMETHEUS_ROUTES
GUI_Main --> HERMES

%% ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨é–¢ä¿‚
ACT_HISTORY --> ACT_LOG_SERVICE
ACT_HISTORY_DETAIL --> ACT_LOG_SERVICE
PDCA --> ACT_LOG_SERVICE
PDCA_RECHECK --> ACT_LOG_SERVICE
PDCA_ROUTES --> ACT_LOG_SERVICE
PDCA_SUMMARY --> ACT_LOG_SERVICE

DASHBOARD --> DASHBOARD_SERVICE
PUSH --> PUSH_HISTORY_SERVICE
STAT_DETAIL --> STATISTICS_SERVICE
STAT_RANKING --> STATISTICS_SERVICE
STAT_SCOREBOARD --> STATISTICS_SERVICE
STAT_TAG_RANKING --> STATISTICS_SERVICE
STAT_COMPARE --> STATISTICS_SERVICE
TAG_SUMMARY --> TAG_SUMMARY_SERVICE
TAG_SUMMARY_DETAIL --> TAG_SUMMARY_SERVICE
TAG_HEATMAP --> TAG_SUMMARY_SERVICE
UPLOAD --> STRATEGY_HANDLER
UPLOAD_HISTORY --> UPLOAD_ACTIONS
STRATEGY_ROUTES --> STRATEGY_HANDLER

%% æˆ¦ç•¥é–¢é€£ Routes
STRATEGY_ROUTES --> STRATEGY_DETAIL
STRATEGY_ROUTES --> STRATEGY_HEATMAP

%% GUIã®DAGãƒˆãƒªã‚¬ãƒ¼é€£æº
TRIGGER -.-> src_core_dag_trigger["src/core/dag_trigger.py<br>Airflow DAGä¸€è¦§å–å¾—ãƒ»DAGãƒˆãƒªã‚¬ãƒ¼é€£æº"]
src_core_dag_trigger --> PDCA

%% ========================
%% ã‚¯ãƒ­ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼/é€£æºãƒ©ã‚¤ãƒ³
%% ========================

%% Master/PDCA/Replayãƒ•ãƒ­ãƒ¼
VPDCA -- "æˆ¦ç•¥ç”Ÿæˆ" --> VG
VPDCA -- "è©•ä¾¡" --> VE
VPDCA -- "æ¡ç”¨è¨˜éŒ²" --> VA
VPDCA -- "GitHubPush" --> VPUSH

VG -- "æˆ¦ç•¥ãƒ•ã‚¡ã‚¤ãƒ«" --> STRATJSON
STRATJSON -- "è©•ä¾¡å¯¾è±¡" --> VE
VE -- "è©•ä¾¡æ¸ˆæˆ¦ç•¥" --> EVALRES
EVALRES -- "è©•ä¾¡çµæœ" --> VA
VA -- "æ¡ç”¨æˆ¦ç•¥æƒ…å ±" --> ACTLOG
ACTLOG -- "Act/å±¥æ­´" --> RC
VA -- "Pushè¦æ±‚" --> VPUSH
VPUSH -- "GitHubã‚³ãƒŸãƒƒãƒˆ" --> GIT
GIT -- "ãƒªãƒã‚¸ãƒˆãƒªçŠ¶æ…‹" --> RC

VS -- "å†è©•ä¾¡æƒ…å ±" --> ACTLOG
VR -- "å†è©•ä¾¡æƒ…å ±" --> ACTLOG
VREPLAY -- "PDCAãƒ­ã‚°ã‹ã‚‰å†é€å‘½ä»¤" --> ACTLOG

RC --> KING

KING -- "æˆ¦ç•¥åˆ¤æ–­/æœ€çµ‚æ„æ€æ±ºå®š" --> PA
KING -- "æˆ¦ç•¥åˆ¤æ–­/æœ€çµ‚æ„æ€æ±ºå®š" --> AA
KING -- "æˆ¦ç•¥åˆ¤æ–­/æœ€çµ‚æ„æ€æ±ºå®š" --> LA
KING -- "æˆ¦ç•¥åˆ¤æ–­/æœ€çµ‚æ„æ€æ±ºå®š" --> NA
KING -- "æ ¹æ‹ èª¬æ˜/è‡ªç„¶è¨€èªåŒ–" --> HA

HGEN -- "ç”Ÿæˆæˆ¦ç•¥ãƒ•ã‚¡ã‚¤ãƒ«" --> HERMES_STRAT
HGEN -- "èª¬æ˜/ãƒŠãƒ©ãƒ†ã‚£ãƒ–" --> HA

HERMES -- "APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ" --> HGEN

%% GUIâ‡”PDCAé€£æº
DASHBOARD -- "PDCAèµ·å‹•ãƒ»çµæœè¡¨ç¤º" --> VPDCA
TRIGGER -- "DAGé¸æŠ/ç™ºä»¤" --> VPDCA
HERMES -- "æˆ¦ç•¥ç”ŸæˆAPI" --> HGEN

%% GUIãƒ»APIâ‡”æˆæœç‰©
DASHBOARD -- "å±¥æ­´DL/CSV" --> ACTLOG
DASHBOARD -- "è©•ä¾¡ãƒ‡ãƒ¼ã‚¿é–²è¦§" --> EVALRES

%% LLMå±¤é€£æº
LLM_SERVER -- "ãƒ†ãƒ³ãƒ—ãƒ¬èª­è¾¼" --> LLM_PROMPT
VG -- "æˆ¦ç•¥ç”ŸæˆæŒ‡ç¤º<br>/generate" --> LLM_SERVER
DASHBOARD -- "æˆ¦ç•¥è‡ªå‹•ç”Ÿæˆ<br>/generate" --> LLM_SERVER
LLM_SERVER -- "ç”Ÿæˆçµæœ" --> VG
LLM_EVALAPI -- "è©•ä¾¡ãƒ­ã‚°API<br>/veritas/eval_logs" --> LLM_MAIN
LLM_MAIN -- "è©•ä¾¡ãƒ­ã‚°å–å¾—" --> DASHBOARD
LLM_MAIN -- "veritas_eval_result.json" --- EVALRES
LLM_EVALAPI -- "veritas_eval_result.json" --- EVALRES

%% PlanDataå±¤é€£æº
PLAN_COLLECT -- "ç”Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆæ™‚ç³»åˆ—DFï¼‰" --> PLAN_FEATURE
PLAN_FEATURE -- "ç‰¹å¾´é‡ä»˜ä¸DF" --> PLAN_STAT
PLAN_STAT -- "åˆ†æçµæœ" --> PLAN_ANALYZER
PLAN_ANALYZER -- "è¦å› æŠ½å‡º/ç‰¹å¾´åˆ†æ" --> PLAN_PROMPT
PLAN_STAT -- "ç•°å¸¸å€¤ãƒ»ãƒ‰ãƒªãƒ•ãƒˆåˆ†æ" --> PLAN_ANOMALY
PLAN_ANOMALY -- "ç•°å¸¸/é€¸è„±æƒ…å ±" --> PLAN_PROMPT

%% PDCA-Planã‚µãƒãƒªãƒ¼è‡ªå‹•ç”Ÿæˆ
PLAN_PDCA_DAG -- "run_pdca_plan_workflow.pyå®Ÿè¡Œ" --> PLAN_PDCA_BATCH
PLAN_PDCA_BATCH -- "Planã‚µãƒãƒªãƒ¼å‡ºåŠ›" --> PLAN_SUMMARY_JSON
PLAN_SUMMARY_JSON -- "å¯è¦–åŒ–/åˆ†æ" --> DASHBOARD

%% ========================
%% ã‚¯ãƒ©ã‚¹å®šç¾©ãƒ»è‰²åˆ†ã‘
%% ========================
classDef pdca fill:#f9f9cc,stroke:#e9c900,stroke-width:2px;
class VPDCA,VPUSH,VR,VREPLAY pdca;

classDef gui fill:#d8eafd,stroke:#2c6faa,stroke-width:2px;
class GUI_Main,HOME,DASHBOARD,KINGHIST,TRIGGER,UPLOAD,UPLOAD_HISTORY,ACT_HISTORY,ACT_HISTORY_DETAIL,LOGS,PDCA,PDCA_RECHECK,PDCA_ROUTES,PDCA_SUMMARY,PUSH,STRATEGY_ROUTES,STRATEGY_DETAIL,STRATEGY_HEATMAP,STAT_DETAIL,STAT_RANKING,STAT_SCOREBOARD,STAT_TAG_RANKING,STAT_COMPARE,TAG_SUMMARY,TAG_SUMMARY_DETAIL,TAG_HEATMAP,PATH_CHECKER,PROMETHEUS_ROUTES,HERMES gui;

classDef services fill:#f6fff4,stroke:#49c972,stroke-width:1.5px;
class ACT_LOG_SERVICE,DASHBOARD_SERVICE,PUSH_HISTORY_SERVICE,STATISTICS_SERVICE,STRATEGY_HANDLER,TAG_SUMMARY_SERVICE,UPLOAD_ACTIONS services;

classDef data fill:#e2ffd8,stroke:#09a509,stroke-width:1.5px;
class GIT,ACTLOG,STRATJSON,HERMES_STRAT,EVALRES,PLAN_SUMMARY_JSON data;

classDef llm fill:#f1e8ff,stroke:#9651ed,stroke-width:2px;
class LLM_MAIN,LLM_SERVER,LLM_PROMPT,LLM_EVALAPI llm;

classDef hermes fill:#e1f4ff,stroke:#2d9fc2,stroke-width:2px;
class HA,HGEN,HERMES hermes;

