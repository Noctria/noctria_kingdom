flowchart TD

%% --- Plan層（計画・戦略立案） ---
subgraph P[Plan（計画・戦略立案）]
    PLAN_COLLECTOR["plan_data/collector.py<br>データ収集・集約"]
    PLAN_STATS["plan_data/statistics.py<br>KPI・統計算出"]
    PLAN_ANALYZER["plan_data/analyzer.py<br>特徴量・要因分析"]
    PLAN_WORKFLOW["plan_data/run_pdca_plan_workflow.py<br>Pワークフロー統合"]

    AURUS["strategies/aurus_singularis.py<br>市場総合分析AI"]
    VERITAS["strategies/veritas_machina.py<br>ML戦略生成・評価AI"]
    HERMES["strategies/hermes_cognitor.py<br>LLM説明・要約AI"]
    PROMETHEUS["strategies/prometheus_oracle.py<br>未来予測AI"]

    PLAN_COLLECTOR --> PLAN_STATS
    PLAN_STATS --> PLAN_ANALYZER
    PLAN_ANALYZER --> PLAN_WORKFLOW
    PLAN_WORKFLOW -->|features/labels/KPI| AURUS
    PLAN_WORKFLOW -->|features/labels/KPI| VERITAS
    PLAN_WORKFLOW -->|features/labels/KPI| HERMES
    PLAN_WORKFLOW -->|features/labels/KPI| PROMETHEUS
end

%% --- Do層（実行・意思決定） ---
subgraph D[Do（実行・売買シグナル）]
    LEVIA["strategies/levia_tempest.py<br>スキャルピングAI"]
    AURUS_DO["strategies/aurus_singularis.py<br>シグナル出力"]
end

%% --- Check層（リスク・監査） ---
subgraph C[Check（監査・リスク評価）]
    NOCTUS["strategies/noctus_sentinella.py<br>リスク評価・承認AI"]
end

%% --- Act層（改善・閾値修正・学習） ---
subgraph A[Act（改善・再評価）]
    ACT_PLACEHOLDER["（Act層: 閾値再設計・AI再学習等）"]
end

%% --- データ/情報フロー ---
AURUS -- シグナル/戦略提案 --> LEVIA
AURUS -- シグナル/戦略提案 --> AURUS_DO
VERITAS -- 戦略提案 --> AURUS_DO
PROMETHEUS -- 未来予測値 --> LEVIA
PROMETHEUS -- 未来予測値 --> AURUS_DO

LEVIA -- 行動案/市況 --> NOCTUS
AURUS_DO -- 行動案/市況 --> NOCTUS

NOCTUS -- 承認/警告/改善要請 --> ACT_PLACEHOLDER

ACT_PLACEHOLDER -- 閾値/モデル更新 --> PLAN_ANALYZER
ACT_PLACEHOLDER -- 閾値/モデル更新 --> AURUS
ACT_PLACEHOLDER -- 閾値/モデル更新 --> LEVIA

%% --- ノード色・フォント色調整 ---
style PLAN_COLLECTOR fill:#e0f2fe,stroke:#0284c7,stroke-width:2px,color:#1e293b
style PLAN_STATS fill:#e0f2fe,stroke:#0284c7,stroke-width:2px,color:#1e293b
style PLAN_ANALYZER fill:#fef9c3,stroke:#ca8a04,stroke-width:2px,color:#1e293b
style PLAN_WORKFLOW fill:#ede9fe,stroke:#7c3aed,stroke-width:2px,color:#1e293b

style AURUS fill:#38bdf8,stroke:#0ea5e9,stroke-width:2px,color:#fff
style VERITAS fill:#fbbf24,stroke:#f59e42,stroke-width:2px,color:#1e293b
style HERMES fill:#a78bfa,stroke:#6366f1,stroke-width:2px,color:#1e293b
style PROMETHEUS fill:#f9fafb,stroke:#3b82f6,stroke-width:2px,color:#0f172a

style LEVIA fill:#f3f4f6,stroke:#fbbf24,stroke-width:2px,color:#1e293b
style AURUS_DO fill:#38bdf8,stroke:#0ea5e9,stroke-width:2px,color:#fff

style NOCTUS fill:#fef2f2,stroke:#dc2626,stroke-width:2px,color:#1e293b

style ACT_PLACEHOLDER fill:#d1fae5,stroke:#059669,stroke-width:2px,color:#1e293b

%% --- サブグラフラベル色分け ---
style P fill:#f3e8ff,stroke:#8b5cf6,stroke-width:2px,color:#3b0764
style D fill:#f0fdfa,stroke:#34d399,stroke-width:2px,color:#065f46
style C fill:#fef2f2,stroke:#f87171,stroke-width:2px,color:#7f1d1d
style A fill:#f0fdf4,stroke:#4ade80,stroke-width:2px,color:#064e3b
