flowchart TD

%% --- Plan層（計画・分析・未来予測） ---
subgraph P[Plan（計画・戦略立案）]
    PLAN_COLLECTOR["plan_data/collector.py<br>データ収集・集約"]
    PLAN_STATS["plan_data/statistics.py<br>KPI・統計算出"]
    PLAN_ANALYZER["plan_data/analyzer.py<br>特徴量・要因分析"]
    PLAN_WORKFLOW["plan_data/run_pdca_plan_workflow.py<br>Pワークフロー統合"]

    AURUS["strategies/aurus_singularis.py<br>市場総合分析AI"]
    VERITAS["strategies/veritas_machina.py<br>ML戦略生成・評価AI"]
    HERMES["strategies/hermes_cognitor.py<br>LLM説明・要約AI"]
    PROMETHEUS["strategies/prometheus_oracle.py<br>未来予測AI"]

    PLAN_COLLECTOR --> PLAN_STATS
    PLAN_STATS --> PLAN_ANALYZER
    PLAN_ANALYZER --> PLAN_WORKFLOW
    PLAN_WORKFLOW -->|features/labels/KPI| AURUS
    PLAN_WORKFLOW -->|features/labels/KPI| VERITAS
    PLAN_WORKFLOW -->|features/labels/KPI| HERMES
    PLAN_WORKFLOW -->|features/labels/KPI| PROMETHEUS

    %% 各AIはPlan層のサブノードとして並列
end

%% --- Do層（実行・意思決定） ---
subgraph D[Do（実行・売買シグナル）]
    LEVIA["strategies/levia_tempest.py<br>スキャルピングAI"]
    AURUS_DO["strategies/aurus_singularis.py<br>シグナル出力"]
    %% PlanのAURUSとDoのAURUSを別ノードで示す（用途ごと）
end

%% --- Check層（リスク・監査） ---
subgraph C[Check（監査・リスク評価）]
    NOCTUS["strategies/noctus_sentinella.py<br>リスク評価・承認AI"]
end

%% --- Act層（改善・閾値修正・学習） ---
subgraph A[Act（改善・再評価）]
    %% Act層は今回は省略または今後設計
    ACT_PLACEHOLDER["（Act層: 閾値再設計・AI再学習等）"]
end

%% --- データ/情報フロー ---
%% PlanからDoへ（戦略シグナル・売買提案）
AURUS -- シグナル/戦略提案 --> LEVIA
AURUS -- シグナル/戦略提案 --> AURUS_DO
VERITAS -- 戦略提案 --> AURUS_DO
PROMETHEUS -- 未来予測値 --> LEVIA
PROMETHEUS -- 未来予測値 --> AURUS_DO

%% DoからCheckへ（行動案＋市場データ）
LEVIA -- 行動案/市況 --> NOCTUS
AURUS_DO -- 行動案/市況 --> NOCTUS

%% CheckからActへ（承認or警告）
NOCTUS -- 承認/警告/改善要請 --> ACT_PLACEHOLDER

%% ActからPlan/Do層へ（閾値修正・再学習）
ACT_PLACEHOLDER -- 閾値/モデル更新 --> PLAN_ANALYZER
ACT_PLACEHOLDER -- 閾値/モデル更新 --> AURUS
ACT_PLACEHOLDER -- 閾値/モデル更新 --> LEVIA

%% --- GUI/王Noctriaとの連携ノード（省略可） ---
%% 例: GUI/王がすべてのAIを統治・最終意思決定

style PLAN_COLLECTOR fill:#374151,stroke:#d1fae5,stroke-width:2px
style PLAN_STATS fill:#374151,stroke:#d1fae5,stroke-width:2px
style PLAN_ANALYZER fill:#374151,stroke:#d1fae5,stroke-width:2px
style PLAN_WORKFLOW fill:#1e293b,stroke:#7dd3fc,stroke-width:2px
style AURUS fill:#334155,stroke:#facc15,stroke-width:2px
style VERITAS fill:#334155,stroke:#f59e42,stroke-width:2px
style HERMES fill:#334155,stroke:#8b5cf6,stroke-width:2px
style PROMETHEUS fill:#334155,stroke:#38bdf8,stroke-width:2px
style LEVIA fill:#6d28d9,stroke:#fde68a,stroke-width:2px
style AURUS_DO fill:#334155,stroke:#facc15,stroke-width:2px
style NOCTUS fill:#64748b,stroke:#d1d5db,stroke-width:2px
style ACT_PLACEHOLDER fill:#a7f3d0,stroke:#475569,stroke-width:2px

%% --- サブグラフラベル色分け ---
style P fill:#172554,stroke:#f472b6,stroke-width:2px
style D fill:#f3f4f6,stroke:#a7f3d0,stroke-width:2px
style C fill:#e0e7ef,stroke:#f87171,stroke-width:2px
style A fill:#ecfeff,stroke:#38bdf8,stroke-width:2px
