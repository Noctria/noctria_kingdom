flowchart TD

  %% --- Plan層（計画・特徴量生成） ---
  subgraph Plan["🗺️ PLAN層: 市場分析・特徴量生成 (src/plan_data/)"]
    COLLECTOR["collector.py<br>🟩 データ収集<br>yfinance/FRED/ニュース/イベント"]
    FEATURES["features.py<br>🟦 テクニカル・マクロ特徴量生成"]
    STATISTICS["statistics.py<br>🟪 KPI集計/統計"]
    ANALYZER["analyzer.py<br>🟧 要因抽出・自然言語説明"]
    PLAN_WORKFLOW["run_pdca_plan_workflow.py<br>🟫 PDCA Planワークフロー"]
    DF_OUTPUT["出力: <br><b>標準特徴量DataFrame</b>（詳細下記）"]
    COLLECTOR --> FEATURES
    FEATURES --> STATISTICS
    FEATURES --> ANALYZER
    ANALYZER --> PLAN_WORKFLOW
    STATISTICS --> PLAN_WORKFLOW
    PLAN_WORKFLOW --> DF_OUTPUT
  end

  %% --- 標準特徴量例 ---
  subgraph DF["🗃️ 標準特徴量DataFrame"]
    DF_COLUMNS["主なカラム:<br>
    - Date, {Asset}_Close, {Asset}_Volume, {Asset}_Return<br>
    - {Asset}_Volatility_5d/20d, {Asset}_RSI_14d, {Asset}_GC_Flag<br>
    - News_Count, News_Positive, News_Negative, News_Positive_Ratio, ...<br>
    - CPIAUCSL_Value, UNRATE_Value, FEDFUNDS_Value, ...<br>
    - FOMC, CPI, NFP, ...イベント系<br>
    - 他: テクニカル/マクロ特徴量（詳細：features.py参照）"]
  end
  DF_OUTPUT --> DF_COLUMNS

  %% --- 各戦略AI（臣下AI） ---
  subgraph Strategies["🤖 各AI臣下（src/strategies/）"]
    AURUS["aurus_singularis.py<br>🟦 総合市場分析AI<br>（ML/主要テク・マクロ特徴量）"]
    LEVIA["levia_tempest.py<br>🟧 スキャルピングAI<br>（即時データ/閾値反応型）"]
    NOCTUS["noctus_sentinella.py<br>🟫 リスク評価AI<br>（RiskManager+市場データ）"]
    PROMETHEUS["prometheus_oracle.py<br>🟪 未来予測AI<br>（ML/時系列特徴量）"]
    HERMES["hermes_cognitor.py<br>🟦 LLM要約・説明AI<br>（Plan特徴量＋要因説明）"]
    VERITAS["veritas_machina.py<br>🟩 ML戦略生成/評価AI"]
  end

  DF_OUTPUT -- "dict/DFで受け渡し\n（臣下ごとに要素抽出・前処理）" --> AURUS
  DF_OUTPUT --> LEVIA
  DF_OUTPUT --> NOCTUS
  DF_OUTPUT --> PROMETHEUS
  DF_OUTPUT --> VERITAS
  ANALYZER -- "要因抽出＋特徴量dict" --> HERMES

  %% --- 王（Noctria）による統治 ---
  subgraph King["👑 Noctria（中央統治AI）"]
    KING["king_noctria.py<br>PDCA統括・臣下AI制御"]
  end

  AURUS -- "signal/解釈/要約" --> KING
  LEVIA -- "signal/解釈" --> KING
  NOCTUS -- "リスク判定" --> KING
  PROMETHEUS -- "未来予測" --> KING
  HERMES -- "LLM説明/要約" --> KING
  VERITAS -- "戦略提案/評価" --> KING

  %% --- デザイン調整: 明暗配色+可読性向上 ---
  style COLLECTOR fill:#2176ae,color:#fff
  style FEATURES fill:#2a9d8f,color:#fff
  style STATISTICS fill:#6649b8,color:#fff
  style ANALYZER fill:#e68653,color:#fff
  style PLAN_WORKFLOW fill:#8367c7,color:#fff
  style DF_OUTPUT fill:#1d3557,color:#fff
  style DF_COLUMNS fill:#d7eefa,color:#333

  style AURUS fill:#2980b9,color:#fff
  style LEVIA fill:#e89c4d,color:#111
  style NOCTUS fill:#574f7d,color:#fff
  style PROMETHEUS fill:#512b81,color:#fff
  style HERMES fill:#5fa8d3,color:#111
  style VERITAS fill:#52b788,color:#fff

  style KING fill:#FFD700,color:#2d2d2d,stroke:#222,stroke-width:3px
  style Plan stroke:#aaa,stroke-width:2px
  style Strategies stroke:#aaa,stroke-width:2px
  style King stroke:#bca136,stroke-width:2px
