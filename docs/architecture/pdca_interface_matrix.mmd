# ğŸ§© PDCA Interface Matrix â€” Canonical
**File role:** Single source of truth for **all interfaces between PDCA layers** (data contracts, producers/consumers, transport, observability, and invariants).  
**Status:** Stable (design-first) / Code follows this spec  
**Last Updated (JST):** 2025-08-23

> æœ¬æ›¸ã¯ **è¨­è¨ˆã‚’å…ˆã«å›ºå®š** ã—ã€ã‚ã¨ã‹ã‚‰å®Ÿè£…ã‚’æ•´åˆã•ã›ã‚‹ãŸã‚ã®ã€Œæ¥ç¶šå°å¸³ã€ã§ã™ã€‚  
> å„å¥‘ç´„ã®æœ¬æ–‡ã¯ Contracts ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è²¬ä»»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ã€ã“ã“ã§ã¯ **å¢ƒç•Œãƒ»é‹ç”¨ãƒ»çµåˆãƒ«ãƒ¼ãƒ«** ã‚’çµ±ä¸€ã—ã¾ã™ã€‚

---

## 0) References (è²¬ä»»ãƒ•ã‚¡ã‚¤ãƒ«)
- **Architecture Overview:** `docs/architecture/Architecture-Overview.md`
- **Mermaid (PDCA):** `docs/architecture/diagrams/plan_layer.mmd`, `do_layer.mmd`, `check_layer.mmd`, `act_layer.mmd`
- **Contracts (Data/API):**
  - FeatureBundle v1.0 â€” `docs/architecture/contracts/FeatureBundle.md`
  - StrategyProposal v1.0 â€” `docs/architecture/contracts/StrategyProposal.md`
  - DecisionRecord v1.0 â€” `docs/architecture/contracts/DecisionRecord.md`
  - **OrderRequest v1.1** â€” `docs/architecture/contracts/OrderRequest.md`ï¼ˆ`idempotency_key` è¿½åŠ ï¼‰
- **Observability (Guide / APIs):**
  - High-level: `docs/observability/Observability.md`
  - APIs & GUI: `docs/apis/observability/Observability.md`

---

## 1) Global Conventionsï¼ˆå…¨ä½“è¦ç´„ï¼‰
- **Time:** All timestamps are **UTC ISO-8601** (`YYYY-MM-DDTHH:MM:SSZ`); GUIã§TZå¤‰æ›ã€‚
- **SemVer:** Contracts follow **SemVer**. Minor (`v1.x`) = backward compatible. Major (`v2.0+`) = breaking.
- **Correlation:** `trace_id` is **MUST** at all edges; generated in Plan (`src/plan_data/trace.py`) and propagated E2E.
- **Idempotency:** For **mutating / side-effecting** actions (placing orders, releasing configs), an **idempotency key** is **SHOULD / MUST** as specified per edge. In Doå±¤, `OrderRequest.idempotency_key` is **MUST** (v1.1).
- **Transport:** In-process Python objects unlessæ˜è¨˜; audit/exportã¯ JSONï¼ˆimmutable snapshotï¼‰ã€‚
- **Observability:** Each edge **MUST** log to `obs_*` tables; GUI reads `obs_trace_timeline`, `obs_trace_latency`, `obs_latency_daily`.

---

## 2) Matrix (Edges at a Glance)
| From | To | Contract(s) | Producer (files) | Consumer (files) | Transport | Observability |
|---|---|---|---|---|---|---|
| PLAN | AI | **FeatureBundle v1.0** | `src/plan_data/{collector,features,analyzer}.py` â†’ `strategy_adapter.py` | `src/strategies/*.py` | In-proc obj (dict/DF) | `obs_plan_runs`, `obs_infer_calls` |
| AI | DECISION | **StrategyProposal v1.0** (Nä»¶) | `src/strategies/*.py` | `src/decision/decision_engine.py` | In-proc obj | `obs_infer_calls`, `obs_decisions` |
| DECISION | DO | **DecisionRecord v1.0**ï¼ˆå¸¸æ™‚ï¼‰, **OrderRequest v1.1**ï¼ˆç™ºæ³¨æ™‚ï¼‰ | `decision_engine.py` | `execution/order_execution.py` | In-proc obj â†’ JSON audit | `obs_decisions`, `obs_exec_events` |
| DO | CHECK | `exec_result.json`, `risk_event.json`, `audit_order.json` | `execution/*.py` | `src/check/{evaluation,challenge_monitor}.py` | JSON files / events | `obs_exec_events`, `obs_alerts` |
| CHECK | ACT | `kpi_summary.json` | `src/check/evaluation.py` | `noctria_gui/routes/pdca_*` / `src/act/*` | JSON â†’ GUI | `obs_act_runs` (summary ops) |
| ACT | PLAN | `plan_update.json`, `strategy_release.json` | `src/act/*.py` | `src/plan_data/*` | JSON / API | `obs_act_runs`, `obs_alerts` |

> è©³ç´°å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å„ Contract ã®è²¬ä»»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã€‚ä»¥ä¸‹ã§ã¯ **æ¥ç¶šãƒ»é‹ç”¨ä¸Šã®è¦ä»¶** ã‚’å›ºå®šã€‚

---

## 3) PLAN â†’ AI
**Contract:** FeatureBundle v1.0  
**Flow:** `collector.py â†’ features.py â†’ analyzer.py â†’ strategy_adapter.propose_with_logging()` ãŒ FeatureBundle ã‚’æ§‹ç¯‰ã—ã€å„ AI ã¸æ¸¡ã™ã€‚

**Rules**
- `trace_id`ï¼ˆMUSTï¼‰: Plané–‹å§‹ã§ç”Ÿæˆã—ã€FeatureBundleã«å«ã‚ã‚‹ã€‚
- **Determinismï¼ˆæ¨å¥¨ï¼‰**: åŒä¸€ `trace_id` ã¨åŒä¸€ãƒ‡ãƒ¼ã‚¿ãªã‚‰ FeatureBundle ã¯å†ç¾å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã€‚
- **Loggingï¼ˆMUSTï¼‰**:  
  - `obs_plan_runs`: phase=`PLAN:START|END`  
  - `obs_infer_calls`: å„AIå‘¼ã³å‡ºã—ã® `model`, `ver`, `dur_ms`, `success`

---

## 4) AI â†’ DECISION
**Contract:** StrategyProposal v1.0ï¼ˆAIã”ã¨ã« 0..Nä»¶ï¼‰  
**Flow:** `strategy_adapter.py` ãŒ proposer ã‚’å‘¼ã³ã€çµæœã‚’é›†ç´„ã—ã¦ DecisionEngine ã«æ¸¡ã™ã€‚

**Rules**
- **Multiplicity**: Nä»¶ã‚’ã‚½ãƒ¼ãƒˆï¼ˆscore/priorityï¼‰ã—ã¦æ¸¡ã™ã€‚Top-N ã¯ DecisionEngine ã§åˆ¶å¾¡ã€‚
- **trace_idï¼ˆMUSTï¼‰**: å„ Proposal ã«åŒå°ã€‚
- **Loggingï¼ˆMUSTï¼‰**: `obs_infer_calls` ã« latency, success, metaï¼ˆsymbol, horizon ç­‰ï¼‰ã‚’è¨˜éŒ²ã€‚

---

## 5) DECISION â†’ DO
**Contracts:**  
- **DecisionRecord v1.0**ï¼ˆå¸¸æ™‚ãƒ»ç›£æŸ»ç”¨ï¼‰  
- **OrderRequest v1.1**ï¼ˆå®Ÿç™ºæ³¨æ™‚ã®ã¿ï¼‰  
  - `idempotency_key`ï¼ˆMUSTï¼‰: ç”Ÿæˆè¦å‰‡ã¯ OrderRequest.mdï¼ˆv1.1ï¼‰ã«æº–æ‹ ã€‚

**Flow:** `decision_engine.py` ãŒå„ Proposal ã‚’è©•ä¾¡ãƒ»çµ±åˆï¼ˆprofiles.yaml / quality gate åæ˜ ï¼‰ã€‚  
ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã€Œå–å¼•å¿…è¦ã€ã®å ´åˆ `OrderRequest` ã‚’ç”Ÿæˆã€`order_execution.py` ã«æ‰‹æ¸¡ã—ã€‚å¸¸ã« `DecisionRecord` ã‚’æ°¸ç¶šåŒ–ã€‚

**Rules**
- **Idempotencyï¼ˆMUSTï¼‰**:  
  - `OrderRequest.idempotency_key` ã‚’å¿…é ˆã€‚  
  - Doå±¤ Outboxï¼ˆ`outbox_orders.idempotency_key UNIQUE`ï¼‰ã§äºŒé‡é€ä¿¡ã‚’æŠ‘æ­¢ã€‚  
  - `exec_result` ã«åŒã‚­ãƒ¼ã‚’åæ˜ ã€‚
- **trace_idï¼ˆMUSTï¼‰**: DecisionRecord / OrderRequest ã«å…±é€šã§å«ã‚ã‚‹ã€‚
- **Loggingï¼ˆMUSTï¼‰**:  
  - `obs_decisions`ï¼šaction / confidence / reasons / selected sources  
  - handoff ä»¥å¾Œã¯ `obs_exec_events` ã«é€£ãªã‚‹ã€‚

---

## 6) DO â†’ CHECK
**Artifacts:**  
- `exec_result.json`ï¼ˆfills, avg_price, fee, status, **trace_id**, **idempotency_key**ï¼‰  
- `risk_event.json`ï¼ˆpolicy, severity, reason, **trace_id**ï¼‰  
- `audit_order.json`ï¼ˆé€ä¿¡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼šOrderRequest + broker payloadï¼‰

**Rules**
- **Idempotencyï¼ˆMUSTï¼‰**: `exec_result.json` ã« `idempotency_key` ã‚’å«ã‚ã€åŒã‚­ãƒ¼ã®é‡è¤‡ã¯é›†è¨ˆå´ã§ **åŒä¸€ã‚¤ãƒ™ãƒ³ãƒˆ** ã¨æ‰±ã†ã€‚
- **FSMï¼ˆæº–æ‹ ï¼‰**: `NEW â†’ SENT â†’ ACCEPTED â†’ PARTIALLY_FILLED â†’ FILLED | REJECTED | CANCELLED | EXPIRED`  
  - `obs_exec_events.status` ã¯ä¸Šè¨˜ã„ãšã‚Œã‹ã€‚  
- **Observabilityï¼ˆMUSTï¼‰**:  
  - `obs_exec_events`: é€ä¿¡/å¿œç­”/ç´„å®šãƒ»å¤±æ•—  
  - `obs_alerts`: ã‚¬ãƒ¼ãƒ‰é•å/ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ç•°å¸¸/å†é€éå¤š ç­‰

---

## 7) CHECK â†’ ACT
**Artifact:** `kpi_summary.json`ï¼ˆæˆ¦ç•¥åˆ¥/éŠ˜æŸ„åˆ¥ KPIã€æœŸé–“é›†è¨ˆï¼‰  
**Consumers:** `noctria_gui/routes/pdca_summary.py`, `src/act/pdca_recheck.py` ãªã©ã€‚

**Rules**
- **Determinism**: å…¥åŠ›ãŒåŒã˜ãªã‚‰é›†è¨ˆçµæœã¯åŒä¸€ã€‚  
- **GUI**: `/pdca/summary` ãŒä¸»è¦é–²è¦§å£ã€‚  
- **Observability**: ã‚µãƒãƒªæ›´æ–°ã‚’ `obs_act_runs` ã«è¨˜éŒ²ï¼ˆduration / statusï¼‰ã€‚

---

## 8) ACT â†’ PLAN
**Artifacts:**  
- `plan_update.json`ï¼ˆfeature/thresholdææ¡ˆã€‚TBD: schema semverï¼‰  
- `strategy_release.json`ï¼ˆæ¡ç”¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³/è¨­å®šã€‚TBD: schema semverï¼‰

**Rules**
- **Governance**: Two-Person + King ã®æ‰¿èªãƒ•ãƒ­ãƒ¼ï¼ˆGUIã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ â†’ push/tagï¼‰ã€‚  
- **Observability**: æ¡ç”¨/å·®ã—æˆ»ã—/å¤±æ•—ã¯ `obs_act_runs`ãƒ»`obs_alerts` ã«åæ˜ ã€‚

---

## 9) Observability Bindingsï¼ˆãƒ­ã‚°çµç·šã®æ¨™æº–ï¼‰
- **Tablesï¼ˆåŸå§‹ï¼‰**:  
  - `obs_plan_runs`, `obs_infer_calls`, `obs_decisions`, `obs_exec_events`, `obs_alerts`
- **Views / MView**:  
  - `obs_trace_timeline`, `obs_trace_latency`, `obs_latency_daily`
- **GUI Routes**:  
  - `GET /pdca/timeline`, `GET /pdca/latency/daily`, `POST /pdca/observability/refresh`
- **MUST**: ã™ã¹ã¦ã®ã‚¨ãƒƒã‚¸ã§ `trace_id` ã‚’è¨˜éŒ²ã€‚Doå±¤ã¯ `idempotency_key` ã‚‚å¯èƒ½ãªé™ã‚Šè¨˜éŒ²ã€‚

---

## 10) Error, Retry, Idempotencyï¼ˆæ¨ªæ–­è¦ç´„ï¼‰
- **Retry Budget**: å„ã‚¨ãƒƒã‚¸ã¯ **æœ€å¤§Nå›**ï¼ˆå®Ÿè£…å´è¨­å®šï¼‰ã¾ã§æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã€‚Doå±¤ã¯ **Outbox ãƒ‘ã‚¿ãƒ¼ãƒ³**ã§å†ªç­‰ã«å†é€ã€‚
- **Duplicate Handling**: `idempotency_key` é‡è¤‡ã¯ **å®‰å…¨ã«ç„¡è¦–**ï¼ˆå¹‚ç­‰æˆåŠŸã¨ã—ã¦æ‰±ã†ï¼‰ã€‚
- **Poison Messages**: é€£ç¶šå¤±æ•—ã¯ `obs_alerts`ï¼ˆseverity=Criticalï¼‰ã«è¨˜éŒ²ã—ã€ä»¥é™ã®è‡ªå‹•å†é€ã‚’åœæ­¢ã€‚

---

## 11) Profiles & Policyï¼ˆDecisionçµ±åˆ¶ï¼‰
- **profiles.yaml**ï¼ˆè¨ˆç”»ï¼‰: `weights`, `rollout_percent`, `min_confidence`, `combine`, `alpha_risk`ã€‚  
- **risk_policy.yml**ï¼ˆDoå±¤ï¼‰: `max_position_notional`, `max_order_qty`, `trading_hours_utc`, `max_consecutive_losses`, `shrink_after_losses_pct`, `forbidden_symbols`ã€‚  
- **QualityGateï¼ˆPlanâ†’Decisionæ‰‹å‰ï¼‰**: `missing_ratio` / `data_lag` â†’ `OK/SCALE/FLAT`ï¼ˆç†ç”±ã¯ DecisionRecord ã«æ®‹ã™ï¼‰ã€‚

---

## 12) Validation Checklistï¼ˆé‹ç”¨ãƒã‚§ãƒƒã‚¯ï¼‰
- **Contracts å¼•ç”¨æ•´åˆ**ï¼š`rg -n "FeatureBundle|StrategyProposal|DecisionRecord|OrderRequest" docs` ãŒæœŸå¾…ç®‡æ‰€ã«å‡ºç¾ã€‚  
- **Mermaid å‚ç…§**ï¼š`plan_layer.mmd` ç­‰ã«å¥‘ç´„æ³¨é‡ˆã‚³ãƒ¡ãƒ³ãƒˆãŒæ®‹ã£ã¦ã„ã‚‹ã€‚  
- **Observability**ï¼šãƒ“ãƒ¥ãƒ¼ä½œæˆæ¸ˆã¿ & GUI ã§å¯è¦–åŒ–ï¼ˆ/pdca/timeline, /pdca/latency/daily ãŒæç”»OKï¼‰ã€‚  
- **Idempotency å®ŸåŠ¹æ€§**ï¼šåŒä¸€ `OrderRequest` ã‚’2å›æŠ•å…¥ã—ã¦ã‚‚ **Brokeré€ä¿¡1å›**ã€`obs_exec_events` é‡è¤‡ãªã—ã€‚  
- **FSM æ•´åˆ**ï¼š`obs_exec_events.status` ãŒä»•æ§˜ã®æœ‰é™é›†åˆã«é™å®šã•ã‚Œã¦ã„ã‚‹ã€‚

---

## 13) Appendix A â€” Doå±¤ Outboxï¼ˆDDL ä¾‹ï¼‰
> å®Ÿè£…ã¯åˆ¥è²¬ä»»ã ãŒã€**è¨­è¨ˆå‰æ**ã¨ã—ã¦ã®ä¸€æ„åˆ¶ç´„ã¨ç›£æŸ»é …ç›®ã€‚

```sql
CREATE TABLE IF NOT EXISTS outbox_orders (
  id BIGSERIAL PRIMARY KEY,
  idempotency_key TEXT NOT NULL UNIQUE,
  trace_id TEXT,
  payload JSONB NOT NULL,              -- OrderRequest snapshot
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  sent_at TIMESTAMPTZ,
  broker_response JSONB                -- last response snapshot
);
