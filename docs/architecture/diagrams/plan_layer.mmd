flowchart TD
classDef plan fill:#262e44,stroke:#47617a,color:#d8e0f7;
classDef ai fill:#2f3136,stroke:#a97e2c,color:#ffe476;
classDef do fill:#3d2d2d,stroke:#cc9999,color:#ffcccc;
classDef todo fill:#323232,stroke:#ff9f43,color:#ffd8a8;
classDef obs fill:#1e2a36,stroke:#5dade2,color:#d6eaf8;
classDef demo fill:#202020,stroke:#8a8a8a,color:#eaeaea;
subgraph PLAN ["PLAN layer (src/plan_data)"]
  COLLECT["collector.py - market data collection"]:::plan
  FEATURES["features.py - feature engineering"]:::plan
  FEATDF["FeatureBundle output (df + context) - implemented v1.0"]:::plan
  ANALYZER["analyzer.py - factor extraction"]:::plan
  STATS["statistics.py - KPI aggregation"]:::plan
  ADAPTER["strategy_adapter.py - propose_with_logging - logs obs_infer_calls"]:::plan
end
subgraph AI_UNDERLINGS ["AI underlings (src/strategies)"]
  AURUS["Aurus - propose()"]:::ai
  LEVIA["Levia - propose()"]:::ai
  PROM["Prometheus - predict_future()"]:::ai
  VERITAS["Veritas - propose()"]:::ai
  HERMES["Hermes - LLM explain - propose() - non-execution"]:::ai
end
DECISION["DecisionEngine (min) - integrate & log (IMPLEMENTED)"]:::plan
NOCTUSGATE["Noctus Gate - mandatory risk and lot filter - TODO"]:::todo
QUALITY["DataQualityGate - missing_ratio and data_lag to FLAT or Fallback - TODO"]:::todo
PROFILES["profiles.yaml - weights and rollout 7->30->100% - TODO"]:::todo
CONTRACTS["Contracts - FeatureBundle & StrategyProposal implemented v1.0 - OrderRequest TBD"]:::todo
TRACEID["Correlation ID trace_id - PLAN/AI/Decision/Exec implemented"]:::plan
subgraph DO_LAYER ["Do layer (handoff)"]
  ORDER["order_execution.py - execution API (dummy ok)"]:::do
end
subgraph DEMO ["Demo and tests"]
  DECISION_MINI["e2e/decision_minidemo.py - E2E (IMPLEMENTED)"]:::demo
  TEST_E2E["tests/test_trace_decision_e2e.py - integration (IMPLEMENTED)"]:::demo
end
subgraph OBS ["Observability taps (tables)"]
  OBS_PLAN["obs_plan_runs - collector/features/statistics/analyzer - trace_id present"]:::obs
  OBS_INFER["obs_infer_calls - AI propose/predict latency - trace_id present"]:::obs
  OBS_DEC["obs_decisions - decision metrics & reasons - trace_id present (NEW)"]:::obs
  OBS_EXEC["obs_exec_events - send status / provider response - trace_id present (NEW)"]:::obs
  OBS_ALT["obs_alerts - quality or risk alerts - TODO"]:::obs
end
COLLECT --> FEATURES --> STATS
FEATURES --> FEATDF
FEATDF --> ANALYZER
ANALYZER --> HERMES
FEATDF --> ADAPTER
ADAPTER --> AURUS
ADAPTER --> LEVIA
ADAPTER --> PROM
ADAPTER --> VERITAS
FEATDF -. "uses" .-> CONTRACTS
ADAPTER -. "uses" .-> CONTRACTS
AURUS -. "returns" .-> CONTRACTS
LEVIA -. "returns" .-> CONTRACTS
PROM  -. "returns" .-> CONTRACTS
VERITAS -. "returns" .-> CONTRACTS
FEATDF --> QUALITY
QUALITY --> DECISION
AURUS --> DECISION
LEVIA --> DECISION
PROM  --> DECISION
VERITAS --> DECISION
PROFILES -. "config" .-> DECISION
DECISION --> NOCTUSGATE
NOCTUSGATE --> ORDER
DECISION_MINI --> FEATDF
DECISION_MINI --> DECISION
DECISION_MINI --> ORDER
TEST_E2E -. "psql counts by trace_id" .-> OBS_PLAN
TEST_E2E -.-> OBS_INFER
TEST_E2E -.-> OBS_DEC
TEST_E2E -.-> OBS_EXEC
COLLECT  -->|log| OBS_PLAN
FEATURES -->|log| OBS_PLAN
STATS    -->|log| OBS_PLAN
ANALYZER -->|log| OBS_PLAN
AURUS    -->|log| OBS_INFER
LEVIA    -->|log| OBS_INFER
PROM     -->|log| OBS_INFER
VERITAS  -->|log| OBS_INFER
DECISION -->|log| OBS_DEC
ORDER    -->|log| OBS_EXEC
NOCTUSGATE -->|alert| OBS_ALT
FEATDF -. "trace_id (PLAN & AI implemented)" .-> AURUS
FEATDF -. "trace_id (PLAN & AI implemented)" .-> LEVIA
FEATDF -. "trace_id (PLAN & AI implemented)" .-> PROM
FEATDF -. "trace_id (PLAN & AI implemented)" .-> VERITAS
DECISION -. "trace_id (P->D->Exec implemented)" .-> ORDER
class COLLECT,FEATURES,FEATDF,ANALYZER,STATS,ADAPTER plan;
class AURUS,LEVIA,PROM,VERITAS,HERMES ai;
class ORDER do;
class DECISION plan;
class NOCTUSGATE,QUALITY,PROFILES,CONTRACTS todo;
class TRACEID plan;
class OBS_PLAN,OBS_INFER,OBS_DEC,OBS_EXEC,OBS_ALT obs;
class DECISION_MINI,TEST_E2E demo;
