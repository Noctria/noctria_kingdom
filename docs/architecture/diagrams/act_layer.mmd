graph TD

%% ====== styles (GitHub-safe) ======
classDef inputs fill:#243447,stroke:#4f86c6,color:#e6f0ff;
classDef act fill:#3a2e4d,stroke:#a78bfa,color:#f3e8ff;
classDef train fill:#2d3a2f,stroke:#76c893,color:#e0ffe8;
classDef outputs fill:#1f3b2d,stroke:#6bbf59,color:#d7fbe8;
classDef gov fill:#2e2e2e,stroke:#b7b7b7,color:#ffffff;
classDef obs fill:#1e2a36,stroke:#5dade2,color:#d6eaf8;
classDef todo fill:#323232,stroke:#ff9f43,color:#ffd8a8;

%% ====== INPUTS ======
subgraph INPUTS ["Upstream inputs"]
  KPI["kpi_summary.json - from CHECK"]
  ECONF["eval_config.json - targets / window / metrics - TODO: hypothesis id and test settings not implemented"]
  GUIACT["GUI /pdca/act - human accept or threshold adjust"]
end

%% ====== ACT layer ======
subgraph ACT_LAYER ["ACT layer (src/noctria_gui/routes and src/pdca)"]
  RECHECK["pdca_recheck.py - re-evaluate / param search / A-B compare - TODO: full experiment tracking not implemented"]
  PUSH["pdca_push.py - adopt and release - Git push and tag - TODO: release bundle signature and SBOM not implemented"]
  SUMMARY["pdca_summary.py - period and tag summaries - TODO: statistical report and benchmarks not implemented"]
  FEEDBACK["feedback_adapter.py - proposals back to PLAN - TODO: proposal vs applied contract not implemented"]
end

%% ====== Training and retraining ======
subgraph TRAINING ["Training and retraining (Airflow)"]
  TRAIN_DAG["train_* DAG - train and validate - TODO: auto trigger from drift or SLO not implemented"]
  REGISTRY["models/registry - source of truth: version and signature and data fingerprint - TODO: enforcement not implemented"]
end

%% ====== OUTPUTS ======
subgraph OUTPUTS ["Downstream outputs"]
  PLANUPD["plan_update.json - feature or threshold proposals - TODO: schema semver not implemented"]
  STRATREL["strategy_release.json - selected version and config - TODO: schema semver not implemented"]
  DASH["dashboard_feed.json - visualization feed"]
end

%% ====== Governance and operations ======
subgraph GOVERNANCE ["Governance and operations"]
  DAG_ACT["Airflow DAG pdca_act_flow.py - orchestrate - TODO: idempotent per trace_id and branch lock not implemented"]
  GUI_ROUTE["GUI /pdca/summary and /pdca/recheck - approve and review - TODO: two person plus king workflow events not implemented"]
  APPROVAL["approval_record.json - approvers and timestamps - TODO: persistence not implemented"]
end

%% ====== Observability taps ======
subgraph OBS ["Observability taps (tables)"]
  OBS_ACT["obs_act_runs - start and end and status and duration and approvers - TODO: add trace_id and decision_id"]
  OBS_RECHECK["obs_recheck_jobs - trials and best and p values and CI - TODO: add trace_id and decision_id"]
  OBS_ALT["obs_alerts - promotion failed or rollback or policy deviation - TODO: add decision_id"]
end

%% ====== Policies and identity ======
CRITERIA["promotion_criteria.yaml - thresholds and period and tests - TODO: formalize not implemented"]
ROLLBACK["rollback_policy.yaml - rules and kill switch - TODO: formalize not implemented"]
IDS["ids and versions - trace_id and decision_id and schema_version - TODO: enforce across outputs not implemented"]

%% ====== FLOWS ======
KPI --> RECHECK
ECONF --> RECHECK
GUIACT --> RECHECK
RECHECK --> SUMMARY
RECHECK --> PUSH
RECHECK -. train data .-> TRAIN_DAG
TRAIN_DAG --> REGISTRY
PUSH --> STRATREL
SUMMARY --> DASH
FEEDBACK --> PLANUPD

%% ====== Governance links ======
GUI_ROUTE --> RECHECK
GUI_ROUTE --> PUSH
GUI_ROUTE --> APPROVAL
DAG_ACT --> RECHECK
DAG_ACT --> PUSH

%% ====== Policies links ======
CRITERIA --> RECHECK
ROLLBACK --> PUSH

%% ====== Feedback loop to PLAN ======
OUTPUTS --> FEEDBACK

%% ====== Observability links ======
RECHECK -->|log| OBS_RECHECK
PUSH -->|log| OBS_ACT
SUMMARY -->|log| OBS_ACT
APPROVAL -->|log| OBS_ACT
ROLLBACK -->|alert| OBS_ALT

%% ====== Identity propagation (not implemented) ======
KPI -. trace_id .-> RECHECK
RECHECK -. decision_id .-> PUSH
PUSH -. decision_id .-> STRATREL
SUMMARY -. decision_id .-> DASH
PLANUPD -. trace_id .-> FEEDBACK

%% ====== class bindings ======
class KPI,ECONF,GUIACT inputs;
class RECHECK,PUSH,SUMMARY,FEEDBACK act;
class TRAIN_DAG,REGISTRY train;
class PLANUPD,STRATREL,DASH outputs;
class DAG_ACT,GUI_ROUTE,APPROVAL gov;
class OBS_ACT,OBS_RECHECK,OBS_ALT obs;
class CRITERIA,ROLLBACK,IDS todo;
