flowchart TD

%% === 中央統治・王AI層 ===
subgraph CENTRAL_GOV["👑 Central Governance (Noctria Kingdom)"]
  KNOCTRIA["king_noctria.py<br>王AI：中央統治・指令発令"]
  HERMES["hermes_cognitor.py<br>Hermes：LLM要約/解説"]
  VERITAS["veritas_machine.py<br>Veritas：ML戦略評価"]
  PROMETHEUS["prometheus_oracle.py<br>Prometheus：未来予測"]
  AURUS["aurus_singularis.py<br>Aurus：市場分析"]
  LEVIA["levia_tempest.py<br>Levia：スキャルピング/流動性"]
end

%% === Airflowワークフロー・PDCA自動化クラスタ ===
subgraph AIRFLOW_PDCA["🔁 Airflow PDCA/Strategy Workflow"]
  DAG_PDCA["veritas_pdca_dag.py<br>PDCA自動ループ"]
  DAG_GEN["veritas_generate_dag.py<br>戦略生成"]
  DAG_EVAL["veritas_eval_dag.py<br>戦略一括評価"]
  DAG_REEVAL["veritas_eval_single_dag.py<br>単体再評価"]
  DAG_PUSH["veritas_push_dag.py<br>採用/Push"]
  DAG_REPLAY["veritas_replay_dag.py<br>Replay/リカバリ"]
  DAG_ACTREC["veritas_act_record_dag.py<br>Act記録"]
end

%% === モデル・生成・評価クラスタ ===
subgraph STRATEGY_GEN["🧠 ML戦略生成・評価"]
  STRAT_GEN["strategy_generator.py<br>戦略生成ロジック"]
  SIMPLE_MODEL["models/ml_model/simple_model.py<br>MLモデル本体"]
  STRAT_EVAL["strategy_evaluator.py<br>戦略評価ロジック"]
end

%% === GUI/HUD・APIクラスタ ===
subgraph GUI_API["💻 GUI・API（FastAPI/HTML/HUD）"]
  ROUTES_HOME["routes/home.py"]
  ROUTES_DASH["routes/dashboard.py"]
  ROUTES_KING["routes/king_routes.py"]
  ROUTES_AI["routes/ai_routes.py"]
  ROUTES_PDCA["routes/pdca.py"]
  ROUTES_TRIGGER["routes/trigger.py"]
  GUI_TEMPLATES["templates/*.html<br>（base_hud, dashboard, trigger, etc.）"]
  STATIC_HUD["static/hud_style.css"]
end

%% === DB・Log・Config・データクラスタ ===
subgraph STORAGE["🗄️ データ/設定/ログ"]
  POSTGRES["PostgreSQL<br>戦略・評価記録"]
  LOGS["logs/<br>各種ログ"]
  CONFIG["core/path_config.py, settings.py"]
end

%% === データ/指標フロー（AI↔DAG/DB） ===
KNOCTRIA -- 指令/統治 --> HERMES
KNOCTRIA -- 指令/統治 --> VERITAS
KNOCTRIA -- 指令/統治 --> PROMETHEUS
KNOCTRIA -- 指令/統治 --> AURUS
KNOCTRIA -- 指令/統治 --> LEVIA

KNOCTRIA -- 発令/操作 --> ROUTES_KING

HERMES -- LLMサマリ/解説 --> ROUTES_AI
VERITAS -- 評価/PDCA統括 --> AIRFLOW_PDCA
VERITAS -- 戦略評価 --> STRAT_EVAL
VERITAS -- 戦略生成 --> STRAT_GEN
STRAT_GEN -- モデル読込/生成 --> SIMPLE_MODEL

AIRFLOW_PDCA -- 戦略生成・評価 --> STRATEGY_GEN
AIRFLOW_PDCA -- Act記録/評価記録 --> POSTGRES
AIRFLOW_PDCA -- ログ/障害 --> LOGS

ROUTES_HOME --> GUI_TEMPLATES
ROUTES_DASH --> GUI_TEMPLATES
ROUTES_AI --> GUI_TEMPLATES
ROUTES_KING --> GUI_TEMPLATES
ROUTES_TRIGGER --> GUI_TEMPLATES
GUI_TEMPLATES -.-> STATIC_HUD

GUI_TEMPLATES -- 表示データ --> POSTGRES
ROUTES_PDCA -- PDCA操作 --> AIRFLOW_PDCA
ROUTES_TRIGGER -- DAG操作 --> AIRFLOW_PDCA

STRAT_GEN -- モデル/評価パラメータ --> CONFIG
AIRFLOW_PDCA -- 設定読込 --> CONFIG

PROMETHEUS -- 未来予測/指標 --> ROUTES_DASH
AURUS -- 市場分析 --> ROUTES_DASH
LEVIA -- スキャルピング成績 --> ROUTES_DASH

%% === 各AIのデータ参照系 ===
VERITAS -- 評価/PDCA集計 --> ROUTES_PDCA
HERMES -- サマリ/解説 --> ROUTES_AI
PROMETHEUS -- 予測値 --> ROUTES_DASH

%% === バックアップ・Replay系 ===
DAG_REPLAY -- ログ/記録 --> POSTGRES
DAG_ACTREC -- Act記録 --> POSTGRES

%% === 環境変数・設定ファイル ===
CONFIG -.-> STRAT_GEN
CONFIG -.-> AIRFLOW_PDCA
CONFIG -.-> ROUTES_DASH

%% === モデル保存・バージョン管理 ===
SIMPLE_MODEL -- モデルファイル管理 --> STORAGE

