flowchart TD
  %% --- Plan層 ---
  subgraph PLAN["🗺️ PLAN層（collector→features→analyzer/statistics）"]
    COLLECT["PlanDataCollector<br>市場データ収集"]
    FEATENG["FeatureEngineer<br>特徴量生成"]
    FEATDF["特徴量DataFrame/Dict出力"]
    ANALYZER["PlanAnalyzer<br>要因抽出/ラベル"]
  end

  %% --- Prometheus 分離構造 ---
  subgraph PROMETHEUS["🔮 Prometheus Oracle"]
    PROM_TRAIN["train_prometheus.py<br>履歴学習"]
    PROM_PRED["prometheus_oracle.py<br>未来予測"]
  end

  %% --- Do層 ---
  subgraph DO["⚔️ Do層（実オーダー執行/リスク/監視）"]
    ORDER["order_execution.py<br>発注API本体"]
    OPTORDER["optimized_order_execution.py<br>分割/リトライ案"]
    CHALMON["challenge_monitor.py<br>リスク/損失アラート"]
    GENORDER["generate_order_json.py<br>シグナル記録・JSON化"]
  end

  %% --- 接続 ---
  COLLECT --> FEATENG
  FEATENG --> FEATDF
  FEATDF --> ANALYZER

  FEATDF --> PROM_TRAIN
  FEATDF --> PROM_PRED

  PROM_PRED --> ORDER

  ORDER --> GENORDER
  ORDER -.-> OPTORDER
  ORDER --> CHALMON
