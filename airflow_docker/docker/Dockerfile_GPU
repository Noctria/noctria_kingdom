# âœ… GPUå¯¾å¿œãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆTensorFlow + Python 3.10ï¼‰
FROM tensorflow/tensorflow:2.14.0-gpu

# rootæ¨©é™ã§ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å°å…¥
USER root

# âœ… ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    libpq-dev \
    build-essential \
    libxml2-dev \
    libxslt1-dev \
    zlib1g-dev \
    curl \
    git \
    unzip \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# âœ… Airflow + ãã®ä»–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN pip install --upgrade pip

# ğŸ¯ Airflowã¯2.9.1ï¼ˆPython3.10ï¼‰å¯¾å¿œç‰ˆã‚’åˆ¶ç´„ä»˜ãã§å°å…¥
RUN pip install apache-airflow==2.9.1 \
    --constraint "https://raw.githubusercontent.com/apache/airflow/constraints-2.9.1/constraints-3.10.txt"

# âœ… AIé–¢é€£ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆGPUç‰ˆPyTorch + Optunaãªã©ï¼‰
RUN pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118 && \
    pip install optuna stable-baselines3 pandas numpy matplotlib

# âœ… requirements.txt ãŒã‚ã‚Œã°ä¸€æ‹¬åæ˜ ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç‹¬è‡ªãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰
COPY requirements.txt /requirements.txt
RUN pip install --no-cache-dir -r /requirements.txt || echo "requirements.txt ã¯çœç•¥å¯èƒ½"

# âœ… DAGã‚„ã‚¹ã‚¯ãƒªãƒ—ãƒˆãªã©ã‚’é…ç½®ï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
WORKDIR /opt/airflow
COPY dags/ dags/
COPY scripts/ scripts/
COPY core/ core/
COPY strategies/ strategies/

# airflowãƒ¦ãƒ¼ã‚¶ã¨ã—ã¦å®Ÿè¡Œ
RUN useradd -ms /bin/bash airflow
USER airflow

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆCMDï¼ˆdocker-composeã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã•ã‚Œã‚‹å‰æï¼‰
CMD ["airflow", "version"]
