# ================================
# ğŸŒª Noctria Kingdom: Airflow Dockerfile (v3.4)
# ================================

FROM apache/airflow:2.7.3-python3.10

# âœ… ç’°å¢ƒå¤‰æ•°å®šç¾©
ENV PYTHONUNBUFFERED=1 \
    PYTHONPATH=/opt/airflow \
    AIRFLOW_HOME=/opt/airflow

WORKDIR ${AIRFLOW_HOME}

# âœ… Gitã‚³ãƒãƒ³ãƒ‰ã®è¿½åŠ ï¼ˆsb3ç­‰ã®é–‹ç™ºç’°å¢ƒå¯¾å¿œï¼‰
USER root
RUN apt-get update && apt-get install -y git && apt-get clean
USER airflow

# âœ… å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆä¾å­˜å®šç¾©ï¼‰
COPY docker/requirements_airflow.txt /requirements_airflow.txt
COPY docker/requirements_extra.txt /requirements_extra.txt
COPY docker/constraints.txt /tmp/constraints.txt

# âœ… Airflowã®å…¬å¼æ¨å¥¨ã«åŸºã¥ã„ãŸä¾å­˜ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN set -ex \
 && pip install --upgrade pip \
 && pip install --no-cache-dir -r /requirements_airflow.txt --constraint /tmp/constraints.txt

# âœ… è¿½åŠ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
RUN pip install --no-cache-dir -r /requirements_extra.txt

# âœ… SB3é–¢é€£ï¼ˆGitHubã§ã¯ãªãPyPIã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
RUN pip uninstall -y sb3-contrib stable-baselines3 || true \
 && pip install --no-cache-dir stable-baselines3==2.2.1 sb3-contrib==2.2.1

# âœ… ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚³ãƒ”ãƒ¼ï¼ˆãƒ„ãƒ¼ãƒ«ç¾¤ï¼‰
COPY tools/create_admin_user.py /opt/airflow/tools/create_admin_user.py
COPY tools/entrypoint.sh /opt/airflow/tools/entrypoint.sh

# âœ… Entrypointã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸
RUN chmod +x /opt/airflow/tools/entrypoint.sh

# âœ… Entrypointã‚’ä¸Šæ›¸ãï¼ˆAirflowæ¨™æº–â†’ç‹¬è‡ªã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰
ENTRYPOINT ["/opt/airflow/tools/entrypoint.sh"]

# âœ… ä¸è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
RUN rm -f /tmp/constraints.txt || true
