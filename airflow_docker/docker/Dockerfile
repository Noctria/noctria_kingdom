# ================================
# ğŸŒª Noctria Kingdom: Airflow Dockerfile (v3.0)
# ================================

FROM apache/airflow:2.7.3-python3.10

# ğŸ”¹ ãƒ­ã‚°éãƒãƒƒãƒ•ã‚¡åŒ– / çµ±ä¸€ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹
ENV PYTHONUNBUFFERED=1 \
    PYTHONPATH=/opt/airflow \
    AIRFLOW_HOME=/opt/airflow

# ğŸ”¹ ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
WORKDIR ${AIRFLOW_HOME}

# ğŸ”¹ è¦æ±‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚³ãƒ”ãƒ¼ï¼ˆbuild context: airflow_docker/docker/ï¼‰
COPY requirements_airflow.txt /requirements_airflow.txt
COPY requirements_extra.txt /requirements_extra.txt
COPY constraints.txt /tmp/constraints.txt

# ğŸ”¹ Airflowæœ¬ä½“ + åŸºæœ¬ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
RUN set -ex \
 && pip install --upgrade pip \
 && pip install --no-cache-dir -r /requirements_airflow.txt --constraint /tmp/constraints.txt

# ğŸ”¹ å¤–éƒ¨ä¾å­˜ï¼ˆåˆ¶ç´„ã«å…¥ã‚Œãªã„é‡ã„ãƒ»GPUç³»ãªã©ï¼‰
RUN pip install --no-cache-dir -r /requirements_extra.txt

# ğŸ”¹ ãƒ“ãƒ«ãƒ‰å¾Œã®è»½é‡åŒ–ï¼ˆä»»æ„ï¼‰
RUN rm -rf /root/.cache /tmp/constraints.txt
