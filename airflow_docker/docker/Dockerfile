# ================================
# ğŸŒª Noctria Kingdom: Airflow Dockerfile (v3.1)
# ================================

FROM apache/airflow:2.7.3-python3.10

# ğŸ”¹ ç’°å¢ƒå¤‰æ•°ï¼ˆãƒ­ã‚°éãƒãƒƒãƒ•ã‚¡ãƒ»Airflowãƒ«ãƒ¼ãƒˆçµ±ä¸€ï¼‰
ENV PYTHONUNBUFFERED=1 \
    PYTHONPATH=/opt/airflow \
    AIRFLOW_HOME=/opt/airflow

# ğŸ”¹ ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
WORKDIR ${AIRFLOW_HOME}

# ğŸ”¹ Gitã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆsb3-contrib GitHubã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç”¨ï¼‰
USER root
RUN apt-get update && apt-get install -y git && apt-get clean
USER airflow

# ğŸ”¹ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸è¦æ±‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼ï¼ˆbuild context: airflow_docker/docker/ï¼‰
COPY docker/requirements_airflow.txt /requirements_airflow.txt
COPY docker/requirements_extra.txt /requirements_extra.txt
COPY docker/constraints.txt /tmp/constraints.txt

# ğŸ”¹ Airflow + åŸºæœ¬ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN set -ex \
 && pip install --upgrade pip \
 && pip install --no-cache-dir -r /requirements_airflow.txt --constraint /tmp/constraints.txt

# ğŸ”¹ å¤–éƒ¨ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆé€šå¸¸ã®ã‚‚ã®ï¼‰
RUN pip install --no-cache-dir -r /requirements_extra.txt

# ğŸ”¹ âœ… sb3-contribï¼ˆoptuna_callbackå¯¾å¿œï¼‰ã‚’GitHubã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN pip uninstall -y sb3-contrib stable-baselines3 || true \
 && pip install git+https://github.com/DLR-RM/stable-baselines3-contrib.git@v2.2.0

# ğŸ”¹ ãƒ“ãƒ«ãƒ‰å¾Œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ï¼ˆå¤±æ•—ã—ã¦ã‚‚ç¶™ç¶šï¼‰
RUN rm -f /tmp/constraints.txt || true
