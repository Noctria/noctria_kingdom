name: pr-policy (soft block)

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  require-green-lint:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      checks: read
    steps:
<<<<<<< HEAD
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 変更ファイルを見て、src/core or Lint設定に関係ある変更のみ"対象"にする
      - name: Guard: consider only src/core or lint-config changes
        id: guard
        shell: bash
        run: |
          set -euo pipefail
          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.event.pull_request.head.sha }}"
          changed="$(git diff --name-only "${base}" "${head}" || true)"
          echo "Changed files:"
          echo "${changed}"

          should_run=false
          if echo "${changed}" | grep -E -q '^src/core/.*\.(py|pyi)$'; then
            should_run=true
          elif echo "${changed}" | grep -E -q '^(\.ruff\.toml|\.pre-commit-config\.yaml|\.github/workflows/lint\.yml)$'; then
            should_run=true
          fi

          echo "should_run=${should_run}" >> "$GITHUB_OUTPUT"

      - name: Skip (not a lint-governed PR)
        if: steps.guard.outputs.should_run != 'true'
        run: echo "No src/core or lint-config change — skipping soft block."

      - name: Evaluate CI statuses
        id: eval
        if: steps.guard.outputs.should_run == 'true'
=======
      - name: Evaluate CI statuses
        id: eval
>>>>>>> origin/main
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            const sha = pr.head.sha;

<<<<<<< HEAD
            // Checks (GitHub Actions)
            const checks = await github.rest.checks.listForRef({ owner, repo, ref: sha, per_page: 100 });
            const runs = checks.data.check_runs || [];

            // Statuses (legacy)
            const statuses = await github.rest.repos.getCombinedStatusForRef({ owner, repo, ref: sha });
            const contexts = (statuses.data.statuses || []).map(s => ({ context: s.context, state: s.state }));

            // 必須チェック（必要なら "smoke" を追加可）
            const required = ["ruff","ruff-format"];

            function isGreen(name) {
              const okRun = runs.some(r => (r.name === name || (r.name||"").includes(name)) && r.conclusion === "success");
=======
            const checks = await github.rest.checks.listForRef({ owner, repo, ref: sha, per_page: 100 });
            const runs = checks.data.check_runs || [];

            const statuses = await github.rest.repos.getCombinedStatusForRef({ owner, repo, ref: sha });
            const contexts = (statuses.data.statuses || []).map(s => ({ context: s.context, state: s.state }));

            const required = ["ruff","ruff-format"];

            function isGreen(name) {
              const okRun = runs.some(r => (r.name === name || r.name?.includes?.(name)) && r.conclusion === "success");
>>>>>>> origin/main
              const okCtx = contexts.some(c => c.context === name && c.state === "success");
              return okRun || okCtx;
            }

            const failed = required.filter(n => !isGreen(n));
            core.setOutput("failed", failed.join(","));

      - name: Soft-block if not green
<<<<<<< HEAD
        if: steps.guard.outputs.should_run == 'true' && steps.eval.outputs.failed != ''
=======
        if: steps.eval.outputs.failed != ''
>>>>>>> origin/main
        uses: actions/github-script@v7
        with:
          script: |
            const failed = "${{ steps.eval.outputs.failed }}";
            const pr = context.payload.pull_request;
            const body = [
              "❌ Soft block: 必須チェック未通過のため PR を自動クローズします。",
              "",
              "**未通過チェック**: " + failed,
              "",
              "通過後に **Reopen** してください。（Branch Protection 非対応の暫定運用）"
            ].join("\n");
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.number, body });
            await github.rest.pulls.update({ owner: context.repo.owner, repo: context.repo.repo, pull_number: pr.number, state: "closed" });

      - name: All good (post info)
<<<<<<< HEAD
        if: steps.guard.outputs.should_run == 'true' && steps.eval.outputs.failed == ''
=======
        if: steps.eval.outputs.failed == ''
>>>>>>> origin/main
        run: echo "All required checks passed (ruff, ruff-format)"
