name: Handoff Rollup

on:
  workflow_dispatch:
    inputs:
      pinned_issue_number:
        description: "ã‚³ãƒ¡ãƒ³ãƒˆå…ˆã®ãƒ”ãƒ³ç•™ã‚Issueç•ªå·"
        required: true
        default: "1"
      lookback_hours:
        description: "ç›´è¿‘ä½•æ™‚é–“ã®æ›´æ–°ã‚’é›†è¨ˆã™ã‚‹ã‹"
        required: true
        default: "1"
  schedule:
    - cron: "0 * * * *"  # æ¯æ™‚00åˆ†ï¼ˆUTCï¼‰

permissions:
  contents: read
  pull-requests: read
  issues: write

concurrency:
  group: handoff-rollup
  cancel-in-progress: true

env:
  PINNED_ISSUE_NUMBER: ${{ github.event.inputs.pinned_issue_number || '1' }}
  LOOKBACK_HOURS: ${{ github.event.inputs.lookback_hours || '1' }}
  TZ: "Asia/Tokyo"

jobs:
  rollup:
    runs-on: ubuntu-latest
    steps:
      - name: Post rollup comment
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = parseInt(process.env.PINNED_ISSUE_NUMBER || "1", 10);
            let hours = parseInt(process.env.LOOKBACK_HOURS || "1", 10);
            if (isNaN(hours) || hours < 1) hours = 1;

            const sinceISO = new Date(Date.now() - hours * 60 * 60 * 1000).toISOString();

            const closed = await github.paginate(github.rest.pulls.list, {
              owner, repo, state: 'closed', sort: 'updated', direction: 'desc', per_page: 100
            });
            const merged = closed.filter(pr => pr.merged_at && pr.merged_at >= sinceISO).slice(0, 20);

            const openPRs = await github.paginate(github.rest.pulls.list, {
              owner, repo, state: 'open', sort: 'updated', direction: 'desc', per_page: 20
            });
            const openIssuesAll = await github.paginate(github.rest.issues.listForRepo, {
              owner, repo, state: 'open', sort: 'updated', direction: 'desc', per_page: 40
            });
            const openIssues = openIssuesAll.filter(i => !i.pull_request).slice(0, 20);

            const nowJST = new Date().toLocaleString('ja-JP', { timeZone: process.env.TZ });

            const b = [];
            b.push(`## ğŸ“ å¼•ãç¶™ãï¼ˆ${nowJST}ï¼‰`);
            b.push(`_ç›´è¿‘ **${hours}h** ã®æ›´æ–°ã‚’é›†è¨ˆ_`);
            b.push('');
            b.push('### âœ… æœ€è¿‘ãƒãƒ¼ã‚¸');
            if (merged.length === 0) b.push('- ãªã—');
            merged.forEach(pr => b.push(`- #${pr.number} ${pr.title} (@${pr.user.login})`));
            b.push('');
            b.push('### ğŸ”§ ã‚ªãƒ¼ãƒ—ãƒ³PRï¼ˆæœ€æ–°20ä»¶ï¼‰');
            if (openPRs.length === 0) b.push('- ãªã—');
            openPRs.forEach(pr => b.push(`- #${pr.number} ${pr.title} (@${pr.user.login})`));
            b.push('');
            b.push('### ğŸ“Œ ã‚ªãƒ¼ãƒ—ãƒ³Issueï¼ˆæœ€æ–°20ä»¶ï¼‰');
            if (openIssues.length === 0) b.push('- ãªã—');
            openIssues.forEach(i => {
              const d = new Date(i.updated_at).toLocaleString('ja-JP', { timeZone: process.env.TZ });
              b.push(`- #${i.number} ${i.title}ï¼ˆæ›´æ–°: ${d}ï¼‰`);
            });
            b.push('');
            b.push('> è‡ªå‹•æŠ•ç¨¿: GitHub Actionsï¼ˆæ‰‹å‹•/æ¯æ™‚ï¼‰');

            await github.rest.issues.createComment({ owner, repo, issue_number, body: b.join('\n') });
