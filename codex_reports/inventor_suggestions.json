[
  {
    "title": "Add simple alert emitter to observability (stdout/logging)",
    "file": "src/plan_data/observability.py",
    "patch": "--- a/src/plan_data/observability.py\n+++ b/src/plan_data/observability.py\n@@\n+import json as _json\n+import logging as _logging\n+import os as _os\n+import sys as _sys\n+\n+# æ—¢å­˜: NOCTRIA_OBS_MODE=stdout|off|db|auto ã®åˆ‡æ›¿ãŒã‚ã‚‹æƒ³å®š\n+# ã“ã“ã«â€œã©ã“ã‹ã‚‰ã§ã‚‚ä½¿ãˆã‚‹â€è»½é‡ç™ºç«APIã‚’è¿½åŠ ã€‚\n+\n+def emit_alert(kind: str, message: str = \"\", **fields):\n+    \"\"\"æœ€å°ã‚³ã‚¹ãƒˆã®ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç«ã€‚\n+    - stdout: 1è¡ŒJSONã§å‡ºåŠ›ï¼ˆtestsã®capture_alertsã§æ‹¾ãˆã‚‹ï¼‰\n+    - ãã®ä»–: logging.WARNING ã§ã‚‚å‡ºã™ï¼ˆä¿é™ºï¼‰\n+    \"\"\"\n+    try:\n+        payload = {\"kind\": kind, \"message\": message or \"\", **fields}\n+        mode = (_os.getenv(\"NOCTRIA_OBS_MODE\") or \"auto\").lower()\n+\n+        line = _json.dumps(payload, ensure_ascii=False)\n+        if mode in (\"stdout\", \"auto\"):  # auto ã§ DSNç„¡â†’stdout ã¨ã„ã†æ—¢å­˜æ–¹é‡ã«æ•´åˆ\n+            print(line)\n+            _sys.stdout.flush()\n+        # ã©ã®ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚WARNINGãƒ­ã‚°ã«æ®‹ã™ï¼ˆãƒ†ã‚¹ãƒˆãƒ»é‹ç”¨ã®å®‰å…¨ç¶²ï¼‰\n+        _logging.getLogger(\"noctria.alert\").warning(line)\n+    except Exception as e:  # å¤±æ•—ã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã‚’æ­¢ã‚ãªã„\n+        _logging.getLogger(\"noctria.alert\").warning(f\"emit_alert_failed: {e}\")\n"
  },
  {
    "title": "QUALITY gate: emit alerts on missing_ratio / data_lag",
    "file": "src/plan_data/quality_gate.py",
    "patch": "--- a/src/plan_data/quality_gate.py\n+++ b/src/plan_data/quality_gate.py\n@@\n from __future__ import annotations\n@@\n+from plan_data.observability import emit_alert\n@@\n-def evaluate_quality(fb, conn_str=None):\n+def evaluate_quality(fb, conn_str=None):\n     \"\"\"\n     FeatureBundle ã‹ã‚‰å“è³ªã‚’è©•ä¾¡ã—ã¦ Result ã‚’è¿”ã™ã€‚\n     æœŸå¾…å±æ€§:\n       - fb.context[\"missing_ratio\"] (0.0~1.0)\n       - fb.context[\"data_lag_min\"] (int)\n       - fb.context[\"symbol\"], fb.context[\"timeframe\"], ä»»æ„ã§ fb.context[\"trace\"]\n     \"\"\"\n     ctx = getattr(fb, \"context\", {}) or {}\n     miss = float(ctx.get(\"missing_ratio\", 0.0))\n     lag  = int(ctx.get(\"data_lag_min\", 0))\n     sym  = ctx.get(\"symbol\")\n     tf   = ctx.get(\"timeframe\")\n     trace= ctx.get(\"trace\")\n@@\n-    # ã—ãã„å€¤åˆ¤å®šï¼ˆä¾‹: æ¬ æ>10% ã‹é…å»¶>30åˆ†ã§NGï¼‰\n-    ok = not (miss >= 0.10 or lag >= 30)\n+    # ã—ãã„å€¤åˆ¤å®šï¼ˆä¾‹: æ¬ æ>10% ã‹é…å»¶>30åˆ†ã§NGï¼‰\n+    ok = not (miss >= 0.10 or lag >= 30)\n     action = \"SCALE\" if miss >= 0.10 else (\"FLAT\" if lag >= 30 else \"HOLD\")\n@@\n-    res = QualityResult(ok=ok, action=action, missing_ratio=miss, data_lag_min=lag)\n+    res = QualityResult(ok=ok, action=action, missing_ratio=miss, data_lag_min=lag)\n+\n+    # ğŸ”” æœŸå¾…ã•ã‚Œã‚‹QUALITYã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç™ºç«\n+    if miss >= 0.10:\n+        emit_alert(\n+            \"QUALITY.MISSING_RATIO\",\n+            message=f\"missing_ratio={miss:.2%}\",\n+            symbol=sym, timeframe=tf, trace=trace, missing_ratio=miss\n+        )\n+    if lag >= 30:\n+        emit_alert(\n+            \"QUALITY.DATA_LAG\",\n+            message=f\"data_lag_min={lag}\",\n+            symbol=sym, timeframe=tf, trace=trace, data_lag_min=lag\n+        )\n     return res\n"
  },
  {
    "title": "NOCTUS gate: emit alert when strategy is blocked",
    "file": "src/noctria/noctus_gate.py",
    "patch": "--- a/src/noctria/noctus_gate.py\n+++ b/src/noctria/noctus_gate.py\n@@\n from __future__ import annotations\n@@\n+from plan_data.observability import emit_alert\n@@\n-def run_strategy_and_decide(strategy, fb, conn_str=None):\n+def run_strategy_and_decide(strategy, fb, conn_str=None):\n     \"\"\"æˆ¦ç•¥ã‚’å®Ÿè¡Œã—ã€NoctusGate ã§ãƒ–ãƒ­ãƒƒã‚¯åˆ¤å®šã™ã‚‹ã€‚\"\"\"\n     decision = strategy.run(fb)\n@@\n-    if should_block(decision):\n+    if should_block(decision):\n         decision = {\"decision\": {\"decision\": {\"action\": \"REJECT\"}}}\n+        ctx = getattr(fb, \"context\", {}) or {}\n+        emit_alert(\n+            \"NOCTUS.BLOCKED\",\n+            message=\"blocked by NoctusGate\",\n+            **{k: ctx.get(k) for k in (\"symbol\", \"timeframe\", \"trace\") if k in ctx}\n+        )\n     return decision\n"
  }
]
