{% extends "base_layout.html" %}

{% block content %}
<h1>ğŸ“Š çµ±è¨ˆã‚¹ã‚³ã‚¢ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

<form method="get" action="/statistics">
  <label>æˆ¦ç•¥å:
    <select name="strategy">
      <option value="">-- å…¨ã¦ --</option>
      {% for name in strategies %}
        <option value="{{ name }}" {% if name == strategy %}selected{% endif %}>{{ name }}</option>
      {% endfor %}
    </select>
  </label>

  <label>é€šè²¨ãƒšã‚¢:
    <select name="symbol">
      <option value="">-- å…¨ã¦ --</option>
      {% for sym in symbols %}
        <option value="{{ sym }}" {% if sym == symbol %}selected{% endif %}>{{ sym }}</option>
      {% endfor %}
    </select>
  </label>

  <button type="submit">ğŸ” çµã‚Šè¾¼ã¿</button>
  <button type="button" onclick="location.href='/statistics/export'">ğŸ“¤ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
</form>

<div class="chart-toggle">
  <button onclick="switchChart('bar')">ğŸ“Š ãƒãƒ¼</button>
  <button onclick="switchChart('radar')">ğŸ§© ãƒ¬ãƒ¼ãƒ€ãƒ¼</button>
  <button onclick="switchChart('line')">ğŸ“ˆ ãƒ©ã‚¤ãƒ³</button>
</div>

<canvas id="statChart"></canvas>

<section>
  <h2>ğŸ“› ã‚¿ã‚°åˆ¥æˆ¦ç•¥æ•°</h2>
  <canvas id="tagChart"></canvas>
</section>

<table>
  <thead>
    <tr>
      <th>æˆ¦ç•¥å</th>
      <th>é€šè²¨ãƒšã‚¢</th>
      <th>å‹ç‡</th>
      <th>æœ€å¤§DD</th>
      <th>å–å¼•æ•°</th>
      <th>æ—¥ä»˜</th>
    </tr>
  </thead>
  <tbody>
    {% for stat in statistics %}
      {% set win = stat.win_rate or 0 %}
      {% set hue = 120 * (win / 100) %}
      <tr>
        <td>{{ stat.strategy }}</td>
        <td>{{ stat.symbol }}</td>
        <td style="background-color: hsl({{ hue }}, 70%, 80%)">
          {{ "%.2f"|format(win) }}%
        </td>
        <td>{{ "%.2f"|format(stat.max_drawdown or 0) }}</td>
        <td>{{ stat.num_trades or "â€•" }}</td>
        <td>{{ stat.date or "â€•" }}</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const stats = {{ statistics | tojson }};
  const tagsCount = {{ tags_count | tojson }};
  const labels = stats.map(s => s.strategy);
  const winRates = stats.map(s => s.win_rate || 0);
  const drawdowns = stats.map(s => s.max_drawdown || 0);
  const trades = stats.map(s => s.num_trades || 0);
  let chart = null;

  function renderChart(type) {
    const ctx = document.getElementById("statChart").getContext("2d");
    if (chart) chart.destroy();

    let chartData = {
      labels: labels,
      datasets: [{
        label: "å‹ç‡ (%)",
        data: winRates,
        backgroundColor: "rgba(54, 162, 235, 0.6)",
        borderColor: "rgba(54, 162, 235, 1)",
        fill: type !== "line"
      }]
    };

    if (type === "radar") {
      chartData = {
        labels: ["å‹ç‡", "æœ€å¤§DD", "å–å¼•æ•°"],
        datasets: stats.map(s => ({
          label: s.strategy,
          data: [
            s.win_rate || 0,
            s.max_drawdown || 0,
            s.num_trades || 0
          ],
          fill: true
        }))
      };
    }

    chart = new Chart(ctx, {
      type: type,
      data: chartData,
      options: {
        responsive: true,
        plugins: {
          tooltip: {
            callbacks: {
              label: function(ctx) {
                const i = ctx.dataIndex;
                const s = stats[i] || ctx.dataset;
                return `${s.strategy || ctx.dataset.label} â†’ å‹ç‡: ${s.win_rate || "?"}, DD: ${s.max_drawdown || "?"}, å–å¼•: ${s.num_trades || "?"}`;
              }
            }
          }
        },
        onClick: (e, el) => {
          if (el.length > 0) {
            const i = el[0].index;
            const name = stats[i].strategy;
            window.location.href = `/strategy/detail?name=${encodeURIComponent(name)}`;
          }
        }
      }
    });
  }

  function switchChart(type) {
    renderChart(type);
  }

  function renderTagChart() {
    const ctx = document.getElementById("tagChart").getContext("2d");
    new Chart(ctx, {
      type: "pie",
      data: {
        labels: Object.keys(tagsCount),
        datasets: [{
          label: "æˆ¦ç•¥æ•°",
          data: Object.values(tagsCount),
          backgroundColor: Object.keys(tagsCount).map((_, i) =>
            `hsl(${(i * 360 / Object.keys(tagsCount).length)}, 70%, 70%)`
          )
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "bottom" },
          tooltip: {
            callbacks: {
              label: function(ctx) {
                return `${ctx.label}: ${ctx.raw} æˆ¦ç•¥`;
              }
            }
          }
        }
      }
    });
  }

  renderChart("bar");
  renderTagChart();
</script>

{% endblock %}
