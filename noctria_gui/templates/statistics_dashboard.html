{% extends "base_layout.html" %}

{% block title %}ğŸ“Š æ¯”è¼ƒåˆ†æ - Noctria Kingdom{% endblock %}

{% block content %}
<h2 class="text-xl font-bold mb-4">ğŸ“Š æˆ¦ç•¥ãƒ»ã‚¿ã‚°æ¯”è¼ƒåˆ†æ</h2>

<!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
<form method="get" action="/statistics/compare" class="mb-6">
  <div class="flex flex-wrap gap-4 items-end">
    <div>
      <label for="mode">ğŸ“Œ ãƒ¢ãƒ¼ãƒ‰é¸æŠï¼š</label>
      <select id="mode" name="mode" onchange="this.form.submit()">
        <option value="strategy" {% if mode == "strategy" %}selected{% endif %}>ğŸ§  æˆ¦ç•¥åˆ¥</option>
        <option value="tag" {% if mode == "tag" %}selected{% endif %}>ğŸ”– ã‚¿ã‚°åˆ¥</option>
      </select>
    </div>

    <div>
      <label>ğŸ“… æœŸé–“ï¼š</label>
      <input type="date" name="from" value="{{ filter.from }}">
      ã€œ
      <input type="date" name="to" value="{{ filter.to }}">
    </div>

    <div>
      <label for="sort">ğŸ”½ ã‚½ãƒ¼ãƒˆï¼š</label>
      <select id="sort" name="sort">
        <option value="score" {% if sort == "score" %}selected{% endif %}>ğŸ“ˆ å‹ç‡ãƒ»DDé †</option>
        <option value="check" {% if sort == "check" %}selected{% endif %}>ğŸ—‚ ãƒã‚§ãƒƒã‚¯é †</option>
      </select>
    </div>
  </div>

  <div class="mt-4">
    <label>{{ "ğŸ”– ã‚¿ã‚°ä¸€è¦§ï¼š" if mode == "tag" else "ğŸ§  æˆ¦ç•¥ä¸€è¦§ï¼š" }}</label>
    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 0.5rem;">
      <button type="button" class="button" onclick="selectAll(true)">âœ… å…¨é¸æŠ</button>
      <button type="button" class="button" onclick="selectAll(false)">âŒ å…¨è§£é™¤</button>
      <span style="margin-left: 1rem;">âœ… é¸æŠæ•°: <span id="selectedCount">0</span></span><br><br>

      {% for k in all_keys %}
        <label style="display: inline-block; margin-right: 1rem;">
          <input type="checkbox" name="{{ mode }}s" value="{{ k }}" {% if k in keys %}checked{% endif %} onchange="updateCount()">
          {{ k }}
        </label>
      {% endfor %}
    </div>
  </div>

  <div class="mt-4 flex gap-2">
    <button type="submit" class="button">ğŸ“¥ è¡¨ç¤º</button>
    {% if keys %}
      <a href="/statistics/compare/export?mode={{ mode }}&from={{ filter.from }}&to={{ filter.to }}&sort={{ sort }}&{{ mode }}s={{ keys | join(',') }}" class="button">ğŸ“„ CSVå‡ºåŠ›</a>
    {% endif %}
  </div>
</form>

{% if keys %}
  <div class="mt-4 mb-6">
    <label>ğŸ”— ç¾åœ¨ã®URLï¼ˆå…±æœ‰å¯ï¼‰:</label><br>
    <input id="shareUrl" type="text" readonly style="width: 90%;" value="{{ request.url }}" />
    <button class="button" onclick="copyUrl()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
  </div>
{% endif %}

{% if results %}
  <div class="mb-6">
    <h3 class="font-semibold text-lg mb-2">ğŸ“Š çµ±è¨ˆã‚µãƒãƒª</h3>
    <ul>
      <li>ğŸ“ˆ å‹ç‡ å¹³å‡: <strong>{{ summary.avg_win_mean }}</strong>ï¼…ã€€| ä¸­å¤®å€¤: <strong>{{ summary.avg_win_median }}</strong>ï¼…</li>
      <li>ğŸ“‰ DD å¹³å‡: <strong>{{ summary.avg_dd_mean }}</strong>ï¼…ã€€| ä¸­å¤®å€¤: <strong>{{ summary.avg_dd_median }}</strong>ï¼…</li>
      <li>ğŸ“¦ ç·ä»¶æ•°: <strong>{{ summary.total_count }}</strong></li>
    </ul>
  </div>

  <div class="mb-4">
    <label for="chartTypeSelect">ğŸ“ˆ è¡¨ç¤ºå½¢å¼:</label>
    <select id="chartTypeSelect">
      <option value="bar">æ£’ã‚°ãƒ©ãƒ•</option>
      <option value="line">æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•</option>
      <option value="radar">ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ</option>
    </select>
    <button class="button ml-4" onclick="downloadCharts()">ğŸ’¾ ã‚°ãƒ©ãƒ•ç”»åƒã‚’ä¿å­˜</button>
  </div>

  <div class="overflow-x-auto">
    <table class="table-auto border border-gray-400 w-full mb-4">
      <thead class="bg-gray-200">
        <tr>
          <th class="border px-2 py-1">æ¯”è¼ƒå¯¾è±¡</th>
          <th class="border px-2 py-1">å¹³å‡å‹ç‡ï¼ˆ%ï¼‰</th>
          <th class="border px-2 py-1">å¹³å‡DDï¼ˆ%ï¼‰</th>
          <th class="border px-2 py-1">ä»¶æ•°</th>
        </tr>
      </thead>
      <tbody>
        {% for row in results %}
        <tr class="hover:bg-gray-100">
          <td class="border px-2 py-1">
            <div>
              <a href="/statistics/detail?mode={{ mode }}&key={{ row.key | urlencode }}&sort_by=date&order=desc" class="text-blue-600 hover:underline">
                {{ row.key }}
              </a><br>
              {% if mode == 'strategy' %}
                <a href="/strategy/detail?name={{ row.key | urlencode }}" class="text-sm text-gray-500 hover:underline">ğŸ” è©³ç´°</a>
              {% endif %}
            </div>
          </td>
          <td class="border px-2 py-1">{{ row.avg_win }}</td>
          <td class="border px-2 py-1">{{ row.avg_dd }}</td>
          <td class="border px-2 py-1">{{ row.count }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <canvas id="winChart" height="100"></canvas>
  <canvas id="ddChart" height="100"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const labels = {{ results | map(attribute='key') | list | tojson }};
    const winRates = {{ results | map(attribute='avg_win') | list | tojson }};
    const ddRates = {{ results | map(attribute='avg_dd') | list | tojson }};
    let winChartInstance, ddChartInstance;

    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const chartColors = {
      text: isDark ? '#eee' : '#222',
      grid: isDark ? '#444' : '#ccc',
      win: 'rgba(54, 162, 235, 0.7)',
      winBorder: 'rgba(54, 162, 235, 1)',
      dd: 'rgba(255, 99, 132, 0.7)',
      ddBorder: 'rgba(255, 99, 132, 1)'
    };

    function renderCharts(type) {
      if (winChartInstance) winChartInstance.destroy();
      if (ddChartInstance) ddChartInstance.destroy();

      const commonOptions = {
        responsive: true,
        plugins: {
          legend: { labels: { color: chartColors.text } }
        },
        scales: type !== 'radar' ? {
          y: { beginAtZero: true, ticks: { color: chartColors.text }, grid: { color: chartColors.grid } },
          x: { ticks: { color: chartColors.text }, grid: { color: chartColors.grid } }
        } : {}
      };

      winChartInstance = new Chart(document.getElementById('winChart'), {
        type,
        data: {
          labels,
          datasets: [{
            label: 'å¹³å‡å‹ç‡ï¼ˆ%ï¼‰',
            data: winRates,
            backgroundColor: chartColors.win,
            borderColor: chartColors.winBorder,
            fill: type !== 'line',
            tension: 0.2
          }]
        },
        options: commonOptions
      });

      ddChartInstance = new Chart(document.getElementById('ddChart'), {
        type,
        data: {
          labels,
          datasets: [{
            label: 'å¹³å‡DDï¼ˆ%ï¼‰',
            data: ddRates,
            backgroundColor: chartColors.dd,
            borderColor: chartColors.ddBorder,
            fill: type !== 'line',
            tension: 0.2
          }]
        },
        options: commonOptions
      });
    }

    function downloadCharts() {
      [winChartInstance, ddChartInstance].forEach((chart, i) => {
        const canvas = chart.canvas;
        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = i === 0 ? "win_chart.png" : "dd_chart.png";
        link.click();
      });
    }

    function copyUrl() {
      const input = document.getElementById("shareUrl");
      input.select();
      input.setSelectionRange(0, 99999);
      navigator.clipboard.writeText(input.value).then(() => {
        alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
      });
    }

    function selectAll(flag) {
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = flag);
      updateCount();
    }

    function updateCount() {
      const count = [...document.querySelectorAll('input[type="checkbox"]')].filter(cb => cb.checked).length;
      document.getElementById("selectedCount").textContent = count;
    }

    window.onload = function () {
      updateCount();
      renderCharts("bar");
      document.getElementById("chartTypeSelect").addEventListener("change", e => renderCharts(e.target.value));
    };
  </script>
{% endblock %}
