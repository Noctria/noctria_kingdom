{% extends "base_hud.html" %}

{% block title %}ğŸ§­ é–‹ç™ºAIã‚µã‚¤ã‚¯ãƒ«é€²æ—å±¥æ­´ - Noctria HUD{% endblock %}

{% block header_icon %}<i class="fas fa-robot"></i>{% endblock %}
{% block header_title %}é–‹ç™ºAIã‚µã‚¤ã‚¯ãƒ«é€²æ—å±¥æ­´{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸æˆ»ã‚‹{% endblock %}

{% block content %}
<section class="hud-panel">
  <h2 class="panel-title"><i class="fas fa-tasks"></i> é€²æ—ã‚µãƒãƒªãƒ¼</h2>
  <canvas id="progressChart" style="max-width: 100%; background: #131a4f; border-radius: 8px; margin-bottom: 2rem;"></canvas>
</section>

<section class="hud-panel">
  <h2 class="panel-title"><i class="fas fa-list"></i> å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«</h2>
  <div style="overflow-x:auto;">
    <table style="width:100%; border-collapse:collapse; color:var(--text-color-base); background: var(--panel-bg);">
      <thead>
        <tr>
          <th>ã‚¿ãƒ¼ãƒ³</th>
          <th>é–‹å§‹æ™‚åˆ»</th>
          <th>çµ‚äº†æ™‚åˆ»</th>
          <th>åˆæ ¼æ•°/ç·æ•°</th>
          <th>åˆæ ¼ç‡</th>
          <th>ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«</th>
          <th>ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜</th>
          <th>å¤±æ•—</th>
          <th>å‚™è€ƒ</th>
        </tr>
      </thead>
      <tbody>
      {% for row in history %}
        <tr>
          <td>{{ row['turn_number'] }}</td>
          <td>
            {% if row['started_at'] %}
              {{ row['started_at'].strftime('%Y-%m-%d %H:%M:%S') if row['started_at'].__class__.__name__ == "datetime" else row['started_at'] }}
            {% endif %}
          </td>
          <td>
            {% if row['finished_at'] %}
              {{ row['finished_at'].strftime('%Y-%m-%d %H:%M:%S') if row['finished_at'].__class__.__name__ == "datetime" else row['finished_at'] }}
            {% endif %}
          </td>
          <td>{{ row['passed_tests'] }}/{{ row['total_tests'] }}</td>
          <td>{{ row['pass_rate'] }}%</td>
          <td>{{ row['generated_files'] }}</td>
          <td>{{ row['review_comments'] }}</td>
          <td>
            {% if row['failed'] %}
              <span class="text-red">å¤±æ•—</span>
            {% else %}
              <span class="text-green">æˆåŠŸ</span>
            {% endif %}
          </td>
          <td>
            {% if row['extra_info'] and row['extra_info'] is mapping and row['extra_info'].get('note') %}
              {{ row['extra_info']['note'] }}
            {% elif row['extra_info'] and row['extra_info'] is string %}
              {{ row['extra_info'] }}
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const data = {
    labels: {{ history | map(attribute='turn_number') | list | tojson }},
    datasets: [
      {
        label: "åˆæ ¼ç‡ (%)",
        data: {{ history | map(attribute='pass_rate') | list | tojson }},
        borderColor: "#22d1ee",
        backgroundColor: "#131a4f",
        tension: 0.15,
        yAxisID: 'y1',
      },
      {
        label: "ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«æ•°",
        data: {{ history | map(attribute='generated_files') | list | tojson }},
        borderColor: "#4caf50",
        backgroundColor: "#4caf5077",
        type: 'bar',
        yAxisID: 'y2',
      }
    ]
  };
  const config = {
    type: 'line',
    data,
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { labels: { color: '#22d1ee' } } },
      scales: {
        y1: {
          type: 'linear',
          position: 'left',
          min: 0, max: 100,
          grid: { color: "#233" },
          title: { display: true, text: "åˆæ ¼ç‡(%)", color: "#22d1ee" },
          ticks: { color: "#22d1ee" }
        },
        y2: {
          type: 'linear',
          position: 'right',
          grid: { drawOnChartArea: false },
          title: { display: true, text: "ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«æ•°", color: "#4caf50" },
          ticks: { color: "#4caf50" }
        }
      }
    }
  };
  new Chart(document.getElementById('progressChart'), config);
});
</script>
{% endblock %}
