{% extends "base_hud.html" %}

{% block title %}ğŸ“œ Act History - Noctria Kingdom HUD{% endblock %}

{% block header_icon %}<i class="fas fa-scroll"></i>{% endblock %}
{% block header_title %}VERITAS ADOPTION LOG{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}DASHBOARD{% endblock %}

{% block content %}
<!-- Filter Panel -->
<section class="hud-panel filter-panel">
    <h2 class="panel-title"><i class="fas fa-filter"></i> FILTER & SEARCH</h2>
    <form method="get" action="/act-history" class="filter-form">
        <input type="text" name="strategy_name" placeholder="Strategy Name..." value="{{ request.query_params.get('strategy_name', '') }}">

        <select name="pushed">
            <option value="">Push Status...</option>
            <option value="true" {{ 'selected' if request.query_params.get('pushed') == 'true' }}>Pushed</option>
            <option value="false" {{ 'selected' if request.query_params.get('pushed') == 'false' }}>Not Pushed</option>
        </select>

        <button type="submit" class="hud-btn"><i class="fas fa-search"></i> APPLY</button>
    </form>
</section>

<!-- History Log Panel -->
<main class="hud-panel log-panel">
    <h2 class="panel-title">SYSTEM ACTIVITY LOGS</h2>
    <div class="table-wrapper">
        <table class="hud-table" id="log-table">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">æˆ¦ç•¥å <i class="fas fa-sort"></i></th>
                    <th>é€šè²¨ãƒšã‚¢</th>
                    <th onclick="sortTable(2)">æ˜‡æ ¼æ—¥æ™‚ <i class="fas fa-sort"></i></th>
                    <th onclick="sortTable(3)">å¹³å‡ã‚¹ã‚³ã‚¢ <i class="fas fa-sort"></i></th>
                    <th onclick="sortTable(4)">å‹ç‡ <i class="fas fa-sort"></i></th>
                    <th onclick="sortTable(5)">æœ€å¤§DD <i class="fas fa-sort"></i></th>
                    <th>ã‚¿ã‚°</th>
                    <th>Pushæ¸ˆ</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr>
                    <td><a href="/act-history/detail/{{ log.id }}" class="link-cyan">{{ log.strategy }}</a></td>
                    <td>{{ log.symbol }}</td>
                    <td>{{ log.promoted_at or log.timestamp }}</td>
                    <td class="text-cyan">{{ "%.2f"|format(log.score_mean) if log.score_mean is not none else '-' }}</td>
                    <td>
                        {% if log.win_rate is not none %}
                            <span class="{{ 'text-green' if log.win_rate > 70 else 'text-magenta' if log.win_rate < 50 else 'text-yellow' }}">
                                {{ "%.1f"|format(log.win_rate) }}%
                            </span>
                        {% else %}-{% endif %}
                    </td>
                    <td>{{ "%.2f"|format(log.max_drawdown) if log.max_drawdown is not none else '-' }}%</td>
                    <td>
                        {% if log.tags %}
                            {% for tag in log.tags %}
                                <span class="hud-tag">{{ tag }}</span>
                            {% endfor %}
                        {% else %}-{% endif %}
                    </td>
                    <td>
                        <span class="status-icon">{{ "âœ…" if log.pushed else "âŒ" }}</span>
                    </td>
                    <td class="action-buttons">
                        <!-- âœ… ä¿®æ­£: ãƒœã‚¿ãƒ³ã®ã‚¯ãƒ©ã‚¹ã‚’ 'hud-btn' ã«çµ±ä¸€ -->
                        <form method="post" action="/act-history/repush" class="action-form">
                            <input type="hidden" name="strategy_name" value="{{ log.strategy }}">
                            <button type="submit" class="hud-btn">
                                <i class="fas fa-rocket"></i> å†Pushå¯ã«
                            </button>
                        </form>
                        <form method="post" action="/act-history/reevaluate" class="action-form">
                            <input type="hidden" name="strategy_name" value="{{ log.strategy }}">
                            <button type="submit" class="hud-btn">
                                <i class="fas fa-sync-alt"></i> å†è©•ä¾¡
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="9" style="text-align: center;">No activity logs found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</main>

<!-- âœ… ä¿®æ­£: ãƒœã‚¿ãƒ³ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ•´ãˆã‚‹ãŸã‚ã®CSSã®ã¿æ®‹ã™ -->
<style>
    .action-buttons {
        display: flex;
        gap: 0.5rem; /* 8px */
        align-items: center;
    }
    .action-form {
        margin: 0;
    }
    .action-buttons .hud-btn {
        white-space: nowrap; /* ãƒœã‚¿ãƒ³å†…ã®ãƒ†ã‚­ã‚¹ãƒˆãŒæ”¹è¡Œã—ãªã„ã‚ˆã†ã«ã™ã‚‹ */
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    function sortTable(colIndex) {
        const table = document.getElementById("log-table");
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.rows);
        const isNumeric = [3, 4, 5].includes(colIndex);

        const currentDir = table.querySelectorAll('th')[colIndex].dataset.sortDir || 'desc';
        const newDir = currentDir === 'asc' ? 'desc' : 'asc';

        table.querySelectorAll('th').forEach(th => th.dataset.sortDir = '');
        table.querySelectorAll('th')[colIndex].dataset.sortDir = newDir;

        const sortedRows = rows.sort((a, b) => {
            const valA = a.cells[colIndex].innerText.trim().replace(/%|,/g, '');
            const valB = b.cells[colIndex].innerText.trim().replace(/%|,/g, '');
            if (valA === '-' || valB === '-') return valA === '-' ? 1 : -1;
            const numA = isNumeric ? parseFloat(valA) : valA;
            const numB = isNumeric ? parseFloat(valB) : valB;
            return newDir === 'asc' ? (numA < numB ? -1 : 1) : (numA > numB ? -1 : 1);
        });

        while (tbody.firstChild) tbody.removeChild(tbody.firstChild);
        tbody.append(...sortedRows);
    }
</script>
{% endblock %}
```

### ä¿®æ­£ç‚¹ã®è§£èª¬

* **ãƒœã‚¿ãƒ³ã®ã‚¯ãƒ©ã‚¹å¤‰æ›´:**
    ã€Œå†Pushå¯ã«ã€ã¨ã€Œå†è©•ä¾¡ã€ã®ãƒœã‚¿ãƒ³ã«é©ç”¨ã•ã‚Œã¦ã„ãŸ`btn-modern`ã‚¯ãƒ©ã‚¹ã‚’ã€`APPLY`ãƒœã‚¿ãƒ³ã¨åŒã˜`hud-btn`ã‚¯ãƒ©ã‚¹ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚
* **CSSã®ç°¡ç•¥åŒ–:**
    å‰å›ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãŸã‚ã«è¿½åŠ ã—ãŸ`<style>`ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰ã€ä¸è¦ã«ãªã£ãŸ`.btn-modern`é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚ãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ãŸã‚ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ`.action-buttons`ãªã©ï¼‰ã¯æ®‹ã—ã¦ã‚ã‚Šã¾ã™ã€‚
* **HTMLæ§‹é€ ã®æ•´ç†:**
    ãƒœã‚¿ãƒ³å†…ã®ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’`<span>`ã‚¿ã‚°ã§å›²ã‚“ã§ã„ã¾ã—ãŸãŒã€APPLYãƒœã‚¿ãƒ³ã®æ§‹é€ ã«åˆã‚ã›ã¦ã‚ˆã‚Šã‚·ãƒ³ãƒ—ãƒ«ãªå½¢ã«ã—ã¾ã—ãŸã€‚

ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ã—ã¦ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã™ã‚‹ã¨ã€ãƒœã‚¿ãƒ³ãŒçµ±ä¸€æ„Ÿã®ã‚ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³ã«å¤‰ã‚ã£ã¦ã„ã‚‹ã¯ãš
