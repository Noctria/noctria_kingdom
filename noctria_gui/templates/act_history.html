{% extends "base_hud.html" %}

{% block title %}üìú Act History - Noctria Kingdom HUD{% endblock %}

{% block header_icon %}<i class="fas fa-scroll"></i>{% endblock %}
{% block header_title %}VERITAS ADOPTION LOG{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}DASHBOARD{% endblock %}

{% block content %}
<!-- Filter Panel -->
<section class="hud-panel filter-panel">
    <h2 class="panel-title"><i class="fas fa-filter"></i> FILTER & SEARCH</h2>
    <form method="get" action="/act-history" class="filter-form">
        <input type="text" name="strategy_name" placeholder="Strategy Name..." value="{{ request.query_params.get('strategy_name', '') }}">

        <select name="pushed">
            <option value="">Push Status...</option>
            <option value="true" {{ 'selected' if request.query_params.get('pushed') == 'true' }}>Pushed</option>
            <option value="false" {{ 'selected' if request.query_params.get('pushed') == 'false' }}>Not Pushed</option>
        </select>

        <button type="submit" class="hud-btn"><i class="fas fa-search"></i> APPLY</button>
    </form>
</section>

<!-- History Log Panel -->
<main class="hud-panel log-panel">
    <h2 class="panel-title">SYSTEM ACTIVITY LOGS</h2>
    <div class="table-wrapper">
        <table class="hud-table" id="log-table">
            <thead>
                <tr>
                    <th data-sort-col="0">Êà¶Áï•Âêç <i class="fas fa-sort"></i></th>
                    <th>ÈÄöË≤®„Éö„Ç¢</th>
                    <th data-sort-col="2">ÊòáÊ†ºÊó•ÊôÇ <i class="fas fa-sort"></i></th>
                    <th data-sort-col="3">Âπ≥Âùá„Çπ„Ç≥„Ç¢ <i class="fas fa-sort"></i></th>
                    <th data-sort-col="4">ÂãùÁéá <i class="fas fa-sort"></i></th>
                    <th data-sort-col="5">ÊúÄÂ§ßDD <i class="fas fa-sort"></i></th>
                    <th>„Çø„Ç∞</th>
                    <th>PushÊ∏à</th>
                    <th>Êìç‰Ωú</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr>
                    <td><a href="/act-history/detail/{{ log.id }}" class="link-cyan">{{ log.strategy }}</a></td>
                    <td>{{ log.symbol }}</td>
                    <td>{{ log.promoted_at or log.timestamp }}</td>
                    <td class="text-cyan">{{ "%.2f"|format(log.score_mean) if log.score_mean is not none else '-' }}</td>
                    <td>
                        {% if log.win_rate is not none %}
                            <span class="{{ 'text-green' if log.win_rate > 70 else 'text-magenta' if log.win_rate < 50 else 'text-yellow' }}">
                                {{ "%.1f"|format(log.win_rate) }}%
                            </span>
                        {% else %}-{% endif %}
                    </td>
                    <td>{{ "%.2f"|format(log.max_drawdown) if log.max_drawdown is not none else '-' }}%</td>
                    <td>
                        {% if log.tags %}
                            {% for tag in log.tags %}
                                <span class="hud-tag">{{ tag }}</span>
                            {% endfor %}
                        {% else %}-{% endif %}
                    </td>
                    <td>
                        <span class="status-icon">{{ "‚úÖ" if log.pushed else "‚ùå" }}</span>
                    </td>
                    <td class="action-buttons">
                        <!-- ‚úÖ ‰øÆÊ≠£: ÈùûÂêåÊúüÂá¶ÁêÜÁî®„ÅÆ„ÇØ„É©„Çπ„ÇíËøΩÂä† -->
                        <form method="post" action="/act-history/repush" class="action-form">
                            <input type="hidden" name="strategy_name" value="{{ log.strategy }}">
                            <button type="submit" class="hud-btn">
                                <i class="fas fa-rocket"></i> ÂÜçPushÂèØ„Å´
                            </button>
                        </form>
                        <form method="post" action="/act-history/reevaluate" class="action-form">
                            <input type="hidden" name="strategy_name" value="{{ log.strategy }}">
                            <button type="submit" class="hud-btn">
                                <i class="fas fa-sync-alt"></i> ÂÜçË©ï‰æ°
                            </button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="9" style="text-align: center;">No activity logs found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</main>

<style>
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    .action-form {
        margin: 0;
    }
    .action-buttons .hud-btn {
        white-space: nowrap;
    }
    th[data-sort-col] {
        cursor: pointer;
    }
    /* „Éú„Çø„É≥„ÅÆÊàêÂäü„ÉªÂ§±ÊïóÊôÇ„ÅÆ„Çπ„Çø„Ç§„É´ */
    .hud-btn.is-success { background: #2ecc71; border-color: #2ecc71; }
    .hud-btn.is-error { background: #e74c3c; border-color: #e74c3c; }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- „ÉÜ„Éº„Éñ„É´„ÇΩ„Éº„ÉàÊ©üËÉΩ ---
    const table = document.getElementById("log-table");
    if (table) {
        const headers = table.querySelectorAll("th[data-sort-col]");
        headers.forEach(header => {
            header.addEventListener('click', () => {
                const colIndex = parseInt(header.dataset.sortCol, 10);
                sortTable(colIndex);
            });
        });
    }

    function sortTable(colIndex) {
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.rows);
        const isNumeric = [3, 4, 5].includes(colIndex);
        const header = table.querySelector(`th[data-sort-col="${colIndex}"]`);
        const currentDir = header.dataset.sortDir || 'desc';
        const newDir = currentDir === 'asc' ? 'desc' : 'asc';
        table.querySelectorAll('th').forEach(th => th.dataset.sortDir = '');
        header.dataset.sortDir = newDir;

        const sortedRows = rows.sort((a, b) => {
            const valA = a.cells[colIndex].innerText.trim().replace(/%|,/g, '');
            const valB = b.cells[colIndex].innerText.trim().replace(/%|,/g, '');
            if (valA === '-' && valB === '-') return 0;
            if (valA === '-') return 1;
            if (valB === '-') return -1;
            const numA = isNumeric ? parseFloat(valA) : valA.toLowerCase();
            const numB = isNumeric ? parseFloat(valB) : valB.toLowerCase();
            if (numA < numB) return newDir === 'asc' ? -1 : 1;
            if (numA > numB) return newDir === 'asc' ? 1 : -1;
            return 0;
        });

        const fragment = document.createDocumentFragment();
        sortedRows.forEach(row => fragment.appendChild(row));
        tbody.innerHTML = '';
        tbody.appendChild(fragment);
    }

    // --- ‚úÖ ËøΩÂä†: ÈùûÂêåÊúü„Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥Ê©üËÉΩ ---
    const actionForms = document.querySelectorAll('.action-form');
    actionForms.forEach(form => {
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const button = form.querySelector('button');
            const originalHtml = button.innerHTML;
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form)
                });

                const data = await response.json();

                if (response.ok) {
                    button.innerHTML = '‚úÖ ÊàêÂäü';
                    button.classList.add('is-success');
                } else {
                    button.innerHTML = '‚ùå Â§±Êïó';
                    button.classList.add('is-error');
                    console.error('Action failed:', data.detail);
                }
            } catch (error) {
                button.innerHTML = '‚ùå ÈÄö‰ø°„Ç®„É©„Éº';
                button.classList.add('is-error');
                console.error('Network error:', error);
            } finally {
                // 2ÁßíÂæå„Å´ÂÖÉ„ÅÆÁä∂ÊÖã„Å´Êàª„Åô
                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = originalHtml;
                    button.classList.remove('is-success', 'is-error');
                }, 2000);
            }
        });
    });
});
</script>
{% endblock %}
