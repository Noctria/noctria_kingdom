{% extends "base.html" %}
{% block title %}ğŸ“„ è©³ç´°: {{ key }} - Noctria Kingdom{% endblock %}

{% block content %}
<h2>ğŸ“„ è©³ç´°è¡¨ç¤ºï¼ˆ{{ "æˆ¦ç•¥" if mode == "strategy" else "ã‚¿ã‚°" }}ï¼‰: {{ key }}</h2>

<!-- ğŸ”½ ã‚½ãƒ¼ãƒˆé¸æŠ -->
<form method="get" action="/statistics/detail" style="margin-bottom: 1rem;">
  <input type="hidden" name="mode" value="{{ mode }}">
  <input type="hidden" name="key" value="{{ key }}">

  <label>ğŸ”ƒ ä¸¦ã³é †:</label>
  <select name="sort_by">
    <option value="date" {% if sort_by == 'date' %}selected{% endif %}>ğŸ“… æ—¥ä»˜</option>
    <option value="win_rate" {% if sort_by == 'win_rate' %}selected{% endif %}>ğŸ“ˆ å‹ç‡</option>
    <option value="max_drawdown" {% if sort_by == 'max_drawdown' %}selected{% endif %}>ğŸ“‰ æœ€å¤§DD</option>
  </select>

  <select name="order">
    <option value="asc" {% if order == 'asc' %}selected{% endif %}>æ˜‡é †</option>
    <option value="desc" {% if order == 'desc' %}selected{% endif %}>é™é †</option>
  </select>

  <button type="submit" class="button">ğŸ”„ ä¸¦ã³æ›¿ãˆ</button>
</form>

{% if results %}
  <p>ğŸ“Œ ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: <strong>{{ results | length }}</strong></p>
  <p>
    ğŸ“ˆ å¹³å‡å‹ç‡ï¼ˆ%ï¼‰:
    <strong>
      {{ results | map(attribute='win_rate') | select('!=', none) | list | sum / results|length | round(1) }}
    </strong><br>
    ğŸ“‰ å¹³å‡DDï¼ˆ%ï¼‰:
    <strong>
      {{ results | map(attribute='max_drawdown') | select('!=', none) | list | sum / results|length | round(1) }}
    </strong>
  </p>

  <!-- ğŸ“ˆ æ™‚ç³»åˆ—ã‚°ãƒ©ãƒ• -->
  <canvas id="detailChart" height="120"></canvas>

  <!-- ğŸ”¢ Binæ•°ã‚»ãƒ¬ã‚¯ãƒˆ -->
  <div style="margin-top: 2rem;">
    <label>ğŸ”¢ ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã®åŒºé–“æ•°ï¼ˆBinæ•°ï¼‰:</label>
    <select id="binCountSelect" class="button">
      <option value="5">5</option>
      <option value="10" selected>10</option>
      <option value="15">15</option>
      <option value="20">20</option>
    </select>
  </div>

  <!-- ğŸ“Š ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ  -->
  <h3>ğŸ“Š å‹ç‡ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ </h3>
  <canvas id="winHistogram" height="100"></canvas>

  <h3>ğŸ“Š æœ€å¤§DDãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ </h3>
  <canvas id="ddHistogram" height="100"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const labels = {{ results | map(attribute='date') | list | tojson }};
    const winRates = {{ results | map(attribute='win_rate') | list | tojson }};
    const ddRates = {{ results | map(attribute='max_drawdown') | list | tojson }};

    let winChart, winHistChart, ddHistChart;

    // ğŸ“ˆ æ™‚ç³»åˆ—ã‚°ãƒ©ãƒ•
    winChart = new Chart(document.getElementById('detailChart'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'å‹ç‡ï¼ˆ%ï¼‰',
            data: winRates,
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            tension: 0.3,
            yAxisID: 'y',
          },
          {
            label: 'æœ€å¤§DDï¼ˆ%ï¼‰',
            data: ddRates,
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            tension: 0.3,
            yAxisID: 'y1',
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'å‹ç‡' } },
          y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'æœ€å¤§DD' } }
        }
      }
    });

    // ğŸ“Š ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ æç”»é–¢æ•°
    function renderHistogram(data, canvasId, label, color, binCount) {
      const cleanData = data.filter(v => typeof v === 'number');
      if (cleanData.length === 0) return;

      const min = Math.min(...cleanData);
      const max = Math.max(...cleanData);
      const binWidth = (max - min) / binCount;
      const bins = new Array(binCount).fill(0);
      const binLabels = [];

      cleanData.forEach(val => {
        const index = Math.min(Math.floor((val - min) / binWidth), binCount - 1);
        bins[index]++;
      });

      for (let i = 0; i < binCount; i++) {
        const start = (min + i * binWidth).toFixed(1);
        const end = (min + (i + 1) * binWidth).toFixed(1);
        binLabels.push(`${start}ã€œ${end}`);
      }

      const ctx = document.getElementById(canvasId).getContext('2d');
      if (canvasId === 'winHistogram' && winHistChart) winHistChart.destroy();
      if (canvasId === 'ddHistogram' && ddHistChart) ddHistChart.destroy();

      const chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: binLabels,
          datasets: [{
            label: label,
            data: bins,
            backgroundColor: color
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'ä»¶æ•°' } }
          }
        }
      });

      if (canvasId === 'winHistogram') winHistChart = chart;
      if (canvasId === 'ddHistogram') ddHistChart = chart;
    }

    // ğŸ“Š åˆæœŸæç”»
    renderHistogram(winRates, 'winHistogram', 'å‹ç‡ã®åˆ†å¸ƒ', 'rgba(54, 162, 235, 0.7)', 10);
    renderHistogram(ddRates, 'ddHistogram', 'æœ€å¤§DDã®åˆ†å¸ƒ', 'rgba(255, 99, 132, 0.7)', 10);

    // ğŸ”„ Binæ•°å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById("binCountSelect").addEventListener("change", e => {
      const binCount = parseInt(e.target.value);
      renderHistogram(winRates, 'winHistogram', 'å‹ç‡ã®åˆ†å¸ƒ', 'rgba(54, 162, 235, 0.7)', binCount);
      renderHistogram(ddRates, 'ddHistogram', 'æœ€å¤§DDã®åˆ†å¸ƒ', 'rgba(255, 99, 132, 0.7)', binCount);
    });
  </script>
{% else %}
  <p>âš  ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚</p>
{% endif %}

<a href="/statistics/compare" class="button" style="margin-top: 1rem;">â† æ¯”è¼ƒãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</a>
{% endblock %}
