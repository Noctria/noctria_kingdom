{% extends "base.html" %}
{% block title %}ğŸ“Š è©³ç´°åˆ†æ - Noctria Kingdom{% endblock %}

{% block content %}
<h2>ğŸ“Š è©³ç´°åˆ†æï¼ˆ{{ mode }}: {{ key }}ï¼‰</h2>

<!-- ğŸ” ã‚½ãƒ¼ãƒˆè¨­å®š -->
<form method="get" action="/statistics/detail" style="margin-bottom: 1rem;">
  <input type="hidden" name="mode" value="{{ mode }}">
  <input type="hidden" name="key" value="{{ key }}">

  <label>ã‚½ãƒ¼ãƒˆé …ç›®:</label>
  <select name="sort_by">
    <option value="date" {% if sort_by == "date" %}selected{% endif %}>ğŸ“… æ—¥ä»˜</option>
    <option value="win_rate" {% if sort_by == "win_rate" %}selected{% endif %}>ğŸ“ˆ å‹ç‡</option>
    <option value="max_drawdown" {% if sort_by == "max_drawdown" %}selected{% endif %}>ğŸ“‰ æœ€å¤§DD</option>
  </select>

  <label style="margin-left: 1rem;">é †åº:</label>
  <select name="order">
    <option value="asc" {% if order == "asc" %}selected{% endif %}>æ˜‡é †</option>
    <option value="desc" {% if order == "desc" %}selected{% endif %}>é™é †</option>
  </select>

  <button type="submit" class="button">ğŸ”„ ä¸¦ã³æ›¿ãˆ</button>
</form>

<!-- ğŸ“„ CSVå‡ºåŠ› -->
<a class="button" href="/statistics/detail/export?mode={{ mode }}&key={{ key }}&sort_by={{ sort_by }}&order={{ order }}">ğŸ“„ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</a>

<!-- ğŸ“Š è¡¨ -->
<table style="margin-top: 1rem;">
  <thead>
    <tr>
      <th>æ—¥ä»˜</th>
      <th>å‹ç‡ï¼ˆ%ï¼‰</th>
      <th>æœ€å¤§DDï¼ˆ%ï¼‰</th>
    </tr>
  </thead>
  <tbody>
    {% for row in results %}
    <tr>
      <td>{{ row.date }}</td>
      <td>{{ row.win_rate }}</td>
      <td>{{ row.max_drawdown }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- ğŸ“ˆ æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ• -->
<h3 style="margin-top: 2rem;">ğŸ“ˆ å‹ç‡ãƒ»æœ€å¤§DDã®æ™‚ç³»åˆ—æ¨ç§»</h3>
<canvas id="lineChart" height="100"></canvas>

<!-- ğŸ“ˆ ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ  -->
<h3 style="margin-top: 2rem;">ğŸ“Š ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ </h3>
<canvas id="winHistogram" height="100"></canvas>
<canvas id="ddHistogram" height="100"></canvas>

<!-- ğŸ”¢ Binæ•°ã‚»ãƒ¬ã‚¯ãƒˆ -->
<div style="margin-top: 1rem;">
  <label>Binæ•°:</label>
  <select id="binCountSelect">
    <option value="5">5</option>
    <option value="10" selected>10</option>
    <option value="15">15</option>
    <option value="20">20</option>
  </select>
</div>

<!-- ğŸ’¾ ä¿å­˜ãƒœã‚¿ãƒ³ -->
<div style="margin-top: 1rem;">
  <button class="button" onclick="downloadChart('winHistogram', 'win_histogram.png')">ğŸ’¾ å‹ç‡ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ä¿å­˜</button>
  <button class="button" onclick="downloadChart('ddHistogram', 'dd_histogram.png')">ğŸ’¾ æœ€å¤§DDãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ä¿å­˜</button>
  <button class="button" onclick="downloadChart('lineChart', 'time_series_chart.png')">ğŸ’¾ æ™‚ç³»åˆ—ã‚°ãƒ©ãƒ•ä¿å­˜</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const rawData = {{ results | tojson }};
  let winChart = null;
  let ddChart = null;
  let lineChart = null;

  // ğŸ“ˆ æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•æç”»
  function drawLineChart() {
    const labels = rawData.map(r => r.date);
    const winData = rawData.map(r => Number(r.win_rate));
    const ddData = rawData.map(r => Number(r.max_drawdown));

    const ctx = document.getElementById("lineChart").getContext("2d");
    if (lineChart) lineChart.destroy();

    lineChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [
          {
            label: "å‹ç‡",
            data: winData,
            borderColor: "rgba(54, 162, 235, 1)",
            backgroundColor: "rgba(54, 162, 235, 0.2)",
            tension: 0.3,
            yAxisID: "y1"
          },
          {
            label: "æœ€å¤§DD",
            data: ddData,
            borderColor: "rgba(255, 99, 132, 1)",
            backgroundColor: "rgba(255, 99, 132, 0.2)",
            tension: 0.3,
            yAxisID: "y2"
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: "top" }
        },
        scales: {
          y1: {
            type: "linear",
            position: "left",
            beginAtZero: true,
            title: { display: true, text: "å‹ç‡" }
          },
          y2: {
            type: "linear",
            position: "right",
            beginAtZero: true,
            title: { display: true, text: "æœ€å¤§DD" },
            grid: { drawOnChartArea: false }
          }
        }
      }
    });
  }

  // ğŸ“Š ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ æç”»
  function renderHistogram(values, canvasId, label, color, binCount = 10) {
    const filtered = values.filter(v => typeof v === 'number' && !isNaN(v));
    if (filtered.length === 0) return;

    const min = Math.min(...filtered);
    const max = Math.max(...filtered);
    const step = (max - min) / binCount || 1;

    const bins = Array(binCount).fill(0);
    const labels = [];

    for (let i = 0; i < binCount; i++) {
      const start = min + step * i;
      const end = start + step;
      labels.push(`${start.toFixed(1)}ã€œ${end.toFixed(1)}`);
    }

    filtered.forEach(v => {
      const idx = Math.min(Math.floor((v - min) / step), binCount - 1);
      bins[idx]++;
    });

    const ctx = document.getElementById(canvasId).getContext("2d");
    if (canvasId === "winHistogram" && winChart) winChart.destroy();
    if (canvasId === "ddHistogram" && ddChart) ddChart.destroy();

    const chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: bins,
          backgroundColor: color,
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1,
              precision: 0,
              color: "#444"
            }
          },
          x: {
            ticks: { color: "#444" }
          }
        }
      }
    });

    if (canvasId === "winHistogram") winChart = chart;
    if (canvasId === "ddHistogram") ddChart = chart;
  }

  function drawAllHistograms() {
    const binCount = parseInt(document.getElementById("binCountSelect").value);
    const winRates = rawData.map(r => Number(r.win_rate));
    const drawdowns = rawData.map(r => Number(r.max_drawdown));
    renderHistogram(winRates, "winHistogram", "å‹ç‡åˆ†å¸ƒ", "rgba(54, 162, 235, 0.7)", binCount);
    renderHistogram(drawdowns, "ddHistogram", "æœ€å¤§DDåˆ†å¸ƒ", "rgba(255, 99, 132, 0.7)", binCount);
  }

  document.getElementById("binCountSelect").addEventListener("change", drawAllHistograms);

  // åˆæœŸæç”»
  drawLineChart();
  drawAllHistograms();

  function downloadChart(canvasId, filename) {
    const canvas = document.getElementById(canvasId);
    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/png", 1.0);
    link.download = filename;
    link.click();
  }
</script>
{% endblock %}
