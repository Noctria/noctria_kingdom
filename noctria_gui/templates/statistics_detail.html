{% extends "base.html" %}
{% block title %}ğŸ“Š è©³ç´°åˆ†æ - Noctria Kingdom{% endblock %}

{% block content %}
<h2>ğŸ“Š è©³ç´°åˆ†æï¼ˆ{{ mode }}: {{ key }}ï¼‰</h2>

<!-- ğŸ” ã‚½ãƒ¼ãƒˆè¨­å®š -->
<form method="get" action="/statistics/detail" style="margin-bottom: 1rem;">
  <input type="hidden" name="mode" value="{{ mode }}">
  <input type="hidden" name="key" value="{{ key }}">

  <label>ã‚½ãƒ¼ãƒˆé …ç›®:</label>
  <select name="sort_by">
    <option value="date" {% if sort_by == "date" %}selected{% endif %}>ğŸ“… æ—¥ä»˜</option>
    <option value="win_rate" {% if sort_by == "win_rate" %}selected{% endif %}>ğŸ“ˆ å‹ç‡</option>
    <option value="max_drawdown" {% if sort_by == "max_drawdown" %}selected{% endif %}>ğŸ“‰ æœ€å¤§DD</option>
  </select>

  <label style="margin-left: 1rem;">é †åº:</label>
  <select name="order">
    <option value="asc" {% if order == "asc" %}selected{% endif %}>æ˜‡é †</option>
    <option value="desc" {% if order == "desc" %}selected{% endif %}>é™é †</option>
  </select>

  <button type="submit" class="button">ğŸ”„ ä¸¦ã³æ›¿ãˆ</button>
</form>

<!-- ğŸ“„ CSVå‡ºåŠ› -->
<a class="button" href="/statistics/detail/export?mode={{ mode }}&key={{ key }}&sort_by={{ sort_by }}&order={{ order }}">ğŸ“„ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</a>

<!-- ğŸ“Š è¡¨ -->
<table style="margin-top: 1rem;">
  <thead>
    <tr>
      <th>æ—¥ä»˜</th>
      <th>å‹ç‡ï¼ˆ%ï¼‰</th>
      <th>æœ€å¤§DDï¼ˆ%ï¼‰</th>
    </tr>
  </thead>
  <tbody>
    {% for row in results %}
    <tr>
      <td>{{ row.date }}</td>
      <td>{{ row.win_rate }}</td>
      <td>{{ row.max_drawdown }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- ğŸ“˜ çµ±è¨ˆã‚µãƒãƒªè¡¨ç¤º -->
<h3 style="margin-top: 2rem;">ğŸ“˜ æŒ‡æ¨™ã®çµ±è¨ˆã‚µãƒãƒª</h3>
<table style="margin-bottom: 2rem;">
  <thead>
    <tr>
      <th>æŒ‡æ¨™</th>
      <th>ä»¶æ•°</th>
      <th>æœ€å°</th>
      <th>Q1</th>
      <th>ä¸­å¤®å€¤</th>
      <th>Q3</th>
      <th>æœ€å¤§</th>
    </tr>
  </thead>
  <tbody id="statSummary">
    <!-- JSã§æŒ¿å…¥ -->
  </tbody>
</table>

<!-- ğŸ“ˆ æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ• -->
<h3>ğŸ“ˆ å‹ç‡ãƒ»æœ€å¤§DDã®æ™‚ç³»åˆ—æ¨ç§»</h3>
<canvas id="lineChart" height="100"></canvas>

<!-- ğŸ“Š ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ  -->
<h3 style="margin-top: 2rem;">ğŸ“Š ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ </h3>
<canvas id="winHistogram" height="100"></canvas>
<canvas id="ddHistogram" height="100"></canvas>

<!-- ğŸ”¢ Binæ•°ã‚»ãƒ¬ã‚¯ãƒˆ -->
<div style="margin-top: 1rem;">
  <label>Binæ•°:</label>
  <select id="binCountSelect">
    <option value="5">5</option>
    <option value="10" selected>10</option>
    <option value="15">15</option>
    <option value="20">20</option>
  </select>
</div>

<!-- ğŸ’¾ ä¿å­˜ãƒœã‚¿ãƒ³ -->
<div style="margin-top: 1rem;">
  <button class="button" onclick="downloadChart('winHistogram', 'win_histogram.png')">ğŸ’¾ å‹ç‡ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ä¿å­˜</button>
  <button class="button" onclick="downloadChart('ddHistogram', 'dd_histogram.png')">ğŸ’¾ æœ€å¤§DDãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ä¿å­˜</button>
  <button class="button" onclick="downloadChart('lineChart', 'time_series_chart.png')">ğŸ’¾ æ™‚ç³»åˆ—ã‚°ãƒ©ãƒ•ä¿å­˜</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const rawData = {{ results | tojson }};
  let winChart, ddChart, lineChart;

  // ğŸ“˜ çµ±è¨ˆè¨ˆç®—ï¼ˆå››åˆ†ä½æ•°å«ã‚€ï¼‰
  function computeStats(values) {
    const sorted = values.filter(v => typeof v === 'number' && !isNaN(v)).sort((a, b) => a - b);
    const n = sorted.length;
    if (n === 0) return null;
    const q1 = sorted[Math.floor(n * 0.25)];
    const q2 = sorted[Math.floor(n * 0.5)];
    const q3 = sorted[Math.floor(n * 0.75)];
    return {
      count: n,
      min: sorted[0],
      q1: q1,
      median: q2,
      q3: q3,
      max: sorted[n - 1]
    };
  }

  function renderSummary() {
    const winStats = computeStats(rawData.map(r => Number(r.win_rate)));
    const ddStats = computeStats(rawData.map(r => Number(r.max_drawdown)));

    const tbody = document.getElementById("statSummary");
    tbody.innerHTML = "";

    function rowHTML(label, stats) {
      if (!stats) return `<tr><td>${label}</td><td colspan="6">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>`;
      return `
        <tr>
          <td>${label}</td>
          <td>${stats.count}</td>
          <td>${stats.min}</td>
          <td>${stats.q1}</td>
          <td>${stats.median}</td>
          <td>${stats.q3}</td>
          <td>${stats.max}</td>
        </tr>
      `;
    }

    tbody.innerHTML += rowHTML("å‹ç‡ï¼ˆ%ï¼‰", winStats);
    tbody.innerHTML += rowHTML("æœ€å¤§DDï¼ˆ%ï¼‰", ddStats);
  }

  // æ—¢å­˜ã® drawLineChart, drawAllHistograms, downloadChart é–¢æ•°ã¯çœç•¥ï¼ˆå‰å›ã¾ã§ã¨åŒã˜ï¼‰

  document.getElementById("binCountSelect").addEventListener("change", drawAllHistograms);

  // åˆæœŸæç”»
  renderSummary();
  drawLineChart();
  drawAllHistograms();
</script>
{% endblock %}
