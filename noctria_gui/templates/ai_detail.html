{% extends "base_hud.html" %}

{% block title %}👁️ AI詳細 - {{ ai_name }}{% endblock %}
{% block header_icon %}<i class="fas fa-robot"></i>{% endblock %}
{% block header_title %}AI詳細：{{ ai_name }}{% endblock %}
{% block header_nav %}
<a href="/dashboard" class="nav-item-back">
  <i class="fas fa-tachometer-alt"></i><span>ダッシュボード</span>
</a>
<a href="/strategies" class="nav-item-back" style="margin-left:1rem;">
  <i class="fas fa-scroll"></i><span>戦略一覧</span>
</a>
{% endblock %}

{% block content %}
<section class="hud-panel">
  <h2 class="panel-title">📊 {{ ai_name }} - 指標トレンド</h2>
  <div style="display:flex; gap:1.5rem; flex-wrap: wrap;">
    {% for metric in dashboard_metrics %}
    <div style="flex: 1 1 180px; background: rgba(34,38,58,0.9); border-radius: 1rem; padding: 1rem;">
      <h3>{{ metric.label }}</h3>
      <canvas id="trendChart-{{ metric.key }}" width="220" height="140"></canvas>
      <div style="margin-top: 0.4rem; color:#9fd5f7; font-weight: 600;">
        平均: {{ trend_dict[metric.key].avg or '-' }}{{ metric.unit }}
        ／ 最大: {{ trend_dict[metric.key].max or '-' }}{{ metric.unit }}
        ／ 最小: {{ trend_dict[metric.key].min or '-' }}{{ metric.unit }}
      </div>
    </div>
    {% endfor %}
  </div>
</section>

<section class="hud-panel" style="margin-top: 1rem;">
  <h2 class="panel-title">📈 {{ ai_name }} - 指標分布</h2>
  <div>
    <canvas id="distHistogram" width="900" height="180" style="max-width:100%; background:#181c2b; margin-bottom: 12px;"></canvas>
    <canvas id="distBoxplot" width="900" height="90" style="max-width:100%; background:#1a1f2f;"></canvas>
  </div>
</section>

<section class="hud-panel" style="margin-top: 1rem;">
  <h2 class="panel-title">📜 {{ ai_name }} - 戦略リスト</h2>
  <table class="hud-table">
    <thead>
      <tr>
        <th>戦略名</th>
        {% for metric in dashboard_metrics %}
        <th>{{ metric.label }}</th>
        {% endfor %}
        <th>評価日時</th>
      </tr>
    </thead>
    <tbody>
      {% for s in strategy_list %}
      <tr>
        <td>
          <a href="/strategies/detail/{{ s.strategy }}" class="hud-link" style="font-weight:600;">
            {{ s.strategy }}
          </a>
        </td>
        {% for metric in dashboard_metrics %}
        <td>{{ s[metric.key] or '-' }}</td>
        {% endfor %}
        <td>{{ s.evaluated_at }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin-plot/build/Chart.BoxPlot.min.js"></script>
<script>
{% for metric in dashboard_metrics %}
(function() {
  const ctx = document.getElementById('trendChart-{{ metric.key }}');
  if (!ctx) return;
  const labels = {{ trend_dict[metric.key].labels | tojson | safe }};
  const values = {{ trend_dict[metric.key]["values"] | tojson | safe }};
  new Chart(ctx.getContext('2d'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: '{{ metric.label }}',
        data: values,
        borderColor: '#18e1ef',
        backgroundColor: 'rgba(24,225,239,0.12)',
        pointRadius: 2,
        tension: 0.2,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: { display: true, text: '{{ metric.label }}トレンド', color: '#a8b2d1' }
      },
      scales: {
        x: { ticks: { color: '#a8b2d1' } },
        y: { ticks: { color: '#a8b2d1' }, beginAtZero: true }
      }
    }
  });
})();
{% endfor %}

(function() {
  const histCtx = document.getElementById('distHistogram');
  const boxCtx = document.getElementById('distBoxplot');
  if (!histCtx || !boxCtx) return;

  // 分布描画対象の指標キーを最初のメトリクスで安全に取得
  const metricKey = "{{ dashboard_metrics[0].key if dashboard_metrics|length > 0 else '' }}";
  const values = {{ metric_dist[metricKey] | default([]) | tojson | safe }};

  // ヒストグラムはChart.js標準にはないためプラグイン利用または代替描画検討が必要
  // ここではボックスプロットの例を示します

  new Chart(boxCtx.getContext('2d'), {
    type: 'boxplot',
    data: {
      labels: [metricKey],
      datasets: [{ label: metricKey, data: [values] }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { ticks: { color: "#a8b2d1" } }
      }
    }
  });
})();
</script>
{% endblock %}
