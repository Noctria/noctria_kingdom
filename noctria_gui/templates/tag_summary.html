{% extends "base_hud.html" %}

{% block title %}🧠 タグ別戦略統計 - Noctria Kingdom{% endblock %}

{% block header_icon %}<i class="fas fa-brain"></i>{% endblock %}
{% block header_title %}タグ別戦略統計{% endblock %}
{% block header_nav %}
<a href="/dashboard" class="nav-item-back">
  <i class="fas fa-chart-line"></i><span>ダッシュボードへ</span>
</a>
{% endblock %}

{% block content %}
  <div class="controls-panel" style="justify-content: space-between;">
    <div class="filter-form" style="flex-grow: 1;">
      <input type="text" id="tagSearch" placeholder="🔍 タグ名を検索">
      <label for="sortBy" style="color: var(--text-color-base); font-weight: 700;">ソート:</label>
      <select id="sortBy" class="hud-btn">
        <option value="strategy_count">戦略数</option>
        <option value="average_win_rate">平均勝率</option>
        <option value="average_trade_count">平均取引数</option>
        <option value="average_max_drawdown">平均最大DD</option>
      </select>
    </div>
    <div>
      <a href="/tag-summary/export" class="hud-btn">📁 CSVエクスポート</a>
    </div>
  </div>

  <div class="table-wrapper">
    <table class="hud-table" id="tagTable">
      <thead>
        <tr>
          <th>タグ</th>
          <th>戦略数</th>
          <th>平均勝率</th>
          <th>平均取引数</th>
          <th>平均最大DD</th>
          <th>戦略例</th>
        </tr>
      </thead>
      <tbody>
        {% for item in summary_data %}
        <tr>
          <td>
            <a class="tag-link" href="/tag-summary/detail?tag={{ item.tag }}" style="color: var(--glow-primary); font-weight: bold;">
              {{ item.tag }}
            </a>
          </td>
          <td>{{ item.strategy_count }}</td>
          <td>{{ item.average_win_rate }}%</td>
          <td>{{ item.average_trade_count }}</td>
          <td>{{ item.average_max_drawdown }}</td>
          <td>
            {% for strategy in item.sample_strategies %}
              <a class="strategy-link" href="/strategy/detail?name={{ strategy }}" style="color: var(--text-color-base); text-decoration: none;">
                {{ strategy }}
              </a>{% if not loop.last %}, {% endif %}
            {% endfor %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}

{% block scripts %}
<script>
  const searchInput = document.getElementById('tagSearch');
  const sortBy = document.getElementById('sortBy');
  const table = document.getElementById('tagTable');
  const rows = Array.from(table.tBodies[0].rows);

  searchInput.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase();
    rows.forEach(row => {
      const tag = row.cells[0].innerText.toLowerCase();
      row.style.display = tag.includes(query) ? '' : 'none';
    });
  });

  sortBy.addEventListener('change', () => {
    const keyIndex = {
      'strategy_count': 1,
      'average_win_rate': 2,
      'average_trade_count': 3,
      'average_max_drawdown': 4
    }[sortBy.value];

    const sorted = [...rows].sort((a, b) => {
      const valA = parseFloat(a.cells[keyIndex].innerText) || 0;
      const valB = parseFloat(b.cells[keyIndex].innerText) || 0;
      return valB - valA;
    });

    sorted.forEach(row => table.tBodies[0].appendChild(row));
  });
</script>
{% endblock %}
