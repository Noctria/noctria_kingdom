<!-- noctria_gui/templates/plan_news.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Plan News — {{ asset }}{% if event_tag %} / {{ event_tag }}{% endif %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- HUDテーマ -->
  <link rel="stylesheet" href="/static/hud_style.css">
  <!-- （任意）HUDのフォント -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <!-- 追加の最小レイアウト調整（HUDに合わせる） -->
  <style>
    .wrap { display: grid; grid-template-columns: 1fr; gap: 1.25rem; }
    .row { display: flex; gap: .6rem; align-items: center; flex-wrap: wrap; }
    .row input { padding: .4rem .6rem; background: rgba(0,0,0,.3); border: 1px solid var(--panel-border); color: var(--text-color-base); border-radius: 6px; }
    .row button { padding: .45rem .8rem; background: var(--bg-color); border: 1px solid var(--panel-border); color: var(--text-color-light); border-radius: 8px; cursor: pointer; }
    .row button:hover { box-shadow: 0 0 12px var(--glow-primary); }
    .muted { color: var(--text-color-light); opacity: .7; font-size: .85rem; }

    /* キャンバスの入れ物に固定高を与え、再描画で伸び続けるのを防止 */
    .chart-wrap { position: relative; height: 280px; }
    /* 必要なら2つ目を少し低く/高く */
    .chart-wrap.impact { height: 260px; }

    /* キャンバス自体は親の高さにフィット */
    .chart-wrap canvas { width: 100% !important; height: 100% !important; }
  </style>
</head>
<body>
  <div class="hud-container-simple">
    <!-- ヘッダー -->
    <div class="header">
      <a class="nav-item-back" href="/dashboard">← ダッシュボード</a>
      <div class="hud-title">
        <span>Plan News — <span class="text-light">{{ asset }}</span>{% if event_tag %} / <span class="text-normal">{{ event_tag }}</span>{% endif %}</span>
      </div>
    </div>

    <div class="wrap">
      <!-- Timeline パネル -->
      <section class="hud-panel">
        <div class="panel-title">News Timeline</div>
        <div class="muted">GET /api/plan/news_timeline?asset={{ asset }}</div>
        <div class="chart-wrap">
          <canvas id="timelineChart"></canvas>
        </div>
      </section>

      <!-- Event Impact パネル -->
      <section class="hud-panel">
        <div class="panel-title">Event Impact</div>
        <div class="row" style="margin-bottom:.5rem">
          <label>event_tag:
            <input id="eventTagInput" value="{{ event_tag or '' }}" placeholder="例: CPI, FOMC, BOJ">
          </label>
          <label>start: <input id="startInput" type="number" value="-3" style="width:80px"></label>
          <label>end: <input id="endInput" type="number" value="3" style="width:80px"></label>
          <button id="reloadBtn">Reload</button>
        </div>
        <div class="muted">GET /api/plan/event_impact?asset={{ asset }}&event_tag=...&start=...&end=...</div>
        <div class="chart-wrap impact">
          <canvas id="impactChart"></canvas>
        </div>
      </section>
    </div>
  </div>

  <script>
    const asset = {{ asset|tojson }};
    const initialEventTag = {{ (event_tag or "")|tojson }};

    async function fetchJson(url){
      const r = await fetch(url);
      if(!r.ok){ throw new Error(await r.text()); }
      return r.json();
    }

    // グローバル（同一キャンバスに複数Chartが重ならないよう管理）
    let timelineChart = null;
    let impactChart = null;

    // Timeline
    async function renderTimeline(){
      const url = `/api/plan/news_timeline?asset=${encodeURIComponent(asset)}`;
      const data = await fetchJson(url);
      const ctx = document.getElementById('timelineChart').getContext('2d');

      if (timelineChart && typeof timelineChart.destroy === 'function') {
        timelineChart.destroy();
      }

      timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels,
          datasets: [
            { label: 'cnt_1d', data: data.series.cnt_1d },
            { label: 'cnt_7d_ma', data: data.series.cnt_7d_ma },
            { label: 'senti_1d_avg', data: data.series.senti_1d_avg },
            { label: 'senti_7d_avg', data: data.series.senti_7d_avg },
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,   // ← 親の固定高にフィット
          interaction: { mode: 'index', intersect: false },
          scales: { y: { beginAtZero: false } }
        }
      });
    }

    // Event impact
    async function renderImpact(tag, start=-3, end=3){
      const ctx = document.getElementById('impactChart').getContext('2d');

      if (impactChart && typeof impactChart.destroy === 'function') {
        impactChart.destroy();
      }

      if(!tag){
        // イベントタグ未指定時は空グラフでリセット
        impactChart = new Chart(ctx, {
          type: 'line',
          data: { labels: [], datasets: [] },
          options: { responsive: true, maintainAspectRatio: false }
        });
        return;
      }

      const url = `/api/plan/event_impact?asset=${encodeURIComponent(asset)}&event_tag=${encodeURIComponent(tag)}&start=${start}&end=${end}`;
      const data = await fetchJson(url);

      impactChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels.map(String),
          datasets: [
            { label: 'cnt_avg', data: data.series.cnt_avg },
            { label: 'senti_avg', data: data.series.senti_avg },
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,   // ← 親の固定高にフィット
          interaction: { mode: 'index', intersect: false },
          scales: { x: { title: { display:true, text:'days from event' } } }
        }
      });
    }

    // 初期描画
    renderTimeline();
    renderImpact(initialEventTag);

    // UI: Reload
    document.getElementById('reloadBtn').addEventListener('click', () => {
      const tag = document.getElementById('eventTagInput').value.trim();
      const start = parseInt(document.getElementById('startInput').value || '-3', 10);
      const end   = parseInt(document.getElementById('endInput').value || '3', 10);
      renderImpact(tag, start, end);
    });
  </script>
</body>
</html>
