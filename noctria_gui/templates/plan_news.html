<!-- noctria_gui/templates/plan_news.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Plan News — {{ asset }}{% if event_tag %} / {{ event_tag }}{% endif %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js をCDNで -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; font-size: 20px; }
    .wrap { display: grid; grid-template-columns: 1fr; gap: 24px; }
    .card { padding: 16px; border: 1px solid #e5e7eb; border-radius: 12px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .row input, .row select { padding: 6px 10px; }
    .muted { color: #6b7280; font-size: 12px; }
  </style>
</head>
<body>
  <h1>Plan News — <strong>{{ asset }}</strong>{% if event_tag %} / <strong>{{ event_tag }}</strong>{% endif %}</h1>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div><strong>News Timeline</strong></div>
        <div class="muted">/api/plan/news_timeline?asset={{ asset }}</div>
      </div>
      <canvas id="timelineChart" height="120"></canvas>
    </div>

    <div class="card">
      <div class="row">
        <div><strong>Event Impact</strong></div>
        <label>event_tag:
          <input id="eventTagInput" value="{{ event_tag or '' }}" placeholder="例: CPI, FOMC, BOJ">
        </label>
        <label>start: <input id="startInput" type="number" value="-3" style="width:72px"></label>
        <label>end: <input id="endInput" type="number" value="3" style="width:72px"></label>
        <button id="reloadBtn">Reload</button>
      </div>
      <div class="muted">/api/plan/event_impact?asset={{ asset }}&event_tag=...&start=...&end=...</div>
      <canvas id="impactChart" height="120"></canvas>
    </div>
  </div>

  <script>
    const asset = {{ asset|tojson }};
    const initialEventTag = {{ (event_tag or "")|tojson }};

    async function fetchJson(url){
      const r = await fetch(url);
      if(!r.ok){ throw new Error(await r.text()); }
      return r.json();
    }

    // Timeline
    async function renderTimeline(){
      const url = `/api/plan/news_timeline?asset=${encodeURIComponent(asset)}`;
      const data = await fetchJson(url);
      const ctx = document.getElementById('timelineChart').getContext('2d');
      if(window.timelineChart){ window.timelineChart.destroy(); }
      window.timelineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels,
          datasets: [
            { label: 'cnt_1d', data: data.series.cnt_1d },
            { label: 'cnt_7d_ma', data: data.series.cnt_7d_ma },
            { label: 'senti_1d_avg', data: data.series.senti_1d_avg },
            { label: 'senti_7d_avg', data: data.series.senti_7d_avg },
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          scales: { y: { beginAtZero: false } }
        }
      });
    }

    // Event impact
    async function renderImpact(tag, start=-3, end=3){
      if(!tag){
        // イベントタグ未指定なら、初期表示はスキップ（空グラフ）
        const ctx = document.getElementById('impactChart').getContext('2d');
        if(window.impactChart){ window.impactChart.destroy(); }
        window.impactChart = new Chart(ctx, {
          type: 'line',
          data: { labels: [], datasets: [] },
        });
        return;
      }
      const url = `/api/plan/event_impact?asset=${encodeURIComponent(asset)}&event_tag=${encodeURIComponent(tag)}&start=${start}&end=${end}`;
      const data = await fetchJson(url);
      const ctx = document.getElementById('impactChart').getContext('2d');
      if(window.impactChart){ window.impactChart.destroy(); }
      window.impactChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels.map(String),
          datasets: [
            { label: 'cnt_avg', data: data.series.cnt_avg },
            { label: 'senti_avg', data: data.series.senti_avg },
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          scales: { x: { title: { display:true, text:'days from event' } } }
        }
      });
    }

    // 初期描画
    renderTimeline();
    renderImpact(initialEventTag);

    // UI: Reload
    document.getElementById('reloadBtn').addEventListener('click', () => {
      const tag = document.getElementById('eventTagInput').value.trim();
      const start = parseInt(document.getElementById('startInput').value || '-3', 10);
      const end   = parseInt(document.getElementById('endInput').value || '3', 10);
      renderImpact(tag, start, end);
    });
  </script>
</body>
</html>
