{% extends "base_hud.html" %}

{% block title %}ğŸ“Œ ã‚¿ã‚° Ã— æŒ‡æ¨™ãƒ©ãƒ³ã‚­ãƒ³ã‚°{% endblock %}

{% block header_icon %}<i class="fas fa-tags"></i>{% endblock %}
{% block header_title %}ã‚¿ã‚°åˆ¥æŒ‡æ¨™ãƒ©ãƒ³ã‚­ãƒ³ã‚°{% endblock %}
{% block header_nav %}
<a href="/dashboard" class="nav-item-back">
  <i class="fas fa-chart-line"></i><span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸</span>
</a>
{% endblock %}

{% block content %}
  <div class="select-container controls-panel">
    <label for="metricSelect" class="hud-btn">ğŸ“Š æŒ‡æ¨™ã‚’é¸æŠï¼š</label>
    <select id="metricSelect" class="hud-btn">
      <option value="win_rate">å‹ç‡ï¼ˆ%ï¼‰</option>
      <option value="max_drawdown">æœ€å¤§ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³ï¼ˆ%ï¼‰</option>
      <option value="num_trades">å–å¼•å›æ•°</option>
      <option value="promotion_rate">æ˜‡æ ¼ç‡</option>
    </select>
  </div>

  <div class="chart-container-half">
    <canvas id="rankingChart"></canvas>
  </div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const rawData = {{ tag_stats | tojson }};
    const metrics = {
      win_rate: {
        label: "å‹ç‡ï¼ˆ%ï¼‰",
        color: "rgba(60, 179, 113, 0.7)" // ç·‘
      },
      max_drawdown: {
        label: "æœ€å¤§ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³ï¼ˆ%ï¼‰",
        color: "rgba(220, 20, 60, 0.7)" // èµ¤
      },
      num_trades: {
        label: "å–å¼•å›æ•°",
        color: "rgba(30, 144, 255, 0.7)" // é’
      },
      promotion_rate: {
        label: "æ˜‡æ ¼ç‡",
        color: "rgba(255, 215, 0, 0.7)" // ã‚´ãƒ¼ãƒ«ãƒ‰
      }
    };

    let chartInstance = null;

    function renderChart(metric) {
      const sorted = [...rawData]
        .filter(d => d[metric] != null)
        .sort((a, b) => b[metric] - a[metric])
        .slice(0, 10);

      const labels = sorted.map(d => d.type);
      const data = sorted.map(d => d[metric]);

      const ctx = document.getElementById("rankingChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: metrics[metric].label,
            data: data,
            backgroundColor: metrics[metric].color
          }]
        },
        options: {
          responsive: true,
          indexAxis: 'y',
          plugins: {
            title: {
              display: true,
              text: `ğŸ“Œ ${metrics[metric].label} ä¸Šä½ã‚¿ã‚°`,
              font: { size: 18 }
            },
            legend: { display: false }
          },
          scales: {
            x: { beginAtZero: true }
          }
        }
      });
    }

    document.getElementById("metricSelect").addEventListener("change", (e) => {
      renderChart(e.target.value);
    });

    // åˆæœŸè¡¨ç¤º
    renderChart("win_rate");
  </script>
{% endblock %}
