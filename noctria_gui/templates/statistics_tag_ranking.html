{% extends "base_hud.html" %}

{% block title %}📌 タグ × 指標ランキング{% endblock %}

{% block header_icon %}<i class="fas fa-tags"></i>{% endblock %}
{% block header_title %}タグ別指標ランキング{% endblock %}
{% block header_nav %}
<a href="/dashboard" class="nav-item-back">
  <i class="fas fa-chart-line"></i><span>ダッシュボードへ</span>
</a>
{% endblock %}

{% block content %}
  <div class="select-container controls-panel">
    <label for="metricSelect" class="hud-btn">📊 指標を選択：</label>
    <select id="metricSelect" class="hud-btn">
      <option value="win_rate">勝率（%）</option>
      <option value="max_drawdown">最大ドローダウン（%）</option>
      <option value="num_trades">取引回数</option>
      <option value="promotion_rate">昇格率</option>
    </select>
  </div>

  <div class="chart-container-half">
    <canvas id="rankingChart"></canvas>
  </div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const rawData = {{ tag_stats | tojson }};
    const metrics = {
      win_rate: {
        label: "勝率（%）",
        color: "rgba(60, 179, 113, 0.7)" // 緑
      },
      max_drawdown: {
        label: "最大ドローダウン（%）",
        color: "rgba(220, 20, 60, 0.7)" // 赤
      },
      num_trades: {
        label: "取引回数",
        color: "rgba(30, 144, 255, 0.7)" // 青
      },
      promotion_rate: {
        label: "昇格率",
        color: "rgba(255, 215, 0, 0.7)" // ゴールド
      }
    };

    let chartInstance = null;

    function renderChart(metric) {
      const sorted = [...rawData]
        .filter(d => d[metric] != null)
        .sort((a, b) => b[metric] - a[metric])
        .slice(0, 10);

      const labels = sorted.map(d => d.type);
      const data = sorted.map(d => d[metric]);

      const ctx = document.getElementById("rankingChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: metrics[metric].label,
            data: data,
            backgroundColor: metrics[metric].color
          }]
        },
        options: {
          responsive: true,
          indexAxis: 'y',
          plugins: {
            title: {
              display: true,
              text: `📌 ${metrics[metric].label} 上位タグ`,
              font: { size: 18 }
            },
            legend: { display: false }
          },
          scales: {
            x: { beginAtZero: true }
          }
        }
      });
    }

    document.getElementById("metricSelect").addEventListener("change", (e) => {
      renderChart(e.target.value);
    });

    // 初期表示
    renderChart("win_rate");
  </script>
{% endblock %}
