<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>📌 タグ × 指標ランキング</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    /* --- Root Variables --- */
    :root {
        --bg-color: #0a192f;
        --glow-primary: #7DF9FF;
        --glow-secondary: #00e5ff;
        --accent-color-1: #7DF9FF;
        --accent-color-2: #4b90ff;
        --accent-color-3: #2c6cb5;
        --panel-bg: rgba(17, 34, 64, 0.6);
        --panel-border: rgba(0, 229, 255, 0.3);
        --panel-shadow: rgba(0, 229, 255, 0.4);
        --text-color-base: #a8b2d1;
        --text-color-title: #e6f1ff;
        --glow-effect: 0 0 4px var(--glow-primary);
        --font-family: 'Roboto Mono', Consolas, 'Courier New', monospace;
    }

    /* --- Base & Body --- */
    body {
        background-color: var(--bg-color);
        color: var(--text-color-base);
        font-family: var(--font-family);
        margin: 0;
        padding: 2rem;
        overflow: hidden;
    }

    h1 {
        color: var(--text-color-title);
        margin-bottom: 1.5rem;
        text-shadow: var(--glow-effect);
    }

    .select-container {
        margin-bottom: 2rem;
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        padding: 1rem;
        border-radius: 4px;
    }

    canvas {
        max-width: 800px;
        margin: 0 auto;
        display: block;
    }

    a {
        display: inline-block;
        margin-top: 2rem;
        text-decoration: none;
        color: var(--glow-primary);
    }

    .hud-btn {
        background: transparent;
        border: 1px solid var(--glow-primary);
        color: var(--glow-primary);
        padding: 0.75rem 1.5rem;
        font-family: var(--font-family);
        font-size: 1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
        text-shadow: var(--glow-effect);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .hud-btn:hover {
        background: var(--glow-primary);
        color: var(--bg-color);
    }

  </style>
</head>
<body>
  <h1>📌 タグ × 指標ランキング</h1>

  <div class="select-container">
    <label for="metricSelect" class="hud-btn">📊 指標を選択：</label>
    <select id="metricSelect" class="hud-btn">
      <option value="win_rate">勝率（%）</option>
      <option value="max_drawdown">最大ドローダウン（%）</option>
      <option value="num_trades">取引回数</option>
      <option value="promotion_rate">昇格率</option>
    </select>
  </div>

  <canvas id="rankingChart"></canvas>

  <p><a href="/dashboard" class="hud-btn">← ダッシュボードへ戻る</a></p>

  <script>
    const rawData = {{ tag_stats | tojson }};
    const metrics = {
      win_rate: {
        label: "勝率（%）",
        color: "rgba(60, 179, 113, 0.7)" // 緑
      },
      max_drawdown: {
        label: "最大ドローダウン（%）",
        color: "rgba(220, 20, 60, 0.7)" // 赤
      },
      num_trades: {
        label: "取引回数",
        color: "rgba(30, 144, 255, 0.7)" // 青
      },
      promotion_rate: {
        label: "昇格率",
        color: "rgba(255, 215, 0, 0.7)" // ゴールド
      }
    };

    let chartInstance = null;

    function renderChart(metric) {
      const sorted = [...rawData]
        .filter(d => d[metric] != null)
        .sort((a, b) => b[metric] - a[metric])
        .slice(0, 10);

      const labels = sorted.map(d => d.type);
      const data = sorted.map(d => d[metric]);

      const ctx = document.getElementById("rankingChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: metrics[metric].label,
            data: data,
            backgroundColor: metrics[metric].color
          }]
        },
        options: {
          responsive: true,
          indexAxis: 'y',
          plugins: {
            title: {
              display: true,
              text: `📌 ${metrics[metric].label} 上位タグ`,
              font: { size: 18 }
            },
            legend: { display: false }
          },
          scales: {
            x: { beginAtZero: true }
          }
        }
      });
    }

    document.getElementById("metricSelect").addEventListener("change", (e) => {
      renderChart(e.target.value);
    });

    // 初期表示
    renderChart("win_rate");
  </script>
</body>
</html>
