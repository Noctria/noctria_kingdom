{% extends "base_hud.html" %}

{% block title %}👑 Noctria Kingdom - Central Governance HUD{% endblock %}

{% block header_icon %}<i class="fas fa-chess-king"></i>{% endblock %}
{% block header_title %}CENTRAL GOVERNANCE HUD{% endblock %}
{% block header_nav_href %}#{% endblock %}
{% block header_nav_text %}—{% endblock %}

{% block content %}
<!-- 🔢 Key Metrics -->
<section class="hud-panel metrics">
    <h2 class="panel-title">KEY METRICS</h2>
    <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
        <div class="metric-item">
            <h3><i class="fas fa-chart-line"></i> 平均勝率</h3>
            <p class="metric-value text-green">{{ stats.avg_win_rate | round(2) }}%</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-arrow-up"></i> 採用戦略数</h3>
            <p class="metric-value">{{ stats.promoted_count }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-upload"></i> GitHubへPush済</h3>
            <p class="metric-value text-blue">{{ stats.pushed_count }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-history"></i> PDCA再評価数</h3>
            <p class="metric-value text-yellow">{{ stats.pdca_count }}</p>
        </div>
    </div>
</section>

<!-- 📈 Oracle予測グラフ -->
<section class="hud-panel">
    <h2 class="panel-title"><i class="fas fa-chart-area"></i> ORACLE予測チャート</h2>
    <div id="forecast-data-holder" data-forecast='{{ forecast | tojson }}'></div>
    <canvas id="forecastChart" height="120"></canvas>
</section>

{% endblock %}

{% block extra_scripts %}
<!-- ✅ Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ORACLE予測グラフ描画 ---
    const dataHolder = document.getElementById('forecast-data-holder');
    if (dataHolder) {
        let forecast = [];
        try {
            forecast = JSON.parse(dataHolder.getAttribute('data-forecast') || "[]");
        } catch (e) {
            console.error("ORACLE予測データのパースに失敗", e);
        }
        if (forecast.length > 0 && document.getElementById('forecastChart')) {
            const ctx = document.getElementById('forecastChart').getContext('2d');
            const labels = forecast.map(d => d.date);
            const forecasts = forecast.map(d => d.forecast);
            const lowers = forecast.map(d => d.lower);
            const uppers = forecast.map(d => d.upper);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '予測値',
                            data: forecasts,
                            borderColor: '#00e5ff',
                            backgroundColor: 'rgba(0,229,255,0.15)',
                            pointRadius: 2,
                            tension: 0.25
                        },
                        {
                            label: '下限',
                            data: lowers,
                            borderColor: 'rgba(255, 99, 132, 0.5)',
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0,
                            tension: 0.15
                        },
                        {
                            label: '上限',
                            data: uppers,
                            borderColor: 'rgba(99, 255, 132, 0.5)',
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0,
                            tension: 0.15
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, labels: { color: '#e6f1ff' } },
                        title: { display: true, text: 'Oracle予測時系列', color: '#e6f1ff' }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#a8b2d1' },
                            title: { display: true, text: '日付', color: '#a8b2d1' }
                        },
                        y: {
                            ticks: { color: '#a8b2d1' },
                            title: { display: true, text: '価格', color: '#a8b2d1' }
                        }
                    }
                }
            });
        } else {
            console.warn("forecastChart が見つからない、または forecast データが空です");
        }
    }
});
</script>
{% endblock %}
