{% extends "base_hud.html" %}

{% block title %}👑 Noctria Kingdom - Central Governance HUD{% endblock %}
{% block header_icon %}<i class="fas fa-chess-king"></i>{% endblock %}
{% block header_title %}<span class="text-normal">CENTRAL GOVERNANCE HUD</span>{% endblock %}
{% block header_nav_href %}#{% endblock %}
{% block header_nav_text %}—{% endblock %}

{% block content %}
<div id="data-holder"
     data-metrics-dict='{{ metrics_dict | tojson | safe }}'
     data-overall-metrics='{{ overall_metrics | tojson | safe }}'
     data-dashboard-metrics='{{ dashboard_metrics | tojson | safe }}'
     data-ai-names='{{ ai_names | tojson | safe }}'>
</div>

<section class="hud-panel dashboard-nav" style="padding: 1rem; margin-bottom: 1rem;">
  <h2 class="panel-title text-normal"><i class="fas fa-compass"></i> Navigation</h2>
  <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
    {% set nav_items = [
      {"href": "/strategies",               "icon": "fas fa-scroll",          "text": "戦略一覧"},
      {"href": "/strategies/compare",       "icon": "fas fa-balance-scale",   "text": "戦略比較"},
      {"href": "/pdca/summary",             "icon": "fas fa-chart-pie",       "text": "PDCAサマリー"},
      {"href": "/pdca/history",             "icon": "fas fa-history",         "text": "PDCA履歴"},
      {"href": "/ai",                       "icon": "fas fa-robot",           "text": "AI管理"},
      {"href": "/trigger",                  "icon": "fas fa-gavel",           "text": "王命発令"},
      {"href": "/act-history",              "icon": "fas fa-file-alt",        "text": "Act履歴"},
      {"href": "/push_history",             "icon": "fas fa-upload",          "text": "Push履歴"},
      {"href": "/statistics",               "icon": "fas fa-chart-bar",       "text": "統計ダッシュボード"},
      {"href": "/api/king/prometheus",      "icon": "fas fa-flask",           "text": "Prometheus学習"},
      {"href": "/plan/news?asset=USDJPY",   "icon": "fas fa-newspaper",       "text": "Plan News（USDJPY）"},
      {"href": "/backtests",                "icon": "fas fa-vial",            "text": "Backtests"},
    ] %}
    {# 🆕 Airflow成果物ビューをGUIから閲覧できるリンクを追加 #}
    {% for item in nav_items %}
      <a href="{{ item.href }}" class="hud-link">
        <i class="{{ item.icon }}" style="font-size: 1.6rem; color: var(--text-color-normal);"></i>
        <span class="text-light">{{ item.text }}</span>
      </a>
    {% endfor %}
  </div>
</section>

<section class="hud-panel" style="margin-bottom: 1rem;">
  <h2 class="panel-title text-normal"><i class="fas fa-newspaper"></i> Plan News ショートカット</h2>
  <form action="/plan/news" method="get" class="controls"
        style="display:flex; flex-wrap: wrap; gap:.75rem; align-items:center;">
    <label class="text-light">asset:
      <input name="asset" value="USDJPY" placeholder="例: USDJPY" />
    </label>
    <label class="text-light">event_tag:
      <input name="event_tag" placeholder="例: CPI / FOMC / BOJ（任意）" />
    </label>
    <button type="submit" class="hud-link" style="padding:.4rem 1rem;">
      <i class="fas fa-external-link-alt"></i> Open
    </button>
    <small class="text-light" style="margin-left:.5rem;">/plan/news?asset=...&event_tag=...</small>
  </form>
</section>

<section class="hud-panel metrics">
  <h2 class="panel-title text-normal">KEY METRICS</h2>
  <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
    <div class="metric-item">
      <h3 class="text-normal"><i class="fas fa-chart-line"></i> 平均勝率</h3>
      <p class="metric-value text-green">
        {{ overall_metrics.get('win_rate', {}).get('avg', '-') }}%
      </p>
    </div>
  </div>
</section>

<section class="hud-panel">
  <h2 class="panel-title text-normal"><i class="fas fa-rocket"></i> Prometheus クイック学習</h2>
  <p class="text-light" style="margin-bottom: .75rem;">
    ここから直接、Airflow の <code>train_prometheus_obs8</code> をトリガーします。詳細設定や最新モデルの評価は
    <a href="/api/king/prometheus">Prometheus専用ダッシュボード</a> へ。
  </p>
  <form method="post" action="/api/king/prometheus/train"
        style="display:grid; gap:.75rem; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
    <div>
      <label for="tt" class="text-light">TOTAL_TIMESTEPS</label>
      <input id="tt" name="TOTAL_TIMESTEPS" type="number" placeholder="10000" />
    </div>
    <div>
      <label class="text-light">learning_rate</label>
      <input name="learning_rate" type="text" placeholder="0.0003" />
    </div>
    <div>
      <label class="text-light">n_steps</label>
      <input name="n_steps" type="number" placeholder="2048" />
    </div>
    <div>
      <label class="text-light">batch_size</label>
      <input name="batch_size" type="number" placeholder="256" />
    </div>
    <div>
      <label class="text-light">gamma</label>
      <input name="gamma" type="text" placeholder="0.99" />
    </div>
    <div>
      <label class="text-light">eval_n_episodes</label>
      <input name="eval_n_episodes" type="number" placeholder="5" />
    </div>
    <div>
      <label class="text-light">eval_deterministic</label>
      <select name="eval_deterministic">
        <option value="true" selected>True</option>
        <option value="false">False</option>
      </select>
    </div>
    <div style="grid-column: 1 / -1; display:flex; gap:.5rem; margin-top:.25rem;">
      <button class="btn" type="submit"><i class="fas fa-paper-plane"></i> 学習を開始</button>
      <a class="btn btn--ghost" href="/api/king/prometheus"><i class="fas fa-external-link-alt"></i> 専用ダッシュボードへ</a>
    </div>
    <p class="text-light" style="grid-column:1/-1; margin:0;">未入力項目は既定値（DAG/ENV）を使用します。</p>
  </form>
</section>

<section class="hud-panel">
  <h2 class="panel-title text-normal"><i class="fas fa-chart-area"></i> ORACLE予測チャート</h2>
  <canvas id="oracleForecastChart" width="600" height="300"></canvas>
</section>

<section class="hud-panel">
  <h2 class="panel-title text-normal"><i class="fas fa-chart-bar"></i> 全AI・全指標トレンド可視化</h2>
  <canvas id="allAiMetricsChart" width="600" height="300"></canvas>
</section>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script src="/static/js/dashboard.js"></script>
{% endblock %}
