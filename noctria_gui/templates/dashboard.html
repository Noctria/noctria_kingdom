{% extends "base_hud.html" %}

{% block title %}ğŸ‘‘ Noctria Kingdom - Central Governance HUD{% endblock %}

{% block header_icon %}<i class="fas fa-chess-king"></i>{% endblock %}
{% block header_title %}CENTRAL GOVERNANCE HUD{% endblock %}
{% block header_nav_href %}#{% endblock %}
{% block header_nav_text %}â€”{% endblock %}

{% block content %}
<!-- ğŸ”¢ Key Metrics -->
<section class="hud-panel metrics">
    <h2 class="panel-title">KEY METRICS</h2>
    <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
        <div class="metric-item">
            <h3><i class="fas fa-chart-line"></i> å¹³å‡å‹ç‡</h3>
            <p class="metric-value text-green">
                {{ overall_metrics['win_rate']['avg'] if overall_metrics['win_rate'] else '-' }}%
            </p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-arrow-up"></i> æ¡ç”¨æˆ¦ç•¥æ•°</h3>
            <p class="metric-value">{{ stats.promoted_count }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-upload"></i> GitHubã¸Pushæ¸ˆ</h3>
            <p class="metric-value text-blue">{{ stats.pushed_count }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-history"></i> PDCAå†è©•ä¾¡æ•°</h3>
            <p class="metric-value text-yellow">{{ stats.pdca_count }}</p>
        </div>
    </div>
</section>

<!-- ğŸ“ˆ Oracleäºˆæ¸¬ã‚°ãƒ©ãƒ• -->
<section class="hud-panel">
    <h2 class="panel-title"><i class="fas fa-chart-area"></i> ORACLEäºˆæ¸¬ãƒãƒ£ãƒ¼ãƒˆ</h2>
    <div id="forecast-data-holder" data-forecast='{{ forecast | tojson | safe }}'></div>
    <canvas id="forecastChart" width="900" height="300" style="max-width:100%; background:#181c2b; margin:16px 0;"></canvas>
</section>

<!-- ğŸŸ¦ æŒ‡æ¨™Ã—AIãƒ»åˆ†å¸ƒãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
<section class="hud-panel">
  <h2 class="panel-title"><i class="fas fa-chart-bar"></i> å…¨AIãƒ»å…¨æŒ‡æ¨™ãƒˆãƒ¬ãƒ³ãƒ‰/åˆ†å¸ƒå¯è¦–åŒ–</h2>
  <div class="chart-mode-switcher" style="display:flex; gap:1rem; margin-bottom:.7rem;">
    <button id="tab-trend" class="mode-tab active" onclick="switchChartMode('trend')"><i class="fas fa-chart-line"></i> ãƒˆãƒ¬ãƒ³ãƒ‰</button>
    <button id="tab-dist" class="mode-tab" onclick="switchChartMode('dist')"><i class="fas fa-chart-area"></i> åˆ†å¸ƒ</button>
  </div>
  <div class="metric-switcher" style="display:flex; gap:1.1rem; margin-bottom:.9rem;">
    {% for m in dashboard_metrics %}
      <button class="metric-tab{% if loop.first %} active{% endif %}" onclick="switchMetric('{{ m.key }}')">{{ m.label }}</button>
    {% endfor %}
    <button class="metric-tab metric-tab-overall" onclick="switchAI('overall')" id="tab-overall" style="margin-left:2em;">
      <i class="fas fa-globe"></i> å…¨ä½“å¹³å‡
    </button>
  </div>
  <div class="ai-switcher" id="ai-switcher" style="margin-bottom: 1rem;">
    {% for ai in ai_names %}
      <a
        class="ai-tab{% if loop.first %} active{% endif %}"
        href="/ai/{{ ai }}"
        onclick="event.preventDefault();switchAI('{{ ai }}');window.history.pushState({}, '', '/dashboard#'+encodeURIComponent('{{ ai }}'));">
        {{ ai }}
        <span class="ai-detail-link" style="font-size:0.92em; margin-left:0.25em; color:#19c0e9; text-decoration:underline; cursor:pointer;" title="AIè©³ç´°ãƒšãƒ¼ã‚¸ã‚’é–‹ã">
          <i class="fas fa-external-link-alt"></i>
        </span>
      </a>
    {% endfor %}
  </div>
  <div id="trend-canvas-box">
    <canvas id="metricChart" width="900" height="230" style="max-width:100%; background:#181c2b; margin:16px 0;"></canvas>
  </div>
  <div id="dist-canvas-box" style="display:none;">
    <canvas id="distHistogram" width="900" height="180" style="max-width:100%; background:#181c2b; margin:12px 0 0 0;"></canvas>
    <canvas id="distBoxplot" width="900" height="90" style="max-width:100%; background:#1a1f2f; margin:0;"></canvas>
  </div>
  <div class="metric-summary" style="margin-top:1.2rem; color:#aee3fc; font-size:1.05em;">
    <span id="metric-summary-label">å¹³å‡</span>: <span id="metric-avg">-</span><span id="metric-unit"></span>
    ï¼ æœ€å¤§: <span id="metric-max">-</span><span id="metric-unit-max"></span>
    ï¼ æœ€å°: <span id="metric-min">-</span><span id="metric-unit-min"></span>
    ï¼ å‰å›å·®åˆ†: <span id="metric-diff">-</span><span id="metric-unit-diff"></span>
    <span id="metric-summary-dist"></span>
  </div>
</section>

<!-- ğŸŸ§ AIã”ã¨ã®é€²æ—ç‡ -->
<section class="hud-panel">
    <h2 class="panel-title"><i class="fas fa-bolt"></i> AIã”ã¨ã®é€²æ—ç‡</h2>
    <div class="panel-graph-row" style="display:flex;gap:2rem;flex-wrap:wrap;">
      {% for ai in ai_progress %}
      <div class="mini-panel" style="flex:1 1 220px;min-width:180px;max-width:240px; background:rgba(34,38,58,0.86); border-radius:1.2rem; padding:1rem 1.2rem; box-shadow:0 0 14px 0 #199bda38;">
        <h3 style="font-size:1.1rem;color:#7eeafc;font-weight:600;">{{ ai.name }}</h3>
        <canvas id="progress-{{ ai.id }}" width="120" height="120"></canvas>
        <div class="progress-label" style="margin-top:.7em; color:#e6f1ff;font-weight:bold;">
          {{ ai.progress }}%
          <span style="margin-left:1em; color:#aac7ff;font-weight:normal;">{{ ai.phase }}</span>
        </div>
      </div>
      {% endfor %}
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin-plot@4.0.1/dist/chartjs-chart-box-and-violin-plot.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-histogram@4.0.0/dist/chartjs-chart-histogram.min.js"></script>
<script>
const metricsDict = {{ metrics_dict | tojson | safe }};
const overallMetrics = {{ overall_metrics | tojson | safe }};
const dashboardMetrics = {{ dashboard_metrics | tojson | safe }};
const aiNames = {{ ai_names | tojson | safe }};
const aiMetricDist = {{ ai_metric_dist | tojson | safe }};
let selectedMetric = dashboardMetrics[0].key;
let selectedAI = aiNames[0];
let selectedMode = "trend"; // or "dist"

// ... Chart.jsã‚°ãƒ©ãƒ•æç”»ãƒ»UIåˆ¶å¾¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆå‰è¿°ã‚µãƒ³ãƒ—ãƒ«ã§OKï¼‰ ...
// drawMetricChart, drawDistCharts, switchMetric, switchAI, switchChartMode, showSummary ãªã©

</script>
<style>
/* HUDã‚¹ã‚¿ã‚¤ãƒ«UIã®ãƒœã‚¿ãƒ³ãƒ»ã‚¿ãƒ–é¡ã¯å‰æ²ã®styleã‚’ä½¿ã£ã¦OKã§ã™ */
.ai-tab .ai-detail-link {
    margin-left: 0.3em;
    vertical-align: middle;
    color: #19c0e9;
}
</style>
{% endblock %}
