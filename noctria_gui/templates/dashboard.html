<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>🏰 Noctria Kingdom - 中央統治ダッシュボード</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition duration-300 font-sans p-4 md:p-6">
  <header class="mb-6 flex flex-col md:flex-row justify-between items-center">
    <h1 class="text-2xl md:text-3xl font-bold">🏰 Noctria Kingdom - 中央統治ダッシュボード</h1>
    <button id="darkModeToggle" class="mt-2 md:mt-0 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">🌙 Dark Mode</button>
  </header>

  <!-- 統計HUD -->
  <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
      <h2 class="text-lg font-semibold mb-2">📈 平均勝率</h2>
      <p class="text-2xl">{{ stats.avg_win_rate }}%</p>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
      <h2 class="text-lg font-semibold mb-2">📌 採用数</h2>
      <p class="text-2xl">{{ stats.promoted_count }}</p>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
      <h2 class="text-lg font-semibold mb-2">🚀 Push数</h2>
      <p class="text-2xl">{{ stats.pushed_count }}</p>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 col-span-1 md:col-span-2">
      <h2 class="text-lg font-semibold mb-2">🔮 Oracle精度評価</h2>
      <ul class="list-disc ml-6">
        <li>RMSE: {{ stats.oracle_metrics.RMSE }}</li>
        <li>MAE: {{ stats.oracle_metrics.MAE }}</li>
        <li>MAPE: {{ stats.oracle_metrics.MAPE }}</li>
      </ul>
    </div>
  </section>

  <!-- 📤 マーケットデータ送信フォーム -->
  <section class="card mb-8 bg-white dark:bg-gray-800 rounded-xl p-6 shadow">
    <h2 class="text-xl font-semibold mb-4">📤 評議会開催フォーム</h2>
    <form id="councilForm">
      <div class="grid grid-cols-2 gap-4">
        <input type="number" name="price" placeholder="現価格" class="input" required>
        <input type="number" name="previous_price" placeholder="前回価格" class="input">
        <input type="number" name="volume" placeholder="出来高" class="input">
        <input type="number" name="spread" placeholder="スプレッド" class="input" step="0.001">
        <input type="number" name="order_block" placeholder="オーダーブロック" class="input" step="0.01">
        <input type="number" name="volatility" placeholder="ボラティリティ" class="input" step="0.01">
        <input type="text" name="trend_prediction" placeholder="トレンド予測 (bullish/bearish)" class="input">
        <input type="number" name="sentiment" placeholder="センチメント(0~1)" class="input" step="0.01">
        <input type="number" name="trend_strength" placeholder="トレンド強度" class="input" step="0.01">
        <input type="number" name="liquidity_ratio" placeholder="流動性比率" class="input" step="0.01">
        <input type="number" name="momentum" placeholder="モメンタム" class="input" step="0.01">
        <input type="number" name="short_interest" placeholder="ショート残高" class="input" step="0.01">
      </div>
      <button type="submit" class="btn mt-4">📣 評議会を開催</button>
    </form>
    <div id="councilResult" class="mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg"></div>
  </section>

  <!-- 📈 Chart.js グラフ -->
  <section class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow">
    <h2 class="text-xl font-semibold mb-4">📊 Oracle 予測チャート</h2>
    <canvas id="forecastChart" height="100"></canvas>
  </section>

  <script>
    // 🌙 ダークモード切替
    const toggle = document.getElementById('darkModeToggle');
    toggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
    });

    // 📈 Chart.js描画
    const forecast = {{ forecast | tojson }};
    const ctx = document.getElementById("forecastChart").getContext("2d");
    const chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: forecast.map(item => item.date),
        datasets: [
          { label: "予測", data: forecast.map(item => item.y_pred), borderWidth: 2 },
          { label: "下限", data: forecast.map(item => item.y_lower), borderWidth: 1, borderDash: [5, 5] },
          { label: "上限", data: forecast.map(item => item.y_upper), borderWidth: 1, borderDash: [5, 5] },
        ]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: false } }
      }
    });

    // 👑 評議会フォーム送信処理
    const councilForm = document.getElementById("councilForm");
    const resultDiv = document.getElementById("councilResult");

    councilForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(councilForm);
      const marketData = {};
      formData.forEach((v, k) => { marketData[k] = isNaN(v) ? v : Number(v); });

      resultDiv.innerHTML = "⏳ 評議会開催中…";

      const res = await fetch("/king/hold-council", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(marketData)
      });

      if (res.ok) {
        const data = await res.json();
        resultDiv.innerHTML = `
          <strong>👑 王の判断:</strong> ${data.final_decision}<br/>
          <strong>📘 Veritas:</strong> ${JSON.stringify(data.veritas)}<br/>
          <strong>📈 Prometheus:</strong> ${JSON.stringify(data.prometheus_forecast)}<br/>
          <strong>⚙ Aurus:</strong> ${data.aurus}<br/>
          <strong>🌊 Levia:</strong> ${data.levia}<br/>
          <strong>🛡 Noctus:</strong> ${data.noctus}
        `;
      } else {
        resultDiv.innerHTML = "❌ エラーが発生しました。";
      }
    });
  </script>

  <style>
    .input {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 100%;
    }
    .btn {
      background: #4b7bec;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn:hover {
      background: #3867d6;
    }
  </style>
</body>
</html>
