{% extends "base_hud.html" %}

{% block title %}ğŸ‘‘ Noctria Kingdom - Central Governance HUD{% endblock %}

{% block header_icon %}<i class="fas fa-chess-king"></i>{% endblock %}
{% block header_title %}CENTRAL GOVERNANCE HUD{% endblock %}
{% block header_nav_href %}#{% endblock %}
{% block header_nav_text %}â€”{% endblock %}

{% block content %}
<!-- ğŸ”¢ Key Metrics -->
<section class="hud-panel metrics">
    <h2 class="panel-title">KEY METRICS</h2>
    <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
        <div class="metric-item">
            <h3><i class="fas fa-chart-line"></i> å¹³å‡å‹ç‡</h3>
            <p class="metric-value text-green">{{ stats.avg_win_rate | round(2) }}%</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-arrow-up"></i> æ¡ç”¨æˆ¦ç•¥æ•°</h3>
            <p class="metric-value">{{ stats.promoted_count }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-upload"></i> GitHubã¸Pushæ¸ˆ</h3>
            <p class="metric-value text-blue">{{ stats.pushed_count }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-history"></i> PDCAå†è©•ä¾¡æ•°</h3>
            <p class="metric-value text-yellow">{{ stats.pdca_count }}</p>
        </div>
    </div>
</section>

<!-- ğŸ“ˆ Oracleäºˆæ¸¬ã‚°ãƒ©ãƒ• -->
<section class="hud-panel">
    <h2 class="panel-title"><i class="fas fa-chart-area"></i> ORACLEäºˆæ¸¬ãƒãƒ£ãƒ¼ãƒˆ</h2>
    <!-- ãƒ‡ãƒ¼ã‚¿åŸ‹ã‚è¾¼ã¿ -->
    <div id="forecast-data-holder" data-forecast='{{ forecast | tojson | safe }}'></div>
    <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºç”¨canvas -->
    <canvas id="forecastChart" width="900" height="300" style="max-width:100%; background:#181c2b; margin:16px 0;"></canvas>
</section>
{% endblock %}

{% block extra_scripts %}
<!-- Chart.js CDNï¼ˆæœ€æ–°ç‰ˆï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dataHolder = document.getElementById('forecast-data-holder');
    const canvas = document.getElementById('forecastChart');
    if (!dataHolder || !canvas) {
        console.warn("å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼");
        return;
    }
    let forecastData = [];
    try {
        forecastData = JSON.parse(dataHolder.dataset.forecast || "[]");
        console.log("ğŸ“Š ORACLEãƒ‡ãƒ¼ã‚¿", forecastData);
    } catch (e) {
        console.error("ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹å¤±æ•—", e);
        return;
    }
    if (!Array.isArray(forecastData) || forecastData.length === 0) {
        canvas.parentElement.innerHTML = "<div style='color:#fff'>No forecast data.</div>";
        return;
    }

    const labels = forecastData.map(d => d.date);
    const forecasts = forecastData.map(d => d.forecast);
    const lowers = forecastData.map(d => d.lower);
    const uppers = forecastData.map(d => d.upper);

    new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'äºˆæ¸¬å€¤',
                    data: forecasts,
                    borderColor: '#00e5ff',
                    backgroundColor: 'rgba(0,229,255,0.12)',
                    pointRadius: 3,
                    tension: 0.25,
                    fill: false,
                },
                {
                    label: 'ä¸‹é™',
                    data: lowers,
                    borderColor: 'rgba(255, 99, 132, 0.5)',
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0,
                    tension: 0.2
                },
                {
                    label: 'ä¸Šé™',
                    data: uppers,
                    borderColor: 'rgba(99, 255, 132, 0.5)',
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0,
                    tension: 0.2
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true, labels: { color: '#e6f1ff' } },
                title: { display: true, text: 'Oracleäºˆæ¸¬æ™‚ç³»åˆ—', color: '#e6f1ff' }
            },
            scales: {
                x: {
                    ticks: { color: '#a8b2d1' },
                    title: { display: true, text: 'æ—¥ä»˜', color: '#a8b2d1' }
                },
                y: {
                    ticks: { color: '#a8b2d1' },
                    title: { display: true, text: 'ä¾¡æ ¼', color: '#a8b2d1' }
                }
            }
        }
    });
});
</script>
{% endblock %}
