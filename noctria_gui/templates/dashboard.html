<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ° Noctria Kingdom - ä¸­å¤®çµ±æ²»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
    .input {
      padding: 0.75rem;
      border: 1px solid #d1d5db; /* gray-300 */
      border-radius: 8px;
      width: 100%;
      background-color: #f9fafb; /* gray-50 */
      color: #111827; /* gray-900 */
    }
    .dark .input {
      border-color: #4b5563; /* gray-600 */
      background-color: #374151; /* gray-700 */
      color: #f9fafb; /* gray-50 */
    }
    .btn {
      background-color: #2563eb; /* blue-600 */
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
    }
    .btn:hover {
      background-color: #1d4ed8; /* blue-700 */
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition duration-300 font-sans">
  <div class="container mx-auto p-4 md:p-6">
    <header class="mb-6 flex flex-col md:flex-row justify-between items-center">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">ğŸ° ä¸­å¤®çµ±æ²»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <button id="darkModeToggle" class="mt-2 md:mt-0 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <span class="light-mode-icon">ğŸŒ™</span>
        <span class="dark-mode-icon hidden">â˜€ï¸</span>
      </button>
    </header>

    <!-- çµ±è¨ˆHUD -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-5">
        <h2 class="text-lg font-semibold text-gray-600 dark:text-gray-400 mb-2">ğŸ“ˆ å¹³å‡å‹ç‡</h2>
        <p class="text-3xl font-bold text-green-500">{{ stats.avg_win_rate | round(2) }}%</p>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-5">
        <h2 class="text-lg font-semibold text-gray-600 dark:text-gray-400 mb-2">ğŸ“Œ æ¡ç”¨æˆ¦ç•¥æ•°</h2>
        <p class="text-3xl font-bold text-blue-500">{{ stats.promoted_count }}</p>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-5">
        <h2 class="text-lg font-semibold text-gray-600 dark:text-gray-400 mb-2">ğŸš€ Pushå®Ÿè¡Œæ•°</h2>
        <p class="text-3xl font-bold text-purple-500">{{ stats.pushed_count }}</p>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-5">
        <h2 class="text-lg font-semibold text-gray-600 dark:text-gray-400 mb-2">ğŸ”® Oracleç²¾åº¦ (RMSE)</h2>
        <p class="text-3xl font-bold text-yellow-500">{{ stats.oracle_metrics.RMSE | round(4) }}</p>
      </div>
    </section>

    <!-- ğŸ“¤ è©•è­°ä¼šé–‹å‚¬ãƒ•ã‚©ãƒ¼ãƒ  -->
    <section class="mb-8 bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
      <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">ğŸ“¤ è©•è­°ä¼šé–‹å‚¬ãƒ•ã‚©ãƒ¼ãƒ </h2>
      <form id="councilForm">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <input type="number" name="price" placeholder="ç¾ä¾¡æ ¼" class="input" required step="any" />
          <input type="number" name="previous_price" placeholder="å‰å›ä¾¡æ ¼" class="input" step="any" />
          <input type="number" name="volume" placeholder="å‡ºæ¥é«˜" class="input" step="any" />
          <input type="number" name="spread" placeholder="ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰" class="input" step="0.001" />
          <input type="number" name="order_block" placeholder="ã‚ªãƒ¼ãƒ€ãƒ¼ãƒ–ãƒ­ãƒƒã‚¯" class="input" step="0.01" />
          <input type="number" name="volatility" placeholder="ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£" class="input" step="0.01" />
          <input type="text" name="trend_prediction" placeholder="ãƒˆãƒ¬ãƒ³ãƒ‰äºˆæ¸¬ (bullish/bearish)" class="input" />
          <input type="number" name="sentiment" placeholder="ã‚»ãƒ³ãƒãƒ¡ãƒ³ãƒˆ(0~1)" class="input" step="0.01" />
          <input type="number" name="trend_strength" placeholder="ãƒˆãƒ¬ãƒ³ãƒ‰å¼·åº¦" class="input" step="0.01" />
          <input type="number" name="liquidity_ratio" placeholder="æµå‹•æ€§æ¯”ç‡" class="input" step="0.01" />
          <input type="number" name="momentum" placeholder="ãƒ¢ãƒ¡ãƒ³ã‚¿ãƒ " class="input" step="0.01" />
          <input type="number" name="short_interest" placeholder="ã‚·ãƒ§ãƒ¼ãƒˆæ®‹é«˜" class="input" step="0.01" />
        </div>
        <button type="submit" class="btn mt-6 w-full md:w-auto">ğŸ“£ è©•è­°ä¼šã‚’é–‹å‚¬</button>
      </form>
      <div id="councilResult" class="mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg min-h-[50px] font-mono text-sm"></div>
    </section>

    <!-- ğŸ“ˆ Chart.js ã‚°ãƒ©ãƒ• -->
    <section class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
      <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">ğŸ“Š Oracle äºˆæ¸¬ãƒãƒ£ãƒ¼ãƒˆ</h2>
      <!-- ä¿®æ­£ç‚¹: ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹ãŸã‚ã®divè¦ç´ ã‚’è¿½åŠ  -->
      <div id="forecastDataContainer" data-forecast='{{ forecast | tojson | safe }}' style="display: none;"></div>
      <canvas id="forecastChart"></canvas>
    </section>
  </div>

  <script>
    // ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    const darkModeToggle = document.getElementById('darkModeToggle');
    const body = document.body;
    const lightIcon = darkModeToggle.querySelector('.light-mode-icon');
    const darkIcon = darkModeToggle.querySelector('.dark-mode-icon');

    if (localStorage.getItem('darkMode') === 'enabled') {
        body.classList.add('dark');
        lightIcon.classList.add('hidden');
        darkIcon.classList.remove('hidden');
    }

    darkModeToggle.addEventListener('click', () => {
      body.classList.toggle('dark');
      if (body.classList.contains('dark')) {
        localStorage.setItem('darkMode', 'enabled');
        lightIcon.classList.add('hidden');
        darkIcon.classList.remove('hidden');
      } else {
        localStorage.setItem('darkMode', 'disabled');
        lightIcon.classList.remove('hidden');
        darkIcon.classList.add('hidden');
      }
      // ãƒãƒ£ãƒ¼ãƒˆã‚’å†æç”»ã—ã¦ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
      forecastChart.options.scales.x.ticks.color = body.classList.contains('dark') ? '#e5e7eb' : '#6b7280';
      forecastChart.options.scales.y.ticks.color = body.classList.contains('dark') ? '#e5e7eb' : '#6b7280';
      forecastChart.options.plugins.legend.labels.color = body.classList.contains('dark') ? '#e5e7eb' : '#6b7280';
      forecastChart.update();
    });

    // ğŸ“ˆ Chart.jsæç”»
    // ä¿®æ­£ç‚¹: dataå±æ€§ã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    const forecastDataElement = document.getElementById('forecastDataContainer');
    const forecastData = JSON.parse(forecastDataElement.dataset.forecast);

    const ctx = document.getElementById("forecastChart").getContext("2d");
    const forecastChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: forecastData.map(item => item.date),
        datasets: [
          {
            label: "å®Ÿç¸¾",
            data: forecastData.map(item => item.y_actual),
            borderColor: 'rgb(34, 197, 94)', // green-500
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            borderWidth: 2,
            fill: true,
          },
          {
            label: "äºˆæ¸¬",
            data: forecastData.map(item => item.y_pred),
            borderColor: 'rgb(59, 130, 246)', // blue-500
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 2,
            fill: true,
          },
          {
            label: "äºˆæ¸¬ä¸‹é™",
            data: forecastData.map(item => item.y_lower),
            borderWidth: 1,
            borderDash: [5, 5],
            fill: false,
            borderColor: 'rgba(147, 197, 253, 0.8)', // blue-300
            pointRadius: 0,
          },
          {
            label: "äºˆæ¸¬ä¸Šé™",
            data: forecastData.map(item => item.y_upper),
            borderWidth: 1,
            borderDash: [5, 5],
            fill: '-1', // ä¸Šä¸‹é™ã®é–“ã‚’å¡—ã‚‹
            borderColor: 'rgba(147, 197, 253, 0.8)',
            backgroundColor: 'rgba(147, 197, 253, 0.2)',
            pointRadius: 0,
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: { color: body.classList.contains('dark') ? '#e5e7eb' : '#6b7280' }
          },
          y: {
            beginAtZero: false,
            ticks: { color: body.classList.contains('dark') ? '#e5e7eb' : '#6b7280' }
          }
        },
        plugins: {
          legend: {
            labels: { color: body.classList.contains('dark') ? '#e5e7eb' : '#6b7280' }
          }
        }
      }
    });

    // ğŸ‘‘ è©•è­°ä¼šãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
    const councilForm = document.getElementById("councilForm");
    const resultDiv = document.getElementById("councilResult");

    councilForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(councilForm);
      const marketData = {};
      formData.forEach((value, key) => {
        if (value === null || value === "") return;
        const num = Number(value);
        marketData[key] = isNaN(num) ? value : num;
      });

      resultDiv.innerHTML = "â³ è©•è­°ä¼šé–‹å‚¬ä¸­â€¦";

      try {
        const res = await fetch("/king/hold-council", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(marketData)
        });

        const data = await res.json();
        if (res.ok) {
          resultDiv.innerHTML = `
            <strong class="text-green-500">ğŸ‘‘ ç‹ã®åˆ¤æ–­: ${data.final_decision}</strong><br/>
            <span>ğŸ“˜ Veritas: ${data.veritas.decision} (Score: ${data.veritas.score})</span><br/>
            <span>ğŸ“ˆ Prometheus: ${data.prometheus_forecast.prediction}</span><br/>
            <span>...</span>
          `;
        } else {
          resultDiv.innerHTML = `<strong class="text-red-500">âŒ ã‚¨ãƒ©ãƒ¼: ${data.detail || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}</strong>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<strong class="text-red-500">âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}</strong>`;
      }
    });
  </script>
</body>
</html>
