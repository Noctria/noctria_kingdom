{% extends "base_hud.html" %}

{% block title %}ğŸ‘‘ Noctria Kingdom - Central Governance HUD{% endblock %}

{% block header_icon %}<i class="fas fa-chess-king"></i>{% endblock %}
{% block header_title %}CENTRAL GOVERNANCE HUD{% endblock %}
{% block header_nav_href %}#{% endblock %}
{% block header_nav_text %}â€”{% endblock %}

{% block content %}
<section class="hud-panel metrics">
    <h2 class="panel-title">KEY METRICS</h2>
    <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
        <div class="metric-item">
            <h3><i class="fas fa-chart-line"></i> å¹³å‡å‹ç‡</h3>
            <p class="metric-value text-green">{{ stats.avg_win_rate | round(2) }}%</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-check-double"></i> æ¡ç”¨æˆ¦ç•¥æ•°</h3>
            <p class="metric-value text-green">{{ stats.promoted_count }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-rocket"></i> PUSHå®Ÿè¡Œæ•°</h3>
            <p class="metric-value text-magenta">{{ stats.pushed_count }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-brain"></i> ORACLE RMSE</h3>
            {% if stats.oracle_metrics and stats.oracle_metrics.RMSE is defined %}
                <p class="metric-value text-yellow">{{ stats.oracle_metrics.RMSE | round(4) }}</p>
            {% else %}
                <p class="metric-value text-yellow">â€”</p>
            {% endif %}
        </div>
    </div>
</section>

<section class="hud-panel chart-panel">
    <h2 class="panel-title"><i class="fas fa-chart-area"></i> ORACLE PREDICTION ANALYSIS</h2>
    <div style="height: 300px;">
        <canvas id="forecastChart"></canvas>
    </div>
</section>

<section class="hud-panel navigation">
    <h2 class="panel-title"><i class="fas fa-compass"></i> NAVIGATION</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
        <a href="/statistics/dashboard" class="nav-item"><i class="fas fa-chart-pie"></i><span>çµ±è¨ˆDB</span></a>
        <a href="/strategies/compare" class="nav-item"><i class="fas fa-balance-scale"></i><span>æˆ¦ç•¥æ¯”è¼ƒ</span></a>
        <a href="/act-history" class="nav-item"><i class="fas fa-history"></i><span>Actå±¥æ­´</span></a>
        <a href="/upload-strategy" class="nav-item"><i class="fas fa-upload"></i><span>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span></a>
        <a href="/pdca/summary" class="nav-item"><i class="fas fa-sync-alt"></i><span>PDCA</span></a>
        <a href="/trigger" class="nav-item"><i class="fas fa-bullhorn"></i><span>ç‹å‘½ç™ºä»¤</span></a>
    </div>
</section>

<section class="hud-panel council-form">
    <h2 class="panel-title"><i class="fas fa-gavel"></i> HOLD COUNCIL</h2>
    <form id="councilForm">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem;">
            <input type="number" name="price" placeholder="PRICE" required step="any" />
            <input type="number" name="volume" placeholder="VOLUME" step="any" />
            <input type="number" name="volatility" placeholder="VOLATILITY" step="0.01" />
            <input type="text" name="trend_prediction" placeholder="TREND (bull/bear)" />
        </div>
        <button type="submit" class="hud-btn">EXECUTE</button>
    </form>
    <div id="councilResult" class="council-result">Awaiting command...</div>
</section>

<script type="application/json" id="forecast-data">
    {{ forecast | default([]) | tojson | safe }}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
{% raw %}
document.addEventListener('DOMContentLoaded', () => {
    // âœ… system-time ã« null ãƒã‚§ãƒƒã‚¯ä»˜ãã§å¯¾å¿œ
    const timeElement = document.getElementById('system-time');
    function updateTime() {
        if (timeElement) {
            const now = new Date();
            const options = {
                timeZone: 'Asia/Tokyo', year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            };
            const formatter = new Intl.DateTimeFormat('en-CA', options);
            const jstString = formatter.format(now).replace(', ', ' ');
            timeElement.textContent = `${jstString} JST`;
        }
    }
    setInterval(updateTime, 1000);
    updateTime();

    // âœ… ä¿®æ­£: Forecast Chart ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å˜ä¸€ã® try...catch ã«é›†ç´„
    const chartContainer = document.getElementById("forecastChart").parentElement;
    try {
        const rawData = document.getElementById("forecast-data")?.textContent;
        const forecastData = JSON.parse(rawData);

        // ãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—ã§ãªã„ã€ã¾ãŸã¯ç©ºã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹
        if (!Array.isArray(forecastData) || forecastData.length === 0) {
            throw new Error("ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ãŒç©ºã€ã¾ãŸã¯ä¸æ­£ãªå½¢å¼ã§ã™ã€‚");
        }

        // ã‚°ãƒ©ãƒ•æç”»
        const ctx = document.getElementById("forecastChart").getContext("2d");
        const labels = forecastData.map(d => d.date);
        const forecast = forecastData.map(d => d.forecast);
        const lower = forecastData.map(d => d.y_lower);
        const upper = forecastData.map(d => d.y_upper);

        new Chart(ctx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [
                    {
                        label: "äºˆæ¸¬å€¤",
                        data: forecast,
                        borderColor: "rgba(0, 153, 255, 1)",
                        backgroundColor: "rgba(0, 153, 255, 0.2)",
                        pointRadius: 2,
                        fill: false,
                        tension: 0.3,
                    },
                    {
                        label: "ä¿¡é ¼åŒºé–“", // å‡¡ä¾‹ã‚’ä¸€ã¤ã«ã¾ã¨ã‚ã‚‹
                        data: upper, // ä¸Šé™ãƒ‡ãƒ¼ã‚¿ã‚’ä»£è¡¨ã¨ã—ã¦ä½¿ç”¨
                        borderColor: "rgba(0, 153, 255, 0.0)",
                        backgroundColor: "rgba(0, 153, 255, 0.15)",
                        fill: '+1', // âœ… ä¿®æ­£: æ­£ã—ãã¯ `+1` ã§ã¯ãªãã€æ¬¡ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã€ç‰¹å®šã®å¢ƒç•Œã‚’æŒ‡å®š
                        pointRadius: 0,
                    },
                    {
                        label: "ä¿¡é ¼åŒºé–“ï¼ˆä¸‹é™ï¼‰",
                        data: lower,
                        borderColor: "rgba(0, 153, 255, 0.0)",
                        backgroundColor: "rgba(0, 153, 255, 0.15)",
                        fill: '-1', // ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‹ã‚‰ä¸€ã¤å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¾ã§ã®é–“ã‚’åŸ‹ã‚ã‚‹
                        pointRadius: 0,
                        tension: 0.3,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'day' },
                        ticks: { color: '#a8b2d1' },
                        grid: { color: 'rgba(0, 229, 255, 0.2)', borderDash: [2, 4] }
                    },
                    y: {
                        ticks: { color: '#a8b2d1' },
                        grid: { color: 'rgba(0, 229, 255, 0.2)' }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: '#e6f1ff' }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 30, 60, 0.8)',
                        borderColor: '#00e5ff',
                        borderWidth: 1
                    }
                }
            }
        });

    } catch (e) {
        // JSONã®ãƒ‘ãƒ¼ã‚¹å¤±æ•—ã€ãƒ‡ãƒ¼ã‚¿ãŒç©ºã€ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã‚’ã™ã¹ã¦ã“ã“ã§æ•æ‰
        console.error("ã‚°ãƒ©ãƒ•ã®æç”»ã«å¤±æ•—:", e);
        chartContainer.innerHTML = `<p style='color: #ff4d4d; font-weight: bold; text-align: center;'>âš ï¸ äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</p><p style='color: #a8b2d1; font-size: 0.8em; text-align: center;'>(${e.message})</p>`;
    }

    // Council Submission
    const form = document.getElementById("councilForm");
    const resultDiv = document.getElementById("councilResult");
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const payload = {};
        formData.forEach((v, k) => {
            if (v === "") return;
            const num = Number(v);
            payload[k] = isNaN(num) ? v : num;
        });
        resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Executing Council...';
        try {
            const res = await fetch("/dashboard/king/hold-council", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            resultDiv.textContent = res.ok
                ? `Decision: ${data.final_decision}`
                : `Error: ${data.detail || 'Unknown'}`;
        } catch (err) {
            resultDiv.textContent = `Communication Error: ${err.message}`;
        }
    });
});
{% endraw %}
</script>
{% endblock %}
