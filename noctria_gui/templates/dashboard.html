{% extends "base_hud.html" %}

{% block title %}ğŸ‘‘ Noctria Kingdom - Central Governance HUD{% endblock %}
{% block header_icon %}<i class="fas fa-chess-king"></i>{% endblock %}
{% block header_title %}CENTRAL GOVERNANCE HUD{% endblock %}
{% block header_nav_href %}#{% endblock %}
{% block header_nav_text %}â€”{% endblock %}

{% block content %}
<section class="hud-panel metrics">
  <h2 class="panel-title">KEY METRICS</h2>
  <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
    <div class="metric-item">
      <h3><i class="fas fa-chart-line"></i> å¹³å‡å‹ç‡</h3>
      <p class="metric-value text-green">
        {{ overall_metrics['win_rate']['avg'] if overall_metrics['win_rate'] else '-' }}%
      </p>
    </div>
    <div class="metric-item">
      <h3><i class="fas fa-arrow-up"></i> æ¡ç”¨æˆ¦ç•¥æ•°</h3>
      <p class="metric-value">{{ stats.promoted_count }}</p>
    </div>
    <div class="metric-item">
      <h3><i class="fas fa-upload"></i> GitHubã¸Pushæ¸ˆ</h3>
      <p class="metric-value text-blue">{{ stats.pushed_count }}</p>
    </div>
    <div class="metric-item">
      <h3><i class="fas fa-history"></i> PDCAå†è©•ä¾¡æ•°</h3>
      <p class="metric-value text-yellow">{{ stats.pdca_count }}</p>
    </div>
  </div>
</section>

<section class="hud-panel">
  <h2 class="panel-title"><i class="fas fa-chart-area"></i> ORACLEäºˆæ¸¬ãƒãƒ£ãƒ¼ãƒˆ</h2>
  <!-- â–¼â–¼â–¼ ä¿®æ­£ç‚¹: JavaScriptã«æ¸¡ã™å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã®divã«é›†ç´„ â–¼â–¼â–¼ -->
  <div id="data-holder" 
       style="display:none;"
       data-metrics-dict='{{ metrics_dict | tojson | safe }}'
       data-overall-metrics='{{ overall_metrics | tojson | safe }}'
       data-dashboard-metrics='{{ dashboard_metrics | tojson | safe }}'
       data-ai-names='{{ ai_names | tojson | safe }}'
       data-ai-metric-dist='{{ ai_metric_dist | tojson | safe }}'
       data-forecast='{{ forecast | tojson | safe }}'
  ></div>
  <canvas id="forecastChart" width="900" height="300" style="max-width:100%; background:#181c2b; margin:16px 0;"></canvas>
</section>

<section class="hud-panel">
  <h2 class="panel-title"><i class="fas fa-chart-bar"></i> å…¨AIãƒ»å…¨æŒ‡æ¨™ãƒˆãƒ¬ãƒ³ãƒ‰/åˆ†å¸ƒå¯è¦–åŒ–</h2>

  <div class="chart-mode-switcher hud-btn-group" style="margin-bottom: 0.7rem;">
    <button id="tab-trend" class="mode-tab active hud-btn" onclick="switchChartMode('trend')">
      <i class="fas fa-chart-line"></i> ãƒˆãƒ¬ãƒ³ãƒ‰
    </button>
    <button id="tab-dist" class="mode-tab hud-btn" onclick="switchChartMode('dist')">
      <i class="fas fa-chart-area"></i> åˆ†å¸ƒ
    </button>
  </div>

  <div class="metric-switcher hud-btn-group" style="margin-bottom: 0.9rem;">
    {% for m in dashboard_metrics %}
      <button class="metric-tab hud-btn{% if loop.first %} active{% endif %}" onclick="switchMetric('{{ m.key }}', event)">
        {{ m.label }}
      </button>
    {% endfor %}
    <button class="metric-tab hud-btn metric-tab-overall" onclick="switchAI('overall')" id="tab-overall" style="margin-left: 2em;">
      <i class="fas fa-globe"></i> å…¨ä½“å¹³å‡
    </button>
  </div>

  <div class="ai-switcher hud-btn-group" id="ai-switcher" style="margin-bottom: 1rem;">
    {% for ai in ai_names %}
      <button
        class="ai-tab hud-btn{% if loop.first %} active{% endif %}"
        data-ai-name="{{ ai }}"
        onclick="switchAI('{{ ai }}')"
      >
        {{ ai }}
        <a
          href="/ai/{{ ai }}"
          class="ai-detail-link"
          target="_blank"
          title="AIè©³ç´°ãƒšãƒ¼ã‚¸ã‚’åˆ¥ã‚¿ãƒ–ã§é–‹ã"
          onclick="event.stopPropagation();"
          style="margin-left: 0.25em;"
        >
          <i class="fas fa-external-link-alt"></i>
        </a>
      </button>
    {% endfor %}
  </div>

  <div id="trend-canvas-box">
    <canvas id="metricChart" width="900" height="230" style="max-width:100%; background:#181c2b; margin:16px 0;"></canvas>
  </div>

  <div id="dist-canvas-box" style="display:none;">
    <canvas id="distHistogram" width="900" height="180" style="max-width:100%; background:#181c2b; margin:12px 0 0 0;"></canvas>
    <canvas id="distBoxplot" width="900" height="90" style="max-width:100%; background:#1a1f2f; margin:0;"></canvas>
  </div>

  <div class="metric-summary" style="margin-top:1.2rem; color:#aee3fc; font-size:1.05em;">
    <span id="metric-summary-label">å¹³å‡</span>: <span id="metric-avg">-</span><span id="metric-unit"></span>
    ï¼ æœ€å¤§: <span id="metric-max">-</span><span id="metric-unit-max"></span>
    ï¼ æœ€å°: <span id="metric-min">-</span><span id="metric-unit-min"></span>
    ï¼ å‰å›å·®åˆ†: <span id="metric-diff">-</span><span id="metric-unit-diff"></span>
    <span id="metric-summary-dist"></span>
  </div>
</section>

{% endblock %}

{% block extra_scripts %}
<!-- 
  â–¼â–¼â–¼ ä¿®æ­£ç‚¹ â–¼â–¼â–¼
  - Chart.jsæœ¬ä½“ã€BoxPlotãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã€Histogramãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®URLã‚’å‹•ä½œç¢ºèªæ¸ˆã¿ã®æ­£ã—ã„ã‚‚ã®ã«ä¿®æ­£ã—ã¾ã—ãŸã€‚
  - deferå±æ€§ã§ã€HTMLè§£æå¾Œã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¨˜è¿°é †ã«å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¾ã™ã€‚
-->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@sgratzl/chartjs-chart-box-and-violin-plot@4.0.1/dist/chartjs-chart-box-and-violin-plot.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-histogram@4.0.2/dist/chartjs-chart-histogram.umd.min.js"></script>

<!-- æœ€å¾Œã«ã€ä¿®æ­£ã—ãŸã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™ -->
<script src="/static/js/dashboard.js"></script>
{% endblock %}
