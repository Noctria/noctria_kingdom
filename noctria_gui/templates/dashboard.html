{% extends "base_hud.html" %}

{% block title %}ğŸ‘‘ Noctria Kingdom - Central Governance HUD{% endblock %}

{% block header_icon %}<i class="fas fa-chess-king"></i>{% endblock %}
{% block header_title %}CENTRAL GOVERNANCE HUD{% endblock %}
{% block header_nav_href %}#{% endblock %}
{% block header_nav_text %}â€”{% endblock %}

{% block content %}
<section class="hud-panel metrics">
    <h2 class="panel-title">KEY METRICS</h2>
    <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
        <div class="metric-item">
            <h3><i class="fas fa-chart-line"></i> å¹³å‡å‹ç‡</h3>
            <p class="metric-value text-green">{{ stats.avg_win_rate | round(2) }}%</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-check-double"></i> æ¡ç”¨æˆ¦ç•¥æ•°</h3>
            <p class="metric-value text-green">{{ stats.promoted_count }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-rocket"></i> PUSHå®Ÿè¡Œæ•°</h3>
            <p class="metric-value text-magenta">{{ stats.pushed_count }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-brain"></i> ORACLE RMSE</h3>
            {% if stats.oracle_metrics and stats.oracle_metrics.RMSE is defined %}
                <p class="metric-value text-yellow">{{ stats.oracle_metrics.RMSE | round(4) }}</p>
            {% else %}
                <p class="metric-value text-yellow">â€”</p>
            {% endif %}
        </div>
    </div>
</section>

<section class="hud-panel chart-panel">
    <h2 class="panel-title"><i class="fas fa-chart-area"></i> ORACLE PREDICTION ANALYSIS</h2>
    <div style="height: 300px;">
        <canvas id="forecastChart"></canvas>
    </div>
</section>

<section class="hud-panel navigation">
    <h2 class="panel-title"><i class="fas fa-compass"></i> NAVIGATION</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
        <a href="/statistics/dashboard" class="hud-btn"><i class="fas fa-chart-pie"></i> çµ±è¨ˆDB</a>
        <a href="/strategies/compare" class="hud-btn"><i class="fas fa-balance-scale"></i> æˆ¦ç•¥æ¯”è¼ƒ</a>
        <a href="/act-history" class="hud-btn"><i class="fas fa-history"></i> Actå±¥æ­´</a>
        <a href="/upload-strategy" class="hud-btn"><i class="fas fa-upload"></i> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</a>
        <a href="/pdca/summary" class="hud-btn"><i class="fas fa-sync-alt"></i> PDCA</a>
        <a href="/trigger" class="hud-btn"><i class="fas fa-bullhorn"></i> ç‹å‘½ç™ºä»¤</a>
    </div>
</section>

<section class="hud-panel council-form">
    <h2 class="panel-title"><i class="fas fa-gavel"></i> HOLD COUNCIL</h2>
    <form id="councilForm">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem;">
            <input type="number" name="price" placeholder="PRICE" required step="any" />
            <input type="number" name="volume" placeholder="VOLUME" step="any" />
            <input type="number" name="volatility" placeholder="VOLATILITY" step="0.01" />
            <input type="text" name="trend_prediction" placeholder="TREND (bull/bear)" />
        </div>
        <button type="submit" class="hud-btn">EXECUTE</button>
    </form>
    <div id="councilResult" class="council-result">Awaiting command...</div>
</section>

<div id="forecast-data-holder" data-forecast="{{ forecast | default([]) | tojson | safe }}" style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ORACLEäºˆæ¸¬ã‚°ãƒ©ãƒ•æç”» ---
    const dataHolder = document.getElementById('forecast-data-holder');
    if (dataHolder) {
        let forecast = [];
        try {
            forecast = JSON.parse(dataHolder.getAttribute('data-forecast') || "[]");
        } catch (e) {
            console.error("ORACLEäºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—", e);
        }
        if (forecast.length > 0 && document.getElementById('forecastChart')) {
            const ctx = document.getElementById('forecastChart').getContext('2d');
            const labels = forecast.map(d => d.date || d.timestamp || "");
            const data = forecast.map(d => d.value || d.forecast || null);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'äºˆæ¸¬å€¤',
                        data: data,
                        borderColor: '#00e5ff',
                        backgroundColor: 'rgba(0,229,255,0.15)',
                        pointRadius: 1,
                        tension: 0.25
                    }]
                },
                options: {
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Oracleäºˆæ¸¬æ™‚ç³»åˆ—', color: '#e6f1ff' }
                    },
                    scales: {
                        x: { ticks: { color: '#a8b2d1' } },
                        y: { ticks: { color: '#a8b2d1' } }
                    }
                }
            });
        }
    }

    // --- ä¼šè­°ãƒ•ã‚©ãƒ¼ãƒ  â†’ ä¸­å¤®AIã¸API POST ---
    const form = document.getElementById("councilForm");
    const resultDiv = document.getElementById("councilResult");
    if (form && resultDiv) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            resultDiv.textContent = "â³ é›†è¨ˆä¸­...";
            const formData = new FormData(form);
            const market = {};
            for (const [k, v] of formData.entries()) market[k] = v;
            try {
                // â€»ãƒ«ãƒ¼ãƒˆä¾‹ï¼š/api/king/councilï¼ˆFastAPIå´ã§è¨­è¨ˆã«åˆã‚ã›ã¦ãã ã•ã„ï¼‰
                const resp = await fetch("/api/king/council", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(market)
                });
                if (!resp.ok) throw new Error("APIã‚¨ãƒ©ãƒ¼ " + resp.status);
                const data = await resp.json();
                resultDiv.innerHTML = `<b>ç‹å‘½: ${data.final_decision}</b><br><pre>${JSON.stringify(data.assessments, null, 2)}</pre>`;
            } catch (err) {
                resultDiv.innerHTML = `<span style="color:#ff4d4d">APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: ${err}</span>`;
            }
        });
    }
});
</script>
{% endblock %}
