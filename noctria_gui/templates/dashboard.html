{% extends "base_hud.html" %}

{% block title %}ğŸ‘‘ Noctria Kingdom - Central Governance HUD{% endblock %}

{% block header_icon %}<i class="fas fa-chess-king"></i>{% endblock %}
{% block header_title %}CENTRAL GOVERNANCE HUD{% endblock %}
{% block header_nav_href %}#{% endblock %}
{% block header_nav_text %}â€”{% endblock %}

{% block content %}
<section class="hud-panel metrics">
    <h2 class="panel-title">KEY METRICS</h2>
    <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
        <div class="metric-item">
            <h3><i class="fas fa-chart-line"></i> å¹³å‡å‹ç‡</h3>
            <p class="metric-value text-green">{{ stats.avg_win_rate | round(2) }}%</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-check-double"></i> æ¡ç”¨æˆ¦ç•¥æ•°</h3>
            <p class="metric-value text-green">{{ stats.promoted_count }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-rocket"></i> PUSHå®Ÿè¡Œæ•°</h3>
            <p class="metric-value text-magenta">{{ stats.pushed_count }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-brain"></i> ORACLE RMSE</h3>
            {% if stats.oracle_metrics and stats.oracle_metrics.RMSE is defined %}
                <p class="metric-value text-yellow">{{ stats.oracle_metrics.RMSE | round(4) }}</p>
            {% else %}
                <p class="metric-value text-yellow">â€”</p>
            {% endif %}
        </div>
    </div>
</section>

<section class="hud-panel chart-panel">
    <h2 class="panel-title"><i class="fas fa-chart-area"></i> ORACLE PREDICTION ANALYSIS</h2>
    <div style="height: 300px;">
        <canvas id="forecastChart"></canvas>
    </div>
</section>

<section class="hud-panel navigation">
    <h2 class="panel-title"><i class="fas fa-compass"></i> NAVIGATION</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
        <a href="/statistics/dashboard" class="hud-btn"><i class="fas fa-chart-pie"></i> çµ±è¨ˆDB</a>
        <a href="/strategies/compare" class="hud-btn"><i class="fas fa-balance-scale"></i> æˆ¦ç•¥æ¯”è¼ƒ</a>
        <a href="/act-history" class="hud-btn"><i class="fas fa-history"></i> Actå±¥æ­´</a>
        <a href="/upload-strategy" class="hud-btn"><i class="fas fa-upload"></i> ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</a>
        <a href="/pdca/summary" class="hud-btn"><i class="fas fa-sync-alt"></i> PDCA</a>
        <a href="/trigger" class="hud-btn"><i class="fas fa-bullhorn"></i> ç‹å‘½ç™ºä»¤</a>
    </div>
</section>

<section class="hud-panel council-form">
    <h2 class="panel-title"><i class="fas fa-gavel"></i> HOLD COUNCIL</h2>
    <form id="councilForm">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem;">
            <input type="number" name="price" placeholder="PRICE" required step="any" />
            <input type="number" name="volume" placeholder="VOLUME" step="any" />
            <input type="number" name="volatility" placeholder="VOLATILITY" step="0.01" />
            <input type="text" name="trend_prediction" placeholder="TREND (bull/bear)" />
        </div>
        <button type="submit" class="hud-btn">EXECUTE</button>
    </form>
    <div id="councilResult" class="council-result">Awaiting command...</div>
</section>

<div id="forecast-data-holder" data-forecast="{{ forecast | default([]) | tojson }}" style="display: none;"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<!-- âœ… ä¿®æ­£: ãƒ‡ãƒãƒƒã‚°ç”¨ã®ã‚³ãƒ¼ãƒ‰ã«ä¸€æ™‚çš„ã«å¤‰æ›´ -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log("--- ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ ãƒ‡ãƒãƒƒã‚°é–‹å§‹ ---");
    const dataHolder = document.getElementById('forecast-data-holder');
    
    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ¸¡ã•ã‚ŒãŸç”Ÿã®æ–‡å­—åˆ—ã‚’å–å¾—
    const rawDataString = dataHolder.getAttribute('data-forecast');

    // å–å¾—ã—ãŸæ–‡å­—åˆ—ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¦ç¢ºèª
    console.log("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å—ã‘å–ã£ãŸç”Ÿã®æ–‡å­—åˆ—:", rawDataString);

    // ãã®æ–‡å­—åˆ—ã§JSON.parseã‚’è©¦ã™
    try {
        JSON.parse(rawDataString);
        console.log("âœ… JSON.parse ã«æˆåŠŸã—ã¾ã—ãŸï¼");
    } catch (e) {
        console.error("âŒ JSON.parse ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼:", e);
    }
    console.log("--- ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ ãƒ‡ãƒãƒƒã‚°çµ‚äº† ---");

    // ãƒšãƒ¼ã‚¸ã®ä»–ã®æ©Ÿèƒ½ã¯ã€ãƒ‡ãƒãƒƒã‚°ä¸­ã¯ä¸€æ™‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ãŠãã¾ã™
    /*
    const timeElement = document.getElementById('system-time');
    function updateTime() { ... }
    ...
    const form = document.getElementById("councilForm");
    ...
    */
});
</script>
{% endblock %}
