{% extends "base_hud.html" %}

{% block title %}ğŸ‘‘ Noctria Kingdom - Central Governance HUD{% endblock %}
{% block header_icon %}<i class="fas fa-chess-king"></i>{% endblock %}
{% block header_title %}<span class="text-normal">CENTRAL GOVERNANCE HUD</span>{% endblock %}
{% block header_nav_href %}#{% endblock %}
{% block header_nav_text %}â€”{% endblock %}

{% block content %}
<div id="data-holder"
     data-metrics-dict='{{ metrics_dict | tojson | safe }}'
     data-overall-metrics='{{ overall_metrics | tojson | safe }}'
     data-dashboard-metrics='{{ dashboard_metrics | tojson | safe }}'
     data-ai-names='{{ ai_names | tojson | safe }}'>
</div>

<section class="hud-panel dashboard-nav" style="padding: 1rem; margin-bottom: 1rem;">
  <h2 class="panel-title text-normal"><i class="fas fa-compass"></i> Navigation</h2>
  <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
    {% set nav_items = [
      {"href": "/strategies", "icon": "fas fa-scroll", "text": "æˆ¦ç•¥ä¸€è¦§"},
      {"href": "/strategies/compare", "icon": "fas fa-balance-scale", "text": "æˆ¦ç•¥æ¯”è¼ƒ"},
      {"href": "/pdca/summary", "icon": "fas fa-chart-pie", "text": "PDCAã‚µãƒãƒªãƒ¼"},
      {"href": "/pdca/history", "icon": "fas fa-history", "text": "PDCAå±¥æ­´"},
      {"href": "/ai", "icon": "fas fa-robot", "text": "AIç®¡ç†"},
      {"href": "/trigger", "icon": "fas fa-gavel", "text": "ç‹å‘½ç™ºä»¤"},
      {"href": "/act-history", "icon": "fas fa-file-alt", "text": "Actå±¥æ­´"},
      {"href": "/push_history", "icon": "fas fa-upload", "text": "Pushå±¥æ­´"},
      {"href": "/statistics", "icon": "fas fa-chart-bar", "text": "çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰"},
      {"href": "/api/king/prometheus", "icon": "fas fa-flask", "text": "Prometheuså­¦ç¿’"}
    ] %}
    {% for item in nav_items %}
      <a href="{{ item.href }}" class="hud-link">
        <i class="{{ item.icon }}" style="font-size: 1.6rem; color: var(--text-color-normal);"></i>
        <span class="text-light">{{ item.text }}</span>
      </a>
    {% endfor %}
  </div>
</section>

<section class="hud-panel metrics">
  <h2 class="panel-title text-normal">KEY METRICS</h2>
  <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
    <div class="metric-item">
      <h3 class="text-normal"><i class="fas fa-chart-line"></i> å¹³å‡å‹ç‡</h3>
      <p class="metric-value text-green">
        {{ overall_metrics.get('win_rate', {}).get('avg', '-') }}%
      </p>
    </div>
  </div>
</section>

<section class="hud-panel">
  <h2 class="panel-title text-normal"><i class="fas fa-rocket"></i> Prometheus ã‚¯ã‚¤ãƒƒã‚¯å­¦ç¿’</h2>
  <p class="text-light" style="margin-bottom: .75rem;">
    ã“ã“ã‹ã‚‰ç›´æ¥ã€Airflow ã® <code>train_prometheus_obs8</code> ã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã™ã€‚è©³ç´°è¨­å®šã‚„æœ€æ–°ãƒ¢ãƒ‡ãƒ«ã®è©•ä¾¡ã¯
    <a href="/api/king/prometheus">Prometheuså°‚ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a> ã¸ã€‚
  </p>
  <form method="post" action="/api/king/prometheus/train" style="display:grid; gap:.75rem; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
    <div>
      <label for="tt" class="text-light">TOTAL_TIMESTEPS</label>
      <input id="tt" name="TOTAL_TIMESTEPS" type="number" placeholder="10000" />
    </div>
    <div>
      <label class="text-light">learning_rate</label>
      <input name="learning_rate" type="text" placeholder="0.0003" />
    </div>
    <div>
      <label class="text-light">n_steps</label>
      <input name="n_steps" type="number" placeholder="2048" />
    </div>
    <div>
      <label class="text-light">batch_size</label>
      <input name="batch_size" type="number" placeholder="256" />
    </div>
    <div>
      <label class="text-light">gamma</label>
      <input name="gamma" type="text" placeholder="0.99" />
    </div>
    <div>
      <label class="text-light">eval_n_episodes</label>
      <input name="eval_n_episodes" type="number" placeholder="5" />
    </div>
    <div>
      <label class="text-light">eval_deterministic</label>
      <select name="eval_deterministic">
        <option value="true" selected>True</option>
        <option value="false">False</option>
      </select>
    </div>
    <div style="grid-column: 1 / -1; display:flex; gap:.5rem; margin-top:.25rem;">
      <button class="btn" type="submit"><i class="fas fa-paper-plane"></i> å­¦ç¿’ã‚’é–‹å§‹</button>
      <a class="btn btn--ghost" href="/api/king/prometheus"><i class="fas fa-external-link-alt"></i> å°‚ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸</a>
    </div>
    <p class="text-light" style="grid-column:1/-1; margin:0;">æœªå…¥åŠ›é …ç›®ã¯æ—¢å®šå€¤ï¼ˆDAG/ENVï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
  </form>
</section>

<section class="hud-panel">
  <h2 class="panel-title text-normal"><i class="fas fa-chart-area"></i> ORACLEäºˆæ¸¬ãƒãƒ£ãƒ¼ãƒˆ</h2>
  <canvas id="oracleForecastChart" width="600" height="300"></canvas>
</section>

<section class="hud-panel">
  <h2 class="panel-title text-normal"><i class="fas fa-chart-bar"></i> å…¨AIãƒ»å…¨æŒ‡æ¨™ãƒˆãƒ¬ãƒ³ãƒ‰å¯è¦–åŒ–</h2>
  <canvas id="allAiMetricsChart" width="600" height="300"></canvas>
</section>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<script src="/static/js/dashboard.js"></script>
{% endblock %}
