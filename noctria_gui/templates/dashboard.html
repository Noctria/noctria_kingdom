<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>üëë Noctria Kingdom - Central Governance HUD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Google Fonts & Font Awesome -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Â∞ÇÁî®CSS„Éï„Ç°„Ç§„É´ -->
    <link rel="stylesheet" href="/static/hud_style.css" />

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

</head>
<body>

    <div class="hud-container">
        <!-- Header -->
        <header class="hud-panel header">
            <h1 class="hud-title"><i class="fas fa-chess-king"></i> NOCTRIA KINGDOM - CENTRAL GOVERNANCE HUD</h1>
            <div id="system-time" class="system-time"></div>
        </header>

        <!-- Key Metrics Panel -->
        <section class="hud-panel metrics">
            <h2 class="panel-title">KEY METRICS</h2>
            <div class="metrics-grid">
                <div class="metric-item">
                    <h3><i class="fas fa-chart-line"></i> Âπ≥ÂùáÂãùÁéá</h3>
                    <p class="metric-value text-green">{{ stats.avg_win_rate | round(2) }}%</p>
                </div>
                <div class="metric-item">
                    <h3><i class="fas fa-check-double"></i> Êé°Áî®Êà¶Áï•Êï∞</h3>
                    <p class="metric-value text-cyan">{{ stats.promoted_count }}</p>
                </div>
                <div class="metric-item">
                    <h3><i class="fas fa-rocket"></i> PUSHÂÆüË°åÊï∞</h3>
                    <p class="metric-value text-magenta">{{ stats.pushed_count }}</p>
                </div>
                <div class="metric-item">
                    <h3><i class="fas fa-brain"></i> ORACLE RMSE</h3>
                    {% if stats.oracle_metrics %}
                    <p class="metric-value text-yellow">{{ stats.oracle_metrics.RMSE | round(4) }}</p>
                    {% else %}
                    <p class="metric-value text-yellow">‚Äî</p>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- Oracle Forecast Chart -->
        <section class="hud-panel chart-panel">
            <h2 class="panel-title"><i class="fas fa-chart-area"></i> ORACLE PREDICTION ANALYSIS</h2>
            <div class="chart-wrapper">
                <canvas id="forecastChart"></canvas>
            </div>
        </section>
        
        <!-- Navigation Panel -->
        <section class="hud-panel navigation">
            <h2 class="panel-title"><i class="fas fa-compass"></i> NAVIGATION</h2>
            <div class="nav-grid">
                <a href="/statistics/dashboard" class="nav-item"><i class="fas fa-chart-pie"></i><span>Áµ±Ë®àDB</span></a>
                <a href="/strategy/compare" class="nav-item"><i class="fas fa-balance-scale"></i><span>Êà¶Áï•ÊØîËºÉ</span></a>
                <a href="/act-history" class="nav-item"><i class="fas fa-history"></i><span>ActÂ±•Ê≠¥</span></a>
                <a href="/upload-strategy" class="nav-item"><i class="fas fa-upload"></i><span>„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</span></a>
                <a href="/pdca/summary" class="nav-item"><i class="fas fa-sync-alt"></i><span>PDCA</span></a>
                <a href="/trigger" class="nav-item"><i class="fas fa-bullhorn"></i><span>ÁéãÂëΩÁô∫‰ª§</span></a>
            </div>
        </section>

        <!-- Council Form Panel -->
        <section class="hud-panel council-form">
            <h2 class="panel-title"><i class="fas fa-gavel"></i> HOLD COUNCIL</h2>
            <form id="councilForm">
                <div class="form-grid">
                    <input type="number" name="price" placeholder="PRICE" required step="any" />
                    <input type="number" name="volume" placeholder="VOLUME" step="any" />
                    <input type="number" name="volatility" placeholder="VOLATILITY" step="0.01" />
                    <input type="text" name="trend_prediction" placeholder="TREND (bull/bear)" />
                </div>
                <button type="submit" class="hud-btn">EXECUTE</button>
            </form>
            <div id="councilResult" class="council-result">Awaiting command...</div>
        </section>

    </div>

    <!-- „Éá„Éº„Çø„ÇíÂÆâÂÖ®„Å´Âüã„ÇÅËæº„ÇÄ„Åü„ÇÅ„ÅÆÂ∞ÇÁî®script„Çø„Ç∞ -->
    <script type="application/json" id="forecast-data">
        {{ forecast | tojson | safe }}
    </script>

    <!-- Main Logic Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // System Time
            const timeElement = document.getElementById('system-time');
            function updateTime() {
                const now = new Date();
                const options = {
                    timeZone: 'Asia/Tokyo', year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                };
                const formatter = new Intl.DateTimeFormat('en-CA', options);
                const jstString = formatter.format(now).replace(', ', ' ');
                timeElement.textContent = `${jstString} JST`;
            }
            setInterval(updateTime, 1000);
            updateTime();

            // Chart.js
            try {
                const forecastDataElement = document.getElementById('forecast-data');
                const rawData = forecastDataElement ? forecastDataElement.textContent.trim() : null;

                if (!rawData || rawData.startsWith('{{') || rawData === "null") {
                    throw new Error("„Çµ„Éº„Éê„Éº„Åã„Çâ„Ç∞„É©„Éï„Éá„Éº„Çø„ÅåÊèê‰æõ„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ");
                }
                
                const forecastData = JSON.parse(rawData);

                if (!Array.isArray(forecastData) || forecastData.length === 0) {
                    throw new Error("„Ç∞„É©„Éï„Éá„Éº„Çø„ÅåÁ©∫„Åæ„Åü„ÅØ‰∏çÊ≠£„Å™ÂΩ¢Âºè„Åß„Åô„ÄÇ");
                }

                const ctx = document.getElementById("forecastChart").getContext("2d");
                const hudChartOptions = {
                    responsive: true, maintainAspectRatio: false,
                    chartArea: { backgroundColor: 'rgba(0, 30, 60, 0.4)' },
                    scales: {
                        x: {
                            type: 'time', time: { unit: 'day' },
                            ticks: { color: '#a8b2d1', font: { family: "'Roboto Mono', monospace" } },
                            grid: { color: 'rgba(0, 229, 255, 0.2)', borderDash: [2, 4] }
                        },
                        y: {
                            ticks: { color: '#a8b2d1', font: { family: "'Roboto Mono', monospace" } },
                            grid: { color: 'rgba(0, 229, 255, 0.2)' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#e6f1ff', font: { family: "'Roboto Mono', monospace" } } },
                        tooltip: {
                            backgroundColor: 'rgba(0, 30, 60, 0.8)', titleFont: { family: "'Roboto Mono', monospace" },
                            bodyFont: { family: "'Roboto Mono', monospace" }, borderColor: '#00e5ff', borderWidth: 1
                        }
                    }
                };
                new Chart(ctx, {
                    type: "line",
                    data: {
                        datasets: [
                            { label: "ÂÆüÁ∏æ", data: forecastData.map(d => ({x: d.date, y: d.y_true})), borderWidth: 2, tension: 0.3, pointRadius: 2 },
                            { label: "‰∫àÊ∏¨", data: forecastData.map(d => ({x: d.date, y: d.forecast || d.y_pred})), borderWidth: 2, tension: 0.3, pointRadius: 2 },
                        ]
                    },
                    options: hudChartOptions
                });

            } catch (e) {
                console.error("Chart.js„ÅÆÊèèÁîª„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", e);
                const chartCanvas = document.getElementById("forecastChart");
                if(chartCanvas) {
                    const ctx = chartCanvas.getContext("2d");
                    ctx.font = "16px 'Roboto Mono', monospace";
                    ctx.fillStyle = "#ff79c6"; // magenta
                    ctx.textAlign = "center";
                    ctx.fillText(e.message, chartCanvas.width / 2, 50);
                }
            }

            // Council Form
            const councilForm = document.getElementById("councilForm");
            const resultDiv = document.getElementById("councilResult");
            councilForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const formData = new FormData(councilForm);
                const marketData = {};
                formData.forEach((value, key) => {
                    if (value === null || value === "") return;
                    const num = Number(value);
                    marketData[key] = isNaN(num) ? value : num;
                });
                resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Executing Council...';
                try {
                    const res = await fetch("/dashboard/king/hold-council", {
                        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(marketData)
                    });
                    const data = await res.json();
                    if (res.ok) {
                        resultDiv.textContent = `Decision: ${data.final_decision}`;
                    } else {
                        resultDiv.textContent = `Error: ${data.detail || 'Unknown'}`;
                    }
                } catch (error) {
                    resultDiv.textContent = `Communication Error: ${error.message}`;
                }
            });
        });
    </script>
</body>
</html>
