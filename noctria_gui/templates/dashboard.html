{% extends "base_hud.html" %}

{% block title %}👑 Noctria Kingdom - Central Governance HUD{% endblock %}

{% block header_icon %}<i class="fas fa-chess-king"></i>{% endblock %}
{% block header_title %}CENTRAL GOVERNANCE HUD{% endblock %}
{% block header_nav_href %}#{% endblock %}
{% block header_nav_text %}—{% endblock %}

{% block content %}
<section class="hud-panel metrics">
    <h2 class="panel-title">KEY METRICS</h2>
    <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
        <div class="metric-item">
            <h3><i class="fas fa-chart-line"></i> 平均勝率</h3>
            <p class="metric-value text-green">{{ stats.avg_win_rate | round(2) }}%</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-check-double"></i> 採用戦略数</h3>
            <p class="metric-value text-green">{{ stats.promoted_count }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-rocket"></i> PUSH実行数</h3>
            <p class="metric-value text-magenta">{{ stats.pushed_count }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-brain"></i> ORACLE RMSE</h3>
            {% if stats.oracle_metrics and stats.oracle_metrics.RMSE is defined %}
                <p class="metric-value text-yellow">{{ stats.oracle_metrics.RMSE | round(4) }}</p>
            {% else %}
                <p class="metric-value text-yellow">—</p>
            {% endif %}
        </div>
    </div>
</section>

<section class="hud-panel chart-panel">
    <h2 class="panel-title"><i class="fas fa-chart-area"></i> ORACLE PREDICTION ANALYSIS</h2>
    <div style="height: 300px;">
        <canvas id="forecastChart"></canvas>
    </div>
</section>

<section class="hud-panel navigation">
    <h2 class="panel-title"><i class="fas fa-compass"></i> NAVIGATION</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
        <a href="/statistics/dashboard" class="hud-btn"><i class="fas fa-chart-pie"></i> 統計DB</a>
        <a href="/strategies/compare" class="hud-btn"><i class="fas fa-balance-scale"></i> 戦略比較</a>
        <a href="/act-history" class="hud-btn"><i class="fas fa-history"></i> Act履歴</a>
        <a href="/upload-strategy" class="hud-btn"><i class="fas fa-upload"></i> アップロード</a>
        <a href="/pdca/summary" class="hud-btn"><i class="fas fa-sync-alt"></i> PDCA</a>
        <a href="/trigger" class="hud-btn"><i class="fas fa-bullhorn"></i> 王命発令</a>
    </div>
</section>

<section class="hud-panel council-form">
    <h2 class="panel-title"><i class="fas fa-gavel"></i> HOLD COUNCIL</h2>
    <form id="councilForm">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem;">
            <input type="number" name="price" placeholder="PRICE" required step="any" />
            <input type="number" name="volume" placeholder="VOLUME" step="any" />
            <input type="number" name="volatility" placeholder="VOLATILITY" step="0.01" />
            <input type="text" name="trend_prediction" placeholder="TREND (bull/bear)" />
        </div>
        <button type="submit" class="hud-btn">EXECUTE</button>
    </form>
    <div id="councilResult" class="council-result">Awaiting command...</div>
</section>

<div id="forecast-data-holder" data-forecast="{{ forecast | default([]) | tojson }}" style="display: none;"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<!-- ✅ 修正: デバッグ用のコードに一時的に変更 -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log("--- グラフデータ デバッグ開始 ---");
    const dataHolder = document.getElementById('forecast-data-holder');
    
    // サーバーから渡された生の文字列を取得
    const rawDataString = dataHolder.getAttribute('data-forecast');

    // 取得した文字列をコンソールに出力して確認
    console.log("サーバーから受け取った生の文字列:", rawDataString);

    // その文字列でJSON.parseを試す
    try {
        JSON.parse(rawDataString);
        console.log("✅ JSON.parse に成功しました！");
    } catch (e) {
        console.error("❌ JSON.parse に失敗しました。エラー:", e);
    }
    console.log("--- グラフデータ デバッグ終了 ---");

    // ページの他の機能は、デバッグ中は一時的にコメントアウトしておきます
    /*
    const timeElement = document.getElementById('system-time');
    function updateTime() { ... }
    ...
    const form = document.getElementById("councilForm");
    ...
    */
});
</script>
{% endblock %}
