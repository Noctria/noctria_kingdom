{% extends "base_hud.html" %}

{% block title %}ğŸ‘‘ Noctria Kingdom - Central Governance HUD{% endblock %}
{% block header_icon %}<i class="fas fa-chess-king"></i>{% endblock %}
{% block header_title %}CENTRAL GOVERNANCE HUD{% endblock %}
{% block header_nav_href %}#{% endblock %}
{% block header_nav_text %}â€”{% endblock %}

{% block content %}
<section class="hud-panel metrics">
  <h2 class="panel-title">KEY METRICS</h2>
  <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
    <div class="metric-item">
      <h3><i class="fas fa-chart-line"></i> å¹³å‡å‹ç‡</h3>
      <p class="metric-value text-green">
        {{ overall_metrics['win_rate']['avg'] if overall_metrics['win_rate'] else '-' }}%
      </p>
    </div>
    <div class="metric-item">
      <h3><i class="fas fa-arrow-up"></i> æ¡ç”¨æˆ¦ç•¥æ•°</h3>
      <p class="metric-value">{{ stats.promoted_count }}</p>
    </div>
    <div class="metric-item">
      <h3><i class="fas fa-upload"></i> GitHubã¸Pushæ¸ˆ</h3>
      <p class="metric-value text-blue">{{ stats.pushed_count }}</p>
    </div>
    <div class="metric-item">
      <h3><i class="fas fa-history"></i> PDCAå†è©•ä¾¡æ•°</h3>
      <p class="metric-value text-yellow">{{ stats.pdca_count }}</p>
    </div>
  </div>
</section>

<section class="hud-panel">
  <h2 class="panel-title"><i class="fas fa-chart-area"></i> ORACLEäºˆæ¸¬ãƒãƒ£ãƒ¼ãƒˆ</h2>
  <div id="forecast-data-holder" data-forecast='{{ forecast | tojson | safe }}'></div>
  <canvas id="forecastChart" width="900" height="300" style="max-width:100%; background:#181c2b; margin:16px 0;"></canvas>
</section>

<section class="hud-panel">
  <h2 class="panel-title"><i class="fas fa-chart-bar"></i> å…¨AIãƒ»å…¨æŒ‡æ¨™ãƒˆãƒ¬ãƒ³ãƒ‰/åˆ†å¸ƒå¯è¦–åŒ–</h2>

  <div class="chart-mode-switcher hud-btn-group" style="margin-bottom: 0.7rem;">
    <button id="tab-trend" class="mode-tab active hud-btn" onclick="switchChartMode('trend')">
      <i class="fas fa-chart-line"></i> ãƒˆãƒ¬ãƒ³ãƒ‰
    </button>
    <button id="tab-dist" class="mode-tab hud-btn" onclick="switchChartMode('dist')">
      <i class="fas fa-chart-area"></i> åˆ†å¸ƒ
    </button>
  </div>

  <div class="metric-switcher hud-btn-group" style="margin-bottom: 0.9rem;">
    {% for m in dashboard_metrics %}
      <button class="metric-tab hud-btn{% if loop.first %} active{% endif %}" onclick="switchMetric('{{ m.key }}')">
        {{ m.label }}
      </button>
    {% endfor %}
    <button class="metric-tab hud-btn metric-tab-overall" onclick="switchAI('overall')" id="tab-overall" style="margin-left: 2em;">
      <i class="fas fa-globe"></i> å…¨ä½“å¹³å‡
    </button>
  </div>

  <div class="ai-switcher hud-btn-group" id="ai-switcher" style="margin-bottom: 1rem;">
    {% for ai in ai_names %}
      <button
        class="ai-tab hud-btn{% if loop.first %} active{% endif %}"
        onclick="switchAI('{{ ai }}');window.history.pushState({}, '', '/dashboard#'+encodeURIComponent('{{ ai }}'));"
      >
        {{ ai }}
        <a
          href="/ai/{{ ai }}"
          class="ai-detail-link"
          target="_blank"
          title="AIè©³ç´°ãƒšãƒ¼ã‚¸ã‚’åˆ¥ã‚¿ãƒ–ã§é–‹ã"
          onclick="event.stopPropagation();"
          style="margin-left: 0.25em;"
        >
          <i class="fas fa-external-link-alt"></i>
        </a>
      </button>
    {% endfor %}
  </div>

  <div id="trend-canvas-box">
    <canvas id="metricChart" width="900" height="230" style="max-width:100%; background:#181c2b; margin:16px 0;"></canvas>
  </div>

  <div id="dist-canvas-box" style="display:none;">
    <canvas id="distHistogram" width="900" height="180" style="max-width:100%; background:#181c2b; margin:12px 0 0 0;"></canvas>
    <canvas id="distBoxplot" width="900" height="90" style="max-width:100%; background:#1a1f2f; margin:0;"></canvas>
  </div>

  <div class="metric-summary" style="margin-top:1.2rem; color:#aee3fc; font-size:1.05em;">
    <span id="metric-summary-label">å¹³å‡</span>: <span id="metric-avg">-</span><span id="metric-unit"></span>
    ï¼ æœ€å¤§: <span id="metric-max">-</span><span id="metric-unit-max"></span>
    ï¼ æœ€å°: <span id="metric-min">-</span><span id="metric-unit-min"></span>
    ï¼ å‰å›å·®åˆ†: <span id="metric-diff">-</span><span id="metric-unit-diff"></span>
    <span id="metric-summary-dist"></span>
  </div>
</section>

<section class="hud-panel">
  <h2 class="panel-title"><i class="fas fa-bolt"></i> AIã”ã¨ã®é€²æ—ç‡</h2>
  <div class="panel-graph-row" style="display:flex;gap:2rem;flex-wrap:wrap;">
    {% for ai in ai_progress %}
    <div class="mini-panel" style="flex:1 1 220px;min-width:180px;max-width:240px; background:rgba(34,38,58,0.86); border-radius:1.2rem; padding:1rem 1.2rem; box-shadow:0 0 14px 0 #199bda38;">
      <h3 style="font-size:1.1rem;color:#7eeafc;font-weight:600;">{{ ai.name }}</h3>
      <canvas id="progress-{{ ai.id }}" width="120" height="120"></canvas>
      <div class="progress-label" style="margin-top:.7em; color:#e6f1ff;font-weight:bold;">
        {{ ai.progress }}%
        <span style="margin-left:1em; color:#aac7ff;font-weight:normal;">{{ ai.phase }}</span>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin-plot@4.0.1/dist/chartjs-chart-box-and-violin-plot.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-histogram@4.0.0/dist/chartjs-chart-histogram.umd.min.js"></script>

<script>
// â–¼â–¼â–¼ã€ä¿®æ­£ç‚¹ã€‘ã“ã“ã‹ã‚‰â–¼â–¼â–¼
// DOMã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¦ã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹
document.addEventListener('DOMContentLoaded', function() {
  // ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç™»éŒ²
  // DOMContentLoadedå†…ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒæœªå®šç¾©ã§ã‚ã‚‹å•é¡Œã‚’å›é¿
  Chart.register(
    window.ChartjsChartHistogram.HistogramController,
    window.ChartjsChartHistogram.HistogramElement,
    window.ChartjsChartBoxplot.BoxPlotController,
    window.ChartjsChartBoxplot.BoxAndWhiskers,
    window.ChartjsChartBoxplot.Violin
  );

  // --- ãƒ‡ãƒ¼ã‚¿æº–å‚™ ---
  const metricsDict = {{ metrics_dict | tojson | safe }};
  const overallMetrics = {{ overall_metrics | tojson | safe }};
  const dashboardMetrics = {{ dashboard_metrics | tojson | safe }};
  const aiNames = {{ ai_names | tojson | safe }};
  const aiMetricDist = {{ ai_metric_dist | tojson | safe }};

  // --- çŠ¶æ…‹ç®¡ç† ---
  let selectedMetric = dashboardMetrics[0].key;
  let selectedAI = aiNames[0];
  let selectedMode = "trend"; // "trend" ã¾ãŸã¯ "dist"

  // --- ãƒãƒ£ãƒ¼ãƒˆæç”»é–¢æ•° ---
  // ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆã®æç”»
  window.drawMetricChart = function(metric, ai) {
    const ctx = document.getElementById('metricChart').getContext('2d');
    if (window.metricChartObj) window.metricChartObj.destroy();
    let data, label, unit, dec;
    let showAI = true;
    if (ai === 'overall') {
      data = overallMetrics[metric];
      label = "å…¨ä½“å¹³å‡";
      showAI = false;
    } else {
      data = (metricsDict[metric] && metricsDict[metric][ai]) ? metricsDict[metric][ai] : { labels: [], values: [] };
      label = ai;
    }
    let conf = dashboardMetrics.find(m => m.key === metric);
    unit = conf.unit;
    dec = conf.dec;
    window.metricChartObj = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: [{
          label: conf.label + (showAI ? `ï¼ˆ${label}ï¼‰` : "ï¼ˆå…¨ä½“å¹³å‡ï¼‰"),
          data: data.values,
          borderColor: '#18e1ef',
          backgroundColor: 'rgba(24,225,239,0.10)',
          pointRadius: 3,
          tension: 0.20,
          fill: false
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { color: "#e6f1ff" } },
          title: { display: true, text: `${conf.label}ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆ${label}ï¼‰`, color: "#e6f1ff" }
        },
        scales: {
          x: { ticks: { color: "#a8b2d1" } },
          y: { ticks: { color: "#a8b2d1" } }
        }
      }
    });
    // ã‚µãƒãƒªãƒ¼æ›´æ–°
    document.getElementById('metric-summary-label').textContent = conf.label;
    document.getElementById('metric-avg').textContent = (data.avg != null) ? data.avg : "-";
    document.getElementById('metric-max').textContent = (data.max != null) ? data.max : "-";
    document.getElementById('metric-min').textContent = (data.min != null) ? data.min : "-";
    document.getElementById('metric-diff').textContent = (data.diff != null ? (data.diff >= 0 ? "+" : "") + data.diff : "-");
    document.getElementById('metric-unit').textContent = unit;
    document.getElementById('metric-unit-max').textContent = unit;
    document.getElementById('metric-unit-min').textContent = unit;
    document.getElementById('metric-unit-diff').textContent = unit;
    // AIã‚¹ã‚¤ãƒƒãƒãƒ£ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤º
    document.getElementById('ai-switcher').style.display = showAI ? 'flex' : 'none';
    // ã€Œå…¨ä½“å¹³å‡ã€ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('tab-overall').classList.toggle('active', !showAI);
    // AIã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.ai-tab').forEach(btn => btn.classList.remove('active'));
    if (showAI) {
      const aiBtn = Array.from(document.querySelectorAll('.ai-tab')).find(btn => btn.onclick.toString().includes(`'${ai}'`));
      if (aiBtn) aiBtn.classList.add('active');
    }
  }

  // åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆï¼ˆãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ãƒ»ç®±ã²ã’å›³ï¼‰ã®æç”»
  window.drawDistCharts = function(metric, ai) {
    const histCtx = document.getElementById('distHistogram').getContext('2d');
    const boxCtx = document.getElementById('distBoxplot').getContext('2d');
    if (window.histChart) window.histChart.destroy();
    if (window.boxChart) window.boxChart.destroy();

    let data = [];
    let label = ai === 'overall' ? 'å…¨ä½“' : ai;
    let conf = dashboardMetrics.find(m => m.key === metric);
    if (ai === 'overall') {
      data = aiMetricDist[metric]?.flatMap(d => d.values) || [];
    } else {
      data = aiMetricDist[metric]?.find(d => d.ai === ai)?.values || [];
    }

    window.histChart = new Chart(histCtx, {
      type: 'histogram',
      data: {
        datasets: [{
          label: conf.label,
          data: data,
          backgroundColor: 'rgba(24,225,239,0.5)',
          borderColor: '#18e1ef',
        }]
      },
      options: {
        responsive: true,
        plugins: { 
          legend: { display: false },
          title: { display: true, text: `${conf.label} åˆ†å¸ƒï¼ˆ${label}ï¼‰`, color: "#e6f1ff" }
        },
        scales: {
          x: { ticks: { color: "#a8b2d1" } },
          y: { ticks: { color: "#a8b2d1" } }
        }
      }
    });

    window.boxChart = new Chart(boxCtx, {
      type: 'boxplot',
      data: {
        labels: [conf.label],
        datasets: [{
          label: conf.label,
          data: [data],
          backgroundColor: 'rgba(34,38,58,0.86)',
          borderColor: '#7eeafc',
          outlierColor: '#FF6384',
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { ticks: { color: "#a8b2d1" } }
        }
      }
    });
  }

  // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©é–¢æ•° ---
  // onclickã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ã€windowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ç™»éŒ²ã™ã‚‹
  window.switchMetric = function(metric) {
    selectedMetric = metric;
    document.querySelectorAll('.metric-tab').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    if (selectedMode === "trend") {
      window.drawMetricChart(selectedMetric, selectedAI);
    } else {
      window.drawDistCharts(selectedMetric, selectedAI);
    }
  }

  window.switchAI = function(ai) {
    selectedAI = ai;
    if (selectedMode === "trend") {
      window.drawMetricChart(selectedMetric, selectedAI);
    } else {
      window.drawDistCharts(selectedMetric, selectedAI);
    }
  }

  window.switchChartMode = function(mode) {
    selectedMode = mode;
    document.querySelectorAll('.mode-tab').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`tab-${mode}`).classList.add('active');
    document.getElementById('trend-canvas-box').style.display = (mode === "trend") ? 'block' : 'none';
    document.getElementById('dist-canvas-box').style.display = (mode === "dist") ? 'block' : 'none';
    if (mode === "trend") {
      window.drawMetricChart(selectedMetric, selectedAI);
    } else {
      window.drawDistCharts(selectedMetric, selectedAI);
    }
  }

  // --- åˆæœŸæç”» ---
  window.drawMetricChart(selectedMetric, selectedAI);

});
// â–²â–²â–²ã€ä¿®æ­£ç‚¹ã€‘ã“ã“ã¾ã§â–²â–²â–²
</script>
<style>
/* HUDã‚¹ã‚¿ã‚¤ãƒ«UIã®ãƒœã‚¿ãƒ³ãƒ»ã‚¿ãƒ–é¡ */
.ai-tab .ai-detail-link {
  margin-left: 0.3em;
  vertical-align: middle;
  color: #19c0e9;
}
</style>
{% endblock %}
