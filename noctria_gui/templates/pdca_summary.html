<!-- ファイル: noctria_gui/templates/pdca_summary.html -->
{% extends "base_hud.html" %}

{% block title %}📊 PDCA サマリー - Noctria Kingdom{% endblock %}
{% block header_icon %}<i class="fas fa-sync-alt"></i>{% endblock %}
{% block header_title %}PDCA SUMMARY{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}DASHBOARD{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  .filter-form { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:.75rem; align-items:end; }
  .hud-input, .hud-select {
    background: rgba(0,0,0,0.3); border:1px solid var(--panel-border);
    color: var(--text-color-base); font-family: var(--font-family); font-size:1rem;
    border-radius:4px; padding:.5rem .75rem; transition: box-shadow .25s ease;
  }
  .hud-input:focus, .hud-select:focus { outline:none; box-shadow:0 0 8px var(--glow-primary); border-color: var(--glow-primary); }
  .metrics { display:flex; gap:1rem; flex-wrap:wrap; }
  .metric-item { background: var(--bg-color); border-radius:8px; padding:1rem 1.25rem; box-shadow:0 0 10px var(--glow-primary); flex:1 1 160px; }
  .metric-item h3 { margin:.1rem 0 .25rem; font-size:.9rem; color:var(--text-color-light); }
  .metric-value { font-size:1.6rem; font-weight:700; margin:0; }
  .grid-charts { display:grid; grid-template-columns:repeat(auto-fit,minmax(340px,1fr)); gap:1.2rem; }
  .empty-note { color:#9fbad6; text-align:center; padding:.75rem 0; }
</style>

<!-- ★ まずはローカル配信（/static/vendor に配置済み想定）。CDNは不足時のみ後で読み込み -->
<script src="/static/vendor/chart.umd.js"></script>
<script src="/static/vendor/flatpickr.min.js"></script>
{% endblock %}

{% block content %}
<section class="hud-panel filter-panel">
  <h2 class="panel-title"><i class="fas fa-filter"></i> FILTER & SEARCH</h2>
  <form class="filter-form" onsubmit="return false;">
    <div>
      <label for="from-date"><i class="fas fa-calendar-alt"></i> 開始日</label>
      <input id="from-date" type="text" class="hud-input" autocomplete="off">
    </div>
    <div>
      <label for="to-date"><i class="fas fa-calendar-alt"></i> 終了日</label>
      <input id="to-date" type="text" class="hud-input" autocomplete="off">
    </div>
    <div>
      <label for="limit-select"><i class="fas fa-list-ol"></i> 表示件数</label>
      <select id="limit-select" class="hud-select">
        <option value="20" selected>20件</option>
        <option value="50">50件</option>
        <option value="100">100件</option>
      </select>
    </div>
    <div>
      <button id="applyBtn" class="hud-link" type="button">🔍 適用</button>
    </div>
  </form>
</section>

<section class="hud-panel">
  <h2 class="panel-title"><i class="fas fa-calculator"></i> OVERALL KPI</h2>
  <div class="metrics">
    <div class="metric-item">
      <h3><i class="fas fa-robot"></i> Evaluations</h3>
      <p id="kpi-evals" class="metric-value">-</p>
    </div>
    <div class="metric-item">
      <h3><i class="fas fa-redo"></i> Rechecks</h3>
      <p id="kpi-rechecks" class="metric-value">-</p>
    </div>
    <div class="metric-item">
      <h3><i class="fas fa-percentage"></i> Win Rate</h3>
      <p id="kpi-winrate" class="metric-value">-</p>
    </div>
    <div class="metric-item">
      <h3><i class="fas fa-chart-area"></i> Max DD</h3>
      <p id="kpi-dd" class="metric-value">-</p>
    </div>
    <div class="metric-item">
      <h3><i class="fas fa-exchange-alt"></i> Trades</h3>
      <p id="kpi-trades" class="metric-value">-</p>
    </div>
    <div class="metric-item">
      <h3><i class="fas fa-check-double"></i> Adopted</h3>
      <p id="kpi-adopted" class="metric-value">-</p>
    </div>
  </div>
</section>

<div class="grid-charts">
  <section class="hud-panel">
    <h2 class="panel-title"><i class="fas fa-chart-bar"></i> 日次 Evaluations</h2>
    <div style="height:300px"><canvas id="chartEvals"></canvas></div>
    <div id="noteEvals" class="empty-note" style="display:none">データがありません</div>
  </section>
  <section class="hud-panel">
    <h2 class="panel-title"><i class="fas fa-chart-line"></i> 日次 Win Rate (%)</h2>
    <div style="height:300px"><canvas id="chartWinRate"></canvas></div>
    <div id="noteWR" class="empty-note" style="display:none">データがありません</div>
  </section>
  <section class="hud-panel">
    <h2 class="panel-title"><i class="fas fa-chart-bar"></i> 日次 Trades</h2>
    <div style="height:300px"><canvas id="chartTrades"></canvas></div>
    <div id="noteTrades" class="empty-note" style="display:none">データがありません</div>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script>
/* ---------- 不足時だけCDNを読み込むフォールバック ---------- */
(function ensureLibs() {
  function addScript(src, onload){ var s=document.createElement('script'); s.src=src; s.onload=onload||function(){}; document.head.appendChild(s); }
  function need(name){ return (typeof window[name] === 'undefined'); }
  var p = [];
  if (need('Chart'))     p.push(new Promise(res => addScript('https://cdn.jsdelivr.net/npm/chart.js', res)));
  if (need('flatpickr')) p.push(new Promise(res => addScript('https://cdn.jsdelivr.net/npm/flatpickr', res)));
  Promise.all(p).then(function(){
    if (need('Chart'))     addScript('https://unpkg.com/chart.js@4.4.1/dist/chart.umd.js');
    if (need('flatpickr')) addScript('https://unpkg.com/flatpickr@4.6.13/dist/flatpickr.min.js');
    setTimeout(function(){ // 最終フォールバックでもう一度ローカルを試す
      if (need('Chart'))     addScript('/static/vendor/chart.umd.js');
      if (need('flatpickr')) addScript('/static/vendor/flatpickr.min.js');
    }, 500);
  });
})();
</script>

<script>
/* =========================
   メインスクリプト（ロード待ち & グローバル公開）
   ========================= */
window.charts = { evals:null, winrate:null, trades:null };     // ★ コンソールから参照できるようにwindowへ
window.GLOBAL_DEFAULT_FROM = null;
window.GLOBAL_DEFAULT_TO   = null;

function fmtPercent(x) { return (x == null) ? '—' : (x * 100).toFixed(2) + '%'; }
function fmtDD(x)      { return (x == null) ? '—' : (x * 100).toFixed(2) + '%'; }
function setText(id, t){ const el=document.getElementById(id); if(el) el.textContent = t; }
function show(el, b)   { el.style.display = b ? '' : 'none'; }

function createChart(ctx, type, labels, datasetLabel, data, ySuffix) {
  const gridC='rgba(0, 229, 255, 0.15)', axisC='#a8b2d1';
  return new Chart(ctx, {
    type,
    data: { labels, datasets: [{ label: datasetLabel, data }] },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ display:false } },
      scales:{
        y:{ beginAtZero:true, grid:{ color:gridC }, ticks:{ color:axisC, callback:v => ySuffix ? `${v}${ySuffix}` : v } },
        x:{ grid:{ color:gridC }, ticks:{ color:axisC } }
      }
    }
  });
}

function isoDateDaysAgo(days){
  const t = new Date();
  const d = new Date(Date.UTC(t.getUTCFullYear(), t.getUTCMonth(), t.getUTCDate() - days));
  return d.toISOString().slice(0,10);
}

/* ★ refresh をグローバルに公開（Consoleから呼べるように） */
window.refresh = async function refresh() {
  // inputが空ならグローバルデフォルトで補完（422回避）
  const from = (document.getElementById('from-date').value || window.GLOBAL_DEFAULT_FROM || isoDateDaysAgo(14));
  const to   = (document.getElementById('to-date').value   || window.GLOBAL_DEFAULT_TO   || isoDateDaysAgo(0));
  const limit= document.getElementById('limit-select').value || '20';

  const url = `/pdca/summary/data?from_date=${encodeURIComponent(from)}&to_date=${encodeURIComponent(to)}&limit=${encodeURIComponent(limit)}`;
  let json;
  try {
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) {
      const txt = await res.text().catch(()=> '');
      throw new Error(`HTTP ${res.status} ${res.statusText} ${txt}`);
    }
    json = await res.json();
  } catch (e) {
    console.error('API失敗', e);
    alert('データ取得に失敗しました: ' + e.message);
    return;
  }

  // ----- KPI 更新 -----
  const t = json.totals || {};
  setText('kpi-evals',    (t.evals ?? 0).toString());
  setText('kpi-rechecks', (t.rechecks ?? 0).toString());
  setText('kpi-trades',   (t.trades ?? 0).toString());
  setText('kpi-adopted',  (t.adopted ?? 0).toString());
  setText('kpi-winrate',  fmtPercent(t.win_rate));
  setText('kpi-dd',       fmtDD(t.max_drawdown));

  // ----- グラフ用データ -----
  const byDay = Array.isArray(json.by_day) ? json.by_day : [];
  const labels = byDay.map(r => r.date);
  const evals  = byDay.map(r => r.evals ?? 0);
  const trades = byDay.map(r => r.trades ?? 0);
  const wr     = byDay.map(r => (r.win_rate == null ? null : +(r.win_rate * 100).toFixed(2)));

  // 空データメッセージ
  show(document.getElementById('noteEvals'),  labels.length === 0);
  show(document.getElementById('noteTrades'), labels.length === 0);
  show(document.getElementById('noteWR'),     labels.length === 0);

  // 既存チャート破棄
  for (const k of Object.keys(window.charts)) {
    if (window.charts[k]) { window.charts[k].destroy(); window.charts[k] = null; }
  }

  // 描画
  window.charts.evals   = createChart(document.getElementById('chartEvals').getContext('2d'),  'bar',  labels, 'Evaluations',  evals,  '');
  window.charts.trades  = createChart(document.getElementById('chartTrades').getContext('2d'), 'bar',  labels, 'Trades',       trades, '');
  window.charts.winrate = createChart(document.getElementById('chartWinRate').getContext('2d'),'line', labels, 'Win Rate (%)', wr,     '%');
};

/* ========= DOM とライブラリのロードを待ってから初期化 ========= */
document.addEventListener('DOMContentLoaded', function () {
  // 1) まず input にデフォルト日付（flatpickr未読込でも値が入る）
  window.GLOBAL_DEFAULT_FROM = isoDateDaysAgo(14);
  window.GLOBAL_DEFAULT_TO   = isoDateDaysAgo(0);
  var fromI = document.getElementById('from-date');
  var toI   = document.getElementById('to-date');
  if (fromI && !fromI.value) fromI.value = window.GLOBAL_DEFAULT_FROM;
  if (toI   && !toI.value)   toI.value   = window.GLOBAL_DEFAULT_TO;

  // 2) Flatpickrが来たら上書き初期化（なくてもOK）
  (function initPickers(){
    if (typeof flatpickr === 'undefined') return void setTimeout(initPickers, 120);
    flatpickr('#from-date', { dateFormat:'Y-m-d', allowInput:true, defaultDate: window.GLOBAL_DEFAULT_FROM });
    flatpickr('#to-date',   { dateFormat:'Y-m-d', allowInput:true, defaultDate: window.GLOBAL_DEFAULT_TO   });
  })();

  // 3) ボタンイベント登録
  var btn = document.getElementById('applyBtn');
  if (btn) btn.addEventListener('click', window.refresh);

  // 4) Chart.js を待って初回描画
  (function waitChart(){
    if (typeof Chart === 'undefined') return void setTimeout(waitChart, 120);
    window.refresh();
  })();

  console.log('[PDCA Summary] Ready');
});
</script>
{% endblock %}
