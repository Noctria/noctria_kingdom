<!-- noctria_gui/templates/pdca_summary.html -->
{% extends "base_hud.html" %}

{% block title %}{{ page_title or "ğŸ“Š PDCA ã‚µãƒãƒªãƒ¼" }} - Noctria Kingdom{% endblock %}
{% block header_icon %}<i class="fas fa-sync-alt" aria-hidden="true"></i>{% endblock %}
{% block header_title %}PDCA SUMMARY{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}DASHBOARD{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  .filter-form { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:.75rem; align-items:end; }
  .hud-input, .hud-select {
    background: rgba(0,0,0,0.3); border:1px solid var(--panel-border);
    color: var(--text-color-base); font-family: var(--font-family); font-size:1rem;
    border-radius:4px; padding:.5rem .75rem; transition: box-shadow .25s ease;
  }
  .hud-input:focus, .hud-select:focus { outline:none; box-shadow:0 0 8px var(--glow-primary); border-color: var(--glow-primary); }
  .metrics { display:flex; gap:1rem; flex-wrap:wrap; }
  .metric-item { background: var(--bg-color); border-radius:8px; padding:1rem 1.25rem; box-shadow:0 0 10px var(--glow-primary); flex:1 1 180px; }
  .metric-item h3 { margin:.1rem 0 .25rem; font-size:.9rem; color:var(--text-color-light); }
  .metric-value { font-size:1.6rem; font-weight:700; margin:0; }
  .grid-charts { display:grid; grid-template-columns:repeat(auto-fit,minmax(340px,1fr)); gap:1.2rem; }
  .empty-note { color:#9fbad6; text-align:center; padding:.75rem 0; }
  .btn-row { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-top:.5rem; }
  .preset-row { display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.25rem; }
  .widget-frame { width:100%; border:none; min-height:480px; overflow:hidden; border-radius:8px; }
  .grid-quicklinks { display:grid; gap:1rem; grid-template-columns:repeat(3,minmax(0,1fr)); margin-top:1rem; }
  .link-card { text-decoration:none; color:inherit; }

  /* Toast / spinner */
  .toast { position: fixed; right: 1rem; bottom: 1rem; z-index: 9999; background: rgba(0,0,0,.7); border:1px solid rgba(255,255,255,.15); padding:.6rem .9rem; border-radius:.5rem; display:none; }
  .toast.show { display:block; } .toast.ok { border-color:#22c55e; } .toast.err { border-color:#ef4444; }
  .spinner { display:none; margin-left:.5rem } .spinner.show { display:inline-block; }

  /* Table */
  .table-wrap { overflow:auto; }
  table.hud-table { width:100%; border-collapse:collapse; font-size:.95rem; }
  table.hud-table th, table.hud-table td { padding:.5rem .6rem; border-bottom:1px solid var(--panel-border); white-space:nowrap; }
  table.hud-table th { text-align:left; color:var(--text-color-light); cursor:pointer; user-select:none; }
  table.hud-table th .sort { opacity:.7; font-size:.85em; margin-left:.25rem; }
  .pager { display:flex; gap:.5rem; align-items:center; justify-content:flex-end; margin-top:.5rem; }
  .pager .hud-link[disabled] { opacity:.5; pointer-events:none; }
</style>

<!-- ãƒ­ãƒ¼ã‚«ãƒ« â†’ è¶³ã‚Šãªã‘ã‚Œã°å¾Œæ®µã§CDNãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ -->
<script src="/static/vendor/chart.umd.js"></script>
<script src="/static/vendor/flatpickr.min.js"></script>
{% endblock %}

{% block content %}
<section class="hud-panel filter-panel" aria-labelledby="filter-title">
  <h2 id="filter-title" class="panel-title"><i class="fas fa-filter" aria-hidden="true"></i> FILTER & SEARCH</h2>
  <form class="filter-form" onsubmit="return false;">
    <div>
      <label for="from-date"><i class="fas fa-calendar-alt" aria-hidden="true"></i> é–‹å§‹æ—¥</label>
      <input id="from-date" type="text" class="hud-input" inputmode="numeric" autocomplete="off" placeholder="YYYY-MM-DD">
    </div>
    <div>
      <label for="to-date"><i class="fas fa-calendar-alt" aria-hidden="true"></i> çµ‚äº†æ—¥</label>
      <input id="to-date" type="text" class="hud-input" inputmode="numeric" autocomplete="off" placeholder="YYYY-MM-DD">
    </div>
    <div>
      <label for="tag-input"><i class="fas fa-tags" aria-hidden="true"></i> ã‚¿ã‚°/æˆ¦ç•¥</label>
      <input id="tag-input" type="text" class="hud-input" placeholder="e.g. veritas / levia">
    </div>
    <div>
      <label for="win-diff-input"><i class="fas fa-arrow-trend-up" aria-hidden="true"></i> å‹ç‡å·®åˆ† â‰¥ %</label>
      <input id="win-diff-input" type="number" step="0.1" class="hud-input" placeholder="ä¾‹: 0.7">
    </div>
    <div>
      <label for="dd-diff-input"><i class="fas fa-arrow-trend-down" aria-hidden="true"></i> æœ€å¤§DDå·®åˆ† â‰¤ %</label>
      <input id="dd-diff-input" type="number" step="0.1" class="hud-input" placeholder="ä¾‹: -0.6">
    </div>
    <div>
      <label for="min-trades-input"><i class="fas fa-list-ol" aria-hidden="true"></i> æœ€å°å–å¼•æ•°</label>
      <input id="min-trades-input" type="number" step="1" min="0" class="hud-input" placeholder="ä¾‹: 30">
    </div>

    <div class="btn-row">
      <button id="applyBtn" class="hud-link" type="button">ğŸ” é©ç”¨ <span id="applySpin" class="spinner">â³</span></button>
      <a id="csvBtn" class="hud-link" href="#" download>â¬‡ï¸ CSV</a>
      <button id="copyLinkBtn" class="hud-link" type="button" aria-label="ç¾åœ¨ã®æ¡ä»¶ã‚’å«ã‚€URLã‚’ã‚³ãƒ”ãƒ¼">ğŸ”— ãƒªãƒ³ã‚¯ã‚³ãƒ”ãƒ¼</button>
      <button id="recheckAllBtn" class="hud-link" type="button">ğŸ” ä¸€æ‹¬å†è©•ä¾¡</button>
    </div>

    <!-- ã‚¯ã‚¤ãƒƒã‚¯ãƒ—ãƒªã‚»ãƒƒãƒˆ -->
    <div class="preset-row">
      <button type="button" class="hud-link preset-btn" data-days="0">ä»Šæ—¥</button>
      <button type="button" class="hud-link preset-btn" data-days="7">7æ—¥é–“</button>
      <button type="button" class="hud-link preset-btn" data-days="30">30æ—¥é–“</button>
      <button type="button" class="hud-link preset-btn" data-mode="year">ä»Šå¹´</button>
      <button type="button" class="hud-link preset-btn" data-mode="reset">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </form>
</section>

<!-- ç›´è¿‘æ¡ç”¨ã‚¿ã‚°ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ -->
{% set w = recent_adoptions_params or {'pattern':'veritas-','limit':9,'cols':3,'title':'ğŸ§© ç›´è¿‘æ¡ç”¨ã‚¿ã‚°'} %}
<section class="hud-panel" aria-labelledby="adopt-widget-title">
  <h2 id="adopt-widget-title" class="panel-title"><i class="fas fa-tags" aria-hidden="true"></i> ç›´è¿‘ã®æ¡ç”¨ã‚¿ã‚°</h2>
  <iframe
    class="widget-frame"
    src="/pdca/widgets/recent-adoptions?pattern={{ w.pattern | urlencode }}&limit={{ w.limit }}&cols={{ w.cols }}&title={{ w.title | urlencode }}"
    loading="lazy"
  ></iframe>
</section>

<section class="hud-panel" aria-labelledby="kpi-title">
  <h2 id="kpi-title" class="panel-title"><i class="fas fa-calculator" aria-hidden="true"></i> OVERALL KPIï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å¾Œï¼‰</h2>
  <div class="metrics" role="list">
    <div class="metric-item" role="listitem"><h3><i class="fas fa-hashtag" aria-hidden="true"></i> å¯¾è±¡ä»¶æ•°</h3><p id="kpi-count" class="metric-value" aria-live="polite">-</p></div>
    <div class="metric-item" role="listitem"><h3><i class="fas fa-check-circle" aria-hidden="true"></i> æ¡ç”¨ä»¶æ•°</h3><p id="kpi-adopted" class="metric-value" aria-live="polite">-</p></div>
    <div class="metric-item" role="listitem"><h3><i class="fas fa-redo-alt" aria-hidden="true"></i> å†è©•ä¾¡ä»¶æ•°</h3><p id="kpi-rechecks" class="metric-value" aria-live="polite">-</p></div>
    <div class="metric-item" role="listitem"><h3><i class="fas fa-percentage" aria-hidden="true"></i> å‹ç‡ï¼ˆå¹³å‡ï¼‰</h3><p id="kpi-winrate" class="metric-value" aria-live="polite">-</p></div>
    <div class="metric-item" role="listitem"><h3><i class="fas fa-chart-area" aria-hidden="true"></i> æœ€å¤§DDï¼ˆæœ€æ‚ªï¼‰</h3><p id="kpi-maxdd" class="metric-value" aria-live="polite">-</p></div>
  </div>
</section>

<div class="grid-charts">
  <section class="hud-panel" aria-labelledby="chart-counts-title">
    <h2 id="chart-counts-title" class="panel-title"><i class="fas fa-chart-bar" aria-hidden="true"></i> æ—¥æ¬¡ ä»¶æ•°ï¼ˆè©•ä¾¡ / æ¡ç”¨ï¼‰</h2>
    <div class="btn-row" style="margin:.25rem 0 .5rem"><button type="button" class="hud-link" onclick="downloadChartPNG('chartCounts','counts')">ğŸ“¸ ç”»åƒä¿å­˜</button></div>
    <div style="height:300px"><canvas id="chartCounts" role="img" aria-label="æ—¥æ¬¡ã®è©•ä¾¡ä»¶æ•°ã¨æ¡ç”¨ä»¶æ•°ã®ã‚°ãƒ©ãƒ•"></canvas></div>
    <div id="noteCounts" class="empty-note" style="display:none">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
  </section>
  <section class="hud-panel" aria-labelledby="chart-windiff-title">
    <h2 id="chart-windiff-title" class="panel-title"><i class="fas fa-chart-line" aria-hidden="true"></i> æ—¥æ¬¡ å‹ç‡ï¼ˆå¹³å‡ %ï¼‰</h2>
    <div class="btn-row" style="margin:.25rem 0 .5rem"><button type="button" class="hud-link" onclick="downloadChartPNG('chartWinDiff','winrate')">ğŸ“¸ ç”»åƒä¿å­˜</button></div>
    <div style="height:300px"><canvas id="chartWinDiff" role="img" aria-label="æ—¥æ¬¡ã®å‹ç‡ã®æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•"></canvas></div>
    <div id="noteWinDiff" class="empty-note" style="display:none">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
  </section>
</div>

<!-- è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
<section id="details-panel" class="hud-panel" aria-labelledby="details-title" style="display:none">
  <h2 id="details-title" class="panel-title"><i class="fas fa-table" aria-hidden="true"></i> DETAILS</h2>
  <div class="btn-row" style="margin:.25rem 0 .5rem">
    <label for="page-size">è¡¨ç¤ºä»¶æ•°</label>
    <select id="page-size" class="hud-select" style="width:auto">
      <option value="20" selected>20</option><option value="50">50</option><option value="100">100</option>
    </select>
    <div style="margin-left:auto; display:flex; gap:.5rem; align-items:center;">
      <button id="exportCsvBtn" class="hud-link" type="button">ğŸ“¤ CSVå‡ºåŠ›</button>
      <button id="exportJsonBtn" class="hud-link" type="button">ğŸ“¤ JSONå‡ºåŠ›</button>
      <span class="muted" id="details-info"></span>
    </div>
  </div>
  <div class="table-wrap">
    <table class="hud-table" id="details-table">
      <thead>
        <tr>
          <th data-key="date">æ—¥ä»˜ <span class="sort">â†•</span></th>
          <th data-key="tag">ã‚¿ã‚° <span class="sort">â†•</span></th>
          <th data-key="evals">è©•ä¾¡ <span class="sort">â†•</span></th>
          <th data-key="adopted">æ¡ç”¨ <span class="sort">â†•</span></th>
          <th data-key="win_rate">å‹ç‡(%) <span class="sort">â†•</span></th>
          <th data-key="max_drawdown">æœ€å¤§DD(%) <span class="sort">â†•</span></th>
          <th data-key="rechecks">å†è©•ä¾¡ <span class="sort">â†•</span></th>
          <th data-key="trades">å–å¼•æ•° <span class="sort">â†•</span></th>
        </tr>
      </thead>
      <tbody id="details-body"></tbody>
    </table>
  </div>
  <div class="pager">
    <button class="hud-link" id="prevPage">â—€ å‰ã¸</button>
    <span id="pageStatus">1 / 1</span>
    <button class="hud-link" id="nextPage">æ¬¡ã¸ â–¶</button>
  </div>
</section>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
{% endblock %}

{% block scripts %}
<script>
/* ---------- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èª­è¾¼ ---------- */
(function ensureLibs() {
  function addScript(src, onload){ var s=document.createElement('script'); s.src=src; s.defer=true; s.onload=onload||function(){}; document.head.appendChild(s); }
  function need(name){ return (typeof window[name] === 'undefined'); }
  const p = [];
  if (need('Chart'))     p.push(new Promise(res => addScript('https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js', res)));
  if (need('flatpickr')) p.push(new Promise(res => addScript('https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js', res)));
  Promise.all(p).then(function(){
    setTimeout(function(){
      if (need('Chart'))     addScript('/static/vendor/chart.umd.js');
      if (need('flatpickr')) addScript('/static/vendor/flatpickr.min.js');
    }, 400);
  });
})();
</script>

<script>
/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
function $(id){ return document.getElementById(id); }
function setText(id, t){ const el=$(id); if(el) el.textContent = (t ?? 'â€”'); }
function show(el, b){ if(el) el.style.display = b ? '' : 'none'; }
function intFmt(v){ if(v==null || isNaN(+v)) return 'â€”'; return String(Math.trunc(+v)); }
function percentFmt(v){ if(v==null || isNaN(+v)) return 'â€”'; return (Number(v)*100).toFixed(1) + '%'; }
function toast(msg, ok=true){ const t=$('toast'); if(!t) return; t.className='toast '+(ok?'ok':'err')+' show'; t.textContent=msg; setTimeout(()=>{t.className='toast';},1800); }

function isoDateDaysAgo(days){ const now=new Date(); const d=new Date(now.getFullYear(),now.getMonth(),now.getDate()-days);
  const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${yyyy}-${mm}-${dd}`; }
function normalizeDate(s){
  if(!s) return s; const t=String(s).trim();
  if(/^\d{8}$/.test(t)) return `${t.slice(0,4)}-${t.slice(4,6)}-${t.slice(6,8)}`;
  if(/^\d{4}-\d{2}-\d{2}$/.test(t)) return t;
  const d=new Date(t); if(!isNaN(d)) { const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
  return t;
}

/* ====== PNGå‡ºåŠ› ====== */
function downloadChartPNG(canvasId, baseName){
  const el=$(canvasId); if(!el) return;
  try{ const url=el.toDataURL('image/png',1.0); const a=document.createElement('a'); const stamp=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    a.href=url; a.download=`pdca-${baseName}-${stamp}.png`; document.body.appendChild(a); a.click(); a.remove(); toast('ç”»åƒã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ'); }
  catch(e){ console.error('png export failed', e); toast('ç”»åƒã®æ›¸ãå‡ºã—ã«å¤±æ•—', false); }
}

/* ====== ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ ====== */
window.NoctriaPDCA = window.NoctriaPDCA || {};
function getCharts(){ if(!window.NoctriaPDCA.charts) window.NoctriaPDCA.charts={counts:null,winDiff:null}; return window.NoctriaPDCA.charts; }
window.GLOBAL_DEFAULT_FROM=null; window.GLOBAL_DEFAULT_TO=null;

/* ====== URL â‡„ å…¥åŠ› ====== */
function readUrlIntoInputs(){
  const usp=new URLSearchParams(location.search);
  const rawFrom=usp.get('date_from')||usp.get('from_date')||usp.get('from');
  const rawTo  =usp.get('date_to')  ||usp.get('to_date')  ||usp.get('to');
  const from=normalizeDate(rawFrom||window.GLOBAL_DEFAULT_FROM||isoDateDaysAgo(14));
  const to  =normalizeDate(rawTo  ||window.GLOBAL_DEFAULT_TO  ||isoDateDaysAgo(0));
  $('from-date').value=from; $('to-date').value=to;
  $('tag-input') && ( $('tag-input').value = usp.get('tag')||'' );
  $('win-diff-input') && ( $('win-diff-input').value = usp.get('win_diff')||'' );
  $('dd-diff-input') && ( $('dd-diff-input').value = usp.get('dd_diff')||'' );
  $('min-trades-input') && ( $('min-trades-input').value = usp.get('min_trades')||'' );
}
function inputsToParamsAllKeys(){
  const from=normalizeDate($('from-date')?.value||window.GLOBAL_DEFAULT_FROM||isoDateDaysAgo(14));
  const to  =normalizeDate($('to-date')?.value  ||window.GLOBAL_DEFAULT_TO  ||isoDateDaysAgo(0));
  const tag=$('tag-input')?.value?.trim(), win=$('win-diff-input')?.value?.trim(), dd=$('dd-diff-input')?.value?.trim(), mt=$('min-trades-input')?.value?.trim();
  const p=new URLSearchParams(); p.set('date_from',from); p.set('date_to',to); p.set('from_date',from); p.set('to_date',to); p.set('from',from); p.set('to',to);
  if(tag) p.set('tag',tag); if(win) p.set('win_diff',win); if(dd) p.set('dd_diff',dd); if(mt) p.set('min_trades',mt); return p;
}
function buildCsvParams(){ return inputsToParamsAllKeys(); }
function wireCsvButton(){ const a=$('csvBtn'); if(a) a.href='/pdca/summary.csv?'+buildCsvParams().toString(); }

/* ====== å…±æœ‰ãƒªãƒ³ã‚¯ã‚³ãƒ”ãƒ¼ ====== */
function buildShareUrl(){ const qs=inputsToParamsAllKeys().toString(); return location.origin+location.pathname+(qs?`?${qs}`:''); }
async function copyShareUrl(){
  const url=buildShareUrl();
  try{ await navigator.clipboard.writeText(url); toast('å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }
  catch(e){
    try{ const ta=document.createElement('textarea'); ta.value=url; ta.style.position='fixed'; ta.style.left='-9999px';
      document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); toast('å…±æœ‰ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }
    catch(e2){ prompt('ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', url); }
  }
}

/* ====== ãƒ—ãƒªã‚»ãƒƒãƒˆ ====== */
function wirePresets(){
  document.querySelectorAll('.preset-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const mode=btn.dataset.mode, days=+btn.dataset.days;
      if(mode==='year'){ const y=new Date().getFullYear(); $('from-date').value=`${y}-01-01`; $('to-date').value=isoDateDaysAgo(0); }
      else if(mode==='reset'){ $('from-date').value=window.GLOBAL_DEFAULT_FROM||isoDateDaysAgo(14); $('to-date').value=window.GLOBAL_DEFAULT_TO||isoDateDaysAgo(0); }
      else{ $('from-date').value=isoDateDaysAgo(days); $('to-date').value=isoDateDaysAgo(0); }
      window.pdcaRefresh && window.pdcaRefresh();
    });
  });
}

/* ====== ãƒ†ãƒ¼ãƒ–ãƒ« ====== */
const tableState={ raw:[], view:[], page:1, pageSize:20, sortKey:'date', sortDir:'desc' };
function coerceRow(r){ return { date:r.date??r.day??'', tag:r.tag??r.strategy??r.name??'',
  evals:(+r.evals)||0, adopted:(+r.adopted)||0,
  win_rate:(r.win_rate==null?null:+(+r.win_rate*100).toFixed(2)),
  max_drawdown:(r.max_drawdown==null?null:+(+r.max_drawdown*100).toFixed(2)),
  rechecks:(+r.rechecks||+r.recheck_count||0), trades:(+r.trades||+r.num_trades||0) }; }
function sortView(){ const k=tableState.sortKey,d=tableState.sortDir; tableState.view=[...tableState.raw].sort((a,b)=>{
  const va=a[k],vb=b[k]; if(va==null&&vb==null)return 0; if(va==null)return 1; if(vb==null)return -1;
  if(typeof va==='number' && typeof vb==='number') return d==='asc'?va-vb:vb-va;
  return d==='asc'?String(va).localeCompare(String(vb)):String(vb).localeCompare(String(va));}); }
function renderTablePage(){
  const panel=$('details-panel'); if(!panel) return; if(!tableState.view.length){ panel.style.display='none'; return; } panel.style.display='';
  const body=$('details-body'),info=$('details-info'); const ps=tableState.pageSize,total=tableState.view.length;
  const totalPages=Math.max(1,Math.ceil(total/ps)); if(tableState.page>totalPages) tableState.page=totalPages;
  const start=(tableState.page-1)*ps; const slice=tableState.view.slice(start,start+ps);
  body.innerHTML=slice.map(r=>`<tr><td>${r.date||''}</td><td>${r.tag||''}</td><td>${r.evals}</td><td>${r.adopted}</td>
  <td>${r.win_rate==null?'â€”':r.win_rate.toFixed(2)}</td><td>${r.max_drawdown==null?'â€”':r.max_drawdown.toFixed(2)}</td>
  <td>${r.rechecks}</td><td>${r.trades}</td></tr>`).join('');
  setText('pageStatus', `${tableState.page} / ${totalPages}`); setText('details-info', `å…¨ ${total} ä»¶`);
  $('prevPage')?.toggleAttribute?.('disabled', tableState.page<=1);
  $('nextPage')?.toggleAttribute?.('disabled', tableState.page>=totalPages);
}
function attachTableEvents(){
  $('details-table')?.querySelector('thead')?.addEventListener('click',(ev)=>{
    const th=ev.target.closest('th'); if(!th?.dataset.key) return; const key=th.dataset.key;
    if(tableState.sortKey===key){ tableState.sortDir = (tableState.sortDir==='asc'?'desc':'asc'); }
    else { tableState.sortKey=key; tableState.sortDir=(key==='date'||key==='tag')?'asc':'desc'; }
    sortView(); tableState.page=1; renderTablePage();
  });
  $('prevPage')?.addEventListener('click', ()=>{ if(tableState.page>1){ tableState.page--; renderTablePage(); }});
  $('nextPage')?.addEventListener('click', ()=>{ tableState.page++; renderTablePage(); });
  $('page-size')?.addEventListener('change', (e)=>{ tableState.pageSize=+e.target.value||20; tableState.page=1; renderTablePage(); });
}

/* ====== ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆCSV/JSONï¼‰ ====== */
function getRangeSlug(){
  const usp = new URLSearchParams(location.search);
  const from = normalizeDate(usp.get('date_from')||usp.get('from_date')||usp.get('from')||$('from-date')?.value||'');
  const to   = normalizeDate(usp.get('date_to')  ||usp.get('to_date')  ||usp.get('to')  ||$('to-date')?.value  ||'');
  return `${from||'NA'}_${to||'NA'}`;
}
function downloadBlob(data, mime, filename){
  const blob = new Blob([data], {type: mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function toCsvValue(v){
  const s = (v==null) ? '' : String(v);
  if (/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}
function exportDetailsCSV(){
  if(!tableState.view.length){ toast('å‡ºåŠ›å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“', false); return; }
  const header = ['date','tag','evals','adopted','win_rate_pct','max_drawdown_pct','rechecks','trades'];
  const rows = tableState.view.map(r=>[
    r.date||'', r.tag||'', r.evals, r.adopted,
    (r.win_rate==null?'':r.win_rate.toFixed(2)),
    (r.max_drawdown==null?'':r.max_drawdown.toFixed(2)),
    r.rechecks, r.trades
  ]);
  const bom = '\uFEFF'; // Excelå¯¾ç­–
  const csv = [header.join(','), ...rows.map(rr=>rr.map(toCsvValue).join(','))].join('\n');
  const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  downloadBlob(bom + csv, 'text/csv;charset=utf-8', `pdca_details_${getRangeSlug()}_${stamp}.csv`);
  toast('CSVã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ');
}
function exportDetailsJSON(){
  if(!tableState.view.length){ toast('å‡ºåŠ›å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“', false); return; }
  // æ•°å€¤ã¯ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºã¨åŒã˜ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆ%ã¯0-100ï¼‰ã§è½ã¨ã™
  const data = tableState.view.map(r=>({
    date: r.date||'',
    tag:  r.tag||'',
    evals: r.evals,
    adopted: r.adopted,
    win_rate_pct: (r.win_rate==null?null:+r.win_rate.toFixed(2)),
    max_drawdown_pct: (r.max_drawdown==null?null:+r.max_drawdown.toFixed(2)),
    rechecks: r.rechecks,
    trades: r.trades
  }));
  const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  downloadBlob(JSON.stringify(data, null, 2), 'application/json;charset=utf-8', `pdca_details_${getRangeSlug()}_${stamp}.json`);
  toast('JSONã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ');
}

/* ====== é€£æ‰“é˜²æ­¢ ====== */
let fetching=false;
function setApplying(b){ const btn=$('applyBtn'), spin=$('applySpin'); fetching=b; if(btn){btn.disabled=b; btn.style.opacity=b?.6:1;} if(spin){ b?spin.classList.add('show'):spin.classList.remove('show'); } }

/* ====== ä¸€æ‹¬å†è©•ä¾¡ ====== */
async function triggerRecheckAll(){
  const reason = prompt("ä¸€æ‹¬å†è©•ä¾¡ã®ç†ç”±ï¼ˆä»»æ„ï¼‰", "") || "";
  const p = inputsToParamsAllKeys();
  const url = new URL('/pdca/recheck_all', location.origin);
  url.searchParams.set('reason', reason);
  url.searchParams.set('filter_date_from', p.get('date_from'));
  url.searchParams.set('filter_date_to', p.get('date_to'));
  try{
    const res = await fetch(url.toString(), { method:'POST' });
    const js = await res.json().catch(()=>({message:'æœªçŸ¥ã®å¿œç­”'}));
    toast(js.message || 'èµ·å‹•ã—ã¾ã—ãŸ', res.ok);
  }catch(e){
    toast('å†è©•ä¾¡ã®èµ·å‹•ã«å¤±æ•—: ' + (e?.message || e), false);
  }
}

/* ====== API ====== */
async function fetchDetailsFallback(qs){
  try{ const res=await fetch('/pdca/api/details?'+qs,{cache:'no-store'}); if(!res.ok) return []; const js=await res.json(); return Array.isArray(js)?js:(Array.isArray(js?.items)?js.items:[]);}catch{return[]}
}
async function doRefresh(){
  const p=inputsToParamsAllKeys(); const qs=p.toString();
  history.replaceState(null,'',location.pathname+'?'+qs);

  const res = await fetch('/pdca/api/summary?'+qs, { cache:'no-store' });
  if(!res.ok) throw new Error('summary HTTP '+res.status);
  const s = await res.json();

  const t = s?.totals || {};
  setText('kpi-count', intFmt(s?.count_rows));
  setText('kpi-adopted', intFmt(t?.adopted));
  setText('kpi-rechecks', intFmt(t?.rechecks));
  setText('kpi-winrate', percentFmt(t?.win_rate));
  setText('kpi-maxdd', percentFmt(t?.max_drawdown));

  const by = Array.isArray(s?.by_day) ? s.by_day : [];
  const labels = by.map(r => r?.date ?? '');
  const evals  = by.map(r => (+r?.evals)||0);
  const adopted= by.map(r => (+r?.adopted)||0);
  const wrPct  = by.map(r => (r?.win_rate==null ? null : +(r.win_rate*100).toFixed(2)));

  show($('noteCounts'),  labels.length===0);
  show($('noteWinDiff'), labels.length===0);

  const charts=getCharts();
  if (charts.counts?.destroy) { try{ charts.counts.destroy(); }catch{} }
  if (charts.winDiff?.destroy) { try{ charts.winDiff.destroy(); }catch{} }
  charts.counts=null; charts.winDiff=null;

  const ctxCounts=$('chartCounts'), ctxWinDiff=$('chartWinDiff');
  if (ctxCounts?.getContext) charts.counts = new Chart(ctxCounts.getContext('2d'), {
    type:'bar', data:{ labels, datasets:[{label:'è©•ä¾¡ä»¶æ•°',data:evals,yAxisID:'y1'},{label:'æ¡ç”¨ä»¶æ•°',data:adopted,yAxisID:'y1'}]},
    options:{ responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false},
      scales:{ y1:{ type:'linear', position:'left', beginAtZero:true }, x:{ ticks:{ maxRotation:0 }}}}
  });
  if (ctxWinDiff?.getContext) charts.winDiff = new Chart(ctxWinDiff.getContext('2d'), {
    type:'line', data:{ labels, datasets:[{label:'å‹ç‡ï¼ˆå¹³å‡ %ï¼‰',data:wrPct,tension:.25}]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{ ticks:{ maxRotation:0 }}, y:{ beginAtZero:true }}}
  });

  let details = Array.isArray(s?.details)? s.details : await fetchDetailsFallback(qs);
  if(Array.isArray(details) && details.length){ tableState.raw = details.map(coerceRow); sortView(); tableState.page=1; renderTablePage(); }
  else { tableState.raw=[]; tableState.view=[]; renderTablePage(); }

  wireCsvButton();
}
window.pdcaRefresh = async function(){
  if(fetching) return;
  setApplying(true);
  try{ localStorage.setItem('pdca_filters_v1', JSON.stringify({
    from:$('from-date').value, to:$('to-date').value,
    tag:$('tag-input')?.value||'', win:$('win-diff-input')?.value||'',
    dd:$('dd-diff-input')?.value||'', mt:$('min-trades-input')?.value||''
  })); await doRefresh(); toast('æ›´æ–°ã—ã¾ã—ãŸ'); }
  catch(e){ console.error('[summary] error:',e); toast('å–å¾—ã«å¤±æ•—: '+(e?.message||e), false); }
  finally{ setApplying(false); }
};

/* ====== èµ·å‹• ====== */
document.addEventListener('DOMContentLoaded', function(){
  window.GLOBAL_DEFAULT_FROM = "{{ default_from or '' }}".trim() || isoDateDaysAgo(14);
  window.GLOBAL_DEFAULT_TO   = "{{ default_to or '' }}".trim()   || isoDateDaysAgo(0);

  readUrlIntoInputs();

  (function initPickers(){
    if (typeof flatpickr === 'undefined') return void setTimeout(initPickers, 120);
    $('from-date').value = normalizeDate($('from-date').value || window.GLOBAL_DEFAULT_FROM);
    $('to-date').value   = normalizeDate($('to-date').value   || window.GLOBAL_DEFAULT_TO);
    flatpickr('#from-date', { dateFormat:'Y-m-d', allowInput:true, defaultDate:$('from-date').value });
    flatpickr('#to-date',   { dateFormat:'Y-m-d', allowInput:true, defaultDate:$('to-date').value   });
  })();

  $('applyBtn')?.addEventListener('click', window.pdcaRefresh);
  $('recheckAllBtn')?.addEventListener('click', triggerRecheckAll);
  $('copyLinkBtn')?.addEventListener('click', copyShareUrl);
  $('exportCsvBtn')?.addEventListener('click', exportDetailsCSV);
  $('exportJsonBtn')?.addEventListener('click', exportDetailsJSON);
  wirePresets();
  attachTableEvents();
  wireCsvButton();

  (function waitChart(){
    if (typeof Chart === 'undefined') return void setTimeout(waitChart, 120);
    window.pdcaRefresh();
  })();
});
</script>
{% endblock %}
