<!-- noctria_gui/templates/pdca_summary.html -->
{% extends "base_hud.html" %}
{% block title %}📊 PDCA サマリー - Noctria Kingdom{% endblock %}
{% block header_icon %}<i class="fas fa-chart-line"></i>{% endblock %}
{% block header_title %}PDCA SUMMARY{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}DASHBOARD{% endblock %}

{% block extra_head %}
  <!-- Flatpickr (styles are further customized by hud_style.css) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
{% endblock %}

{% block content %}
<div class="hud-container-simple">

  <!-- Header strip (provided by base_hud) -->

  <!-- Filter panel -->
  <section class="hud-panel">
    <div class="panel-title">🔎 FILTER</div>
    <div class="metrics" style="align-items:flex-end;">
      <div class="metric-item" style="text-align:left; flex:1 1 220px;">
        <label for="from_date" class="text-light">From (YYYY-MM-DD)</label>
        <input id="from_date" type="text" class="flatpickr-input" value="{{ default_from }}" autocomplete="off" />
      </div>
      <div class="metric-item" style="text-align:left; flex:1 1 220px;">
        <label for="to_date" class="text-light">To (YYYY-MM-DD)</label>
        <input id="to_date" type="text" class="flatpickr-input" value="{{ default_to }}" autocomplete="off" />
      </div>
      <div class="metric-item" style="flex:0 0 200px;">
        <button id="applyBtn" class="hud-link" type="button">🔍 適用</button>
      </div>
      <div class="metric-item" style="flex:0 0 200px;">
        <a class="hud-link" href="/pdca/control">🔁 Recheck パネルへ</a>
      </div>
    </div>
    <p class="text-light" style="margin-top:.5rem;">Schema: <span class="text-normal">{{ schema_version }}</span></p>
  </section>

  <!-- KPI cards -->
  <section class="hud-panel">
    <div class="panel-title">📌 KPI SUMMARY</div>
    <div class="metrics">
      <div class="metric-item">
        <div class="text-dark">再評価件数</div>
        <div class="metric-value" id="kpi-rechecks">-</div>
      </div>
      <div class="metric-item">
        <div class="text-dark">評価件数</div>
        <div class="metric-value" id="kpi-evals">-</div>
      </div>
      <div class="metric-item">
        <div class="text-dark">採用件数</div>
        <div class="metric-value" id="kpi-adopted">-</div>
      </div>
      <div class="metric-item">
        <div class="text-dark">採用率</div>
        <div class="metric-value" id="kpi-adoption-rate">-</div>
      </div>
      <div class="metric-item">
        <div class="text-dark">平均勝率</div>
        <div class="metric-value" id="kpi-win-rate">-</div>
      </div>
      <div class="metric-item">
        <div class="text-dark">取引数</div>
        <div class="metric-value" id="kpi-trades">-</div>
      </div>
    </div>
  </section>

  <!-- Charts -->
  <div class="metrics" style="gap:1.5rem;">
    <section class="hud-panel" style="flex:1 1 380px;">
      <div class="panel-title">📈 勝率の推移（Daily）</div>
      <div style="height:300px"><canvas id="chartWinRate"></canvas></div>
    </section>
    <section class="hud-panel" style="flex:1 1 380px;">
      <div class="panel-title">📦 評価/採用 件数（Daily）</div>
      <div style="height:300px"><canvas id="chartCounts"></canvas></div>
    </section>
    <section class="hud-panel" style="flex:1 1 380px;">
      <div class="panel-title">🔁 取引数の推移（Daily）</div>
      <div style="height:300px"><canvas id="chartTrades"></canvas></div>
    </section>
  </div>

</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    (function initPickers(){
      if (!window.flatpickr) return;
      var opts = { dateFormat: "Y-m-d", allowInput: true, defaultHour: 0, defaultMinute: 0 };
      try { window.flatpickr("#from_date", opts); } catch(e){}
      try { window.flatpickr("#to_date", opts); } catch(e){}
    })();

    let chartWin, chartCnt, chartTr;

    function fmtPct(x) {
      if (x == null || isNaN(x)) return "-";
      return (x * 100).toFixed(1) + "%";
    }
    function fmtNum(x) {
      if (x == null || isNaN(x)) return "-";
      return String(x);
    }

    function updateKPIs(totals) {
      document.getElementById('kpi-rechecks').textContent = fmtNum(totals?.rechecks);
      document.getElementById('kpi-evals').textContent    = fmtNum(totals?.evals);
      document.getElementById('kpi-adopted').textContent  = fmtNum(totals?.adopted);
      document.getElementById('kpi-adoption-rate').textContent = totals?.adoption_rate == null ? "-" : fmtPct(totals.adoption_rate);
      document.getElementById('kpi-win-rate').textContent = totals?.win_rate == null ? "-" : fmtPct(totals.win_rate);
      document.getElementById('kpi-trades').textContent   = fmtNum(totals?.trades);
    }

    function renderCharts(byDay) {
      const labels = byDay.map(d => d.date);
      const win    = byDay.map(d => d.win_rate == null ? null : (d.win_rate * 100.0));
      const evals  = byDay.map(d => d.evals || 0);
      const adopt  = byDay.map(d => d.adopted || 0);
      const trades = byDay.map(d => d.trades || 0);

      // 勝率ライン
      const ctx1 = document.getElementById('chartWinRate').getContext('2d');
      if (chartWin) chartWin.destroy();
      chartWin = new Chart(ctx1, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Win Rate (%)', data: win, spanGaps: true }] },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: { y: { suggestedMin: 0, suggestedMax: 100 } }
        }
      });

      // 件数バー
      const ctx2 = document.getElementById('chartCounts').getContext('2d');
      if (chartCnt) chartCnt.destroy();
      chartCnt = new Chart(ctx2, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Evals', data: evals }, { label: 'Adopted', data: adopt }] },
        options: { responsive: true, plugins: { legend: { display: true } } }
      });

      // 取引数ライン
      const ctx3 = document.getElementById('chartTrades').getContext('2d');
      if (chartTr) chartTr.destroy();
      chartTr = new Chart(ctx3, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Trades', data: trades }] },
        options: { responsive: true, plugins: { legend: { display: true } } }
      });
    }

    async function fetchSummary() {
      const from = document.getElementById('from_date').value;
      const to   = document.getElementById('to_date').value;
      const url  = `/pdca/summary/data?from_date=${encodeURIComponent(from)}&to_date=${encodeURIComponent(to)}`;
      const res  = await fetch(url);
      const json = await res.json();
      if (!json.ok) throw new Error(json.detail || "Fetch failed");
      return json;
    }

    async function refresh() {
      try {
        const data = await fetchSummary();
        updateKPIs(data.totals || {});
        renderCharts(data.by_day || []);
      } catch (e) {
        console.error(e);
        updateKPIs({});
        renderCharts([]);
        alert("サマリ取得に失敗しました。DB接続や期間指定を確認してください。");
      }
    }

    document.getElementById('applyBtn').addEventListener('click', refresh);
    window.addEventListener('load', refresh);
  </script>
{% endblock %}
