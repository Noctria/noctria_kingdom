{% extends "base_hud.html" %}

{% block title %}📊 PDCA サマリー - Noctria Kingdom{% endblock %}
{% block header_icon %}<i class="fas fa-sync-alt"></i>{% endblock %}
{% block header_title %}PDCA サマリー{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}DASHBOARD{% endblock %}

{% block content %}
<h1>📊 PDCA 再評価サマリー</h1>

<!-- ✅ フラッシュ表示（再評価結果） -->
{% if recheck_success is not none or recheck_fail is not none %}
  <div class="hud-panel" style="border: 1px solid #00cc66; background: #e6ffe6; color: #003300; margin-bottom: 1rem;">
    ✅ 一括再評価 実行結果：
    {% if recheck_success %} 🎯 成功 {{ recheck_success }}件 {% endif %}
    {% if recheck_fail %} ❌ 失敗 {{ recheck_fail }}件 {% endif %}
  </div>
{% endif %}

<!-- 📅 期間・モード・件数フォーム -->
<form method="get" action="/pdca/summary" class="hud-panel filter-form">
  <label>📅 開始日: <input type="date" name="from" value="{{ filter.from }}"></label>
  <label>📅 終了日: <input type="date" name="to" value="{{ filter.to }}"></label>
  <label>📊 表示モード:
    <select name="mode">
      <option value="strategy" {% if mode == "strategy" %}selected{% endif %}>🧠 戦略別</option>
      <option value="tag" {% if mode == "tag" %}selected{% endif %}>🔖 タグ別</option>
    </select>
  </label>
  <label>🔢 表示件数:
    <select name="limit">
      <option value="10" {% if limit == 10 %}selected{% endif %}>10件</option>
      <option value="20" {% if limit == 20 %}selected{% endif %}>20件</option>
      <option value="50" {% if limit == 50 %}selected{% endif %}>50件</option>
    </select>
  </label>
  <button type="submit" class="hud-btn">🔍 絞り込む</button>
</form>

<!-- ✅ サマリー統計 -->
<div class="hud-panel summary-card">
  <p>📈 勝率平均改善: <strong>{{ stats.avg_win_rate_diff }}%</strong></p>
  <p>📉 最大DD平均改善: <strong>{{ stats.avg_dd_diff }}</strong></p>
  <p>🎯 勝率改善戦略数: <strong>{{ stats.win_rate_improved }}</strong></p>
  <p>🛡 DD改善戦略数: <strong>{{ stats.dd_improved }}</strong></p>
  <p>🔰 採用戦略数: <strong>{{ stats.adopted }}</strong></p>
</div>

<!-- 📈 勝率改善グラフ -->
<h2>📈 勝率改善（{{ "戦略別" if mode == "strategy" else "タグ別" }})</h2>
<canvas id="winRateChart" width="600" height="300"></canvas>

<!-- 📉 最大DD改善グラフ -->
<h2>📉 最大DD改善（{{ "戦略別" if mode == "strategy" else "タグ別" }})</h2>
<canvas id="ddChart" width="600" height="300"></canvas>

<script>
  const winCtx = document.getElementById('winRateChart').getContext('2d');
  new Chart(winCtx, {
    type: 'bar',
    data: {
      labels: {{ chart.labels | safe }},
      datasets: [{
        label: '勝率改善率 (%)',
        backgroundColor: '#2ecc71',
        data: {{ chart.data | safe }}
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: '勝率改善（After - Before）'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: value => value + "%"
          }
        }
      }
    }
  });

  const ddCtx = document.getElementById('ddChart').getContext('2d');
  new Chart(ddCtx, {
    type: 'bar',
    data: {
      labels: {{ chart.labels | safe }},
      datasets: [{
        label: '最大DD改善 (Before - After)',
        backgroundColor: '#e74c3c',
        data: {{ chart.dd_data | safe }}
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: '最大DD改善（Before - After）'
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
</script>

<!-- 🧮 評価詳細テーブル -->
<h2>🧮 評価詳細（{{ "戦略別" if mode == "strategy" else "タグ別" }})</h2>
<button class="hud-btn download-btn" onclick="downloadCSV()">📥 CSVダウンロード</button>

<table id="summary-table" class="hud-table">
  <thead>
    <tr>
      <th>{{ "戦略名" if mode == "strategy" else "タグ" }}</th>
      <th>勝率 (Before)</th>
      <th>勝率 (After)</th>
      <th>差分 (%)</th>
      <th>最大DD (Before)</th>
      <th>最大DD (After)</th>
      <th>採用</th>
    </tr>
  </thead>
  <tbody>
    {% for row in stats.detail %}
    <tr>
      <td>{{ row.strategy }}</td>
      <td>{{ row.win_rate_before }}</td>
      <td>{{ row.win_rate_after }}</td>
      <td>{{ row.diff }}</td>
      <td>{{ row.max_dd_before }}</td>
      <td>{{ row.max_dd_after }}</td>
      <td>{{ row.status }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
  function downloadCSV() {
    let csv = "{{ '戦略名' if mode == 'strategy' else 'タグ' }},勝率(Before),勝率(After),差分(%),最大DD(Before),最大DD(After),採用\n";
    const rows = document.querySelectorAll("#summary-table tbody tr");
    rows.forEach(row => {
      const cols = row.querySelectorAll("td");
      const rowData = Array.from(cols).map(td => `"${td.innerText}"`).join(",");
      csv += rowData + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "pdca_summary.csv";
    link.click();
  }
</script>

{% endblock %}
