{% extends "base_hud.html" %}

{% block title %}ğŸ“Š PDCA ã‚µãƒãƒªãƒ¼ - Noctria Kingdom{% endblock %}
{% block header_icon %}<i class="fas fa-sync-alt"></i>{% endblock %}
{% block header_title %}PDCA ã‚µãƒãƒªãƒ¼{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}DASHBOARD{% endblock %}

{% block content %}
<h1>ğŸ“Š PDCA å†è©•ä¾¡ã‚µãƒãƒªãƒ¼</h1>

<!-- âœ… ãƒ•ãƒ©ãƒƒã‚·ãƒ¥è¡¨ç¤ºï¼ˆå†è©•ä¾¡çµæœï¼‰ -->
{% if recheck_success is not none or recheck_fail is not none %}
  <div class="hud-panel" style="border: 1px solid #00cc66; background: #e6ffe6; color: #003300; margin-bottom: 1rem;">
    âœ… ä¸€æ‹¬å†è©•ä¾¡ å®Ÿè¡Œçµæœï¼š
    {% if recheck_success %} ğŸ¯ æˆåŠŸ {{ recheck_success }}ä»¶ {% endif %}
    {% if recheck_fail %} âŒ å¤±æ•— {{ recheck_fail }}ä»¶ {% endif %}
  </div>
{% endif %}

<!-- ğŸ“… æœŸé–“ãƒ»ãƒ¢ãƒ¼ãƒ‰ãƒ»ä»¶æ•°ãƒ•ã‚©ãƒ¼ãƒ  -->
<form method="get" action="/pdca/summary" class="hud-panel filter-form">
  <label>ğŸ“… é–‹å§‹æ—¥: <input type="date" name="from" value="{{ filter.from }}"></label>
  <label>ğŸ“… çµ‚äº†æ—¥: <input type="date" name="to" value="{{ filter.to }}"></label>
  <label>ğŸ“Š è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰:
    <select name="mode">
      <option value="strategy" {% if mode == "strategy" %}selected{% endif %}>ğŸ§  æˆ¦ç•¥åˆ¥</option>
      <option value="tag" {% if mode == "tag" %}selected{% endif %}>ğŸ”– ã‚¿ã‚°åˆ¥</option>
    </select>
  </label>
  <label>ğŸ”¢ è¡¨ç¤ºä»¶æ•°:
    <select name="limit">
      <option value="10" {% if limit == 10 %}selected{% endif %}>10ä»¶</option>
      <option value="20" {% if limit == 20 %}selected{% endif %}>20ä»¶</option>
      <option value="50" {% if limit == 50 %}selected{% endif %}>50ä»¶</option>
    </select>
  </label>
  <button type="submit" class="hud-btn">ğŸ” çµã‚Šè¾¼ã‚€</button>
</form>

<!-- âœ… ã‚µãƒãƒªãƒ¼çµ±è¨ˆ -->
<div class="hud-panel summary-card">
  <p>ğŸ“ˆ å‹ç‡å¹³å‡æ”¹å–„: <strong>{{ stats.avg_win_rate_diff }}%</strong></p>
  <p>ğŸ“‰ æœ€å¤§DDå¹³å‡æ”¹å–„: <strong>{{ stats.avg_dd_diff }}</strong></p>
  <p>ğŸ¯ å‹ç‡æ”¹å–„æˆ¦ç•¥æ•°: <strong>{{ stats.win_rate_improved }}</strong></p>
  <p>ğŸ›¡ DDæ”¹å–„æˆ¦ç•¥æ•°: <strong>{{ stats.dd_improved }}</strong></p>
  <p>ğŸ”° æ¡ç”¨æˆ¦ç•¥æ•°: <strong>{{ stats.adopted }}</strong></p>
</div>

<!-- ğŸ“ˆ å‹ç‡æ”¹å–„ã‚°ãƒ©ãƒ• -->
<h2>ğŸ“ˆ å‹ç‡æ”¹å–„ï¼ˆ{{ "æˆ¦ç•¥åˆ¥" if mode == "strategy" else "ã‚¿ã‚°åˆ¥" }})</h2>
<canvas id="winRateChart" width="600" height="300"></canvas>

<!-- ğŸ“‰ æœ€å¤§DDæ”¹å–„ã‚°ãƒ©ãƒ• -->
<h2>ğŸ“‰ æœ€å¤§DDæ”¹å–„ï¼ˆ{{ "æˆ¦ç•¥åˆ¥" if mode == "strategy" else "ã‚¿ã‚°åˆ¥" }})</h2>
<canvas id="ddChart" width="600" height="300"></canvas>

<script>
  const winCtx = document.getElementById('winRateChart').getContext('2d');
  new Chart(winCtx, {
    type: 'bar',
    data: {
      labels: {{ chart.labels | safe }},
      datasets: [{
        label: 'å‹ç‡æ”¹å–„ç‡ (%)',
        backgroundColor: '#2ecc71',
        data: {{ chart.data | safe }}
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'å‹ç‡æ”¹å–„ï¼ˆAfter - Beforeï¼‰'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: value => value + "%"
          }
        }
      }
    }
  });

  const ddCtx = document.getElementById('ddChart').getContext('2d');
  new Chart(ddCtx, {
    type: 'bar',
    data: {
      labels: {{ chart.labels | safe }},
      datasets: [{
        label: 'æœ€å¤§DDæ”¹å–„ (Before - After)',
        backgroundColor: '#e74c3c',
        data: {{ chart.dd_data | safe }}
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'æœ€å¤§DDæ”¹å–„ï¼ˆBefore - Afterï¼‰'
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
</script>

<!-- ğŸ§® è©•ä¾¡è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
<h2>ğŸ§® è©•ä¾¡è©³ç´°ï¼ˆ{{ "æˆ¦ç•¥åˆ¥" if mode == "strategy" else "ã‚¿ã‚°åˆ¥" }})</h2>
<button class="hud-btn download-btn" onclick="downloadCSV()">ğŸ“¥ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>

<table id="summary-table" class="hud-table">
  <thead>
    <tr>
      <th>{{ "æˆ¦ç•¥å" if mode == "strategy" else "ã‚¿ã‚°" }}</th>
      <th>å‹ç‡ (Before)</th>
      <th>å‹ç‡ (After)</th>
      <th>å·®åˆ† (%)</th>
      <th>æœ€å¤§DD (Before)</th>
      <th>æœ€å¤§DD (After)</th>
      <th>æ¡ç”¨</th>
    </tr>
  </thead>
  <tbody>
    {% for row in stats.detail %}
    <tr>
      <td>{{ row.strategy }}</td>
      <td>{{ row.win_rate_before }}</td>
      <td>{{ row.win_rate_after }}</td>
      <td>{{ row.diff }}</td>
      <td>{{ row.max_dd_before }}</td>
      <td>{{ row.max_dd_after }}</td>
      <td>{{ row.status }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
  function downloadCSV() {
    let csv = "{{ 'æˆ¦ç•¥å' if mode == 'strategy' else 'ã‚¿ã‚°' }},å‹ç‡(Before),å‹ç‡(After),å·®åˆ†(%),æœ€å¤§DD(Before),æœ€å¤§DD(After),æ¡ç”¨\n";
    const rows = document.querySelectorAll("#summary-table tbody tr");
    rows.forEach(row => {
      const cols = row.querySelectorAll("td");
      const rowData = Array.from(cols).map(td => `"${td.innerText}"`).join(",");
      csv += rowData + "\n";
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "pdca_summary.csv";
    link.click();
  }
</script>

{% endblock %}
