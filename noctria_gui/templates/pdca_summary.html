<!-- noctria_gui/templates/pdca_summary.html -->
{% extends "base_hud.html" %}

{% block title %}{{ page_title or "ğŸ“Š PDCA ã‚µãƒãƒªãƒ¼" }} - Noctria Kingdom{% endblock %}
{% block header_icon %}<i class="fas fa-sync-alt" aria-hidden="true"></i>{% endblock %}
{% block header_title %}PDCA SUMMARY{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}DASHBOARD{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  .filter-form { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:.75rem; align-items:end; }
  .hud-input, .hud-select {
    background: rgba(0,0,0,0.3); border:1px solid var(--panel-border);
    color: var(--text-color-base); font-family: var(--font-family); font-size:1rem;
    border-radius:4px; padding:.5rem .75rem; transition: box-shadow .25s ease;
  }
  .hud-input:focus, .hud-select:focus { outline:none; box-shadow:0 0 8px var(--glow-primary); border-color: var(--glow-primary); }
  .metrics { display:flex; gap:1rem; flex-wrap:wrap; }
  .metric-item { background: var(--bg-color); border-radius:8px; padding:1rem 1.25rem; box-shadow:0 0 10px var(--glow-primary); flex:1 1 180px; }
  .metric-item h3 { margin:.1rem 0 .25rem; font-size:.9rem; color:var(--text-color-light); }
  .metric-value { font-size:1.6rem; font-weight:700; margin:0; }
  .grid-charts { display:grid; grid-template-columns:repeat(auto-fit,minmax(340px,1fr)); gap:1.2rem; }
  .empty-note { color:#9fbad6; text-align:center; padding:.75rem 0; }
  .btn-row { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
  .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
  .widget-frame { width:100%; border:none; min-height:480px; overflow:hidden; border-radius:8px; }
  .grid-quicklinks { display:grid; gap:1rem; grid-template-columns:repeat(3,minmax(0,1fr)); margin-top:1rem; }
  .link-card { text-decoration:none; color:inherit; }
</style>

<!-- ã¾ãšã¯ãƒ­ãƒ¼ã‚«ãƒ«é…ä¿¡ã€‚ç„¡ã‘ã‚Œã°å¾Œæ®µã§CDNãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ -->
<script src="/static/vendor/chart.umd.js"></script>
<script src="/static/vendor/flatpickr.min.js"></script>
{% endblock %}

{% block content %}
<section class="hud-panel filter-panel" aria-labelledby="filter-title">
  <h2 id="filter-title" class="panel-title"><i class="fas fa-filter" aria-hidden="true"></i> FILTER & SEARCH</h2>
  <form class="filter-form" onsubmit="return false;" aria-describedby="filter-help">
    <p id="filter-help" class="sr-only">é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã§ç¯„å›²ã‚’æŒ‡å®šã—ã€é©ç”¨ãƒœã‚¿ãƒ³ã§æ›´æ–°ã—ã¾ã™ã€‚</p>
    <div>
      <label for="from-date"><i class="fas fa-calendar-alt" aria-hidden="true"></i> é–‹å§‹æ—¥</label>
      <input id="from-date" type="text" class="hud-input" inputmode="numeric" autocomplete="off" placeholder="YYYY-MM-DD" aria-describedby="from-date-help">
      <span id="from-date-help" class="sr-only">é–‹å§‹æ—¥ã‚’YYYY-MM-DDã§å…¥åŠ›</span>
    </div>
    <div>
      <label for="to-date"><i class="fas fa-calendar-alt" aria-hidden="true"></i> çµ‚äº†æ—¥</label>
      <input id="to-date" type="text" class="hud-input" inputmode="numeric" autocomplete="off" placeholder="YYYY-MM-DD" aria-describedby="to-date-help">
      <span id="to-date-help" class="sr-only">çµ‚äº†æ—¥ã‚’YYYY-MM-DDã§å…¥åŠ›</span>
    </div>
    <div>
      <label for="limit-select"><i class="fas fa-list-ol" aria-hidden="true"></i> è¡¨ç¤ºä»¶æ•°ï¼ˆè¡¨ç”¨ï¼‰</label>
      <select id="limit-select" class="hud-select" aria-label="è¡¨ç¤ºä»¶æ•°">
        <option value="20" selected>20ä»¶</option>
        <option value="50">50ä»¶</option>
        <option value="100">100ä»¶</option>
      </select>
    </div>
    <div class="btn-row">
      <button id="applyBtn" class="hud-link" type="button" aria-label="ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨">ğŸ” é©ç”¨</button>
      <a id="csvBtn" class="hud-link" href="#" download aria-label="CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">â¬‡ï¸ CSV</a>
      <button id="recheckAllBtn" class="hud-link" type="button" aria-label="ä¸€æ‹¬å†è©•ä¾¡ã‚’å®Ÿè¡Œ">ğŸ” ä¸€æ‹¬å†è©•ä¾¡</button>
    </div>
  </form>
</section>

<!-- ç›´è¿‘æ¡ç”¨ã‚¿ã‚°ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆï¼ˆ/pdca/widgets/recent-adoptionsï¼‰ -->
{% set w = recent_adoptions_params or {'pattern':'veritas-','limit':9,'cols':3,'title':'ğŸ§© ç›´è¿‘æ¡ç”¨ã‚¿ã‚°'} %}
<section class="hud-panel" aria-labelledby="adopt-widget-title">
  <h2 id="adopt-widget-title" class="panel-title"><i class="fas fa-tags" aria-hidden="true"></i> ç›´è¿‘ã®æ¡ç”¨ã‚¿ã‚°</h2>
  <iframe
    class="widget-frame"
    src="/pdca/widgets/recent-adoptions?pattern={{ w.pattern | urlencode }}&limit={{ w.limit }}&cols={{ w.cols }}&title={{ w.title | urlencode }}"
    loading="lazy"
  ></iframe>
</section>

<section class="hud-panel" aria-labelledby="kpi-title">
  <h2 id="kpi-title" class="panel-title"><i class="fas fa-calculator" aria-hidden="true"></i> OVERALL KPIï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å¾Œï¼‰</h2>
  <div class="metrics" role="list">
    <div class="metric-item" role="listitem">
      <h3><i class="fas fa-hashtag" aria-hidden="true"></i> å¯¾è±¡ä»¶æ•°</h3>
      <p id="kpi-count" class="metric-value" aria-live="polite">-</p>
    </div>
    <div class="metric-item" role="listitem">
      <h3><i class="fas fa-arrow-up" aria-hidden="true"></i> å‹ç‡ æ”¹å–„ä»¶æ•°</h3>
      <p id="kpi-impr-win" class="metric-value" aria-live="polite">-</p>
    </div>
    <div class="metric-item" role="listitem">
      <h3><i class="fas fa-arrow-down" aria-hidden="true"></i> æœ€å¤§DD æ”¹å–„ä»¶æ•°</h3>
      <p id="kpi-impr-dd" class="metric-value" aria-live="polite">-</p>
    </div>
    <div class="metric-item" role="listitem">
      <h3><i class="fas fa-percentage" aria-hidden="true"></i> å‹ç‡ å·®åˆ†å¹³å‡</h3>
      <p id="kpi-avg-win-diff" class="metric-value" aria-live="polite">-</p>
    </div>
    <div class="metric-item" role="listitem">
      <h3><i class="fas fa-chart-area" aria-hidden="true"></i> DD å·®åˆ†å¹³å‡</h3>
      <p id="kpi-avg-dd-diff" class="metric-value" aria-live="polite">-</p>
    </div>
  </div>
</section>

<div class="grid-charts">
  <section class="hud-panel" aria-labelledby="chart-counts-title">
    <h2 id="chart-counts-title" class="panel-title"><i class="fas fa-chart-bar" aria-hidden="true"></i> æ—¥æ¬¡ ä»¶æ•°ï¼ˆç·æ•° / å‹ç‡æ”¹å–„ï¼‰</h2>
    <div style="height:300px"><canvas id="chartCounts" role="img" aria-label="æ—¥æ¬¡ã®ç·ä»¶æ•°ã¨å‹ç‡æ”¹å–„ä»¶æ•°ã®ã‚°ãƒ©ãƒ•"></canvas></div>
    <div id="noteCounts" class="empty-note" style="display:none">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
  </section>
  <section class="hud-panel" aria-labelledby="chart-windiff-title">
    <h2 id="chart-windiff-title" class="panel-title"><i class="fas fa-chart-line" aria-hidden="true"></i> æ—¥æ¬¡ å‹ç‡å·®åˆ† å¹³å‡(%)</h2>
    <div style="height:300px"><canvas id="chartWinDiff" role="img" aria-label="æ—¥æ¬¡ã®å‹ç‡å·®åˆ†å¹³å‡ã®æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•"></canvas></div>
    <div id="noteWinDiff" class="empty-note" style="display:none">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
  </section>
</div>

<!-- ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ³ã‚¯ -->
<div class="grid-quicklinks">
  <a class="card link-card" href="/adoptions">
    <div class="card-header">ğŸ—‚ æ¡ç”¨ã‚¿ã‚° Ã— Decision ä¸€è¦§</div>
    <div class="card-body muted">Gitã‚¿ã‚°ã¨Decisionå°å¸³ã‚’çªãåˆã‚ã›ãŸç·è¦§ã€‚CSV/JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾å¿œã€‚</div>
  </a>
  <a class="card link-card" href="/decisions">
    <div class="card-header">ğŸ—„ Decision Registry</div>
    <div class="card-body muted">æ±ºè£ã‚¤ãƒ™ãƒ³ãƒˆã®å°å¸³ã€‚Airflow Run ã¸ã®ç›¸äº’ãƒªãƒ³ã‚¯ã‚ã‚Šã€‚</div>
  </a>
  <a class="card link-card" href="/airflow/runs">
    <div class="card-header">ğŸŒ€ Airflow Runs</div>
    <div class="card-body muted">æ¡ç”¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®Ÿè¡Œå±¥æ­´ã€‚conf/ã‚¿ã‚¹ã‚¯ä¸€è¦§/é–¢é€£Decisionã‚’ç¢ºèªã€‚</div>
  </a>
</div>
{% endblock %}

{% block scripts %}
<script>
/* ---------- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èª­è¾¼ ---------- */
(function ensureLibs() {
  function addScript(src, onload){ var s=document.createElement('script'); s.src=src; s.defer=true; s.onload=onload||function(){}; document.head.appendChild(s); }
  function need(name){ return (typeof window[name] === 'undefined'); }
  const p = [];
  if (need('Chart'))     p.push(new Promise(res => addScript('https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js', res)));
  if (need('flatpickr')) p.push(new Promise(res => addScript('https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js', res)));
  Promise.all(p).then(function(){
    // ãã‚Œã§ã‚‚ç„¡ã‘ã‚Œã°æœ€å¾Œã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚’ã‚‚ã†ä¸€åº¦
    setTimeout(function(){
      if (need('Chart'))     addScript('/static/vendor/chart.umd.js');
      if (need('flatpickr')) addScript('/static/vendor/flatpickr.min.js');
    }, 400);
  });
})();
</script>

<script>
/* =========================
   ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
   - /pdca/api/summary            -> KPI
   - /pdca/api/summary_timeseries -> ã‚°ãƒ©ãƒ•ï¼ˆäº’æ›ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§ /pdca/summary/data ã«å¸åï¼‰
   - /pdca/summary.csv            -> CSVï¼ˆæ–°APIãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã«æ³¨æ„ï¼‰
   ========================= */
window.NoctriaPDCA = { charts: { counts:null, winDiff:null } };
window.GLOBAL_DEFAULT_FROM = null;
window.GLOBAL_DEFAULT_TO   = null;

function setText(id, t){ const el=document.getElementById(id); if(el) el.textContent = t; }
function show(el, b){ if(el) el.style.display = b ? '' : 'none'; }
function percentFmt(v){ return (v == null || isNaN(v)) ? 'â€”' : `${(+v).toFixed(2)}%`; }

function isoDateDaysAgo(days){
  const now = new Date();
  const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() - days);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

function buildQueryLegacy() {
  // æ—§APIäº’æ›ç”¨ï¼ˆdate_from/date_toï¼‰
  const from = document.getElementById('from-date')?.value || window.GLOBAL_DEFAULT_FROM || isoDateDaysAgo(14);
  const to   = document.getElementById('to-date')?.value   || window.GLOBAL_DEFAULT_TO   || isoDateDaysAgo(0);
  const sp = new URLSearchParams();
  sp.set('date_from', from);
  sp.set('date_to', to);
  return sp.toString();
}

function buildQueryNew() {
  // æ–°APIç”¨ï¼ˆfrom_date/to_dateï¼‰â€” CSV ã¯ã“ã¡ã‚‰ã‚’ä½¿ç”¨
  const from = document.getElementById('from-date')?.value || window.GLOBAL_DEFAULT_FROM || isoDateDaysAgo(14);
  const to   = document.getElementById('to-date')?.value   || window.GLOBAL_DEFAULT_TO   || isoDateDaysAgo(0);
  const sp = new URLSearchParams();
  sp.set('from_date', from);
  sp.set('to_date', to);
  return sp.toString();
}

function wireCsvButton(){
  const a = document.getElementById('csvBtn');
  if (!a) return;
  const qs = buildQueryNew(); // â† CSV ã¯æ–°APIå
  a.href = '/pdca/summary.csv' + (qs ? `?${qs}` : '');
}

/* Chart helpers */
function createLine(ctx, labels, label, data, ySuffix){
  const gridC='rgba(0, 229, 255, 0.15)', axisC='#a8b2d1';
  return new Chart(ctx, {
    type: 'line',
    data: { labels, datasets:[{ label, data, tension:0.25 }] },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ display:true } },
      scales:{
        y:{ beginAtZero:true, grid:{ color:gridC }, ticks:{ color:axisC, callback:v => ySuffix ? `${v}${ySuffix}` : v } },
        x:{ grid:{ color:gridC }, ticks:{ color:axisC, maxRotation:0 } }
      }
    }
  });
}

function createBar2Axis(ctx, labels, ds1, ds2){
  const gridC='rgba(0, 229, 255, 0.15)', axisC='#a8b2d1';
  return new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [
      { label: ds1.label, data: ds1.data, yAxisID:'y1' },
      { label: ds2.label, data: ds2.data, yAxisID:'y1' },
    ]},
    options: {
      responsive:true, maintainAspectRatio:false, interaction:{ mode:'index', intersect:false },
      scales:{
        y1:{ type:'linear', position:'left', beginAtZero:true, grid:{ color:gridC }, ticks:{ color:axisC } },
        x :{ grid:{ color:gridC }, ticks:{ color:axisC, maxRotation:0 } }
      },
      plugins:{ legend:{ display:true } }
    }
  });
}

/* ======== ä¸€æ‹¬å†è©•ä¾¡ãƒˆãƒªã‚¬ ======== */
async function triggerRecheckAll(){
  const reason = prompt("ä¸€æ‹¬å†è©•ä¾¡ã®ç†ç”±ï¼ˆä»»æ„ï¼‰", "") || "";
  const qsLegacy = buildQueryLegacy();
  const url = new URL('/pdca/recheck_all', window.location.origin);
  const uspL = new URLSearchParams(qsLegacy);
  url.searchParams.set('reason', reason);
  url.searchParams.set('filter_date_from', uspL.get('date_from'));
  url.searchParams.set('filter_date_to', uspL.get('date_to'));
  try{
    const res = await fetch(url.toString(), { method:'POST' });
    const js = await res.json().catch(()=>({message:'æœªçŸ¥ã®å¿œç­”'}));
    alert(js.message || JSON.stringify(js));
  }catch(e){
    alert('å†è©•ä¾¡ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (e?.message || e));
  }
}

/* ======== ãƒ¡ã‚¤ãƒ³æ›´æ–°å‡¦ç†ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹ï¼‰ ======== */
window.pdcaRefresh = async function pdcaRefresh(){
  const qsLegacy = buildQueryLegacy();

  // 1) KPIï¼ˆæ—§APIã‚’å©ã â†’ ã‚µãƒ¼ãƒå´ã§307ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†ï¼‰
  try{
    const res = await fetch('/pdca/api/summary?' + qsLegacy, { cache:'no-store' });
    if(!res.ok) throw new Error('summary HTTP ' + res.status);
    const s = await res.json();
    setText('kpi-count',     (s.count ?? 0).toString());
    setText('kpi-impr-win',  (s.improved_winrate ?? 0).toString());
    setText('kpi-impr-dd',   (s.improved_maxdd ?? 0).toString());
    setText('kpi-avg-win-diff', percentFmt(s.avg_winrate_diff));  // % ã‚’æƒ³å®š
    setText('kpi-avg-dd-diff',  percentFmt(s.avg_maxdd_diff));    // % ã‚’æƒ³å®š
  }catch(e){
    console.error('[KPI] fetch error:', e);
  }

  // 2) æ™‚ç³»åˆ—
  try{
    const res = await fetch('/pdca/api/summary_timeseries?' + qsLegacy, { cache:'no-store' });
    if(!res.ok) throw new Error('timeseries HTTP ' + res.status);
    const ts = await res.json();

    const labels = Array.isArray(ts.labels) ? ts.labels : [];
    const total  = Array.isArray(ts.total_count) ? ts.total_count : [];
    const impr   = Array.isArray(ts.improved_winrate_count) ? ts.improved_winrate_count : [];
    const avgWr  = (Array.isArray(ts.avg_winrate_diff) ? ts.avg_winrate_diff : []).map(v => (v==null? null : +(+v).toFixed(2)));

    // ç©ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    show(document.getElementById('noteCounts'),  labels.length === 0);
    show(document.getElementById('noteWinDiff'), labels.length === 0);

    // æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆç ´æ£„
    if (window.NoctriaPDCA.charts.counts)  { window.NoctriaPDCA.charts.counts.destroy();  window.NoctriaPDCA.charts.counts = null; }
    if (window.NoctriaPDCA.charts.winDiff) { window.NoctriaPDCA.charts.winDiff.destroy(); window.NoctriaPDCA.charts.winDiff = null; }

    // å†æç”»ï¼ˆè¦ç´ å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼‰
    const ctxCounts  = document.getElementById('chartCounts');
    const ctxWinDiff = document.getElementById('chartWinDiff');
    if (ctxCounts && ctxCounts.getContext) {
      window.NoctriaPDCA.charts.counts  = createBar2Axis(
        ctxCounts.getContext('2d'),
        labels,
        { label:'ç·ä»¶æ•°', data: total },
        { label:'å‹ç‡æ”¹å–„ä»¶æ•°', data: impr }
      );
    }
    if (ctxWinDiff && ctxWinDiff.getContext) {
      window.NoctriaPDCA.charts.winDiff = createLine(
        ctxWinDiff.getContext('2d'),
        labels,
        'å‹ç‡å·®åˆ† å¹³å‡(%)',
        avgWr,
        '%'
      );
    }
  }catch(e){
    console.error('[Timeseries] fetch error:', e);
  }

  // 3) CSV ãƒœã‚¿ãƒ³ã®ãƒªãƒ³ã‚¯æ›´æ–°ï¼ˆæ–°APIåã‚’æ¡ç”¨ï¼‰
  wireCsvButton();
};

/* ========= DOM æº–å‚™ ========= */
document.addEventListener('DOMContentLoaded', function(){
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ åŸºæº–ã§å‰å¾Œãšã‚Œã‚’é¿ã‘ã‚‹ï¼‰
  window.GLOBAL_DEFAULT_FROM = "{{ default_from or '' }}".trim() || isoDateDaysAgo(14);
  window.GLOBAL_DEFAULT_TO   = "{{ default_to or '' }}".trim()   || isoDateDaysAgo(0);
  const fromI = document.getElementById('from-date');
  const toI   = document.getElementById('to-date');
  if (fromI && !fromI.value) fromI.value = window.GLOBAL_DEFAULT_FROM;
  if (toI   && !toI.value)   toI.value   = window.GLOBAL_DEFAULT_TO;

  // Flatpickr ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰åˆæœŸåŒ–ï¼ˆç„¡ãã¦ã‚‚OKï¼‰
  (function initPickers(){
    if (typeof flatpickr === 'undefined') return void setTimeout(initPickers, 120);
    flatpickr('#from-date', { dateFormat:'Y-m-d', allowInput:true, defaultDate: window.GLOBAL_DEFAULT_FROM });
    flatpickr('#to-date',   { dateFormat:'Y-m-d', allowInput:true, defaultDate: window.GLOBAL_DEFAULT_TO   });
  })();

  // ãƒœã‚¿ãƒ³
  const btn  = document.getElementById('applyBtn');
  const rbtn = document.getElementById('recheckAllBtn');
  if (btn)  btn.addEventListener('click', window.pdcaRefresh);
  if (rbtn) rbtn.addEventListener('click', triggerRecheckAll);

  // åˆå›æç”»ï¼ˆChart.js ã‚’å¾…ã£ã¦ã‹ã‚‰ï¼‰
  (function waitChart(){
    if (typeof Chart === 'undefined') return void setTimeout(waitChart, 120);
    window.pdcaRefresh();
  })();
});
</script>
{% endblock %}
