<!-- noctria_gui/templates/pdca_summary.html -->
{% extends "base_hud.html" %}

{% block title %}{{ page_title or "📊 PDCA サマリー" }} - Noctria Kingdom{% endblock %}
{% block header_icon %}<i class="fas fa-sync-alt" aria-hidden="true"></i>{% endblock %}
{% block header_title %}PDCA SUMMARY{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}DASHBOARD{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  /* ====== Layout ====== */
  .filter-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: .75rem;
    align-items: end;
  }
  .hud-field { display:flex; flex-direction:column; gap:.35rem; }
  .hud-field label { font-size:.85rem; opacity:.9; }
  .hud-field input, .hud-field select {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.12);
    padding:.55rem .7rem; border-radius:.6rem; color:inherit; width:100%;
  }
  .hud-btn {
    display:inline-flex; align-items:center; justify-content:center;
    gap:.5rem; padding:.6rem .9rem; border-radius:.7rem;
    border:1px solid var(--glow-primary, #7dd3fc);
    background: linear-gradient(180deg, rgba(125,211,252,.10), rgba(125,211,252,.02));
    cursor:pointer; text-decoration:none;
  }
  .hud-btn i { font-size:.95rem; }
  .hud-cards {
    display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: .9rem; margin-top:1rem;
  }
  .hud-card {
    padding:1rem; border-radius:1rem;
    background: rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.10);
    box-shadow: 0 0 0 1px rgba(125,211,252,.08), 0 8px 18px rgba(0,0,0,.25) inset;
  }
  .hud-card h4 { margin:0 0 .35rem; font-size:.95rem; opacity:.9; }
  .hud-card .value { font-size:1.4rem; font-weight:700; letter-spacing:.3px; }
  .hud-section { margin-top:1.25rem; }
  .hud-section h3 { font-size:1rem; margin:0 0 .6rem; opacity:.95; }

  /* ====== Table ====== */
  .hud-table {
    width:100%; border-collapse: collapse; font-size:.95rem; overflow:auto;
    border:1px solid rgba(255,255,255,0.08); border-radius:.6rem;
  }
  .hud-table th, .hud-table td { padding:.6rem .65rem; text-align:left; }
  .hud-table thead th {
    position:sticky; top:0; background:rgba(255,255,255,0.06);
    border-bottom:1px solid rgba(255,255,255,0.12);
  }
  .hud-table tbody tr:nth-child(even){ background: rgba(255,255,255,0.03); }
  .kpi-good { color:#86efac; }
  .kpi-warn { color:#fde68a; }
  .kpi-bad  { color:#fca5a5; }

  /* ====== Helpers ====== */
  .muted { opacity:.8; font-size:.9rem; }
  .nowrap { white-space:nowrap; }
  .right { text-align:right; }
  .fade { opacity:.85; }
  .scroll-x { overflow-x:auto; }

  .chart-wrap { width:100%; max-width:100%; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.10); border-radius:1rem; padding:.75rem; }
  .chart-wrap canvas { width:100% !important; height:320px !important; }
  @media (max-width: 480px){ .chart-wrap canvas { height:260px !important; } }
</style>
{% endblock %}

{% block content %}
<section aria-label="filters">
  <form class="filter-form" method="get" action="/pdca/summary">
    <div class="hud-field">
      <label for="from">From</label>
      <input id="from" name="from" type="text" placeholder="YYYY-MM-DD"
             value="{{ request.query_params.get('from', from_date|default('', true)) }}">
    </div>
    <div class="hud-field">
      <label for="to">To</label>
      <input id="to" name="to" type="text" placeholder="YYYY-MM-DD"
             value="{{ request.query_params.get('to', to_date|default('', true)) }}">
    </div>
    <div class="hud-field">
      <label for="tag">Tag / Strategy</label>
      <input id="tag" name="tag" type="text" placeholder="e.g. veritas / levia"
             value="{{ request.query_params.get('tag', selected_tag|default('', true)) }}">
    </div>
    <div class="hud-field">
      <label for="win_diff">勝率差分しきい値（%以上）</label>
      <input id="win_diff" name="win_diff" type="number" step="0.1" inputmode="decimal" placeholder="例: 3"
             value="{{ request.query_params.get('win_diff', win_diff|default('', true)) }}">
    </div>
    <div class="hud-field">
      <label for="dd_diff">最大DD差分しきい値（%以上）</label>
      <input id="dd_diff" name="dd_diff" type="number" step="0.1" inputmode="decimal" placeholder="例: -2"
             value="{{ request.query_params.get('dd_diff', dd_diff|default('', true)) }}">
    </div>
    <div class="hud-field">
      <label for="min_trades">最小取引数</label>
      <input id="min_trades" name="min_trades" type="number" step="1" min="0" placeholder="例: 30"
             value="{{ request.query_params.get('min_trades', min_trades|default('', true)) }}">
    </div>
    <div class="hud-field">
      <button class="hud-btn" type="submit" aria-label="apply filters">
        <i class="fas fa-filter"></i> 適用
      </button>
    </div>
    <div class="hud-field">
      <a class="hud-btn" href="/pdca/summary" aria-label="reset filters">
        <i class="fas fa-rotate-left"></i> リセット
      </a>
    </div>
  </form>
  <p class="muted" style="margin-top:.35rem;">
    期間・タグ・差分しきい値で PDCA 再評価結果を絞り込みます。空欄は無視されます。
  </p>
</section>

<section class="hud-section" aria-label="summary-kpis">
  <h3>サマリー</h3>
  <div class="hud-cards">
    {% set S = summary or {} %}
    <div class="hud-card" role="status">
      <h4>対象期間の試行数</h4>
      <div class="value">{{ S.total_runs|default(0) }}</div>
      <div class="muted">runs</div>
    </div>
    <div class="hud-card">
      <h4>採用数 / 採用率</h4>
      <div class="value">
        {{ S.total_adopted|default(0) }} /
        {% if S.adoption_rate is defined %}
          {{ (S.adoption_rate*100)|round(1) }}%
        {% else %}—{% endif %}
      </div>
    </div>
    <div class="hud-card">
      <h4>平均 勝率差分</h4>
      {% set wd = S.avg_winrate_diff if S.avg_winrate_diff is defined else None %}
      <div class="value {% if wd is not none %}{% if wd>=0 %}kpi-good{% else %}kpi-bad{% endif %}{% endif %}">
        {% if wd is not none %}{{ (wd)|round(2) }}%{% else %}—{% endif %}
      </div>
    </div>
    <div class="hud-card">
      <h4>平均 最大DD差分</h4>
      {% set dd = S.avg_maxdd_diff if S.avg_maxdd_diff is defined else None %}
      <div class="value {% if dd is not none %}{% if dd<=0 %}kpi-good{% else %}kpi-bad{% endif %}{% endif %}">
        {% if dd is not none %}{{ (dd)|round(2) }}%{% else %}—{% endif %}
      </div>
    </div>
    <div class="hud-card">
      <h4>対象戦略/タグ</h4>
      <div class="value fade">{{ selected_tag|default("all") }}</div>
      <div class="muted">tag</div>
    </div>
  </div>
</section>

<section class="hud-section" aria-label="charts">
  <h3>トレンド</h3>
  <div class="chart-wrap" aria-live="polite">
    <canvas id="chartCounts" aria-label="日次件数トレンド"></canvas>
  </div>
  <div class="chart-wrap" style="margin-top:.9rem">
    <canvas id="chartDiffs" aria-label="差分分布"></canvas>
  </div>
</section>

<section class="hud-section" aria-label="details">
  <h3>詳細（最新50件）</h3>
  <div class="scroll-x">
    <table class="hud-table">
      <thead>
        <tr>
          <th class="nowrap">日時</th>
          <th>戦略</th>
          <th class="right">勝率差分</th>
          <th class="right">最大DD差分</th>
          <th class="right">取引数</th>
          <th class="nowrap">採用</th>
          <th>メモ</th>
          <th class="nowrap">リンク</th>
        </tr>
      </thead>
      <tbody>
      {% set rows = details or [] %}
      {% if rows and rows|length>0 %}
        {% for r in rows[:50] %}
          <tr>
            <td class="nowrap">{{ r.timestamp|default(r.date)|default("—") }}</td>
            <td>{{ r.strategy|default(r.tag)|default("—") }}</td>
            <td class="right {% if r.winrate_diff is defined %}{% if r.winrate_diff>=0 %}kpi-good{% else %}kpi-bad{% endif %}{% endif %}">
              {% if r.winrate_diff is defined %}{{ (r.winrate_diff)|round(2) }}%{% else %}—{% endif %}
            </td>
            <td class="right {% if r.maxdd_diff is defined %}{% if r.maxdd_diff<=0 %}kpi-good{% else %}kpi-bad{% endif %}{% endif %}">
              {% if r.maxdd_diff is defined %}{{ (r.maxdd_diff)|round(2) }}%{% else %}—{% endif %}
            </td>
            <td class="right">{{ r.trades|default("—") }}</td>
            <td class="nowrap">
              {% if r.adopted in [True, "true", 1, "1", "yes"] %}
                <span class="kpi-good"><i class="fas fa-check"></i></span>
              {% elif r.adopted in [False, "false", 0, "0", "no"] %}
                <span class="kpi-bad"><i class="fas fa-times"></i></span>
              {% else %}—{% endif %}
            </td>
            <td class="fade">{{ r.note|default("") }}</td>
            <td class="nowrap">
              {% if r.link %}
                <a class="hud-btn" href="{{ r.link }}" target="_blank" rel="noopener">
                  <i class="fas fa-up-right-from-square"></i> 詳細
                </a>
              {% else %}—{% endif %}
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="8" class="fade">データがありません。</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</section>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ====== Flatpickr init ======
  const fromEl = document.getElementById('from');
  const toEl = document.getElementById('to');
  if (fromEl) flatpickr(fromEl, { dateFormat: "Y-m-d", allowInput: true });
  if (toEl) flatpickr(toEl, { dateFormat: "Y-m-d", allowInput: true });

  // ====== Chart helpers ======
  function safe(val, fallback){ return (val===null||val===undefined) ? fallback : val; }

  // サーバ側が charts オブジェクトを用意できない場合でも安全に動作
  const charts = safe({{ charts|default({})|tojson }}, {});
  const counts = safe(charts.counts, {});
  const diffs  = safe(charts.diffs, {});

  // --- Chart 1: 日次件数（total vs adopted）
  (function(){
    const ctx = document.getElementById('chartCounts');
    if(!ctx) return;

    const labels = safe(counts.labels, []);
    const total  = safe(counts.total, []);
    const adopted= safe(counts.adopted, []);

    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: '総件数', data: total, tension:.25, borderWidth:2, fill:false },
          { label: '採用件数', data: adopted, tension:.25, borderWidth:2, fill:false }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ mode:'index', intersect:false },
        plugins:{ legend:{ display:true } },
        scales:{
          x:{ ticks:{ maxTicksLimit:10 }},
          y:{ beginAtZero:true, suggestedMax: Math.max(5, Math.max(...total,0)+2) }
        }
      }
    });
  })();

  // --- Chart 2: 差分分布（勝率差分 / 最大DD差分）
  (function(){
    const ctx = document.getElementById('chartDiffs');
    if(!ctx) return;

    const labels = safe(diffs.labels, ['勝率 +','勝率 -','DD +','DD -']);
    const winPos = safe(diffs.win_pos, 0);
    const winNeg = safe(diffs.win_neg, 0);
    const ddPos  = safe(diffs.dd_pos, 0);
    const ddNeg  = safe(diffs.dd_neg, 0);

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: '件数', data: [winPos, winNeg, ddPos, ddNeg], borderWidth:1 }
        ]
      },
      options: {
        responsive:true,
        maintainAspectRatio:false,
        plugins:{ legend:{ display:false } },
        scales:{ y:{ beginAtZero:true } }
      }
    });
  })();
</script>
{% endblock %}
