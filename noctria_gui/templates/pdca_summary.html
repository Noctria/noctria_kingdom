{% extends "base_hud.html" %}

{% block title %}ğŸ“Š PDCA ã‚µãƒãƒªãƒ¼ - Noctria Kingdom{% endblock %}
{% block header_icon %}<i class="fas fa-sync-alt"></i>{% endblock %}
{% block header_title %}PDCA SUMMARY{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}DASHBOARD{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
<style>
.flatpickr-calendar {
  background: var(--bg-color);
  border: 1px solid var(--glow-primary);
  box-shadow: 0 0 10px var(--glow-primary);
  color: var(--text-color);
  font-family: monospace;
}
.flatpickr-day.selected,
.flatpickr-day:hover {
  background: var(--glow-primary);
  color: var(--bg-color);
  border-radius: 4px;
}
</style>
{% endblock %}

{% block content %}
<!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥è¡¨ç¤ºï¼ˆå†è©•ä¾¡çµæœï¼‰ -->
{% if recheck_success is not none or recheck_fail is not none %}
  <div class="hud-panel" style="border: 1px solid #00cc66; background: rgba(0, 204, 102, 0.1); color: #e6f1ff; margin-bottom: 1rem; text-align: center;">
    <i class="fas fa-check-circle"></i> ä¸€æ‹¬å†è©•ä¾¡ å®Ÿè¡Œçµæœï¼š
    {% if recheck_success %} <strong><span class="text-green">æˆåŠŸ {{ recheck_success }}ä»¶</span></strong> {% endif %}
    {% if recheck_fail %} <strong><span class="text-magenta">å¤±æ•— {{ recheck_fail }}ä»¶</span></strong> {% endif %}
  </div>
{% endif %}

<!-- æœŸé–“ãƒ»ãƒ¢ãƒ¼ãƒ‰ãƒ»ä»¶æ•°ãƒ•ã‚©ãƒ¼ãƒ  -->
<section class="hud-panel filter-panel">
    <h2 class="panel-title"><i class="fas fa-filter"></i> FILTER & SEARCH</h2>
    <form method="get" action="/pdca/summary" class="filter-form">
        <label for="from-date"><i class="fas fa-calendar-alt"></i> é–‹å§‹æ—¥</label>
        <input id="from-date" type="text" name="from" value="{{ filter.from | default('') }}" autocomplete="off">
        
        <label for="to-date"><i class="fas fa-calendar-alt"></i> çµ‚äº†æ—¥</label>
        <input id="to-date" type="text" name="to" value="{{ filter.to | default('') }}" autocomplete="off">
        
        <label for="mode-select"><i class="fas fa-eye"></i> è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</label>
        <select id="mode-select" name="mode">
            <option value="strategy" {% if mode == "strategy" %}selected{% endif %}>ğŸ§  æˆ¦ç•¥åˆ¥</option>
            <option value="tag" {% if mode == "tag" %}selected{% endif %}>ğŸ”– ã‚¿ã‚°åˆ¥</option>
        </select>
        
        <label for="limit-select"><i class="fas fa-list-ol"></i> è¡¨ç¤ºä»¶æ•°</label>
        <select id="limit-select" name="limit">
            <option value="10" {% if limit == 10 %}selected{% endif %}>10ä»¶</option>
            <option value="20" {% if limit == 20 %}selected{% endif %}>20ä»¶</option>
            <option value="50" {% if limit == 50 %}selected{% endif %}>50ä»¶</option>
        </select>
        
        <button type="submit" class="hud-btn"><i class="fas fa-search"></i> çµã‚Šè¾¼ã‚€</button>
    </form>
</section>

<!-- ã‚µãƒãƒªãƒ¼çµ±è¨ˆ -->
<section class="hud-panel metrics">
    <h2 class="panel-title"><i class="fas fa-calculator"></i> OVERALL IMPROVEMENT</h2>
    <div style="display: flex; gap: 2rem; flex-wrap: wrap; justify-content: center;">
        <div class="metric-item">
            <h3><i class="fas fa-chart-line"></i> å‹ç‡å¹³å‡æ”¹å–„</h3>
            <p class="metric-value text-green">{{ summary.avg_win_rate_diff | round(2) }}%</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-shield-alt"></i> DDå¹³å‡æ”¹å–„</h3>
            <p class="metric-value text-green">{{ summary.avg_dd_diff | round(2) }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-arrow-up"></i> å‹ç‡æ”¹å–„æ•°</h3>
            <p class="metric-value text-cyan">{{ summary.win_rate_improved }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-arrow-down"></i> DDæ”¹å–„æ•°</h3>
            <p class="metric-value text-cyan">{{ summary.dd_improved }}</p>
        </div>
        <div class="metric-item">
            <h3><i class="fas fa-check-double"></i> æ¡ç”¨æˆ¦ç•¥æ•°</h3>
            <p class="metric-value text-yellow">{{ summary.adopted }}</p>
        </div>
    </div>
</section>

<!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
    <section class="hud-panel chart-panel">
        <h2 class="panel-title"><i class="fas fa-chart-bar"></i> å‹ç‡æ”¹å–„ï¼ˆ{{ "æˆ¦ç•¥åˆ¥" if mode == "strategy" else "ã‚¿ã‚°åˆ¥" }}ï¼‰</h2>
        <div style="height: 300px;"><canvas id="winRateChart"></canvas></div>
    </section>
    <section class="hud-panel chart-panel">
        <h2 class="panel-title"><i class="fas fa-chart-area"></i> æœ€å¤§DDæ”¹å–„ï¼ˆ{{ "æˆ¦ç•¥åˆ¥" if mode == "strategy" else "ã‚¿ã‚°åˆ¥" }}ï¼‰</h2>
        <div style="height: 300px;"><canvas id="ddChart"></canvas></div>
    </section>
</div>

<!-- è©•ä¾¡è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
<section class="hud-panel log-panel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2 class="panel-title" style="margin: 0;"><i class="fas fa-table"></i> è©•ä¾¡è©³ç´°ï¼ˆ{{ "æˆ¦ç•¥åˆ¥" if mode == "strategy" else "ã‚¿ã‚°åˆ¥" }}ï¼‰</h2>
        <button class="hud-btn download-btn" id="downloadCsvBtn"><i class="fas fa-download"></i> CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>
    <div class="table-wrapper">
        <table id="summary-table" class="hud-table">
          <thead>
            <tr>
              <th>{{ "æˆ¦ç•¥å" if mode == "strategy" else "ã‚¿ã‚°" }}</th>
              <th>å‹ç‡ (Before)</th>
              <th>å‹ç‡ (After)</th>
              <th>å·®åˆ† (%)</th>
              <th>æœ€å¤§DD (Before)</th>
              <th>æœ€å¤§DD (After)</th>
              <th>æ¡ç”¨</th>
            </tr>
          </thead>
          <tbody>
            {% if summary.detail|length == 0 %}
              <tr><td colspan="7" style="text-align:center; color:#888;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>
            {% else %}
              {% for row in summary.detail %}
              <tr>
                <td>{{ row.strategy }}</td>
                <td>{{ row.win_rate_before }}</td>
                <td>{{ row.win_rate_after }}</td>
                <td>{{ row.diff }}</td>
                <td>{{ row.max_dd_before }}</td>
                <td>{{ row.max_dd_after }}</td>
                <td>{{ row.status }}</td>
              </tr>
              {% endfor %}
            {% endif %}
          </tbody>
        </table>
    </div>
</section>

<!-- âœ… ã‚°ãƒ©ãƒ•æç”»ç”¨ã®ãƒ‡ãƒ¼ã‚¿ä¿æŒ -->
<div id="chart-data-holder" 
     data-labels="{{ chart.labels | default([]) | tojson | safe }}"
     data-win-rate-data="{{ chart.data | default([]) | tojson | safe }}"
     data-dd-data="{{ chart.dd_data | default([]) | tojson | safe }}"
     style="display: none;">
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // FlatpickråˆæœŸåŒ–
    flatpickr("#from-date", { dateFormat: "Y-m-d", allowInput: true });
    flatpickr("#to-date", { dateFormat: "Y-m-d", allowInput: true });

    const dataHolder = document.getElementById('chart-data-holder');
    // --- ãƒãƒ£ãƒ¼ãƒˆæç”» ---
    if (dataHolder) {
        try {
            const labels = JSON.parse(dataHolder.dataset.labels || '[]');
            const winRateData = JSON.parse(dataHolder.dataset.winRateData || '[]');
            const ddData = JSON.parse(dataHolder.dataset.ddData || '[]');

            const chartOptions = (titleText, yAxisLabel) => ({
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: titleText, color: '#e6f1ff', font: { size: 16 } }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#a8b2d1', callback: yAxisLabel ? (value => value + yAxisLabel) : undefined },
                        grid: { color: 'rgba(0, 229, 255, 0.2)' }
                    },
                    x: {
                        ticks: { color: '#a8b2d1' },
                        grid: { color: 'rgba(0, 229, 255, 0.1)' }
                    }
                }
            });

            const winRateChartEl = document.getElementById('winRateChart');
            if (winRateChartEl && winRateData.length > 0) {
                new Chart(winRateChartEl.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'å‹ç‡æ”¹å–„ç‡ (%)',
                            backgroundColor: 'rgba(46, 204, 113, 0.6)',
                            borderColor: '#2ecc71',
                            borderWidth: 1,
                            data: winRateData
                        }]
                    },
                    options: chartOptions('å‹ç‡æ”¹å–„ï¼ˆAfter - Beforeï¼‰', '%')
                });
            }

            const ddChartEl = document.getElementById('ddChart');
            if (ddChartEl && ddData.length > 0) {
                new Chart(ddChartEl.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æœ€å¤§DDæ”¹å–„ (Before - After)',
                            backgroundColor: 'rgba(231, 76, 60, 0.6)',
                            borderColor: '#e74c3c',
                            borderWidth: 1,
                            data: ddData
                        }]
                    },
                    options: chartOptions('æœ€å¤§DDæ”¹å–„ï¼ˆBefore - Afterï¼‰')
                });
            }
        } catch (e) {
            console.error("ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®æç”»ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
            const chartArea = document.querySelector('.chart-panel');
            if(chartArea) chartArea.innerHTML = `<p style='color: #ff4d4d; text-align: center;'>âš ï¸ ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
        }
    }

    // --- CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ---
    const downloadBtn = document.getElementById('downloadCsvBtn');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', () => {
            let csv = "{{ 'æˆ¦ç•¥å' if mode == 'strategy' else 'ã‚¿ã‚°' }},å‹ç‡(Before),å‹ç‡(After),å·®åˆ†(%),æœ€å¤§DD(Before),æœ€å¤§DD(After),æ¡ç”¨\n";
            const rows = document.querySelectorAll("#summary-table tbody tr");
            rows.forEach(row => {
                const cols = row.querySelectorAll("td");
                const rowData = Array.from(cols).map(td => `"${td.innerText.replace(/"/g, '""')}"`).join(",");
                csv += rowData + "\n";
            });

            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "pdca_summary.csv";
            link.click();
            URL.revokeObjectURL(link.href);
        });
    }
});
</script>
{% endblock %}
