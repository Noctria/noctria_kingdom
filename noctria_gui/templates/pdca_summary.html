<!-- noctria_gui/templates/pdca_summary.html -->
{% extends "base_hud.html" %}

{% block title %}{{ page_title or "ğŸ“Š PDCA ã‚µãƒãƒªãƒ¼" }} - Noctria Kingdom{% endblock %}
{% block header_icon %}<i class="fas fa-sync-alt" aria-hidden="true"></i>{% endblock %}
{% block header_title %}PDCA SUMMARY{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}DASHBOARD{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  .filter-form { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:.75rem; align-items:end; }
  .hud-input, .hud-select {
    background: rgba(0,0,0,0.3); border:1px solid var(--panel-border);
    color: var(--text-color-base); font-family: var(--font-family); font-size:1rem;
    border-radius:4px; padding:.5rem .75rem; transition: box-shadow .25s ease;
  }
  .hud-input:focus, .hud-select:focus { outline:none; box-shadow:0 0 8px var(--glow-primary); border-color: var(--glow-primary); }
  .metrics { display:flex; gap:1rem; flex-wrap:wrap; }
  .metric-item { background: var(--bg-color); border-radius:8px; padding:1rem 1.25rem; box-shadow:0 0 10px var(--glow-primary); flex:1 1 180px; }
  .metric-item h3 { margin:.1rem 0 .25rem; font-size:.9rem; color:var(--text-color-light); }
  .metric-value { font-size:1.6rem; font-weight:700; margin:0; }
  .grid-charts { display:grid; grid-template-columns:repeat(auto-fit,minmax(340px,1fr)); gap:1.2rem; }
  .empty-note { color:#9fbad6; text-align:center; padding:.75rem 0; }
  .btn-row { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
  .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
  .widget-frame { width:100%; border:none; min-height:480px; overflow:hidden; border-radius:8px; }
  .grid-quicklinks { display:grid; gap:1rem; grid-template-columns:repeat(3,minmax(0,1fr)); margin-top:1rem; }
  .link-card { text-decoration:none; color:inherit; }

  /* Toast */
  .toast {
    position: fixed; right: 1rem; bottom: 1rem; z-index: 9999;
    background: rgba(0,0,0,.7); border:1px solid rgba(255,255,255,.15);
    padding:.6rem .9rem; border-radius:.5rem; display:none;
  }
  .toast.show { display:block; }
  .toast.ok { border-color:#22c55e; }
  .toast.err { border-color:#ef4444; }
  .spinner { display:none; margin-left:.5rem }
  .spinner.show { display:inline-block; }

  /* Table */
  .table-wrap { overflow:auto; }
  table.hud-table { width:100%; border-collapse:collapse; font-size:.95rem; }
  table.hud-table th, table.hud-table td { padding:.5rem .6rem; border-bottom:1px solid var(--panel-border); white-space:nowrap; }
  table.hud-table th { text-align:left; color:var(--text-color-light); cursor:pointer; user-select:none; }
  table.hud-table th .sort { opacity:.7; font-size:.85em; margin-left:.25rem; }
  .pager { display:flex; gap:.5rem; align-items:center; justify-content:flex-end; margin-top:.5rem; }
  .pager .hud-link[disabled] { opacity:.5; pointer-events:none; }
</style>

<!-- ãƒ­ãƒ¼ã‚«ãƒ« â†’ è¶³ã‚Šãªã‘ã‚Œã°å¾Œæ®µã§CDNãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ -->
<script src="/static/vendor/chart.umd.js"></script>
<script src="/static/vendor/flatpickr.min.js"></script>
{% endblock %}

{% block content %}
<section class="hud-panel filter-panel" aria-labelledby="filter-title">
  <h2 id="filter-title" class="panel-title"><i class="fas fa-filter" aria-hidden="true"></i> FILTER & SEARCH</h2>
  <form class="filter-form" onsubmit="return false;" aria-describedby="filter-help">
    <p id="filter-help" class="sr-only">æœŸé–“ãƒ»ã‚¿ã‚°ãƒ»ã—ãã„å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã—ã€é©ç”¨ã§æ›´æ–°ã—ã¾ã™ã€‚</p>
    <div>
      <label for="from-date"><i class="fas fa-calendar-alt" aria-hidden="true"></i> é–‹å§‹æ—¥</label>
      <input id="from-date" type="text" class="hud-input" inputmode="numeric" autocomplete="off" placeholder="YYYY-MM-DD">
    </div>
    <div>
      <label for="to-date"><i class="fas fa-calendar-alt" aria-hidden="true"></i> çµ‚äº†æ—¥</label>
      <input id="to-date" type="text" class="hud-input" inputmode="numeric" autocomplete="off" placeholder="YYYY-MM-DD">
    </div>
    <div>
      <label for="tag-input"><i class="fas fa-tags" aria-hidden="true"></i> ã‚¿ã‚°/æˆ¦ç•¥</label>
      <input id="tag-input" type="text" class="hud-input" placeholder="e.g. veritas / levia">
    </div>
    <div>
      <label for="win-diff-input"><i class="fas fa-arrow-trend-up" aria-hidden="true"></i> å‹ç‡å·®åˆ† â‰¥ %</label>
      <input id="win-diff-input" type="number" step="0.1" class="hud-input" placeholder="ä¾‹: 3">
    </div>
    <div>
      <label for="dd-diff-input"><i class="fas fa-arrow-trend-down" aria-hidden="true"></i> æœ€å¤§DDå·®åˆ† â‰¤ %</label>
      <input id="dd-diff-input" type="number" step="0.1" class="hud-input" placeholder="ä¾‹: -2">
    </div>
    <div>
      <label for="min-trades-input"><i class="fas fa-list-ol" aria-hidden="true"></i> æœ€å°å–å¼•æ•°</label>
      <input id="min-trades-input" type="number" step="1" min="0" class="hud-input" placeholder="ä¾‹: 30">
    </div>

    <div class="btn-row">
      <button id="applyBtn" class="hud-link" type="button" aria-label="ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨">
        ğŸ” é©ç”¨ <span id="applySpin" class="spinner">â³</span>
      </button>
      <a id="csvBtn" class="hud-link" href="#" download aria-label="CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">â¬‡ï¸ CSV</a>
      <button id="recheckAllBtn" class="hud-link" type="button" aria-label="ä¸€æ‹¬å†è©•ä¾¡ã‚’å®Ÿè¡Œ">ğŸ” ä¸€æ‹¬å†è©•ä¾¡</button>
    </div>
  </form>
</section>

<!-- ç›´è¿‘æ¡ç”¨ã‚¿ã‚°ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ -->
{% set w = recent_adoptions_params or {'pattern':'veritas-','limit':9,'cols':3,'title':'ğŸ§© ç›´è¿‘æ¡ç”¨ã‚¿ã‚°'} %}
<section class="hud-panel" aria-labelledby="adopt-widget-title">
  <h2 id="adopt-widget-title" class="panel-title"><i class="fas fa-tags" aria-hidden="true"></i> ç›´è¿‘ã®æ¡ç”¨ã‚¿ã‚°</h2>
  <iframe
    class="widget-frame"
    src="/pdca/widgets/recent-adoptions?pattern={{ w.pattern | urlencode }}&limit={{ w.limit }}&cols={{ w.cols }}&title={{ w.title | urlencode }}"
    loading="lazy"
  ></iframe>
</section>

<section class="hud-panel" aria-labelledby="kpi-title">
  <h2 id="kpi-title" class="panel-title"><i class="fas fa-calculator" aria-hidden="true"></i> OVERALL KPIï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å¾Œï¼‰</h2>
  <div class="metrics" role="list">
    <div class="metric-item" role="listitem">
      <h3><i class="fas fa-hashtag" aria-hidden="true"></i> å¯¾è±¡ä»¶æ•°</h3>
      <p id="kpi-count" class="metric-value" aria-live="polite">-</p>
    </div>
    <div class="metric-item" role="listitem">
      <h3><i class="fas fa-check-circle" aria-hidden="true"></i> æ¡ç”¨ä»¶æ•°</h3>
      <p id="kpi-adopted" class="metric-value" aria-live="polite">-</p>
    </div>
    <div class="metric-item" role="listitem">
      <h3><i class="fas fa-redo-alt" aria-hidden="true"></i> å†è©•ä¾¡ä»¶æ•°</h3>
      <p id="kpi-rechecks" class="metric-value" aria-live="polite">-</p>
    </div>
    <div class="metric-item" role="listitem">
      <h3><i class="fas fa-percentage" aria-hidden="true"></i> å‹ç‡ï¼ˆå¹³å‡ï¼‰</h3>
      <p id="kpi-winrate" class="metric-value" aria-live="polite">-</p>
    </div>
    <div class="metric-item" role="listitem">
      <h3><i class="fas fa-chart-area" aria-hidden="true"></i> æœ€å¤§DDï¼ˆæœ€æ‚ªï¼‰</h3>
      <p id="kpi-maxdd" class="metric-value" aria-live="polite">-</p>
    </div>
  </div>
</section>

<div class="grid-charts">
  <section class="hud-panel" aria-labelledby="chart-counts-title">
    <h2 id="chart-counts-title" class="panel-title"><i class="fas fa-chart-bar" aria-hidden="true"></i> æ—¥æ¬¡ ä»¶æ•°ï¼ˆè©•ä¾¡ / æ¡ç”¨ï¼‰</h2>
    <div class="btn-row" style="margin:.25rem 0 .5rem">
      <button type="button" class="hud-link" onclick="downloadChartPNG('chartCounts','counts')">ğŸ“¸ ç”»åƒä¿å­˜</button>
    </div>
    <div style="height:300px"><canvas id="chartCounts" role="img" aria-label="æ—¥æ¬¡ã®è©•ä¾¡ä»¶æ•°ã¨æ¡ç”¨ä»¶æ•°ã®ã‚°ãƒ©ãƒ•"></canvas></div>
    <div id="noteCounts" class="empty-note" style="display:none">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
  </section>
  <section class="hud-panel" aria-labelledby="chart-windiff-title">
    <h2 id="chart-windiff-title" class="panel-title"><i class="fas a fa-chart-line" aria-hidden="true"></i> æ—¥æ¬¡ å‹ç‡ï¼ˆå¹³å‡ %ï¼‰</h2>
    <div class="btn-row" style="margin:.25rem 0 .5rem">
      <button type="button" class="hud-link" onclick="downloadChartPNG('chartWinDiff','winrate')">ğŸ“¸ ç”»åƒä¿å­˜</button>
    </div>
    <div style="height:300px"><canvas id="chartWinDiff" role="img" aria-label="æ—¥æ¬¡ã®å‹ç‡ã®æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•"></canvas></div>
    <div id="noteWinDiff" class="empty-note" style="display:none">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
  </section>
</div>

<!-- è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
<section id="details-panel" class="hud-panel" aria-labelledby="details-title" style="display:none">
  <h2 id="details-title" class="panel-title"><i class="fas fa-table" aria-hidden="true"></i> DETAILS</h2>
  <div class="btn-row" style="margin:.25rem 0 .5rem">
    <label for="page-size">è¡¨ç¤ºä»¶æ•°</label>
    <select id="page-size" class="hud-select" style="width:auto">
      <option value="20" selected>20</option>
      <option value="50">50</option>
      <option value="100">100</option>
    </select>
    <span class="muted" id="details-info" style="margin-left:auto"></span>
  </div>
  <div class="table-wrap">
    <table class="hud-table" id="details-table" aria-describedby="details-title">
      <thead>
        <tr>
          <th data-key="date">æ—¥ä»˜ <span class="sort" aria-hidden="true">â†•</span></th>
          <th data-key="tag">ã‚¿ã‚° <span class="sort">â†•</span></th>
          <th data-key="evals">è©•ä¾¡ <span class="sort">â†•</span></th>
          <th data-key="adopted">æ¡ç”¨ <span class="sort">â†•</span></th>
          <th data-key="win_rate">å‹ç‡(%) <span class="sort">â†•</span></th>
          <th data-key="max_drawdown">æœ€å¤§DD(%) <span class="sort">â†•</span></th>
          <th data-key="rechecks">å†è©•ä¾¡ <span class="sort">â†•</span></th>
          <th data-key="trades">å–å¼•æ•° <span class="sort">â†•</span></th>
        </tr>
      </thead>
      <tbody id="details-body"></tbody>
    </table>
  </div>
  <div class="pager">
    <button class="hud-link" id="prevPage">â—€ å‰ã¸</button>
    <span id="pageStatus">1 / 1</span>
    <button class="hud-link" id="nextPage">æ¬¡ã¸ â–¶</button>
  </div>
</section>

<!-- ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ³ã‚¯ -->
<div class="grid-quicklinks">
  <a class="card link-card" href="/adoptions">
    <div class="card-header">ğŸ—‚ æ¡ç”¨ã‚¿ã‚° Ã— Decision ä¸€è¦§</div>
    <div class="card-body muted">Gitã‚¿ã‚°ã¨Decisionå°å¸³ã‚’çªãåˆã‚ã›ãŸç·è¦§ã€‚CSV/JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾å¿œã€‚</div>
  </a>
  <a class="card link-card" href="/decisions">
    <div class="card-header">ğŸ—„ Decision Registry</div>
    <div class="card-body muted">æ±ºè£ã‚¤ãƒ™ãƒ³ãƒˆã®å°å¸³ã€‚Airflow Run ã¸ã®ç›¸äº’ãƒªãƒ³ã‚¯ã‚ã‚Šã€‚</div>
  </a>
  <a class="card link-card" href="/airflow/runs">
    <div class="card-header">ğŸŒ€ Airflow Runs</div>
    <div class="card-body muted">æ¡ç”¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®Ÿè¡Œå±¥æ­´ã€‚conf/ã‚¿ã‚¹ã‚¯ä¸€è¦§/é–¢é€£Decisionã‚’ç¢ºèªã€‚</div>
  </a>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
{% endblock %}

{% block scripts %}
<script>
/* ---------- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯èª­è¾¼ ---------- */
(function ensureLibs() {
  function addScript(src, onload){ var s=document.createElement('script'); s.src=src; s.defer=true; s.onload=onload||function(){}; document.head.appendChild(s); }
  function need(name){ return (typeof window[name] === 'undefined'); }
  const p = [];
  if (need('Chart'))     p.push(new Promise(res => addScript('https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js', res)));
  if (need('flatpickr')) p.push(new Promise(res => addScript('https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js', res)));
  Promise.all(p).then(function(){
    setTimeout(function(){
      if (need('Chart'))     addScript('/static/vendor/chart.umd.js');
      if (need('flatpickr')) addScript('/static/vendor/flatpickr.min.js');
    }, 400);
  });
})();
</script>

<script>
/* =========================
   ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆURLåŒæœŸ & è¿½åŠ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ & PNGä¿å­˜ & ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
   - /pdca/api/summary?date_from&date_to[&tag&win_diff&dd_diff&min_trades]
   - /pdca/api/details? ... ï¼ˆã‚ã‚Œã°ä½¿ç”¨ï¼‰/ ãªã‘ã‚Œã° s.details ã‚’ä½¿ã†
   - /pdca/summary.csv ã¯ from_date/to_date ã‚‚ä»˜ä¸ï¼ˆäº’æ›ï¼‰
   ========================= */
window.NoctriaPDCA = { charts: { counts:null, winDiff:null } };
window.GLOBAL_DEFAULT_FROM = null;
window.GLOBAL_DEFAULT_TO   = null;

function $(id){ return document.getElementById(id); }
function setText(id, t){ const el=$(id); if(el) el.textContent = (t ?? 'â€”'); }
function show(el, b){ if(el) el.style.display = b ? '' : 'none'; }
function intFmt(v){ if(v==null || isNaN(+v)) return 'â€”'; return String(Math.trunc(+v)); }
function percentFmt(v){ if(v==null || isNaN(+v)) return 'â€”'; return (Number(v)*100).toFixed(1) + '%'; }
function toast(msg, ok=true){
  const t = $('toast'); if(!t) return;
  t.className = 'toast ' + (ok?'ok':'err') + ' show';
  t.textContent = msg;
  setTimeout(()=>{ t.className='toast'; }, 1800);
}

/* ===== PNG ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ===== */
function downloadChartPNG(canvasId, baseName){
  const el = $(canvasId);
  if(!el) return;
  try{
    const url = el.toDataURL('image/png', 1.0);
    const a = document.createElement('a');
    const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    a.href = url;
    a.download = `pdca-${baseName}-${stamp}.png`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    toast('ç”»åƒã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ');
  }catch(e){
    console.error('png export failed', e);
    toast('ç”»åƒã®æ›¸ãå‡ºã—ã«å¤±æ•—', false);
  }
}

function isoDateDaysAgo(days){
  const now = new Date();
  const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() - days);
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

function readUrlIntoInputs(){
  const usp = new URLSearchParams(location.search);
  const from = usp.get('date_from') || usp.get('from_date') || window.GLOBAL_DEFAULT_FROM || isoDateDaysAgo(14);
  const to   = usp.get('date_to')   || usp.get('to_date')   || window.GLOBAL_DEFAULT_TO   || isoDateDaysAgo(0);
  const tag  = usp.get('tag') || '';
  const win  = usp.get('win_diff') || '';
  const dd   = usp.get('dd_diff') || '';
  const mt   = usp.get('min_trades') || '';
  if ($('from-date')) $('from-date').value = from;
  if ($('to-date'))   $('to-date').value   = to;
  if ($('tag-input')) $('tag-input').value = tag;
  if ($('win-diff-input')) $('win-diff-input').value = win;
  if ($('dd-diff-input'))  $('dd-diff-input').value  = dd;
  if ($('min-trades-input')) $('min-trades-input').value = mt;
}

function inputsToParams(){
  const from = $('from-date')?.value || window.GLOBAL_DEFAULT_FROM || isoDateDaysAgo(14);
  const to   = $('to-date')?.value   || window.GLOBAL_DEFAULT_TO   || isoDateDaysAgo(0);
  const tag  = $('tag-input')?.value?.trim();
  const win  = $('win-diff-input')?.value?.trim();
  const dd   = $('dd-diff-input')?.value?.trim();
  const mt   = $('min-trades-input')?.value?.trim();

  const p = new URLSearchParams();
  p.set('date_from', from);
  p.set('date_to', to);
  if (tag) p.set('tag', tag);
  if (win) p.set('win_diff', win);
  if (dd)  p.set('dd_diff', dd);
  if (mt)  p.set('min_trades', mt);
  return p;
}

function buildCsvParams(){
  // äº’æ›ã®ãŸã‚ new/legacy ä¸¡æ–¹ã®ã‚­ãƒ¼ã‚’ä»˜ã‘ã‚‹
  const p = inputsToParams();
  const from = p.get('date_from'); const to = p.get('date_to');
  p.set('from_date', from); p.set('to_date', to);
  return p;
}

function wireCsvButton(){
  const a = $('csvBtn'); if(!a) return;
  a.href = '/pdca/summary.csv?' + buildCsvParams().toString();
}

/* ====== localStorage ï¼ˆè‡ªå‹•ä¿å­˜/å¾©å…ƒï¼‰ ====== */
const LS_KEY = 'pdca_filters_v1';
function saveFilters(){
  try{
    const obj = {
      from: $('from-date')?.value || '',
      to  : $('to-date')?.value || '',
      tag : $('tag-input')?.value || '',
      win : $('win-diff-input')?.value || '',
      dd  : $('dd-diff-input')?.value || '',
      mt  : $('min-trades-input')?.value || ''
    };
    localStorage.setItem(LS_KEY, JSON.stringify(obj));
  }catch{}
}
function restoreFilters(){
  try{
    const v = localStorage.getItem(LS_KEY); if(!v) return;
    const obj = JSON.parse(v);
    if(obj.from && $('from-date')) $('from-date').value = obj.from;
    if(obj.to   && $('to-date'))   $('to-date').value   = obj.to;
    if($('tag-input')) $('tag-input').value = obj.tag ?? '';
    if($('win-diff-input')) $('win-diff-input').value = obj.win ?? '';
    if($('dd-diff-input'))  $('dd-diff-input').value  = obj.dd ?? '';
    if($('min-trades-input')) $('min-trades-input').value = obj.mt ?? '';
  }catch{}
}

/* ====== Chart helpers ====== */
function createLine(ctx, labels, label, data, ySuffix){
  const gridC='rgba(0, 229, 255, 0.15)', axisC='#a8b2d1';
  return new Chart(ctx, {
    type: 'line',
    data: { labels, datasets:[{ label, data, tension:0.25 }] },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ display:true } },
      scales:{
        y:{ beginAtZero:true, grid:{ color:gridC }, ticks:{ color:axisC, callback:v => ySuffix ? `${v}${ySuffix}` : v } },
        x:{ grid:{ color:gridC }, ticks:{ color:axisC, maxRotation:0 } }
      }
    }
  });
}

function createBar2Axis(ctx, labels, ds1, ds2){
  const gridC='rgba(0, 229, 255, 0.15)', axisC='#a8b2d1';
  return new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [
      { label: ds1.label, data: ds1.data, yAxisID:'y1' },
      { label: ds2.label, data: ds2.data, yAxisID:'y1' },
    ]},
    options: {
      responsive:true, maintainAspectRatio:false, interaction:{ mode:'index', intersect:false },
      scales:{
        y1:{ type:'linear', position:'left', beginAtZero:true, grid:{ color:gridC }, ticks:{ color:axisC } },
        x :{ grid:{ color:gridC }, ticks:{ color:axisC, maxRotation:0 } }
      },
      plugins:{ legend:{ display:true } }
    }
  });
}

/* ======== ãƒ•ã‚§ãƒƒãƒé€£æ‰“é˜²æ­¢ ======== */
let fetching = false;
function setApplying(b){
  const btn = $('applyBtn');
  const spin = $('applySpin');
  fetching = b;
  if(btn){ btn.disabled = b; btn.style.opacity = b ? .6 : 1; }
  if(spin){ b ? spin.classList.add('show') : spin.classList.remove('show'); }
}

/* ======== ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒšãƒ¼ã‚¸ãƒ³ã‚°ï¼†ã‚½ãƒ¼ãƒˆï¼‰ ======== */
const tableState = {
  raw: [],          // ã‚µãƒ¼ãƒã‹ã‚‰ã®ç”Ÿé…åˆ—
  view: [],         // ã‚½ãƒ¼ãƒˆå¾Œã®é…åˆ—
  page: 1,
  pageSize: 20,
  sortKey: 'date',
  sortDir: 'desc'   // 'asc' | 'desc'
};

function coerceRow(r){
  // å¯èƒ½ãªã‚­ãƒ¼ã«åˆã‚ã›ã¦ã‚¬ãƒ¼ãƒ‰
  return {
    date: r.date ?? r.day ?? '',
    tag: r.tag ?? r.strategy ?? r.name ?? '',
    evals: Number.isFinite(+r.evals) ? +r.evals : 0,
    adopted: Number.isFinite(+r.adopted) ? +r.adopted : 0,
    win_rate: (r.win_rate==null ? null : +(+r.win_rate*100).toFixed(2)),
    max_drawdown: (r.max_drawdown==null ? null : +(+r.max_drawdown*100).toFixed(2)),
    rechecks: Number.isFinite(+r.rechecks) ? +r.rechecks : (Number.isFinite(+r.recheck_count)? +r.recheck_count : 0),
    trades: Number.isFinite(+r.trades) ? +r.trades : (Number.isFinite(+r.num_trades)? +r.num_trades : 0),
  };
}

function sortView(){
  const key = tableState.sortKey, dir = tableState.sortDir;
  tableState.view = [...tableState.raw].sort((a,b)=>{
    const va = a[key]; const vb = b[key];
    if(va==null && vb==null) return 0;
    if(va==null) return 1;
    if(vb==null) return -1;
    if(typeof va === 'number' && typeof vb === 'number'){
      return dir==='asc' ? (va - vb) : (vb - va);
    }
    // æ–‡å­—åˆ—ã¯ãƒ­ã‚±ãƒ¼ãƒ«æ¯”è¼ƒ
    return dir==='asc' ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
  });
}

function renderTablePage(){
  const panel = $('details-panel');
  if(!panel) return;
  if(!tableState.view.length){
    panel.style.display = 'none';
    return;
  }
  panel.style.display = '';

  const body = $('details-body');
  const info = $('details-info');
  const pageSize = tableState.pageSize;
  const total = tableState.view.length;
  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  if(tableState.page > totalPages) tableState.page = totalPages;
  const start = (tableState.page - 1) * pageSize;
  const slice = tableState.view.slice(start, start + pageSize);

  body.innerHTML = slice.map(r => `
    <tr>
      <td>${r.date || ''}</td>
      <td>${r.tag || ''}</td>
      <td>${r.evals}</td>
      <td>${r.adopted}</td>
      <td>${r.win_rate==null?'â€”':r.win_rate.toFixed(2)}</td>
      <td>${r.max_drawdown==null?'â€”':r.max_drawdown.toFixed(2)}</td>
      <td>${r.rechecks}</td>
      <td>${r.trades}</td>
    </tr>
  `).join('');

  setText('pageStatus', `${tableState.page} / ${totalPages}`);
  setText('details-info', `å…¨ ${total} ä»¶`);
  $('prevPage').toggleAttribute?.('disabled', tableState.page<=1);
  $('nextPage').toggleAttribute?.('disabled', tableState.page>=totalPages);
}

function attachTableEvents(){
  // ã‚½ãƒ¼ãƒˆ
  const thead = $('details-table')?.querySelector('thead');
  if(thead){
    thead.addEventListener('click', (ev)=>{
      const th = ev.target.closest('th');
      if(!th || !th.dataset.key) return;
      const key = th.dataset.key;
      if(tableState.sortKey === key){
        tableState.sortDir = (tableState.sortDir === 'asc' ? 'desc' : 'asc');
      }else{
        tableState.sortKey = key;
        tableState.sortDir = (key==='date' || key==='tag') ? 'asc' : 'desc';
      }
      sortView(); tableState.page = 1; renderTablePage();
    });
  }
  // ãƒšãƒ¼ã‚¸ãƒ³ã‚°
  $('prevPage')?.addEventListener('click', ()=>{ if(tableState.page>1){ tableState.page--; renderTablePage(); }});
  $('nextPage')?.addEventListener('click', ()=>{ tableState.page++; renderTablePage(); });
  $('page-size')?.addEventListener('change', (e)=>{ tableState.pageSize = +e.target.value || 20; tableState.page = 1; renderTablePage(); });
}

/* ======== ãƒ¡ã‚¤ãƒ³æ›´æ–°å‡¦ç† ======== */
async function fetchDetailsFallback(paramsQS){
  // /pdca/api/details ãŒå­˜åœ¨ã™ã‚Œã°ä½¿ã†ã€‚404/ã‚¨ãƒ©ãƒ¼ãªã‚‰ç©ºé…åˆ—ã«ã€‚
  try{
    const res = await fetch('/pdca/api/details?' + paramsQS, { cache:'no-store' });
    if(!res.ok) return [];
    const js = await res.json();
    if(Array.isArray(js)) return js;
    if(Array.isArray(js?.items)) return js.items;
    return [];
  }catch{ return []; }
}

async function doRefresh(){
  // URLåŒæœŸï¼ˆå…±æœ‰/ãƒªãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
  const p = inputsToParams();
  const qs = p.toString();
  history.replaceState(null, '', location.pathname + '?' + qs);

  const res = await fetch('/pdca/api/summary?' + qs, { cache:'no-store' });
  if(!res.ok) throw new Error('summary HTTP ' + res.status);
  const s = await res.json();

  // --- KPI ---
  const t = s?.totals || {};
  setText('kpi-count',     intFmt(s?.count_rows));
  setText('kpi-adopted',   intFmt(t?.adopted));
  setText('kpi-rechecks',  intFmt(t?.rechecks));
  setText('kpi-winrate',   percentFmt(t?.win_rate));
  setText('kpi-maxdd',     percentFmt(t?.max_drawdown));

  // --- æ™‚ç³»åˆ—ï¼ˆby_dayï¼‰
  const by = Array.isArray(s?.by_day) ? s.by_day : [];
  const labels = by.map(r => r?.date ?? '');
  const evals  = by.map(r => Number.isFinite(+r?.evals) ? +r.evals : 0);
  const adopted= by.map(r => Number.isFinite(+r?.adopted) ? +r.adopted : 0);
  const wrPct  = by.map(r => (r?.win_rate==null ? null : +(r.win_rate*100).toFixed(2)));

  show($('noteCounts'),  labels.length === 0);
  show($('noteWinDiff'), labels.length === 0);

  if (window.NoctriaPDCA.charts.counts)  { try{ window.NoctriaPDCA.charts.counts.destroy(); }catch{} window.NoctriaPDCA.charts.counts = null; }
  if (window.NoctriaPDCA.charts.winDiff) { try{ window.NoctriaPDCA.charts.winDiff.destroy(); }catch{} window.NoctriaPDCA.charts.winDiff = null; }

  const ctxCounts  = $('chartCounts');
  const ctxWinDiff = $('chartWinDiff');
  if (ctxCounts && ctxCounts.getContext) {
    window.NoctriaPDCA.charts.counts  = createBar2Axis(
      ctxCounts.getContext('2d'),
      labels,
      { label:'è©•ä¾¡ä»¶æ•°', data: evals },
      { label:'æ¡ç”¨ä»¶æ•°', data: adopted }
    );
  }
  if (ctxWinDiff && ctxWinDiff.getContext) {
    window.NoctriaPDCA.charts.winDiff = createLine(
      ctxWinDiff.getContext('2d'),
      labels,
      'å‹ç‡ï¼ˆå¹³å‡ %ï¼‰',
      wrPct,
      '%'
    );
  }

  // --- è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆs.details ã‹ /pdca/api/detailsï¼‰
  let details = Array.isArray(s?.details) ? s.details : null;
  if(!details) {
    details = await fetchDetailsFallback(qs);
  }
  if(Array.isArray(details) && details.length){
    tableState.raw = details.map(coerceRow);
    sortView(); tableState.page = 1; renderTablePage();
  }else{
    tableState.raw = []; tableState.view = []; renderTablePage();
  }

  wireCsvButton();
}

let fetching = false;
function setApplying(b){
  const btn = $('applyBtn');
  const spin = $('applySpin');
  fetching = b;
  if(btn){ btn.disabled = b; btn.style.opacity = b ? .6 : 1; }
  if(spin){ b ? spin.classList.add('show') : spin.classList.remove('show'); }
}

window.pdcaRefresh = async function pdcaRefresh(){
  if(fetching) return;
  setApplying(true);
  try{
    saveFilters();
    await doRefresh();
    toast('æ›´æ–°ã—ã¾ã—ãŸ');
  }catch(e){
    console.error('[summary] fetch error:', e);
    toast('å–å¾—ã«å¤±æ•—: ' + (e?.message || e), false);
  }finally{
    setApplying(false);
  }
};

/* ========= DOM æº–å‚™ ========= */
document.addEventListener('DOMContentLoaded', function(){
  window.GLOBAL_DEFAULT_FROM = "{{ default_from or '' }}".trim() || isoDateDaysAgo(14);
  window.GLOBAL_DEFAULT_TO   = "{{ default_to or '' }}".trim()   || isoDateDaysAgo(0);

  // URLâ†’å…¥åŠ›æ¬„ã¸ï¼ˆåˆå›ï¼‰
  readUrlIntoInputs();
  // ä¿å­˜æ¸ˆã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§ä¸Šæ›¸ãï¼ˆå‰å›æ“ä½œã®å¾©å…ƒï¼‰
  restoreFilters();

  (function initPickers(){
    if (typeof flatpickr === 'undefined') return void setTimeout(initPickers, 120);
    flatpickr('#from-date', { dateFormat:'Y-m-d', allowInput:true, defaultDate: $('from-date')?.value || window.GLOBAL_DEFAULT_FROM });
    flatpickr('#to-date',   { dateFormat:'Y-m-d', allowInput:true, defaultDate: $('to-date')?.value   || window.GLOBAL_DEFAULT_TO   });
  })();

  const btn  = $('applyBtn');
  const rbtn = $('recheckAllBtn');
  if (btn)  btn.addEventListener('click', window.pdcaRefresh);
  if (rbtn) rbtn.addEventListener('click', triggerRecheckAll);

  // ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆç´ä»˜ã‘
  attachTableEvents();

  // åˆå›ã§ã‚‚æ­£ã—ã„CSVãƒªãƒ³ã‚¯ã‚’å¼µã‚‹
  wireCsvButton();

  (function waitChart(){
    if (typeof Chart === 'undefined') return void setTimeout(waitChart, 120);
    window.pdcaRefresh();
  })();
});
</script>
{% endblock %}
