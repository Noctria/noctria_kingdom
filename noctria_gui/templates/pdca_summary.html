<!-- noctria_gui/templates/pdca_summary.html -->
{% extends "base_hud.html" %}

{% block title %}{{ page_title or "📊 PDCA サマリー" }} - Noctria Kingdom{% endblock %}
{% block header_icon %}<i class="fas fa-sync-alt" aria-hidden="true"></i>{% endblock %}
{% block header_title %}PDCA SUMMARY{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}DASHBOARD{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  .filter-form { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:.75rem; align-items:end; }
  .hud-input, .hud-select { background: rgba(0,0,0,0.3); border:1px solid var(--panel-border); color: var(--text-color-base); font-family: var(--font-family); font-size:1rem; border-radius:4px; padding:.5rem .75rem; transition: box-shadow .25s ease; }
  .hud-input:focus, .hud-select:focus { outline:none; box-shadow:0 0 8px var(--glow-primary); border-color: var(--glow-primary); }
  .metrics { display:flex; gap:1rem; flex-wrap:wrap; }
  .metric-item { background: var(--bg-color); border-radius:8px; padding:1rem 1.25rem; box-shadow:0 0 10px var(--glow-primary); flex:1 1 180px; }
  .metric-item h3 { margin:.1rem 0 .25rem; font-size:.9rem; color:var(--text-color-light); }
  .metric-value { font-size:1.6rem; font-weight:700; margin:0; }
  .grid-charts { display:grid; grid-template-columns:repeat(auto-fit,minmax(340px,1fr)); gap:1.2rem; }
  .empty-note { color:#9fbad6; text-align:center; padding:.75rem 0; }
  .btn-row { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-top:.5rem; }
  .preset-row { display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.25rem; }
  .widget-frame { width:100%; border:none; min-height:480px; overflow:hidden; border-radius:8px; }
  .grid-quicklinks { display:grid; gap:1rem; grid-template-columns:repeat(3,minmax(0,1fr)); margin-top:1rem; }
  .link-card { text-decoration:none; color:inherit; }

  /* Toast / spinner */
  .toast { position: fixed; right: 1rem; bottom: 1rem; z-index: 9999; background: rgba(0,0,0,.72); border:1px solid rgba(255,255,255,.18); padding:.6rem .9rem; border-radius:.5rem; display:none; }
  .toast.show { display:block; } .toast.ok { border-color:#22c55e; } .toast.err { border-color:#ef4444; }
  .spinner { display:none; margin-left:.5rem } .spinner.show { display:inline-block; }

  /* Table */
  .table-wrap { overflow:auto; position:relative; }
  table.hud-table { width:100%; border-collapse:collapse; font-size:.95rem; background: transparent; }
  table.hud-table th, table.hud-table td { padding:.5rem .6rem; border-bottom:1px solid var(--panel-border); white-space:nowrap; }
  table.hud-table th { text-align:left; color:var(--text-color-light); cursor:pointer; user-select:none; position: sticky; top: 0; background: var(--bg-color); z-index: 2; }
  table.hud-table th .sort { opacity:.7; font-size:.85em; margin-left:.25rem; }
  table.hud-table tbody tr { cursor: pointer; }
  table.hud-table tbody tr:hover { background: rgba(34, 209, 238, 0.08); }

  .pager { display:flex; gap:.5rem; align-items:center; justify-content:flex-end; margin-top:.5rem; }
  .pager .hud-link[disabled] { opacity:.5; pointer-events:none; }

  /* ===== Skeletons ===== */
  .skel { position:relative; overflow:hidden; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); border-radius:8px; }
  .skel::after { content:""; position:absolute; inset:0; transform: translateX(-100%); background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,0.14), rgba(255,255,255,0)); animation: shimmer 1.5s infinite; }
  @keyframes shimmer { 100% { transform: translateX(100%); } }
  .skel-chart { height:300px; }
  .skel-metric { height:36px; border-radius:6px; }
  .skel-row { height:36px; }
  .hide-when-loading.loading { display:none !important; }
  .show-when-loading { display:none; }
  .show-when-loading.loading { display:block; }

  /* Error panel */
  .error-panel { display:none; margin-top:.75rem; padding:.6rem .8rem; border-radius:.5rem; border:1px solid #ef4444; background: rgba(239,68,68,.08); }
  .error-panel.show { display:block; }
  .error-panel code { white-space:pre-wrap; }

  /* ====== 詳細モーダル ====== */
  .modal-backdrop {
    position: fixed; inset: 0; background: rgba(0,0,0,0.55); backdrop-filter: blur(2px);
    display: none; align-items: center; justify-content: center; z-index: 10000;
  }
  .modal-backdrop.show { display: flex; }
  .modal-card {
    width: min(880px, 92vw); max-height: 86vh; overflow: auto;
    background: var(--panel-bg); border: 1px solid var(--panel-border);
    border-radius: 12px; box-shadow: 0 0 20px var(--glow-primary); padding: 1rem 1.2rem;
  }
  .modal-header { display:flex; align-items:center; gap:.75rem; margin-bottom:.5rem; }
  .modal-title { font-weight: 800; color: var(--text-color-normal); font-size: 1.2rem; display:flex; gap:.5rem; align-items:center; }
  .modal-sub { color: var(--text-color-light); font-size:.9rem; }
  .modal-actions { margin-left:auto; display:flex; gap:.5rem; }
  .modal-body { display:grid; grid-template-columns: 1fr; gap:.75rem; }
  .kv { display:grid; grid-template-columns: 160px 1fr; gap:.5rem; }
  .kv div:first-child { color: var(--text-color-light); }
  .link-row { display:flex; flex-wrap:wrap; gap:.5rem; }
  .json-pre { background: rgba(0,0,0,0.25); border:1px solid var(--panel-border); padding:.5rem .6rem; border-radius:8px; overflow:auto; max-height: 240px; font-size:.85rem; }
  .chip { display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .5rem; border-radius:999px; background: rgba(34,209,238,.12); border:1px solid var(--panel-border); }
  .kbd { font-family: ui-monospace, "SFMono-Regular", Menlo, Consolas, monospace; font-size:.8em; padding:.05rem .35rem; border:1px solid var(--panel-border); border-radius:4px; }
</style>

<script src="/static/vendor/chart.umd.js"></script>
<script src="/static/vendor/flatpickr.min.js"></script>
{% endblock %}

{% block content %}
<section class="hud-panel filter-panel" aria-labelledby="filter-title">
  <h2 id="filter-title" class="panel-title"><i class="fas fa-filter" aria-hidden="true"></i> FILTER & SEARCH</h2>
  <form class="filter-form" onsubmit="return false;">
    <div>
      <label for="from-date"><i class="fas fa-calendar-alt" aria-hidden="true"></i> 開始日</label>
      <input id="from-date" type="text" class="hud-input" inputmode="numeric" autocomplete="off" placeholder="YYYY-MM-DD">
    </div>
    <div>
      <label for="to-date"><i class="fas fa-calendar-alt" aria-hidden="true"></i> 終了日</label>
      <input id="to-date" type="text" class="hud-input" inputmode="numeric" autocomplete="off" placeholder="YYYY-MM-DD">
    </div>
    <div class="ac-wrap">
      <label for="tag-input"><i class="fas fa-tags" aria-hidden="true"></i> タグ/戦略</label>
      <input id="tag-input" type="text" class="hud-input" placeholder="e.g. veritas / levia" autocomplete="off" aria-autocomplete="list" aria-expanded="false" aria-owns="tag-ac-list" aria-haspopup="listbox">
      <div id="tag-ac-list" class="ac-list" role="listbox" aria-label="タグ候補"></div>
    </div>
    <div>
      <label for="win-diff-input"><i class="fas fa-arrow-trend-up" aria-hidden="true"></i> 勝率差分 ≥ %</label>
      <input id="win-diff-input" type="number" step="0.1" class="hud-input" placeholder="例: 0.7">
    </div>
    <div>
      <label for="dd-diff-input"><i class="fas fa-arrow-trend-down" aria-hidden="true"></i> 最大DD差分 ≤ %</label>
      <input id="dd-diff-input" type="number" step="0.1" class="hud-input" placeholder="例: -0.6">
    </div>
    <div>
      <label for="min-trades-input"><i class="fas fa-list-ol" aria-hidden="true"></i> 最小取引数</label>
      <input id="min-trades-input" type="number" step="1" min="0" class="hud-input" placeholder="例: 30">
    </div>

    <div class="btn-row">
      <button id="applyBtn" class="hud-link" type="button">🔎 適用 <span id="applySpin" class="spinner">⏳</span></button>
      <a id="csvBtn" class="hud-link" href="#" download>⬇️ CSV</a>
      <button id="copyLinkBtn" class="hud-link" type="button" aria-label="現在の条件を含むURLをコピー">🔗 リンクコピー</button>
      <button id="recheckAllBtn" class="hud-link" type="button">🔁 一括再評価</button>
    </div>

    <div class="preset-row">
      <button type="button" class="hud-link preset-btn" data-days="0">今日</button>
      <button type="button" class="hud-link preset-btn" data-days="7">7日間</button>
      <button type="button" class="hud-link preset-btn" data-days="30">30日間</button>
      <button type="button" class="hud-link preset-btn" data-mode="year">今年</button>
      <button type="button" class="hud-link preset-btn" data-mode="reset">リセット</button>
    </div>
  </form>
</section>

{% set w = recent_adoptions_params or {'pattern':'veritas-','limit':9,'cols':3,'title':'🧩 直近採用タグ'} %}
<section class="hud-panel" aria-labelledby="adopt-widget-title">
  <h2 id="adopt-widget-title" class="panel-title"><i class="fas fa-tags" aria-hidden="true"></i> 直近の採用タグ</h2>
  <iframe class="widget-frame"
    src="/pdca/widgets/recent-adoptions?pattern={{ w.pattern | urlencode }}&limit={{ w.limit }}&cols={{ w.cols }}&title={{ w.title | urlencode }}"
    loading="lazy"></iframe>
</section>

<section class="hud-panel" aria-labelledby="kpi-title">
  <h2 id="kpi-title" class="panel-title"><i class="fas fa-calculator" aria-hidden="true"></i> OVERALL KPI（フィルター適用後）</h2>
  <div class="metrics" role="list" id="kpiMetrics" aria-busy="false">
    <div class="metric-item"><div class="skel skel-metric show-when-loading" id="skel-m1"></div><h3><i class="fas fa-hashtag"></i> 対象件数</h3><p id="kpi-count" class="metric-value hide-when-loading">-</p></div>
    <div class="metric-item"><div class="skel skel-metric show-when-loading" id="skel-m2"></div><h3><i class="fas fa-check-circle"></i> 採用件数</h3><p id="kpi-adopted" class="metric-value hide-when-loading">-</p></div>
    <div class="metric-item"><div class="skel skel-metric show-when-loading" id="skel-m3"></div><h3><i class="fas fa-redo-alt"></i> 再評価件数</h3><p id="kpi-rechecks" class="metric-value hide-when-loading">-</p></div>
    <div class="metric-item"><div class="skel skel-metric show-when-loading" id="skel-m4"></div><h3><i class="fas fa-percentage"></i> 勝率（平均）</h3><p id="kpi-winrate" class="metric-value hide-when-loading">-</p></div>
    <div class="metric-item"><div class="skel skel-metric show-when-loading" id="skel-m5"></div><h3><i class="fas fa-chart-area"></i> 最大DD（最悪）</h3><p id="kpi-maxdd" class="metric-value hide-when-loading">-</p></div>
  </div>
</section>

<div class="grid-charts">
  <section class="hud-panel" aria-labelledby="chart-counts-title">
    <h2 id="chart-counts-title" class="panel-title"><i class="fas fa-chart-bar"></i> 日次 件数（評価 / 採用）</h2>
    <div class="btn-row" style="margin:.25rem 0 .5rem"><button type="button" class="hud-link" onclick="downloadChartPNG('chartCounts','counts')">📸 画像保存</button></div>
    <div class="skel skel-chart show-when-loading" id="skel-counts"></div>
    <div style="height:300px" class="hide-when-loading" id="wrapCounts"><canvas id="chartCounts" role="img" aria-label="日次の評価件数と採用件数のグラフ"></canvas></div>
    <div id="noteCounts" class="empty-note hide-when-loading" style="display:none">データがありません</div>
  </section>
  <section class="hud-panel" aria-labelledby="chart-windiff-title">
    <h2 id="chart-windiff-title" class="panel-title"><i class="fas fa-chart-line"></i> 日次 勝率（平均 %）</h2>
    <div class="btn-row" style="margin:.25rem 0 .5rem"><button type="button" class="hud-link" onclick="downloadChartPNG('chartWinDiff','winrate')">📸 画像保存</button></div>
    <div class="skel skel-chart show-when-loading" id="skel-win"></div>
    <div style="height:300px" class="hide-when-loading" id="wrapWin"><canvas id="chartWinDiff" role="img" aria-label="日次の勝率の折れ線グラフ"></canvas></div>
    <div id="noteWinDiff" class="empty-note hide-when-loading" style="display:none">データがありません</div>
  </section>
</div>

<section id="details-panel" class="hud-panel" aria-labelledby="details-title" style="display:none">
  <h2 id="details-title" class="panel-title"><i class="fas fa-table"></i> DETAILS</h2>
  <div class="btn-row" style="margin:.25rem 0 .5rem">
    <label for="page-size">表示件数</label>
    <select id="page-size" class="hud-select" style="width:auto">
      <option value="20" selected>20</option>
      <option value="50">50</option>
      <option value="100">100</option>
      <option value="all">すべて</option>
    </select>
    <div style="margin-left:auto; display:flex; gap:.5rem; align-items:center;">
      <button id="exportCsvBtn" class="hud-link" type="button">📤 CSV出力</button>
      <button id="exportJsonBtn" class="hud-link" type="button">📤 JSON出力</button>
      <span class="muted" id="details-info"></span>
    </div>
  </div>
  <div class="skel skel-row show-when-loading" id="skel-table" style="height:180px"></div>
  <div class="table-wrap hide-when-loading" id="wrapTable" style="max-height:420px;">
    <table class="hud-table" id="details-table">
      <thead>
        <tr>
          <th data-key="date">日付 <span class="sort">↕</span></th>
          <th data-key="tag">タグ <span class="sort">↕</span></th>
          <th data-key="evals">評価 <span class="sort">↕</span></th>
          <th data-key="adopted">採用 <span class="sort">↕</span></th>
          <th data-key="win_rate">勝率(%) <span class="sort">↕</span></th>
          <th data-key="max_drawdown">最大DD(%) <span class="sort">↕</span></th>
          <th data-key="rechecks">再評価 <span class="sort">↕</span></th>
          <th data-key="trades">取引数 <span class="sort">↕</span></th>
        </tr>
      </thead>
      <tbody id="details-body"></tbody>
    </table>
    <!-- 仮想スクロール時のスペーサをJSで追加 -->
  </div>
  <div class="pager hide-when-loading" id="wrapPager">
    <button class="hud-link" id="prevPage">◀ 前へ</button>
    <span id="pageStatus">1 / 1</span>
    <button class="hud-link" id="nextPage">次へ ▶</button>
  </div>
</section>

<!-- エラー詳細 -->
<div id="error-panel" class="error-panel" role="alert" aria-live="assertive"></div>

<!-- ===== 詳細モーダル ===== -->
<div id="detailModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="detailModalTitle">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title"><i class="fas fa-circle-info"></i><span id="detailModalTitle">詳細</span></div>
      <div class="modal-actions">
        <button id="openDecisionBtn" class="hud-link" type="button">🗄 Decisionへ</button>
        <button id="openRunBtn" class="hud-link" type="button">🌀 Runへ</button>
        <button id="closeDetailBtn" class="hud-link" type="button"><span class="kbd">Esc</span> 閉じる</button>
      </div>
    </div>
    <div class="modal-body">
      <div class="kv">
        <div>日付</div><div id="d_date">-</div>
        <div>タグ</div><div id="d_tag">-</div>
        <div>評価 / 採用</div><div><span class="chip"><i class="fas fa-clipboard-check"></i><span id="d_evals">-</span></span> <span class="chip"><i class="fas fa-check-circle"></i><span id="d_adopted">-</span></span></div>
        <div>勝率 / 最大DD</div><div><span class="chip">Win <span id="d_win">-</span>%</span> <span class="chip">DD <span id="d_dd">-</span>%</span></div>
        <div>再評価 / 取引数</div><div><span class="chip">Re <span id="d_re">-</span></span> <span class="chip">Tr <span id="d_tr">-</span></span></div>
      </div>
      <div>
        <div class="modal-sub">関連リンク</div>
        <div class="link-row">
          <a id="d_link_adoptions" class="hud-link" target="_blank" rel="noopener">🧩 Adoptions</a>
          <a id="d_link_decisions" class="hud-link" target="_blank" rel="noopener">🗂 Decisions</a>
          <a id="d_link_runs" class="hud-link" target="_blank" rel="noopener">🌀 Airflow Runs</a>
        </div>
      </div>
      <div>
        <div class="modal-sub">Raw JSON</div>
        <pre id="d_json" class="json-pre">{}</pre>
      </div>
    </div>
  </div>
</div>

<div class="grid-quicklinks">
  <a class="card link-card" href="/adoptions"><div class="card-header">🗂 採用タグ × Decision 一覧</div><div class="card-body muted">GitタグとDecision台帳の総覧。CSV/JSON対応。</div></a>
  <a class="card link-card" href="/decisions"><div class="card-header">🗄 Decision Registry</div><div class="card-body muted">決裁イベントの台帳。Airflow Run への相互リンク。</div></a>
  <a class="card link-card" href="/airflow/runs"><div class="card-header">🌀 Airflow Runs</div><div class="card-body muted">採用パイプライン実行履歴。</div></a>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>
{% endblock %}

{% block scripts %}
<script>
/* ---------- ライブラリのフォールバック ---------- */
(function ensureLibs() {
  function addScript(src, onload){ var s=document.createElement('script'); s.src=src; s.defer=true; s.onload=onload||function(){}; document.head.appendChild(s); }
  function need(name){ return (typeof window[name] === 'undefined'); }
  const p = [];
  if (need('Chart'))     p.push(new Promise(res => addScript('https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js', res)));
  if (need('flatpickr')) p.push(new Promise(res => addScript('https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js', res)));
  Promise.all(p).then(function(){
    setTimeout(function(){
      if (need('Chart'))     addScript('/static/vendor/chart.umd.js');
      if (need('flatpickr')) addScript('/static/vendor/flatpickr.min.js');
    }, 400);
  });
})();
</script>

<script>
/* ========== Utils ========== */
function $(id){ return document.getElementById(id); }
function setText(id, t){ const el=$(id); if(el) el.textContent = (t ?? '—'); }
function show(el, b){ if(el) el.style.display = b ? '' : 'none'; }
function toast(msg, ok=true){ const t=$('toast'); if(!t) return; t.className='toast '+(ok?'ok':'err')+' show'; t.textContent=msg; setTimeout(()=>{t.className='toast';},2000); }
function isoDateDaysAgo(days){ const now=new Date(); const d=new Date(now.getFullYear(),now.getMonth(),now.getDate()-days); const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${yyyy}-${mm}-${dd}`; }
function normalizeDate(s){ if(!s) return s; const t=String(s).trim(); if(/^\d{8}$/.test(t)) return `${t.slice(0,4)}-${t.slice(4,6)}-${t.slice(6,8)}`; if(/^\d{4}-\d{2}-\d{2}$/.test(t)) return t; const d=new Date(t); if(!isNaN(d)){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; } return t; }
function intFmt(v){ if(v==null || isNaN(+v)) return '—'; return String(Math.trunc(+v)); }
function percentFmt(v){ if(v==null || isNaN(+v)) return '—'; return (Number(v)*100).toFixed(1) + '%'; }

/* PNG保存 */
function downloadChartPNG(canvasId, baseName){
  const el=$(canvasId); if(!el) return;
  try{ const url=el.toDataURL('image/png',1.0); const a=document.createElement('a'); const stamp=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    a.href=url; a.download=`pdca-${baseName}-${stamp}.png`; document.body.appendChild(a); a.click(); a.remove(); toast('画像を書き出しました'); }
  catch(e){ console.error('png export failed', e); toast('画像の書き出しに失敗', false); }
}

/* ===== ローディング制御（Skeleton表示） ===== */
let fetching=false;
function setApplying(b){
  const btn=$('applyBtn'), spin=$('applySpin');
  fetching=b;
  if(btn){ btn.disabled=b; btn.style.opacity = b ? 0.6 : 1; }
  if(spin){ b?spin.classList.add('show'):spin.classList.remove('show'); }
  ['kpiMetrics','wrapCounts','wrapWin','wrapTable','wrapPager'].forEach(id=>{
    const el=$(id); if(!el) return; if(b) el.classList.add('loading'); else el.classList.remove('loading');
  });
  ['skel-m1','skel-m2','skel-m3','skel-m4','skel-m5','skel-counts','skel-win','skel-table'].forEach(id=>{
    const el=$(id); if(!el) return; if(b) el.classList.add('loading'); else el.classList.remove('loading');
  });
  const kpi=$('kpiMetrics'); if(kpi) kpi.setAttribute('aria-busy', String(b));
}

/* ===== URL ⇄ 入力 ===== */
function readUrlIntoInputs(){
  const usp=new URLSearchParams(location.search);
  const rawFrom=usp.get('date_from')||usp.get('from_date')||usp.get('from');
  const rawTo  =usp.get('date_to')  ||usp.get('to_date')  ||usp.get('to');
  const from=normalizeDate(rawFrom||window.GLOBAL_DEFAULT_FROM||isoDateDaysAgo(14));
  const to  =normalizeDate(rawTo  ||window.GLOBAL_DEFAULT_TO  ||isoDateDaysAgo(0));
  $('from-date').value=from; $('to-date').value=to;
  $('tag-input') && ( $('tag-input').value = usp.get('tag')||'' );
  $('win-diff-input') && ( $('win-diff-input').value = usp.get('win_diff')||'' );
  $('dd-diff-input') && ( $('dd-diff-input').value = usp.get('dd_diff')||'' );
  $('min-trades-input') && ( $('min-trades-input').value = usp.get('min_trades')||'' );
}
function inputsToParamsAllKeys(){
  const from=normalizeDate($('from-date')?.value||window.GLOBAL_DEFAULT_FROM||isoDateDaysAgo(14));
  const to  =normalizeDate($('to-date')?.value  ||window.GLOBAL_DEFAULT_TO  ||isoDateDaysAgo(0));
  const tag=$('tag-input')?.value?.trim(), win=$('win-diff-input')?.value?.trim(), dd=$('dd-diff-input')?.value?.trim(), mt=$('min-trades-input')?.value?.trim();
  const p=new URLSearchParams(); p.set('date_from',from); p.set('date_to',to); p.set('from_date',from); p.set('to_date',to); p.set('from',from); p.set('to',to);
  if(tag) p.set('tag',tag); if(win) p.set('win_diff',win); if(dd) p.set('dd_diff',dd); if(mt) p.set('min_trades',mt); return p;
}
function wireCsvButton(){ const a=$('csvBtn'); if(a) a.href='/pdca/summary.csv?'+inputsToParamsAllKeys().toString(); }
function buildShareUrl(){ const qs=inputsToParamsAllKeys().toString(); return location.origin+location.pathname+(qs?`?${qs}`:''); }

/* ===== 共有リンクコピー ===== */
async function copyShareUrl(){
  const url=buildShareUrl();
  try{ await navigator.clipboard.writeText(url); toast('共有リンクをコピーしました'); }
  catch(e){
    try{ const ta=document.createElement('textarea'); ta.value=url; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); toast('共有リンクをコピーしました'); }
    catch(e2){ prompt('このURLをコピーしてください:', url); }
  }
}

/* ===== テーブル（ページング + 仮想スクロール） ===== */
const VIRTUAL_THRESHOLD = 800;
const ROW_H = 36;
const BUFFER_ROWS = 8;

const tableState={ raw:[], view:[], page:1, pageSize:20, sortKey:'date', sortDir:'desc', virtual:false };
let vSpacerEl=null;
let vScrollHandler=null;

function coerceRow(r){
  return {
    date:r.date??r.day??'',
    tag:r.tag??r.strategy??r.name??'',
    evals:(+r.evals)||0,
    adopted:(+r.adopted)||0,
    win_rate:(r.win_rate==null?null:+(+r.win_rate*100).toFixed(2)),
    max_drawdown:(r.max_drawdown==null?null:+(+r.max_drawdown*100).toFixed(2)),
    rechecks:(+r.rechecks||+r.recheck_count||0),
    trades:(+r.trades||+r.num_trades||0),
    // ドリルダウン用に可能な限り識別子を保持
    decision_id: r.decision_id || r.decision?.id || null,
    run_id: r.run_id || r.airflow_run_id || null,
    detail_id: r.id || r.detail_id || null,
    __raw: r
  };
}

function sortView(){ const k=tableState.sortKey,d=tableState.sortDir; tableState.view=[...tableState.raw].sort((a,b)=>{
  const va=a[k],vb=b[k]; if(va==null&&vb==null)return 0; if(va==null)return 1; if(vb==null)return -1;
  if(typeof va==='number' && typeof vb==='number') return d==='asc'?va-vb:vb-va;
  return d==='asc'?String(va).localeCompare(String(vb)):String(va).localeCompare(String(vb))*-1;}); }

function ensureSpacer(){
  const wrap=$('wrapTable');
  if(!vSpacerEl){ vSpacerEl=document.createElement('div'); vSpacerEl.id='vSpacer'; vSpacerEl.style.width='1px'; vSpacerEl.style.height='0'; }
  if(wrap && !vSpacerEl.isConnected){ wrap.appendChild(vSpacerEl); }
}

function setVirtualMode(on){
  const wrap=$('wrapTable'), table=$('details-table'), pager=$('wrapPager');
  tableState.virtual = !!on;
  if(on){
    ensureSpacer();
    wrap.style.maxHeight = '420px';
    if(pager) pager.style.display = 'none';
    table.style.position='absolute';
    table.style.top='0'; table.style.left='0'; table.style.right='0';
    if(!vScrollHandler){ vScrollHandler = ()=> renderTableVirtual(); wrap.addEventListener('scroll', vScrollHandler, { passive:true }); }
    renderTableVirtual();
  }else{
    if(vScrollHandler){ wrap.removeEventListener('scroll', vScrollHandler); vScrollHandler=null; }
    if(vSpacerEl){ vSpacerEl.style.height='0px'; }
    const tbody=$('details-body'); if(tbody){ tbody.style.transform=''; }
    const pager=$('wrapPager'); if(pager) pager.style.display = '';
    const table=$('details-table'); if(table){ table.style.position=''; table.style.top=''; table.style.left=''; table.style.right=''; }
    renderTablePage();
  }
}

function trHtml(r, idx){
  return `<tr data-idx="${idx}">
    <td>${r.date||''}</td><td>${r.tag||''}</td><td>${r.evals}</td><td>${r.adopted}</td>
    <td>${r.win_rate==null?'—':r.win_rate.toFixed(2)}</td>
    <td>${r.max_drawdown==null?'—':r.max_drawdown.toFixed(2)}</td>
    <td>${r.rechecks}</td><td>${r.trades}</td>
  </tr>`;
}

function hookRowClicks(){
  const body=$('details-body');
  if(!body) return;
  body.querySelectorAll('tr[data-idx]').forEach(tr=>{
    tr.addEventListener('click', ()=>{
      const idx = +tr.getAttribute('data-idx');
      const row = tableState.view[idx];
      if(row) openDetailModal(row);
    });
  });
}

function renderTableVirtual(){
  const wrap=$('wrapTable'); const tbody=$('details-body');
  if(!wrap||!tbody) return;
  const total = tableState.view.length;
  if(total===0){ tbody.innerHTML=''; if(vSpacerEl) vSpacerEl.style.height='0px'; return; }

  const viewportH = wrap.clientHeight || 420;
  const totalH = total * ROW_H;
  if(vSpacerEl){ vSpacerEl.style.height = totalH + 'px'; }

  const scrollTop = wrap.scrollTop;
  const first = Math.max(0, Math.floor(scrollTop / ROW_H) - BUFFER_ROWS);
  const visRows = Math.ceil(viewportH / ROW_H) + BUFFER_ROWS*2;
  const last = Math.min(total, first + visRows);

  const rows = [];
  for(let i=first;i<last;i++){ rows.push(trHtml(tableState.view[i], i)); }
  tbody.innerHTML = rows.join('');
  tbody.style.transform = `translateY(${first*ROW_H}px)`;
  setText('details-info', `全 ${total} 件（仮想表示 ${last-first} 行）`);
  hookRowClicks();
}

function renderTablePage(){
  const panel=$('details-panel'); if(!panel) return;
  if(!tableState.view.length){ panel.style.display='none'; return; } panel.style.display='';

  if(tableState.virtual){ renderTableVirtual(); return; }

  const body=$('details-body'),info=$('details-info');
  const ps=tableState.pageSize,total=tableState.view.length;
  const totalPages=Math.max(1,Math.ceil(total/ps)); if(tableState.page>totalPages) tableState.page=totalPages;
  const start=(tableState.page-1)*ps; const slice=tableState.view.slice(start,start+ps);
  body.innerHTML=slice.map((r,i)=>trHtml(r, start+i)).join('');
  setText('pageStatus', `${tableState.page} / ${totalPages}`); setText('details-info', `全 ${total} 件`);
  $('prevPage')?.toggleAttribute?.('disabled', tableState.page<=1);
  $('nextPage')?.toggleAttribute?.('disabled', tableState.page>=totalPages);
  hookRowClicks();
}

function attachTableEvents(){
  $('details-table')?.querySelector('thead')?.addEventListener('click',(ev)=>{
    const th=ev.target.closest('th'); if(!th?.dataset.key) return; const key=th.dataset.key;
    if(tableState.sortKey===key){ tableState.sortDir = (tableState.sortDir==='asc'?'desc':'asc'); }
    else { tableState.sortKey=key; tableState.sortDir=(key==='date'||key==='tag')?'asc':'desc'; }
    sortView();
    tableState.page=1;
    $('wrapTable').scrollTop = 0;
    renderTablePage();
  });
  $('prevPage')?.addEventListener('click', ()=>{ if(tableState.page>1){ tableState.page--; renderTablePage(); }});
  $('nextPage')?.addEventListener('click', ()=>{ tableState.page++; renderTablePage(); });
  $('page-size')?.addEventListener('change', (e)=>{
    const v = e.target.value;
    if(v==='all'){
      tableState.pageSize = Number.MAX_SAFE_INTEGER;
      setVirtualMode(true);
    }else{
      tableState.pageSize=+v||20;
      setVirtualMode(tableState.view.length > VIRTUAL_THRESHOLD);
    }
    tableState.page=1;
    $('wrapTable').scrollTop = 0;
    renderTablePage();
  });
}

/* ===== エクスポート ===== */
function downloadBlob(data, mime, filename){ const blob = new Blob([data], {type: mime}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function toCsvValue(v){ const s = (v==null) ? '' : String(v); if (/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"'; return s; }
function getRangeSlug(){ const usp=new URLSearchParams(location.search); const from=normalizeDate(usp.get('date_from')||usp.get('from_date')||usp.get('from')||$('from-date')?.value||''); const to=normalizeDate(usp.get('date_to')||usp.get('to_date')||usp.get('to')||$('to-date')?.value||''); return `${from||'NA'}_${to||'NA'}`; }
function exportDetailsCSV(){
  if(!tableState.view.length){ toast('出力対象がありません', false); return; }
  const header = ['date','tag','evals','adopted','win_rate_pct','max_drawdown_pct','rechecks','trades'];
  const rows = tableState.view.map(r=>[r.date||'', r.tag||'', r.evals, r.adopted, (r.win_rate==null?'':r.win_rate.toFixed(2)), (r.max_drawdown==null?'':r.max_drawdown.toFixed(2)), r.rechecks, r.trades]);
  const bom = '\uFEFF';
  const csv = [header.join(','), ...rows.map(rr=>rr.map(toCsvValue).join(','))].join('\n');
  const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  downloadBlob(bom + csv, 'text/csv;charset=utf-8', `pdca_details_${getRangeSlug()}_${stamp}.csv`);
  toast('CSVを書き出しました');
}
function exportDetailsJSON(){
  if(!tableState.view.length){ toast('出力対象がありません', false); return; }
  const data = tableState.view.map(r=>({ date:r.date||'', tag:r.tag||'', evals:r.evals, adopted:r.adopted, win_rate_pct:(r.win_rate==null?null:+r.win_rate.toFixed(2)), max_drawdown_pct:(r.max_drawdown==null?null:+r.max_drawdown.toFixed(2)), rechecks:r.rechecks, trades:r.trades }));
  const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  downloadBlob(JSON.stringify(data, null, 2), 'application/json;charset=utf-8', `pdca_details_${getRangeSlug()}_${stamp}.json`);
  toast('JSONを書き出しました');
}

/* ===== エラーパネル ===== */
function showErrorPanel(info){
  const p=$('error-panel'); if(!p) return;
  if(!info){ p.classList.remove('show'); p.innerHTML=''; return; }
  const {where,status,statusText,message,requestId,bodySnippet} = info;
  p.innerHTML = `<strong>取得に失敗しました</strong><br>
    <div>場所: <code>${where||'-'}</code></div>
    <div>HTTP: <code>${status||'-'} ${statusText||''}</code> ${requestId?`<span class="muted">(x-request-id: ${requestId})</span>`:''}</div>
    ${message?`<div>詳細: <code>${message}</code></div>`:''}
    ${bodySnippet?`<div>応答抜粋: <code>${bodySnippet}</code></div>`:''}`;
  p.classList.add('show');
}

/* ===== fetch ラッパ（詳細ログ） ===== */
async function fetchJsonWithDetail(url){
  const res = await fetch(url, {cache:'no-store'});
  const rid = res.headers.get('x-request-id') || res.headers.get('x-amzn-requestid') || null;
  let data=null, bodySnippet='';
  try{ data = await res.clone().json(); }
  catch(_){ try{ bodySnippet = (await res.clone().text()).slice(0,300); }catch{} }
  if(!res.ok){
    const apiMsg = data && (data.detail || data.message);
    const err = new Error(apiMsg || `HTTP ${res.status} ${res.statusText}`);
    err.__detail = { status: res.status, statusText: res.statusText, bodySnippet, requestId: rid, message: apiMsg };
    throw err;
  }
  return { data, requestId: rid };
}

/* ===== API ===== */
async function fetchDetailsFallback(qs){
  try{ const {data} = await fetchJsonWithDetail('/pdca/api/details?'+qs); if(Array.isArray(data)) return data; if(Array.isArray(data?.items)) return data.items; }
  catch(e){ console.error('[details] fallback error', e); }
  return [];
}

window.NoctriaPDCA = window.NoctriaPDCA || {};
function getCharts(){ if(!window.NoctriaPDCA.charts) window.NoctriaPDCA.charts={counts:null,winDiff:null}; return window.NoctriaPDCA.charts; }

/* ====== ドリルダウン：詳細モーダル ====== */
function closeDetailModal(){ const m=$('detailModal'); if(!m) return; m.classList.remove('show'); m.setAttribute('aria-hidden','true'); }
function openDetailModal(row){
  const m=$('detailModal'); if(!m) return;

  // ヘッダ
  setText('detailModalTitle', `${row.tag || '—'} @ ${row.date || '—'}`);
  // 概要
  setText('d_date', row.date||'—'); setText('d_tag', row.tag||'—');
  setText('d_evals', row.evals); setText('d_adopted', row.adopted);
  setText('d_win', row.win_rate==null?'—':row.win_rate.toFixed(2));
  setText('d_dd', row.max_drawdown==null?'—':row.max_drawdown.toFixed(2));
  setText('d_re', row.rechecks); setText('d_tr', row.trades);

  // 関連リンク（フォールバックはクエリリンク）
  const q = new URLSearchParams({ tag: row.tag || '', date: row.date || '' }).toString();
  const decUrl = row.decision_id ? `/decisions/${row.decision_id}` : `/decisions?${q}`;
  const runUrl = row.run_id ? `/airflow/runs/${row.run_id}` : `/airflow/runs?${q}`;
  const adoptUrl = `/adoptions?${q}`;

  $('d_link_decisions').href = decUrl;
  $('d_link_runs').href = runUrl;
  $('d_link_adoptions').href = adoptUrl;

  // 追加情報をAPIから引く（あれば）
  (async ()=>{
    let payload = row.__raw || {};
    try{
      // まず id 優先、なければ date+tag で詳細を試す
      let detailRes = null;
      if(row.detail_id){
        try{ detailRes = await fetchJsonWithDetail(`/pdca/api/entry?id=${encodeURIComponent(row.detail_id)}`); }catch(_){}
      }
      if(!detailRes && row.date && row.tag){
        try{ detailRes = await fetchJsonWithDetail(`/pdca/api/entry?date=${encodeURIComponent(row.date)}&tag=${encodeURIComponent(row.tag)}`); }catch(_){}
      }
      if(detailRes?.data){ payload = detailRes.data; }
    }catch(e){ console.debug('detail fetch skipped', e); }
    $('d_json').textContent = JSON.stringify(payload, null, 2);
  })();

  m.classList.add('show');
  m.setAttribute('aria-hidden','false');
}

document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeDetailModal(); }});
</script>

<script>
async function doRefresh(){
  const p=inputsToParamsAllKeys(); const qs=p.toString();
  history.replaceState(null,'',location.pathname+'?'+qs);
  showErrorPanel(null);

  // summary
  const {data:s, requestId:rid1} = await fetchJsonWithDetail('/pdca/api/summary?'+qs);

  // KPI
  const t = s?.totals || {};
  setText('kpi-count', intFmt(s?.count_rows));
  setText('kpi-adopted', intFmt(t?.adopted));
  setText('kpi-rechecks', intFmt(t?.rechecks));
  setText('kpi-winrate', percentFmt(t?.win_rate));
  setText('kpi-maxdd',   percentFmt(t?.max_drawdown));

  // charts
  const by = Array.isArray(s?.by_day) ? s.by_day : [];
  const labels = by.map(r => r?.date ?? '');
  const evals  = by.map(r => (+r?.evals)||0);
  const adopted= by.map(r => (+r?.adopted)||0);
  const wrPct  = by.map(r => (r?.win_rate==null ? null : +(r.win_rate*100).toFixed(2)));

  show($('noteCounts'),  labels.length===0);
  show($('noteWinDiff'), labels.length===0);

  const charts=getCharts();
  if (charts.counts?.destroy) { try{ charts.counts.destroy(); }catch{} }
  if (charts.winDiff?.destroy) { try{ charts.winDiff.destroy(); }catch{} }
  charts.counts=null; charts.winDiff=null;

  const ctxCounts=$('chartCounts'), ctxWinDiff=$('chartWinDiff');
  if (ctxCounts?.getContext) charts.counts = new Chart(ctxCounts.getContext('2d'), {
    type:'bar', data:{ labels, datasets:[{label:'評価件数',data:evals,yAxisID:'y1'},{label:'採用件数',data:adopted,yAxisID:'y1'}]},
    options:{ responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false},
      scales:{ y1:{ type:'linear', position:'left', beginAtZero:true }, x:{ ticks:{ maxRotation:0 }}}}
  });
  if (ctxWinDiff?.getContext) charts.winDiff = new Chart(ctxWinDiff.getContext('2d'), {
    type:'line', data:{ labels, datasets:[{label:'勝率（平均 %）',data:wrPct,tension:.25}]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{ ticks:{ maxRotation:0 }}, y:{ beginAtZero:true }}}
  });

  // details（summaryに含まれなければ fallback）
  let details = Array.isArray(s?.details)? s.details : await fetchDetailsFallback(qs);
  if(Array.isArray(details) && details.length){
    tableState.raw = details.map(coerceRow);
    sortView();
    $('wrapTable').scrollTop = 0;

    // 仮想モード判定
    const sizeSel = $('page-size')?.value || '20';
    if(sizeSel==='all' || tableState.view.length > VIRTUAL_THRESHOLD){
      setVirtualMode(true);
    }else{
      setVirtualMode(false);
    }

    tableState.page=1;
    renderTablePage();
  }else{
    tableState.raw=[]; tableState.view=[];
    setVirtualMode(false);
    renderTablePage();
  }

  wireCsvButton();

  console.groupCollapsed('%cPDCA refresh ok','color:#22c55e');
  console.log('requestId(summary):', rid1);
  console.log('labels:', labels.length, 'details:', details?.length||0, 'virtual:', tableState.virtual);
  console.groupEnd();
}

window.pdcaRefresh = async function(){
  if(fetching) return;
  setApplying(true);
  try{
    localStorage.setItem('pdca_filters_v1', JSON.stringify({
      from:$('from-date').value, to:$('to-date').value,
      tag:$('tag-input')?.value||'', win:$('win-diff-input')?.value||'',
      dd:$('dd-diff-input')?.value||'', mt:$('min-trades-input')?.value||''
    }));
    await doRefresh();
    toast('更新しました');
  }catch(e){
    const d = e?.__detail || {};
    console.group('%cPDCA refresh error','color:#ef4444'); console.error('Error:', e); console.log('detail:', d); console.groupEnd();
    showErrorPanel({ where:'/pdca/api/summary', status:d.status, statusText:d.statusText, message:d.message||e?.message, requestId:d.requestId, bodySnippet:d.bodySnippet });
    toast(`取得に失敗 (HTTP ${d.status||'—'})`, false);
  }finally{
    setApplying(false);
  }
}

/* ===== Presets / Events / CSV ===== */
function wirePresets(){
  document.querySelectorAll('.preset-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const mode=btn.dataset.mode, days=+btn.dataset.days;
      if(mode==='year'){ const y=new Date().getFullYear(); $('from-date').value=`${y}-01-01`; $('to-date').value=isoDateDaysAgo(0); }
      else if(mode==='reset'){ $('from-date').value=window.GLOBAL_DEFAULT_FROM||isoDateDaysAgo(14); $('to-date').value=window.GLOBAL_DEFAULT_TO||isoDateDaysAgo(0); }
      else{ $('from-date').value=isoDateDaysAgo(days); $('to-date').value=isoDateDaysAgo(0); }
      window.pdcaRefresh && window.pdcaRefresh();
    });
  });
}
</script>

<script>
/* ====== タグ・オートコンプリート（既存維持） ====== */
(function(){
  const inputId='tag-input', listId='tag-ac-list';
  let cacheAll=null, lastQuery='', activeIndex=-1, pending=null;
  function el(){ return {inp:$(inputId), list:$(listId)}; }
  function normalizeItems(js){ if(!js) return []; if(Array.isArray(js) && js.length && typeof js[0]==='string') return js; if(Array.isArray(js)) return js.map(o=>o?.name||o?.tag||o).filter(Boolean); return []; }
  async function queryServer(q){
    try{ const r = await fetch('/pdca/api/tags?q='+encodeURIComponent(q||''), {cache:'no-store'}); if(r.ok){ return normalizeItems(await r.json()); } }catch{}
    if(cacheAll==null){ try{ const r2 = await fetch('/pdca/api/tags', {cache:'no-store'}); if(r2.ok){ cacheAll = normalizeItems(await r2.json()); } }catch{ cacheAll = []; } }
    const src = cacheAll||[]; const t=(q||'').toLowerCase();
    const starts = src.filter(s=>s.toLowerCase().startsWith(t));
    const contains = src.filter(s=>!s.toLowerCase().startsWith(t) && s.toLowerCase().includes(t));
    return [...new Set([...starts, ...contains])].slice(0,50);
  }
  function render(items){
    const {inp,list} = el(); if(!list) return;
    list.innerHTML = '';
    if(!items.length){ list.innerHTML = '<div class="ac-empty">候補がありません</div>'; list.classList.add('show'); inp.setAttribute('aria-expanded','true'); activeIndex=-1; return; }
    items.forEach((s,idx)=>{
      const div=document.createElement('div'); div.className='ac-item'; div.setAttribute('role','option'); div.id=`ac-item-${idx}`;
      div.innerHTML = `<span># ${s}</span><span class="ac-kbd">Enterで決定</span>`;
      div.addEventListener('mousedown',(e)=>{ e.preventDefault(); pick(idx); });
      list.appendChild(div);
    });
    list.classList.add('show'); inp.setAttribute('aria-expanded','true'); activeIndex=-1;
  }
  function move(delta){
    const {list,inp}=el(); if(!list?.children?.length) return;
    activeIndex = (activeIndex + delta + list.children.length) % list.children.length;
    [...list.children].forEach((c,i)=>c.classList.toggle('active', i===activeIndex));
    inp.setAttribute('aria-activedescendant', list.children[activeIndex]?.id||'');
    const act = list.children[activeIndex]; if(act){ const r=act.getBoundingClientRect(); const lr=list.getBoundingClientRect();
      if(r.bottom>lr.bottom) act.scrollIntoView(false); else if(r.top<lr.top) act.scrollIntoView(); }
  }
  function close(){ const {list,inp}=el(); if(!list) return; list.classList.remove('show'); inp.setAttribute('aria-expanded','false'); activeIndex=-1; }
  function pick(idx){ const {inp,list}=el(); if(!list) return; const sel = list.children[idx]?.textContent?.replace(/^#\s*/,'').replace(/\s*Enterで決定\s*$/,'') || ''; if(inp){ inp.value = sel; } close(); window.pdcaRefresh && window.pdcaRefresh(); }
  function schedule(q){ if(pending) clearTimeout(pending); pending = setTimeout(async ()=>{ lastQuery=q; const items = await queryServer(q); if(lastQuery!==q) return; render(items); }, 120); }
  function wire(){ const {inp,list}=el(); if(!inp||!list) return; inp.addEventListener('input', (e)=>{ const q=(e.target.value||'').trim(); schedule(q); }); inp.addEventListener('focus', ()=>{ schedule((inp.value||'').trim()); }); inp.addEventListener('blur', ()=>{ setTimeout(close, 120); }); inp.addEventListener('keydown', (e)=>{ if(e.key==='ArrowDown'){ e.preventDefault(); move(1); } else if(e.key==='ArrowUp'){ e.preventDefault(); move(-1); } else if(e.key==='Enter'){ if(activeIndex>=0){ e.preventDefault(); pick(activeIndex); } else { close(); } } else if(e.key==='Escape'){ close(); } }); }
  document.addEventListener('DOMContentLoaded', wire);
})();
</script>

<script>
/* ========== 起動 ========== */
document.addEventListener('DOMContentLoaded', function(){
  window.GLOBAL_DEFAULT_FROM = "{{ default_from or '' }}".trim() || isoDateDaysAgo(14);
  window.GLOBAL_DEFAULT_TO   = "{{ default_to or '' }}".trim()   || isoDateDaysAgo(0);

  readUrlIntoInputs();

  (function initPickers(){
    if (typeof flatpickr === 'undefined') return void setTimeout(initPickers, 120);
    $('from-date').value = normalizeDate($('from-date').value || window.GLOBAL_DEFAULT_FROM);
    $('to-date').value   = normalizeDate($('to-date').value   || window.GLOBAL_DEFAULT_TO);
    flatpickr('#from-date', { dateFormat:'Y-m-d', allowInput:true, defaultDate:$('from-date').value });
    flatpickr('#to-date',   { dateFormat:'Y-m-d', allowInput:true, defaultDate:$('to-date').value   });
  })();

  $('applyBtn')?.addEventListener('click', ()=> window.pdcaRefresh());
  $('recheckAllBtn')?.addEventListener('click', ()=> {
    const reason = prompt("一括再評価の理由（任意）", "") || "";
    const p = inputsToParamsAllKeys();
    const url = new URL('/pdca/recheck_all', location.origin);
    url.searchParams.set('reason', reason);
    url.searchParams.set('filter_date_from', p.get('date_from'));
    url.searchParams.set('filter_date_to', p.get('date_to'));
    fetch(url.toString(), { method:'POST' })
      .then(r=>r.json().catch(()=>({message:'未知の応答'})).then(js=>({ok:r.ok, js})))
      .then(({ok,js})=> toast(js.message || (ok?'起動しました':'失敗しました'), ok))
      .catch(e=> toast('再評価の起動に失敗: '+(e?.message||e), false));
  });
  $('copyLinkBtn')?.addEventListener('click', copyShareUrl);
  $('exportCsvBtn')?.addEventListener('click', exportDetailsCSV);
  $('exportJsonBtn')?.addEventListener('click', exportDetailsJSON);
  $('closeDetailBtn')?.addEventListener('click', closeDetailModal);
  // モーダル外クリックで閉じる
  $('detailModal')?.addEventListener('click', (e)=>{ if(e.target===e.currentTarget) closeDetailModal(); });

  wirePresets();
  attachTableEvents();
  wireCsvButton();

  (function waitChart(){
    if (typeof Chart === 'undefined') return void setTimeout(waitChart, 120);
    window.pdcaRefresh();
  })();
});
</script>
{% endblock %}
