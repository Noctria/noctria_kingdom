<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>üìä Strategy Statistics - Noctria Kingdom HUD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Google Fonts & Font Awesome -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Â∞ÇÁî®CSS„Éï„Ç°„Ç§„É´ -->
    <link rel="stylesheet" href="/static/hud_style.css" />

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div class="hud-container-simple">
        <!-- Header -->
        <header class="hud-panel header">
            <h1 class="hud-title"><i class="fas fa-chart-pie"></i> VERITAS STRATEGY STATISTICS</h1>
            <a href="/dashboard" class="nav-item-back"><i class="fas fa-tachometer-alt"></i><span>DASHBOARD</span></a>
        </header>

        <!-- Controls Panel -->
        <section class="hud-panel controls-panel">
            <form method="get" action="/strategies/search" class="filter-form">
                <input type="text" name="keyword" placeholder="Search by strategy name or tag..." value="{{ keyword if keyword else '' }}">
                <button type="submit" class="hud-btn"><i class="fas fa-search"></i> Ê§úÁ¥¢</button>
            </form>
            <div class="separator"></div>
            <button onclick="plotComparison()" class="hud-btn"><i class="fas fa-chart-bar"></i> ÈÅ∏ÊäûÊà¶Áï•„ÇíÊØîËºÉ„Ç∞„É©„Éï„ÅßË°®Á§∫</button>
        </section>

        <!-- Main Analysis Panel -->
        <main class="hud-panel analysis-panel">
            <div class="chart-container-half">
                <canvas id="comparisonChart"></canvas>
            </div>
            <div class="table-wrapper">
                {% if strategies %}
                <form id="strategy-form">
                <table class="hud-table" id="strategy-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-check-square"></i></th>
                            <th>Êà¶Áï•Âêç</th>
                            <th class="sortable" onclick="sortTable(2, true)">ÂãùÁéá <i class="fas fa-sort"></i></th>
                            <th class="sortable" onclick="sortTable(3, true)">ÂèñÂºïÊï∞ <i class="fas fa-sort"></i></th>
                            <th class="sortable" onclick="sortTable(4, true)">ÊúÄÂ§ßDD <i class="fas fa-sort"></i></th>
                            <th>„Çø„Ç∞</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in strategies %}
                        <tr>
                            <td>
                                <label class="strategy-item-checkbox">
                                    <input type="checkbox" name="compare" value="{{ s.strategy }}"
                                           data-winrate="{{ s.win_rate }}"
                                           data-drawdown="{{ s.max_drawdown }}"
                                           data-trades="{{ s.trade_count }}">
                                    <span class="custom-checkbox"></span>
                                </label>
                            </td>
                            <td class="tag-name-cell">{{ s.strategy }}</td>
                            <td>{{ '{:.1f}'.format(s.win_rate) if s.win_rate is not none else '‚Äï' }}</td>
                            <td>{{ s.trade_count if s.trade_count is not none else '‚Äï' }}</td>
                            <td>{{ s.max_drawdown if s.max_drawdown is not none else '‚Äï' }}</td>
                            <td>
                                {% for tag in s.tags or [] %}
                                    <span class="hud-tag">{{ tag }}</span>
                                {% endfor %}
                            </td>
                            <td class="action-links">
                                <a class="table-link" href="/strategy/detail?name={{ s.strategy }}">üìÑ Ë©≥Á¥∞</a>
                                <a class="table-link" href="/strategies/view?name={{ s.strategy }}.py">üìú „Ç≥„Éº„Éâ</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </form>
                {% else %}
                    <p style="text-align: center; padding: 2rem;">‚ö†Ô∏è Ë°®Á§∫„Åß„Åç„ÇãÊà¶Áï•„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</p>
                {% endif %}
            </div>
        </main>
    </div>

    <script>
        let strategyChart;

        function plotComparison() {
            const checkboxes = document.querySelectorAll('input[name="compare"]:checked');
            if (checkboxes.length === 0) {
                alert("ÊØîËºÉ„Åô„ÇãÊà¶Áï•„Çí1„Å§‰ª•‰∏äÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                return;
            }
            const labels = [];
            const winrates = [];
            const drawdowns = [];

            checkboxes.forEach(cb => {
                labels.push(cb.value);
                winrates.push(parseFloat(cb.dataset.winrate) || 0);
                drawdowns.push(parseFloat(cb.dataset.drawdown) || 0);
            });

            const ctx = document.getElementById('comparisonChart').getContext('2d');
            if (strategyChart) strategyChart.destroy();

            strategyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ÂãùÁéáÔºà%Ôºâ',
                            data: winrates,
                            backgroundColor: 'rgba(125, 249, 255, 0.7)', // accent-color-1
                            borderColor: 'rgb(125, 249, 255)',
                            borderWidth: 1
                        },
                        {
                            label: 'ÊúÄÂ§ß„Éâ„É≠„Éº„ÉÄ„Ç¶„É≥',
                            data: drawdowns,
                            backgroundColor: 'rgba(75, 144, 255, 0.7)', // accent-color-2
                            borderColor: 'rgb(75, 144, 255)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#a8b2d1' }, grid: { color: 'rgba(0, 229, 255, 0.2)' } },
                        x: { ticks: { color: '#a8b2d1' }, grid: { color: 'rgba(0, 229, 255, 0.2)' } }
                    },
                    plugins: {
                        legend: { labels: { color: '#e6f1ff' } }
                    }
                }
            });
        }

        function sortTable(colIndex, isNumeric) {
            const table = document.getElementById("strategy-table");
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.rows);
            const th = table.querySelectorAll("th")[colIndex];
            const currentDir = th.dataset.sortDir || 'desc';
            const newDir = currentDir === 'asc' ? 'desc' : 'asc';

            table.querySelectorAll("th.sortable").forEach(h => h.dataset.sortDir = '');
            th.dataset.sortDir = newDir;

            rows.sort((a, b) => {
                const aText = a.cells[colIndex].innerText.trim();
                const bText = b.cells[colIndex].innerText.trim();
                const aVal = isNumeric ? parseFloat(aText) || -Infinity : aText;
                const bVal = isNumeric ? parseFloat(bText) || -Infinity : bText;
                if (aVal < bVal) return newDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return newDir === 'asc' ? 1 : -1;
                return 0;
            });

            tbody.append(...rows);
        }
    </script>
</body>
</html>
