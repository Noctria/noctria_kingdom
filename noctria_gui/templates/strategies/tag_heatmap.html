<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>🔥 タグ別戦略指標ヒートマップ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f4f4;
      padding: 2rem;
    }
    h1 {
      margin-bottom: 1.5rem;
      color: #222;
    }
    canvas {
      max-width: 1000px;
      margin: 2rem auto;
      display: block;
    }
    .legend {
      max-width: 1000px;
      margin: 0 auto 2rem;
      padding: 1rem;
      background: #fff;
      border-left: 4px solid #007acc;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    a {
      display: inline-block;
      margin-top: 2rem;
      text-decoration: none;
      color: #007acc;
    }
  </style>
</head>
<body>
  <h1>🔥 タグ別戦略指標ヒートマップ</h1>

  <div class="legend">
    <strong>🎨 カラー凡例：</strong><br>
    ✅ <b>勝率（緑）</b>: 高いほど濃く緑に<br>
    ⚠️ <b>最大ドローダウン（赤）</b>: 高いほど濃く赤に<br>
    🔁 <b>取引数（青）</b>: 多いほど濃く青に<br>
    各バーの中に数値ラベルも表示されます。
  </div>

  <canvas id="heatmapCanvas"></canvas>

  <script>
    const stats = {{ tag_stats | tojson }};
    const tags = stats.map(s => s.type);
    const metrics = ["win_rate", "max_drawdown", "num_trades"];
    const displayLabels = {
      win_rate: "勝率（%）",
      max_drawdown: "最大DD（%）",
      num_trades: "取引数"
    };

    function getColor(metric, value) {
      if (metric === "win_rate") {
        const hue = Math.min(120, value * 1.2);
        return `hsl(${hue}, 70%, 75%)`;
      }
      if (metric === "max_drawdown") {
        const hue = 0;
        const lightness = 95 - Math.min(80, value * 1.5);
        return `hsl(${hue}, 70%, ${lightness}%)`;
      }
      if (metric === "num_trades") {
        const hue = 210;
        const lightness = 95 - Math.min(70, value / 3);
        return `hsl(${hue}, 60%, ${lightness}%)`;
      }
      return "#ccc";
    }

    const datasets = metrics.map(metric => ({
      label: displayLabels[metric],
      data: stats.map(s => s[metric] || 0),
      backgroundColor: stats.map(s => getColor(metric, s[metric] || 0)),
      datalabels: {
        color: "#000",
        anchor: "center",
        align: "center",
        formatter: (v) => {
          if (v == null) return "―";
          return metric === "num_trades" ? `${v}` : `${v.toFixed(2)}`;
        }
      }
    }));

    const data = {
      labels: tags,
      datasets: datasets
    };

    Chart.register(ChartDataLabels);

    new Chart(document.getElementById("heatmapCanvas"), {
      type: "bar",
      data: data,
      options: {
        responsive: true,
        indexAxis: 'y',
        plugins: {
          title: {
            display: true,
            text: "タグ × 指標 ヒートマップ",
            font: { size: 18 }
          },
          legend: {
            position: 'top'
          },
          datalabels: {
            clamp: true
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              stepSize: 10
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  </script>

  <p><a href="/dashboard">← ダッシュボードへ戻る</a></p>
</body>
</html>
