<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ğŸ”¥ ã‚¿ã‚°åˆ¥æˆ¦ç•¥æŒ‡æ¨™ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f4f4;
      padding: 2rem;
    }
    h1 {
      margin-bottom: 1.5rem;
      color: #222;
    }
    canvas {
      max-width: 1000px;
      margin: 2rem auto;
      display: block;
    }
    .legend {
      max-width: 1000px;
      margin: 0 auto 2rem;
      padding: 1rem;
      background: #fff;
      border-left: 4px solid #007acc;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    a {
      display: inline-block;
      margin-top: 2rem;
      text-decoration: none;
      color: #007acc;
    }
  </style>
</head>
<body>
  <h1>ğŸ”¥ ã‚¿ã‚°åˆ¥æˆ¦ç•¥æŒ‡æ¨™ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</h1>

  <div class="legend">
    <strong>ğŸ¨ ã‚«ãƒ©ãƒ¼å‡¡ä¾‹ï¼š</strong><br>
    âœ… <b>å‹ç‡ï¼ˆç·‘ï¼‰</b>: é«˜ã„ã»ã©æ¿ƒãç·‘ã«<br>
    âš ï¸ <b>æœ€å¤§ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³ï¼ˆèµ¤ï¼‰</b>: é«˜ã„ã»ã©æ¿ƒãèµ¤ã«<br>
    ğŸ” <b>å–å¼•æ•°ï¼ˆé’ï¼‰</b>: å¤šã„ã»ã©æ¿ƒãé’ã«<br>
    å„ãƒãƒ¼ã®ä¸­ã«æ•°å€¤ãƒ©ãƒ™ãƒ«ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
  </div>

  <canvas id="heatmapCanvas"></canvas>

  <script>
    const stats = {{ tag_stats | tojson }};
    const tags = stats.map(s => s.type);
    const metrics = ["win_rate", "max_drawdown", "num_trades"];
    const displayLabels = {
      win_rate: "å‹ç‡ï¼ˆ%ï¼‰",
      max_drawdown: "æœ€å¤§DDï¼ˆ%ï¼‰",
      num_trades: "å–å¼•æ•°"
    };

    function getColor(metric, value) {
      if (metric === "win_rate") {
        const hue = Math.min(120, value * 1.2);
        return `hsl(${hue}, 70%, 75%)`;
      }
      if (metric === "max_drawdown") {
        const hue = 0;
        const lightness = 95 - Math.min(80, value * 1.5);
        return `hsl(${hue}, 70%, ${lightness}%)`;
      }
      if (metric === "num_trades") {
        const hue = 210;
        const lightness = 95 - Math.min(70, value / 3);
        return `hsl(${hue}, 60%, ${lightness}%)`;
      }
      return "#ccc";
    }

    const datasets = metrics.map(metric => ({
      label: displayLabels[metric],
      data: stats.map(s => s[metric] || 0),
      backgroundColor: stats.map(s => getColor(metric, s[metric] || 0)),
      datalabels: {
        color: "#000",
        anchor: "center",
        align: "center",
        formatter: (v) => {
          if (v == null) return "â€•";
          return metric === "num_trades" ? `${v}` : `${v.toFixed(2)}`;
        }
      }
    }));

    const data = {
      labels: tags,
      datasets: datasets
    };

    Chart.register(ChartDataLabels);

    new Chart(document.getElementById("heatmapCanvas"), {
      type: "bar",
      data: data,
      options: {
        responsive: true,
        indexAxis: 'y',
        plugins: {
          title: {
            display: true,
            text: "ã‚¿ã‚° Ã— æŒ‡æ¨™ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—",
            font: { size: 18 }
          },
          legend: {
            position: 'top'
          },
          datalabels: {
            clamp: true
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              stepSize: 10
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  </script>

  <p><a href="/dashboard">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸æˆ»ã‚‹</a></p>
</body>
</html>
