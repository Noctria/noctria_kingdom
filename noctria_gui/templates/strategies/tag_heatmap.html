<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ”¥ ã‚¿ã‚°åˆ¥æˆ¦ç•¥æŒ‡æ¨™ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f4f4;
      padding: 2rem;
    }
    h1 {
      margin-bottom: 1.5rem;
      color: #222;
    }
    .controls {
      max-width: 1000px;
      margin: 1rem auto;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
    }
    select, input {
      padding: 0.5rem;
      font-size: 1rem;
    }
    .legend {
      max-width: 1000px;
      margin: 1rem auto 2rem;
      padding: 1rem;
      background: #fff;
      border-left: 4px solid #007acc;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    canvas {
      max-width: 1000px;
      margin: 2rem auto;
      display: block;
    }
    a {
      display: inline-block;
      margin-top: 2rem;
      text-decoration: none;
      color: #007acc;
    }
  </style>
</head>
<body>
  <h1>ğŸ”¥ ã‚¿ã‚°åˆ¥æˆ¦ç•¥æŒ‡æ¨™ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</h1>

  <div class="controls">
    <label>
      ğŸ“Š æŒ‡æ¨™é¸æŠï¼š
      <select id="metricSelect">
        <option value="win_rate">å‹ç‡ï¼ˆ%ï¼‰</option>
        <option value="max_drawdown">æœ€å¤§DDï¼ˆ%ï¼‰</option>
        <option value="num_trades">å–å¼•æ•°</option>
      </select>
    </label>
    <label>
      ğŸš« ä»¶æ•°ã—ãã„å€¤ï¼š
      <input type="number" id="minTrades" value="0" min="0" />
    </label>
  </div>

  <div class="legend">
    <strong>ğŸ¨ ã‚«ãƒ©ãƒ¼å‡¡ä¾‹ï¼š</strong><br>
    âœ… <b>å‹ç‡ï¼ˆç·‘ï¼‰</b>: é«˜ã„ã»ã©æ¿ƒãç·‘ã«<br>
    âš ï¸ <b>æœ€å¤§ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³ï¼ˆèµ¤ï¼‰</b>: é«˜ã„ã»ã©æ¿ƒãèµ¤ã«<br>
    ğŸ” <b>å–å¼•æ•°ï¼ˆé’ï¼‰</b>: å¤šã„ã»ã©æ¿ƒãé’ã«<br>
    å„ãƒãƒ¼ã®ä¸­ã«æ•°å€¤ãƒ©ãƒ™ãƒ«ã‚‚è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
  </div>

  <canvas id="heatmapCanvas"></canvas>

  <script>
    const stats = {{ tag_stats | tojson }};
    const displayLabels = {
      win_rate: "å‹ç‡ï¼ˆ%ï¼‰",
      max_drawdown: "æœ€å¤§DDï¼ˆ%ï¼‰",
      num_trades: "å–å¼•æ•°"
    };

    function getColor(metric, value) {
      if (metric === "win_rate") {
        const hue = 120;
        const lightness = 95 - Math.min(60, value * 0.6);
        return `hsl(${hue}, 60%, ${lightness}%)`;
      }
      if (metric === "max_drawdown") {
        const hue = 0;
        const lightness = 95 - Math.min(60, value * 0.8);
        return `hsl(${hue}, 60%, ${lightness}%)`;
      }
      if (metric === "num_trades") {
        const hue = 210;
        const lightness = 95 - Math.min(60, value / 3);
        return `hsl(${hue}, 60%, ${lightness}%)`;
      }
      return "#ccc";
    }

    let chart = null;

    function renderChart(metric, minTrades = 0) {
      const filtered = stats.filter(s => (s.num_trades || 0) >= minTrades);
      const labels = filtered.map(s => s.type);
      const values = filtered.map(s => s[metric] || 0);
      const bgColors = filtered.map(s => getColor(metric, s[metric] || 0));

      const data = {
        labels,
        datasets: [{
          label: displayLabels[metric],
          data: values,
          backgroundColor: bgColors,
          datalabels: {
            color: "#000",
            anchor: "center",
            align: "center",
            formatter: (v) => {
              if (v == null) return "â€•";
              return metric === "num_trades" ? `${v}` : `${v.toFixed(2)}`;
            }
          }
        }]
      };

      const config = {
        type: "bar",
        data,
        options: {
          responsive: true,
          indexAxis: 'y',
          plugins: {
            title: {
              display: true,
              text: "ã‚¿ã‚° Ã— æŒ‡æ¨™ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—",
              font: { size: 18 }
            },
            legend: { display: false },
            datalabels: { clamp: true }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { stepSize: 10 }
            }
          }
        },
        plugins: [ChartDataLabels]
      };

      if (chart) {
        chart.destroy();
      }
      chart = new Chart(document.getElementById("heatmapCanvas"), config);
    }

    document.getElementById("metricSelect").addEventListener("change", () => {
      const metric = document.getElementById("metricSelect").value;
      const minTrades = parseInt(document.getElementById("minTrades").value || "0");
      renderChart(metric, minTrades);
    });

    document.getElementById("minTrades").addEventListener("input", () => {
      const metric = document.getElementById("metricSelect").value;
      const minTrades = parseInt(document.getElementById("minTrades").value || "0");
      renderChart(metric, minTrades);
    });

    // åˆæœŸæç”»
    renderChart("win_rate");
  </script>

  <p><a href="/dashboard">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸æˆ»ã‚‹</a></p>
</body>
</html>
