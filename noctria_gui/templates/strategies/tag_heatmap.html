<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ğŸ”¥ ã‚¿ã‚°åˆ¥æˆ¦ç•¥æŒ‡æ¨™ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f4f4f4;
      padding: 2rem;
    }
    h1 {
      margin-bottom: 1.5rem;
      color: #222;
    }
    canvas {
      max-width: 1000px;
      margin: 2rem auto;
      display: block;
    }
    a {
      display: inline-block;
      margin-top: 2rem;
      text-decoration: none;
      color: #007acc;
    }
  </style>
</head>
<body>
  <h1>ğŸ”¥ ã‚¿ã‚°åˆ¥æˆ¦ç•¥æŒ‡æ¨™ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</h1>

  <canvas id="heatmapCanvas"></canvas>

  <script>
    const stats = {{ tag_stats | tojson }};
    const tags = stats.map(s => s.type);
    const metrics = ["win_rate", "max_drawdown", "num_trades"];
    const displayLabels = {
      win_rate: "å‹ç‡ï¼ˆ%ï¼‰",
      max_drawdown: "æœ€å¤§DDï¼ˆ%ï¼‰",
      num_trades: "å–å¼•æ•°"
    };

    // ğŸŸ© ã‚«ãƒ©ãƒ¼å¼·èª¿ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå‹ç‡ã¯ç·‘ã€é«˜DDã¯èµ¤ã€å–å¼•æ•°ã¯é’å¯„ã‚Šï¼‰
    function getColor(metric, value) {
      if (metric === "win_rate") {
        const hue = Math.min(120, value * 1.2);  // ç·‘ç³»
        return `hsl(${hue}, 70%, 75%)`;
      }
      if (metric === "max_drawdown") {
        const hue = 0;  // èµ¤å›ºå®š
        const lightness = 95 - Math.min(80, value * 1.5);  // DDãŒé«˜ã„ã»ã©æ¿ƒã
        return `hsl(${hue}, 70%, ${lightness}%)`;
      }
      if (metric === "num_trades") {
        const hue = 210;  // é’ç³»
        const lightness = 95 - Math.min(70, value / 3);  // å¤šã„ã»ã©æ¿ƒã
        return `hsl(${hue}, 60%, ${lightness}%)`;
      }
      return "#ccc";
    }

    const datasets = metrics.map(metric => ({
      label: displayLabels[metric],
      data: stats.map(s => s[metric] || 0),
      backgroundColor: stats.map(s => getColor(metric, s[metric] || 0)),
      datalabels: {
        color: "#000",
        anchor: "center",
        align: "center",
        formatter: (v) => {
          if (v == null) return "â€•";
          return metric === "num_trades" ? `${v}` : `${v.toFixed(2)}`;
        }
      }
    }));

    const data = {
      labels: tags,
      datasets: datasets
    };

    // âœ… Chart.js ç™»éŒ²ï¼ˆDatalabelsãƒ—ãƒ©ã‚°ã‚¤ãƒ³æ˜ç¤ºï¼‰
    Chart.register(ChartDataLabels);

    new Chart(document.getElementById("heatmapCanvas"), {
      type: "bar",
      data: data,
      options: {
        responsive: true,
        indexAxis: 'y',
        plugins: {
          title: {
            display: true,
            text: "ã‚¿ã‚° Ã— æŒ‡æ¨™ ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—",
            font: { size: 18 }
          },
          legend: {
            position: 'top'
          },
          datalabels: {
            clamp: true
          }
        },
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              stepSize: 10
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  </script>

  <p><a href="/dashboard">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸æˆ»ã‚‹</a></p>
</body>
</html>
