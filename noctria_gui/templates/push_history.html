#!/usr/bin/env python3
# coding: utf-8

"""
ðŸ“œ Veritasæˆ¦ç•¥ã®Pushè¨˜éŒ²ãƒ«ãƒ¼ãƒˆ
- Pushå±¥æ­´ã®æ¤œç´¢ãƒ»ã‚½ãƒ¼ãƒˆãƒ»ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ»CSVå‡ºåŠ›ãƒ»è©³ç´°è¡¨ç¤ºã‚’æä¾›
"""

from fastapi import APIRouter, Request, Query, HTTPException
from fastapi.responses import HTMLResponse, StreamingResponse
from fastapi.templating import Jinja2Templates
from pathlib import Path
from datetime import datetime
import json
import csv
import io

from core.path_config import PUSH_LOG_DIR, GUI_TEMPLATES_DIR

router = APIRouter()
templates = Jinja2Templates(directory=str(GUI_TEMPLATES_DIR))

# è¨­å®šï¼š1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®ä»¶æ•°
PAGE_SIZE = 25


@router.get("/push-history", response_class=HTMLResponse)
def view_push_history(
    request: Request,
    strategy: str = Query(None),
    tag: str = Query(None),
    start_date: str = Query(None),
    end_date: str = Query(None),
    sort: str = Query("desc"),
    page: int = Query(1)
):
    """
    ðŸ“œ Pushå±¥æ­´ã‚’ä¸€è¦§è¡¨ç¤ºï¼ˆæ¤œç´¢ãƒ»ã‚½ãƒ¼ãƒˆãƒ»ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
    """
    logs = []
    if not PUSH_LOG_DIR.exists():
        PUSH_LOG_DIR.mkdir(parents=True)

    for file in sorted(PUSH_LOG_DIR.glob("*.json")):
        with open(file, "r", encoding="utf-8") as f:
            try:
                log = json.load(f)
                logs.append(log)
            except Exception as e:
                print(f"[PushHistory] âš ï¸ èª­ã¿è¾¼ã¿å¤±æ•—: {file.name} - {e}")

    # ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†
    if strategy:
        logs = [log for log in logs if strategy.lower() in log.get("strategy", "").lower()]
    if tag:
        logs = [log for log in logs if tag.lower() in log.get("tag", "").lower()]
    if start_date:
        logs = [log for log in logs if log.get("timestamp") and log["timestamp"] >= start_date]
    if end_date:
        logs = [log for log in logs if log.get("timestamp") and log["timestamp"] <= end_date]

    # ã‚½ãƒ¼ãƒˆ
    logs.sort(key=lambda x: x.get("timestamp", ""), reverse=(sort == "desc"))

    # ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
    total_count = len(logs)
    total_pages = (total_count + PAGE_SIZE - 1) // PAGE_SIZE
    current_page = max(1, min(page, total_pages))
    start = (current_page - 1) * PAGE_SIZE
    end = start + PAGE_SIZE
    logs_page = logs[start:end]

    return templates.TemplateResponse("push_history.html", {
        "request": request,
        "logs": logs_page,
        "total_count": total_count,
        "total_pages": total_pages,
        "current_page": current_page,
        "filters": {
            "strategy": strategy or "",
            "tag": tag or "",
            "start_date": start_date or "",
            "end_date": end_date or "",
            "sort": sort
        }
    })


@router.get("/push-history/export")
def export_push_history_csv(
    strategy: str = Query(None),
    tag: str = Query(None),
    start_date: str = Query(None),
    end_date: str = Query(None),
):
    """
    ðŸ“¤ Pushå±¥æ­´ã‚’CSVå‡ºåŠ›ï¼ˆãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶åæ˜ ï¼‰
    """
    logs = []
    for file in sorted(PUSH_LOG_DIR.glob("*.json")):
        with open(file, "r", encoding="utf-8") as f:
            try:
                log = json.load(f)
                logs.append(log)
            except Exception:
                continue

    # ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†ï¼ˆact-historyã¨åŒæ§˜ï¼‰
    if strategy:
        logs = [log for log in logs if strategy.lower() in log.get("strategy", "").lower()]
    if tag:
        logs = [log for log in logs if tag.lower() in log.get("tag", "").lower()]
    if start_date:
        logs = [log for log in logs if log.get("timestamp") and log["timestamp"] >= start_date]
    if end_date:
        logs = [log for log in logs if log.get("timestamp") and log["timestamp"] <= end_date]

    fieldnames = ["timestamp", "strategy", "tag", "message", "pushed_by", "signature"]
    output = io.StringIO()
    writer = csv.DictWriter(output, fieldnames=fieldnames)
    writer.writeheader()

    for log in logs:
        writer.writerow({
            "timestamp": log.get("timestamp", ""),
            "strategy": log.get("strategy", ""),
            "tag": log.get("tag", ""),
            "message": log.get("message", ""),
            "pushed_by": log.get("pushed_by", ""),
            "signature": log.get("signature", "")
        })

    output.seek(0)
    filename = f"push_history_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
    return StreamingResponse(output, media_type="text/csv", headers={
        "Content-Disposition": f"attachment; filename={filename}"
    })


@router.get("/push-history/detail", response_class=HTMLResponse)
def push_history_detail(request: Request, timestamp: str):
    """
    ðŸ” æŒ‡å®šPushãƒ­ã‚°ã®è©³ç´°è¡¨ç¤º
    """
    log_path = PUSH_LOG_DIR / f"{timestamp}.json"
    if not log_path.exists():
        raise HTTPException(status_code=404, detail="Log not found")

    with open(log_path, "r", encoding="utf-8") as f:
        log = json.load(f)

    return templates.TemplateResponse("push_history_detail.html", {
        "request": request,
        "log": log
    })
