#!/usr/bin/env python3
# coding: utf-8

"""
📜 Veritas戦略のPush記録ルート
- Push履歴の検索・ソート・ページネーション・CSV出力・詳細表示を提供
"""

from fastapi import APIRouter, Request, Query, HTTPException
from fastapi.responses import HTMLResponse, StreamingResponse
from fastapi.templating import Jinja2Templates
from pathlib import Path
from datetime import datetime
import json
import csv
import io

from core.path_config import PUSH_LOG_DIR, GUI_TEMPLATES_DIR

router = APIRouter()
templates = Jinja2Templates(directory=str(GUI_TEMPLATES_DIR))

# 設定：1ページあたりの件数
PAGE_SIZE = 25


@router.get("/push-history", response_class=HTMLResponse)
def view_push_history(
    request: Request,
    strategy: str = Query(None),
    tag: str = Query(None),
    start_date: str = Query(None),
    end_date: str = Query(None),
    sort: str = Query("desc"),
    page: int = Query(1)
):
    """
    📜 Push履歴を一覧表示（検索・ソート・ページネーション対応）
    """
    logs = []
    if not PUSH_LOG_DIR.exists():
        PUSH_LOG_DIR.mkdir(parents=True)

    for file in sorted(PUSH_LOG_DIR.glob("*.json")):
        with open(file, "r", encoding="utf-8") as f:
            try:
                log = json.load(f)
                logs.append(log)
            except Exception as e:
                print(f"[PushHistory] ⚠️ 読み込み失敗: {file.name} - {e}")

    # フィルター処理
    if strategy:
        logs = [log for log in logs if strategy.lower() in log.get("strategy", "").lower()]
    if tag:
        logs = [log for log in logs if tag.lower() in log.get("tag", "").lower()]
    if start_date:
        logs = [log for log in logs if log.get("timestamp") and log["timestamp"] >= start_date]
    if end_date:
        logs = [log for log in logs if log.get("timestamp") and log["timestamp"] <= end_date]

    # ソート
    logs.sort(key=lambda x: x.get("timestamp", ""), reverse=(sort == "desc"))

    # ページネーション
    total_count = len(logs)
    total_pages = (total_count + PAGE_SIZE - 1) // PAGE_SIZE
    current_page = max(1, min(page, total_pages))
    start = (current_page - 1) * PAGE_SIZE
    end = start + PAGE_SIZE
    logs_page = logs[start:end]

    return templates.TemplateResponse("push_history.html", {
        "request": request,
        "logs": logs_page,
        "total_count": total_count,
        "total_pages": total_pages,
        "current_page": current_page,
        "filters": {
            "strategy": strategy or "",
            "tag": tag or "",
            "start_date": start_date or "",
            "end_date": end_date or "",
            "sort": sort
        }
    })


@router.get("/push-history/export")
def export_push_history_csv(
    strategy: str = Query(None),
    tag: str = Query(None),
    start_date: str = Query(None),
    end_date: str = Query(None),
):
    """
    📤 Push履歴をCSV出力（フィルタ条件反映）
    """
    logs = []
    for file in sorted(PUSH_LOG_DIR.glob("*.json")):
        with open(file, "r", encoding="utf-8") as f:
            try:
                log = json.load(f)
                logs.append(log)
            except Exception:
                continue

    # フィルター処理（act-historyと同様）
    if strategy:
        logs = [log for log in logs if strategy.lower() in log.get("strategy", "").lower()]
    if tag:
        logs = [log for log in logs if tag.lower() in log.get("tag", "").lower()]
    if start_date:
        logs = [log for log in logs if log.get("timestamp") and log["timestamp"] >= start_date]
    if end_date:
        logs = [log for log in logs if log.get("timestamp") and log["timestamp"] <= end_date]

    fieldnames = ["timestamp", "strategy", "tag", "message", "pushed_by", "signature"]
    output = io.StringIO()
    writer = csv.DictWriter(output, fieldnames=fieldnames)
    writer.writeheader()

    for log in logs:
        writer.writerow({
            "timestamp": log.get("timestamp", ""),
            "strategy": log.get("strategy", ""),
            "tag": log.get("tag", ""),
            "message": log.get("message", ""),
            "pushed_by": log.get("pushed_by", ""),
            "signature": log.get("signature", "")
        })

    output.seek(0)
    filename = f"push_history_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
    return StreamingResponse(output, media_type="text/csv", headers={
        "Content-Disposition": f"attachment; filename={filename}"
    })


@router.get("/push-history/detail", response_class=HTMLResponse)
def push_history_detail(request: Request, timestamp: str):
    """
    🔍 指定Pushログの詳細表示
    """
    log_path = PUSH_LOG_DIR / f"{timestamp}.json"
    if not log_path.exists():
        raise HTTPException(status_code=404, detail="Log not found")

    with open(log_path, "r", encoding="utf-8") as f:
        log = json.load(f)

    return templates.TemplateResponse("push_history_detail.html", {
        "request": request,
        "log": log
    })
