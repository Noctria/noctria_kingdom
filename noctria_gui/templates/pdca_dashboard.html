{% extends "base_hud.html" %}

{% block title %}ğŸ“œ PDCA å®Ÿè¡Œå±¥æ­´ - Noctria Kingdom{% endblock %}
{% block header_icon %}<i class="fas fa-clipboard-list"></i>{% endblock %}
{% block header_title %}PDCA å®Ÿè¡Œå±¥æ­´{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}DASHBOARD{% endblock %}

{% block content %}

<!-- âœ… å†è©•ä¾¡çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
{% if recheck_success is not none or recheck_fail is not none %}
  <div class="hud-panel" style="border: 1px solid #00cc66; background: #e6ffe6; color: #003300; margin-bottom: 1rem;">
    âœ… ä¸€æ‹¬å†è©•ä¾¡ å®Ÿè¡Œçµæœï¼š
    {% if recheck_success %} ğŸ¯ æˆåŠŸ {{ recheck_success }}ä»¶ {% endif %}
    {% if recheck_fail %} âŒ å¤±æ•— {{ recheck_fail }}ä»¶ {% endif %}
  </div>
{% endif %}

<!-- ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ UI -->
<form class="hud-form" method="get" action="/pdca">
  <input type="text" name="strategy" placeholder="æˆ¦ç•¥å" value="{{ filters.strategy or '' }}">
  <input type="text" name="symbol" placeholder="é€šè²¨ (ä¾‹: USDJPY)" value="{{ filters.symbol or '' }}">
  <select name="signal">
    <option value="">ã‚·ã‚°ãƒŠãƒ«</option>
    <option value="BUY" {% if filters.signal == 'BUY' %}selected{% endif %}>BUY</option>
    <option value="SELL" {% if filters.signal == 'SELL' %}selected{% endif %}>SELL</option>
  </select>
  <select name="tag">
    <option value="">ã‚¿ã‚°</option>
    {% for t in available_tags %}
      <option value="{{ t }}" {% if filters.tag == t %}selected{% endif %}>ğŸ·ï¸ {{ t }}</option>
    {% endfor %}
  </select>
  <input type="date" name="date_from" value="{{ filters.date_from or '' }}">
  <input type="date" name="date_to" value="{{ filters.date_to or '' }}">
  <select name="sort">
    <option value="">ã‚½ãƒ¼ãƒˆãªã—</option>
    <option value="win_rate" {% if sort == 'win_rate' %}selected{% endif %}>ğŸ“ˆ å‹ç‡ æ˜‡é †</option>
    <option value="-win_rate" {% if sort == '-win_rate' %}selected{% endif %}>ğŸ“ˆ å‹ç‡ é™é †</option>
    <option value="max_dd" {% if sort == 'max_dd' %}selected{% endif %}>ğŸ“‰ DD æ˜‡é †</option>
    <option value="-max_dd" {% if sort == '-max_dd' %}selected{% endif %}>ğŸ“‰ DD é™é †</option>
    <option value="trades" {% if sort == 'trades' %}selected{% endif %}>ğŸ” å›æ•° æ˜‡é †</option>
    <option value="-trades" {% if sort == '-trades' %}selected{% endif %}>ğŸ” å›æ•° é™é †</option>
    <option value="timestamp_dt" {% if sort == 'timestamp_dt' %}selected{% endif %}>ğŸ“… æ™‚åˆ» æ˜‡é †</option>
    <option value="-timestamp_dt" {% if sort == '-timestamp_dt' %}selected{% endif %}>ğŸ“… æ™‚åˆ» é™é †</option>
  </select>
  <button type="submit" class="hud-btn"><i class="fas fa-search"></i> æ¤œç´¢</button>
</form>

<!-- ğŸ” ä¸€æ‹¬å†è©•ä¾¡ -->
<form method="post" action="/pdca/recheck_all" style="margin: 1rem 0;">
  <button class="hud-btn" type="submit" onclick="return confirm('âš ï¸ å…¨æˆ¦ç•¥ã‚’ä¸€æ‹¬ã§å†è©•ä¾¡ã—ã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ');">
    ğŸ” ä¸€æ‹¬å†è©•ä¾¡ï¼ˆå…¨ Veritas æˆ¦ç•¥ï¼‰
  </button>
</form>

<!-- ğŸ“‹ å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« -->
<div class="hud-panel table-wrapper">
  <table class="hud-table">
    <thead>
      <tr>
        <th>ğŸ“… æ™‚åˆ»</th>
        <th>ğŸ§  æˆ¦ç•¥</th>
        <th>ğŸ·ï¸ ã‚¿ã‚°</th>
        <th>ğŸ’¡ ã‚·ã‚°ãƒŠãƒ«</th>
        <th>ğŸ’± é€šè²¨</th>
        <th>ğŸ¯ ãƒ­ãƒƒãƒˆ</th>
        <th>ğŸ¯ TP/SL</th>
        <th>ğŸ“ˆ å‹ç‡</th>
        <th>ğŸ“‰ DD</th>
        <th>ğŸ” å›æ•°</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      {% for log in logs %}
      <tr>
        <td>{{ log.timestamp }}</td>
        <td>{{ log.strategy }}</td>
        <td>{{ log.tags | join(", ") }}</td>
        <td>{{ log.signal }}</td>
        <td>{{ log.symbol }}</td>
        <td>{{ log.lot }}</td>
        <td>{{ log.tp }}/{{ log.sl }}</td>
        <td>
          {% if log.win_rate is defined and log.win_rate is not none %}
            {{ '%.1f' | format(log.win_rate * 100) }}%
          {% else %}-{% endif %}
        </td>
        <td>
          {% if log.max_dd is defined and log.max_dd is not none %}
            {{ '%.1f' | format(log.max_dd * 100) }}%
          {% else %}-{% endif %}
        </td>
        <td>{{ log.trades or "-" }}</td>
        <td>
          <button class="hud-btn-small" onclick="showModal('modal_{{ loop.index }}')">è©³ç´°</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ğŸ” ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ­ã‚°è¡¨ç¤º -->
{% for log in logs %}
<dialog id="modal_{{ loop.index }}" class="hud-modal">
  <h3>ğŸ“„ è©³ç´°ãƒ­ã‚°ï¼ˆ{{ log.filename }})</h3>
  <pre class="hud-log">{{ log.json_text }}</pre>
  <form method="post" action="/pdca/replay">
    <input type="hidden" name="log_path" value="{{ log.path }}">
    <button class="hud-btn" type="submit">ã“ã®å‘½ä»¤ã§å†å®Ÿè¡Œ</button>
  </form>
  <button class="hud-btn" onclick="closeModal('modal_{{ loop.index }}')">é–‰ã˜ã‚‹</button>
</dialog>
{% endfor %}

<script>
  function showModal(id) {
    const el = document.getElementById(id);
    if (el) el.showModal();
  }
  function closeModal(id) {
    const el = document.getElementById(id);
    if (el) el.close();
  }
</script>

{% endblock %}
