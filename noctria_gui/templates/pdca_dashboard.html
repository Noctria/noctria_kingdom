{% extends "base_layout.html" %}

{% block content %}
<h1>ğŸ“œ PDCA å®Ÿè¡Œå±¥æ­´ï¼ˆVeritas Kingdomï¼‰</h1>

<!-- ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼UI -->
<form class="filter-form" method="get" action="/pdca">
  <input type="text" name="strategy" placeholder="æˆ¦ç•¥å" value="{{ filters.strategy or '' }}">
  <input type="text" name="symbol" placeholder="é€šè²¨ (ä¾‹: USDJPY)" value="{{ filters.symbol or '' }}">
  <select name="signal">
    <option value="">ã‚·ã‚°ãƒŠãƒ«</option>
    <option value="BUY" {% if filters.signal == 'BUY' %}selected{% endif %}>BUY</option>
    <option value="SELL" {% if filters.signal == 'SELL' %}selected{% endif %}>SELL</option>
  </select>
  <select name="tag">
    <option value="">ã‚¿ã‚°</option>
    {% for t in available_tags %}
      <option value="{{ t }}" {% if filters.tag == t %}selected{% endif %}>ğŸ·ï¸ {{ t }}</option>
    {% endfor %}
  </select>
  <input type="date" name="date_from" value="{{ filters.date_from or '' }}">
  <input type="date" name="date_to" value="{{ filters.date_to or '' }}">
  <select name="sort">
    <option value="">ã‚½ãƒ¼ãƒˆãªã—</option>
    <option value="win_rate" {% if sort == 'win_rate' %}selected{% endif %}>ğŸ“ˆ å‹ç‡ æ˜‡é †</option>
    <option value="-win_rate" {% if sort == '-win_rate' %}selected{% endif %}>ğŸ“ˆ å‹ç‡ é™é †</option>
    <option value="max_dd" {% if sort == 'max_dd' %}selected{% endif %}>ğŸ“‰ DD æ˜‡é †</option>
    <option value="-max_dd" {% if sort == '-max_dd' %}selected{% endif %}>ğŸ“‰ DD é™é †</option>
    <option value="trades" {% if sort == 'trades' %}selected{% endif %}>ğŸ” å›æ•° æ˜‡é †</option>
    <option value="-trades" {% if sort == '-trades' %}selected{% endif %}>ğŸ” å›æ•° é™é †</option>
    <option value="timestamp_dt" {% if sort == 'timestamp_dt' %}selected{% endif %}>ğŸ“… æ™‚åˆ» æ˜‡é †</option>
    <option value="-timestamp_dt" {% if sort == '-timestamp_dt' %}selected{% endif %}>ğŸ“… æ™‚åˆ» é™é †</option>
  </select>
  <button type="submit">æ¤œç´¢</button>
</form>

<table>
  <thead>
    <tr>
      <th>ğŸ“… æ™‚åˆ»</th>
      <th>ğŸ§  æˆ¦ç•¥</th>
      <th>ğŸ·ï¸ ã‚¿ã‚°</th>
      <th>ğŸ’¡ ã‚·ã‚°ãƒŠãƒ«</th>
      <th>ğŸ’± é€šè²¨</th>
      <th>ğŸ¯ ãƒ­ãƒƒãƒˆ</th>
      <th>ğŸ¯ TP/SL</th>
      <th>ğŸ“ˆ å‹ç‡</th>
      <th>ğŸ“‰ DD</th>
      <th>ğŸ” å›æ•°</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody>
    {% for log in logs %}
    <tr>
      <td>{{ log.timestamp }}</td>
      <td>{{ log.strategy }}</td>
      <td>{{ log.tags | join(", ") }}</td>
      <td>{{ log.signal }}</td>
      <td>{{ log.symbol }}</td>
      <td>{{ log.lot }}</td>
      <td>{{ log.tp }}/{{ log.sl }}</td>
      <td>
        {% if log.win_rate is defined and log.win_rate is not none %}
          {{ '%.1f' | format(log.win_rate * 100) }}%
        {% else %}-{% endif %}
      </td>
      <td>
        {% if log.max_dd is defined and log.max_dd is not none %}
          {{ '%.1f' | format(log.max_dd * 100) }}%
        {% else %}-{% endif %}
      </td>
      <td>{{ log.trades or "-" }}</td>
      <td>
        <button onclick="showModal('modal_{{ loop.index }}')">è©³ç´°</button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<!-- ğŸ” ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ -->
{% for log in logs %}
<dialog id="modal_{{ loop.index }}">
  <h3>ğŸ“„ è©³ç´°ãƒ­ã‚°ï¼ˆ{{ log.filename }})</h3>
  <pre>{{ log.json_text }}</pre>
  <form method="post" action="/pdca/replay">
    <input type="hidden" name="log_path" value="{{ log.path }}">
    <button type="submit">ã“ã®å‘½ä»¤ã§å†å®Ÿè¡Œ</button>
  </form>
  <button onclick="closeModal('modal_{{ loop.index }}')">é–‰ã˜ã‚‹</button>
</dialog>
{% endfor %}

<script>
  function showModal(id) {
    const el = document.getElementById(id);
    if (el) el.showModal();
  }
  function closeModal(id) {
    const el = document.getElementById(id);
    if (el) el.close();
  }
</script>
{% endblock %}
