{% extends "base_hud.html" %}

{% block title %}📑 比較条件選択{% endblock %}

{% block header_icon %}<i class="fas fa-sliders-h"></i>{% endblock %}
{% block header_title %}比較条件の選択{% endblock %}
{% block header_nav %}
<a href="/dashboard" class="nav-item-back">
  <i class="fas fa-chart-line"></i><span>ダッシュボードへ</span>
</a>
{% endblock %}

{% block content %}
  <!-- ✅ 修正: onsubmit属性を削除 -->
  <form id="compareForm" method="get" action="/strategies/compare">
    <input type="hidden" name="mode" value="{{ mode }}">
    <input type="hidden" name="sort" value="check">
    <input type="hidden" id="keys" name="{{ mode }}s" value="">

    <div id="options" class="table-wrapper" style="max-height: 60vh; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem;">
      {% for k in all_keys %}
        <label class="strategy-item-checkbox">
          <input type="checkbox" value="{{ k }}">
          <span class="custom-checkbox"></span>
          <span style="margin-left: 0.5rem;">{{ k }}</span>
        </label>
      {% endfor %}
    </div>

    <div style="margin-top: 2rem;">
      <button type="submit" class="hud-btn">📈 比較する</button>
    </div>
  </form>
{% endblock %}

{% block scripts %}
<!-- ✅ 修正: よりモダンで確実なaddEventListener方式に変更 -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const compareForm = document.getElementById('compareForm');
  
  if (compareForm) {
    compareForm.addEventListener('submit', (event) => {
      // フォームが送信される直前に、チェックされた項目の値を取得する
      const checkedBoxes = document.querySelectorAll('#options input[type=checkbox]:checked');
      
      // 取得した値をカンマ区切りの文字列に変換
      const selectedValues = Array.from(checkedBoxes).map(box => box.value);
      
      // 隠しフィールド（id="keys"）に値を設定
      const keysInput = document.getElementById('keys');
      if (keysInput) {
        keysInput.value = selectedValues.join(',');
      }
      
      // この後、フォームは通常通り送信される
    });
  }

  // 「ダッシュボードへ」のBackボタンは、特別なJavaScriptがなくても
  // <a>タグのhref属性によって正常に動作するはずです。
  // もし動作しない場合、他のJavaScriptエラーが影響していることが多いですが、
  // 上記の修正でその問題も解消される可能性があります。
});
</script>
{% endblock %}
```

### 修正点の解説

* **HTMLの修正:**
    * `<form>`タグから`onsubmit="return setKeys()"`という属性を削除し、代わりに`id="compareForm"`を追加して、JavaScriptからフォームを特定しやすくしました。
* **JavaScriptの修正:**
    * 古い`setKeys`関数を削除し、`DOMContentLoaded`（ページの読み込み完了後）のタイミングで処理を開始するようにしました。
    * `compareForm`の`submit`イベント（送信ボタンが押された時）を監視し、イベントが発生したらチェックボックスの値をまとめて隠しフィールドに設定する、というロジックに変更しました。

この修正により、ボタンが正しく反応するようになるはずです。サービスを再起動して、動作を確認してみてくだ
