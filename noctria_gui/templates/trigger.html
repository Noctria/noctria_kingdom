{% extends "base_hud.html" %}

{% block title %}ğŸ“¯ King's Decree - Noctria Kingdom HUD{% endblock %}

{% block header_icon %}<i class="fas fa-bullhorn"></i>{% endblock %}
{% block header_title %}KING'S DECREE{% endblock %}
{% block header_nav %}
<a href="/dashboard" class="nav-item-back">
  <i class="fas fa-tachometer-alt"></i><span>DASHBOARD</span>
</a>
{% endblock %}

{% block content %}
<section class="hud-panel">
  <h2 class="panel-title"><i class="fas fa-gavel"></i> ISSUE A ROYAL COMMAND (INITIATE PDCA)</h2>
  <p class="panel-description">
    ã“ã“ã§ç‹å‘½ã‚’ç™ºä»¤ã™ã‚‹ã¨ã€ç‹å›½ã®ä¸­æ¢ã§ã‚ã‚‹PDCAæœ€é©åŒ–ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆAirflow DAGï¼‰ãŒæ‰‹å‹•ã§èµ·å‹•ã•ã‚Œã¾ã™ã€‚
  </p>
  <form id="triggerForm" class="filter-form" style="gap: 1rem;">
    <label for="dag_id" class="hud-label">
      ğŸ—‚ï¸ DAGã‚’é¸æŠ:
    </label>
    <select id="dag_id" name="dag_id" class="hud-input" required>
      {% if dag_list %}
        {% for dag in dag_list %}
          <option value="{{ dag }}">{{ dag }}</option>
        {% endfor %}
      {% else %}
        <option value="">-- DAGãŒå–å¾—ã§ãã¾ã›ã‚“ --</option>
      {% endif %}
    </select>
    <label for="manual_reason" class="hud-label">
      ğŸ“œ REASON FOR DECREE:
    </label>
    <input type="text" id="manual_reason" name="manual_reason" value="GUIã‹ã‚‰ã®æ‰‹å‹•å®Ÿè¡Œå‘½ä»¤" required
           class="hud-input" />
    <button type="submit" id="submitBtn" class="hud-btn" aria-label="ç™ºä»¤ã™ã‚‹">
      <i class="fas fa-play-circle"></i> ç™ºä»¤ã™ã‚‹
    </button>
  </form>
</section>

<section id="resultPanel" class="hud-panel" style="margin-top: 1.5rem; display: none;">
  <h2 class="panel-title"><i class="fas fa-scroll"></i> EXECUTION RESULT</h2>
  <div id="resultContent" class="result-content"
       style="white-space: pre-wrap; background: rgba(0,0,0,0.2); border: 1px solid var(--panel-border);
              padding: 1rem; border-radius: 4px; font-family: var(--font-mono); color: var(--text-color-base);">
    <!-- çµæœã¯ã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const triggerForm = document.getElementById('triggerForm');
  const submitBtn = document.getElementById('submitBtn');
  const resultPanel = document.getElementById('resultPanel');
  const resultContent = document.getElementById('resultContent');
  const reasonInput = document.getElementById('manual_reason');
  const dagSelect = document.getElementById('dag_id');

  if (triggerForm) {
    triggerForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã€ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã«å¤‰æ›´
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç™ºä»¤ä¸­...';
      resultPanel.style.display = 'none';

      try {
        const response = await fetch('/trigger', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å½¢å¼ã§é€ä¿¡
          body: new URLSearchParams({
            'dag_id': dagSelect.value,
            'manual_reason': reasonInput.value
          })
        });

        const data = await response.json();

        // çµæœã‚’è¡¨ç¤º
        resultPanel.style.display = 'block';
        if (response.ok) {
          resultContent.style.color = 'var(--cyan)';
          resultContent.textContent = JSON.stringify(data, null, 2);
        } else {
          resultContent.style.color = 'var(--magenta)';
          resultContent.textContent = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (HTTP ${response.status}):\n${JSON.stringify(data, null, 2)}`;
        }

      } catch (error) {
        resultPanel.style.display = 'block';
        resultContent.style.color = 'var(--magenta)';
        resultContent.textContent = `é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
        console.error('Trigger Error:', error);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-play-circle"></i> ç™ºä»¤ã™ã‚‹';
      }
    });
  }
});
</script>
{% endblock %}
