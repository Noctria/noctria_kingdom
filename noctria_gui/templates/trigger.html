{% extends "base_hud.html" %}

{% block title %}📯 King's Decree - Noctria Kingdom HUD{% endblock %}

{% block header_icon %}<i class="fas fa-bullhorn"></i>{% endblock %}
{% block header_title %}KING'S DECREE{% endblock %}
{% block header_nav %}
<a href="/dashboard" class="nav-item-back">
  <i class="fas fa-tachometer-alt"></i><span>DASHBOARD</span>
</a>
{% endblock %}

{% block content %}
<section class="hud-panel">
  <h2 class="panel-title"><i class="fas fa-gavel"></i> ISSUE A ROYAL COMMAND (INITIATE PDCA)</h2>
  <p class="panel-description">
    ここで王命を発令すると、王国の中枢であるPDCA最適化プロセス（Airflow DAG）が手動で起動されます。
  </p>
  <form id="triggerForm" class="filter-form" style="gap: 1rem;">
    <label for="dag_id" class="hud-label">
      🗂️ DAGを選択:
    </label>
    <select id="dag_id" name="dag_id" class="hud-input" required>
      {% if dag_list %}
        {% for dag in dag_list %}
          <option value="{{ dag }}">{{ dag }}</option>
        {% endfor %}
      {% else %}
        <option value="">-- DAGが取得できません --</option>
      {% endif %}
    </select>
    <label for="manual_reason" class="hud-label">
      📜 REASON FOR DECREE:
    </label>
    <input type="text" id="manual_reason" name="manual_reason" value="GUIからの手動実行命令" required
           class="hud-input" />
    <button type="submit" id="submitBtn" class="hud-btn" aria-label="発令する">
      <i class="fas fa-play-circle"></i> 発令する
    </button>
  </form>
</section>

<section id="resultPanel" class="hud-panel" style="margin-top: 1.5rem; display: none;">
  <h2 class="panel-title"><i class="fas fa-scroll"></i> EXECUTION RESULT</h2>
  <div id="resultContent" class="result-content"
       style="white-space: pre-wrap; background: rgba(0,0,0,0.2); border: 1px solid var(--panel-border);
              padding: 1rem; border-radius: 4px; font-family: var(--font-mono); color: var(--text-color-base);">
    <!-- 結果はここに動的に挿入されます -->
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const triggerForm = document.getElementById('triggerForm');
  const submitBtn = document.getElementById('submitBtn');
  const resultPanel = document.getElementById('resultPanel');
  const resultContent = document.getElementById('resultContent');
  const reasonInput = document.getElementById('manual_reason');
  const dagSelect = document.getElementById('dag_id');

  if (triggerForm) {
    triggerForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      // ボタンを無効化し、ローディング表示に変更
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 発令中...';
      resultPanel.style.display = 'none';

      try {
        const response = await fetch('/trigger', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          // フォームデータをURLエンコード形式で送信
          body: new URLSearchParams({
            'dag_id': dagSelect.value,
            'manual_reason': reasonInput.value
          })
        });

        const data = await response.json();

        // 結果を表示
        resultPanel.style.display = 'block';
        if (response.ok) {
          resultContent.style.color = 'var(--cyan)';
          resultContent.textContent = JSON.stringify(data, null, 2);
        } else {
          resultContent.style.color = 'var(--magenta)';
          resultContent.textContent = `エラーが発生しました (HTTP ${response.status}):\n${JSON.stringify(data, null, 2)}`;
        }

      } catch (error) {
        resultPanel.style.display = 'block';
        resultContent.style.color = 'var(--magenta)';
        resultContent.textContent = `通信エラーが発生しました: ${error.message}`;
        console.error('Trigger Error:', error);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-play-circle"></i> 発令する';
      }
    });
  }
});
</script>
{% endblock %}
