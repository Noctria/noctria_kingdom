<!-- noctria_gui/templates/obs_latency.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Noctria Observability â€” Latency</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0a0f2c" />
  <link rel="stylesheet" href="/static/hud_style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header class="header">
    <a class="nav-item-back" href="/dashboard" aria-label="Back to dashboard">â† Dashboard</a>
    <div class="hud-title"><i>â±ï¸</i><span>Observability: PLAN â†’ INFER â†’ DECISION Latency</span></div>
    <div class="right">
      <!-- âœ… url_for ã¯ request.url_for('é–¢æ•°å') ã‚’ä½¿ã† -->
      <a class="hud-button hud-button--ghost" href="{{ request.url_for('latency_dashboard') }}">ã“ã®ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°</a>
    </div>
  </header>

  <main class="hud-container-simple">
    <!-- ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ« ãƒãƒ£ãƒ¼ãƒˆ -->
    <section class="hud-panel">
      <div class="panel-title">æ—¥æ¬¡ãƒ‘ãƒ¼ã‚»ãƒ³ã‚¿ã‚¤ãƒ«ï¼ˆp50 / p90 / p99ï¼‰</div>
      <div class="chart-card">
        <canvas id="latencyChart" height="220"></canvas>
      </div>
    </section>

    <!-- æœ€è¿‘ã®ãƒˆãƒ¬ãƒ¼ã‚¹ + è©³ç´° -->
    <section class="grid2">
      <!-- æœ€è¿‘ã®ãƒˆãƒ¬ãƒ¼ã‚¹ -->
      <div class="hud-panel">
        <div class="panel-title">ğŸ§­ æœ€è¿‘ã®ãƒˆãƒ¬ãƒ¼ã‚¹ <span class="text-light small">(ä»¶æ•°: {{ recent|length }})</span></div>
        <div class="table-wrap">
          <table class="hud-table">
            <thead>
              <tr>
                <th style="text-align:left">trace_id</th>
                <th>é–‹å§‹ â†’ çµ‚äº†</th>
                <th>events</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
            {% if recent and recent|length > 0 %}
              {% for r in recent %}
                <tr>
                  <td style="max-width: 420px;">
                    <span class="truncate mono" title="{{ r.trace_id }}">{{ r.trace_id }}</span>
                  </td>
                  <td class="text-muted nowrap">
                    {{ r.started_at }} â†’ {{ r.finished_at }}
                  </td>
                  <td class="nowrap">{{ r.events }}</td>
                  <td class="right">
                    <!-- âœ… ã“ã“ã‚‚ request.url_for ã‚’ä½¿ç”¨ -->
                    <a class="pill" href="{{ request.url_for('latency_dashboard') }}?trace_id={{ r.trace_id }}">è¦‹ã‚‹</a>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="4">
                <div class="text-muted">æœ€è¿‘ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã¯ 0 ä»¶ã§ã™ã€‚</div>
                <div class="skeleton" style="height:1.25rem;"></div>
              </td></tr>
            {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- ãƒˆãƒ¬ãƒ¼ã‚¹è©³ç´° -->
      <div class="hud-panel">
        <div class="panel-title">ğŸ” ãƒˆãƒ¬ãƒ¼ã‚¹è©³ç´°</div>
        {% if not trace_id %}
          <p class="text-muted">å·¦ã®ä¸€è¦§ã‹ã‚‰ <em>è¦‹ã‚‹</em> ã‚’æŠ¼ã™ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        {% else %}
          <div class="stack">
            <div><span class="badge">trace</span> <span class="truncate mono">{{ trace_id }}</span></div>
            {% if infer %}
              <div class="small text-muted">
                <span class="badge badge--ok">INFER</span>
                {{ infer.name }} / {{ infer.dur_ms }} ms / {{ infer.success and "æˆåŠŸ" or "å¤±æ•—" }} @ {{ infer.at }}
              </div>
            {% endif %}
            {% if decision %}
              <div class="small text-muted">
                <span class="badge badge--warn">DECISION</span>
                {{ decision.strategy_name }} (score={{ decision.score }}) @ {{ decision.at }}
              </div>
              <div class="small text-muted">
                action=<span class="mono">{{ decision.action }}</span>,
                params=<span class="mono">{{ decision.params }}</span>
              </div>
            {% endif %}
          </div>

          <div class="hr"></div>

          <div class="table-wrap">
            <table class="hud-table">
              <thead>
                <tr>
                  <th style="text-align:left">at</th>
                  <th>stage</th>
                  <th>name</th>
                  <th style="text-align:left">detail</th>
                </tr>
              </thead>
              <tbody>
              {% if timeline and timeline|length > 0 %}
                {% for ev in timeline %}
                  <tr>
                    <td class="text-muted nowrap" style="text-align:left">{{ ev.at }}</td>
                    <td class="nowrap">{{ ev.stage }}</td>
                    <td class="nowrap">{{ ev.name }}</td>
                    <td class="mono" style="text-align:left">
                      {{ (ev.detail|string)[:2000] }}{% if (ev.detail|string)|length>2000 %}â€¦{% endif %}
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr><td colspan="4"><div class="text-muted">ã“ã®ãƒˆãƒ¬ãƒ¼ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div></td></tr>
              {% endif %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    </section>
  </main>

  <script>
    const CHART_DATA = {{ chart_json|safe }};
    const ctx = document.getElementById('latencyChart').getContext('2d');

    const SLA_MS = 250;

    const data = {
      labels: CHART_DATA.labels,
      datasets: [
        { label: 'p50 (ms)', data: CHART_DATA.p50, borderWidth: 2, tension: .2 },
        { label: 'p90 (ms)', data: CHART_DATA.p90, borderWidth: 2, tension: .2 },
        { label: 'p99 (ms)', data: CHART_DATA.p99, borderWidth: 2, tension: .2 },
        { label: 'SLA', data: CHART_DATA.labels.map(() => SLA_MS), borderWidth: 1, borderDash: [6,4], pointRadius: 0 }
      ]
    };

    new Chart(ctx, {
      type: 'line',
      data,
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        animation: false,
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 12 } },
          y: { beginAtZero: true, ticks: { callback: v => Number(v).toLocaleString() } }
        },
        plugins: { legend: { labels: { boxWidth: 12 } } }
      }
    });
  </script>
</body>
</html>
