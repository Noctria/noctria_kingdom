<!-- noctria_gui/templates/obs_latency.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Noctria Observability ‚Äî Latency</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0a0f2c" />
  <link rel="stylesheet" href="/static/hud_style.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header class="header">
    <a class="nav-item-back" href="/dashboard" aria-label="Back to dashboard">‚Üê Dashboard</a>
    <div class="hud-title"><i>‚è±Ô∏è</i><span>Observability: PLAN ‚Üí INFER ‚Üí DECISION Latency</span></div>
    <div class="right">
      <a class="hud-button hud-button--ghost" href="{{ url_for('observability_latency.latency_dashboard') }}">„Åì„ÅÆ„Éö„Éº„Ç∏„ÇíÊõ¥Êñ∞</a>
    </div>
  </header>

  <main class="hud-container-simple">
    <!-- „Éë„Éº„Çª„É≥„Çø„Ç§„É´ „ÉÅ„É£„Éº„Éà -->
    <section class="hud-panel">
      <div class="panel-title">Êó•Ê¨°„Éë„Éº„Çª„É≥„Çø„Ç§„É´Ôºàp50 / p90 / p99Ôºâ</div>
      <div class="chart-card">
        <canvas id="latencyChart" height="220"></canvas>
      </div>
    </section>

    <!-- ÊúÄËøë„ÅÆ„Éà„É¨„Éº„Çπ + Ë©≥Á¥∞ -->
    <section class="grid2">
      <!-- ÊúÄËøë„ÅÆ„Éà„É¨„Éº„Çπ -->
      <div class="hud-panel">
        <div class="panel-title">üß≠ ÊúÄËøë„ÅÆ„Éà„É¨„Éº„Çπ</div>
        <div class="table-wrap">
          <table class="hud-table">
            <thead>
              <tr>
                <th style="text-align:left">trace_id</th>
                <th>ÈñãÂßã ‚Üí ÁµÇ‰∫Ü</th>
                <th>events</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
            {% for r in recent %}
              <tr>
                <td style="max-width: 420px;">
                  <span class="truncate mono" title="{{ r.trace_id }}">{{ r.trace_id }}</span>
                </td>
                <td class="text-muted nowrap">
                  {{ r.started_at }} ‚Üí {{ r.finished_at }}
                </td>
                <td class="nowrap">{{ r.events }}</td>
                <td class="right">
                  <a class="pill" href="{{ url_for('observability_latency.latency_dashboard') }}?trace_id={{ r.trace_id }}">Ë¶ã„Çã</a>
                </td>
              </tr>
            {% endfor %}
            {% if not recent %}
              <tr><td colspan="4"><div class="skeleton" style="height:1.25rem;"></div></td></tr>
            {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- „Éà„É¨„Éº„ÇπË©≥Á¥∞ -->
      <div class="hud-panel">
        <div class="panel-title">üîé „Éà„É¨„Éº„ÇπË©≥Á¥∞</div>
        {% if not trace_id %}
          <p class="text-muted">Â∑¶„ÅÆ‰∏ÄË¶ß„Åã„Çâ <em>Ë¶ã„Çã</em> „ÇíÊäº„Åô„Å®Ë©≥Á¥∞„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ</p>
        {% else %}
          <div class="stack">
            <div><span class="badge">trace</span> <span class="truncate mono">{{ trace_id }}</span></div>
            {% if infer %}
              <div class="small text-muted">
                <span class="badge badge--ok">INFER</span>
                {{ infer.name }} / {{ infer.dur_ms }} ms / {{ infer.success and "ÊàêÂäü" or "Â§±Êïó" }} @ {{ infer.at }}
              </div>
            {% endif %}
            {% if decision %}
              <div class="small text-muted">
                <span class="badge badge--warn">DECISION</span>
                {{ decision.strategy_name }} (score={{ decision.score }}) @ {{ decision.at }}
              </div>
              <div class="small text-muted">
                action=<span class="mono">{{ decision.action }}</span>,
                params=<span class="mono">{{ decision.params }}</span>
              </div>
            {% endif %}
          </div>

          <div class="hr"></div>

          <div class="table-wrap">
            <table class="hud-table">
              <thead>
                <tr>
                  <th style="text-align:left">at</th>
                  <th>stage</th>
                  <th>name</th>
                  <th style="text-align:left">detail</th>
                </tr>
              </thead>
              <tbody>
              {% for ev in timeline %}
                <tr>
                  <td class="text-muted nowrap" style="text-align:left">{{ ev.at }}</td>
                  <td class="nowrap">{{ ev.stage }}</td>
                  <td class="nowrap">{{ ev.name }}</td>
                  <td class="mono" style="text-align:left">{{ ev.detail }}</td>
                </tr>
              {% endfor %}
              {% if not timeline %}
                <tr><td colspan="4"><div class="skeleton" style="height:1.25rem;"></div></td></tr>
              {% endif %}
              </tbody>
            </table>
          </div>
        {% endif %}
      </div>
    </section>
  </main>

  <script>
    const CHART_DATA = {{ chart_json|safe }};
    const ctx = document.getElementById('latencyChart').getContext('2d');

    const data = {
      labels: CHART_DATA.labels,
      datasets: [
        { label: 'p50 (ms)', data: CHART_DATA.p50, borderWidth: 2, tension: .2 },
        { label: 'p90 (ms)', data: CHART_DATA.p90, borderWidth: 2, tension: .2 },
        { label: 'p99 (ms)', data: CHART_DATA.p99, borderWidth: 2, tension: .2 },
      ]
    };

    new Chart(ctx, {
      type: 'line',
      data,
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        animation: false,
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 12 } },
          y: { beginAtZero: true, ticks: { callback: v => Number(v).toLocaleString() } }
        },
        plugins: { legend: { labels: { boxWidth: 12 } } }
      }
    });
  </script>
</body>
</html>
