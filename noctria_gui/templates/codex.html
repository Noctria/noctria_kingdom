<!-- noctria_gui/templates/codex.html -->
{% extends "base_hud.html" %}

{% block title %}{{ page_title or "ğŸ§ª Codex Mini-Loop" }} - Noctria Kingdom{% endblock %}
{% block header_icon %}<i class="fas fa-vial"></i>{% endblock %}
{% block header_title %}CODEX MINI-LOOP{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}DASHBOARD{% endblock %}

{% block content %}

<!-- Controls -->
<div class="hud-panel">
  <div class="hud-actions">
    <form action="/codex/run" method="post">
      <button class="hud-button" type="submit"><i class="fas fa-play"></i> Run Mini-Loop</button>
    </form>
    <form action="/codex/review" method="post">
      <button class="hud-button hud-button--ghost" type="submit"><i class="fas fa-search"></i> Run Review (Generate MD & .patch)</button>
    </form>
    <span class="text-muted small">pytestã¯æ—¢å®š <code>-q</code>ã€‚è©³ç´°ã¯ <code>codex/mini_loop.py</code> ã‚’å‚ç…§ã€‚</span>
  </div>
</div>

<div class="grid2">

  <!-- ğŸ§ª Pytest Summary -->
  <section class="hud-panel">
    <h3 class="panel-title">ğŸ§ª Pytest Summary</h3>
    {% set s = (pytest_json.get('summary') if pytest_json else {}) or {} %}
    {% set passed = s.get('passed', 0) %}
    {% set total  = (s.get('total') if s.get('total') is not none else s.get('collected', 0)) %}
    {% set failed = (s.get('failed') if s.get('failed') is not none else (total - passed)) %}
    <div class="metrics">
      <div class="metric-item">
        <div class="metric-label">Passed</div>
        <div class="metric-value text-green">{{ passed }}</div>
      </div>
      <div class="metric-item">
        <div class="metric-label">Failed</div>
        <div class="metric-value text-red">{{ failed }}</div>
      </div>
      <div class="metric-item">
        <div class="metric-label">Total</div>
        <div class="metric-value">{{ total }}</div>
      </div>
    </div>

    <div class="surface scrollbox max-h-420 mono">{{ pytest_summary_md or '(no summary)' }}</div>

    <p class="mt-2 small">
      <a class="hud-link" href="/codex_reports/tmp.json" target="_blank"><i class="fas fa-file-code"></i> tmp.json ã‚’é–‹ã</a>
    </p>

    {% set tests = (pytest_json.get('tests') if pytest_json else []) or [] %}
    {% if tests and tests|length > 0 %}
      <div class="table-wrap mt-2">
        <table class="hud-table zebra">
          <thead>
            <tr>
              <th class="col-test">Test</th>
              <th class="col-outcome">Outcome</th>
              <th class="col-duration">Duration (s)</th>
            </tr>
          </thead>
          <tbody>
            {% for t in tests %}
            {% set outcome = (t.outcome or '').lower() %}
            {% set dur = (t.call.duration if t.call and t.call.duration else 0) %}
            <tr class="
              {% if outcome == 'passed' %}is-pass{% elif outcome == 'failed' %}is-fail{% else %}is-other{% endif %}
            ">
              <td class="mono small truncate" title="{{ t.nodeid }}">{{ t.nodeid }}</td>
              <td class="center">
                {% if outcome == 'passed' %}
                  <span class="badge badge--ok">PASSED</span>
                {% elif outcome == 'failed' %}
                  <span class="badge badge--err">FAILED</span>
                {% else %}
                  <span class="badge badge--warn">{{ t.outcome or 'other' }}</span>
                {% endif %}
              </td>
              <td class="right mono">{{ "%.4f"|format(dur) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </section>

  <!-- ğŸ’¡ Inventor Suggestions -->
  <section class="hud-panel">
    <h3 class="panel-title">ğŸ’¡ Inventor Suggestions</h3>
    <div class="surface scrollbox max-h-420 mono">{{ inventor_md or '(no inventor suggestions)' }}</div>
    <p class="mt-2 small">
      <a class="hud-link" href="/codex_reports/inventor_suggestions.md" target="_blank">
        <i class="fas fa-file-alt"></i> inventor_suggestions.md
      </a>
      <span class="pill">auto-rendered if available</span>
    </p>
  </section>

  <!-- ğŸ§® Harmonia Review -->
  <section class="hud-panel">
    <h3 class="panel-title">ğŸ§® Harmonia Review</h3>
    <div class="surface scrollbox max-h-420 mono">{{ harmonia_md or '(no harmonia review)' }}</div>
    <p class="mt-2 small">
      <a class="hud-link" href="/codex_reports/harmonia_review.md" target="_blank">
        <i class="fas a-file-alt"></i> harmonia_review.md
      </a>
    </p>
  </section>

  <!-- ğŸ§© Patches -->
  <section class="hud-panel">
    <h3 class="panel-title">ğŸ§© Generated Patches</h3>
    <p class="small"><span class="pill">dir: codex_reports/patches/</span></p>

    {% if patches and patches|length > 0 %}
      <div class="table-wrap mt-2">
        <table class="hud-table zebra">
          <thead>
            <tr>
              <th class="col-test">Patch file</th>
              <th class="col-duration">Size (bytes)</th>
            </tr>
          </thead>
          <tbody>
            {% for p in patches %}
            <tr>
              <td class="mono small">
                <a class="hud-link" href="/codex_reports/patches/{{ p.filename }}" target="_blank">{{ p.filename }}</a>
              </td>
              <td class="right small mono">{{ p.size }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted small">ãƒ‘ãƒƒãƒä¸€è¦§ã¯ç©ºã§ã™ã€‚Mini-Loop å®Ÿè¡Œå¾Œã« <em>Run Review</em> ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
    {% endif %}

    <h4 class="mt-2">Index</h4>
    <div class="surface scrollbox max-h-420 mono">{{ patches_index_md or '(no patches_index.md)' }}</div>
  </section>

</div>

<!-- =========================
     ğŸ“ˆ Graph + ğŸ›¡ Scope ãƒ‘ãƒãƒ«
     ========================= -->
<div class="grid2">

  <!-- ğŸ“ˆ Graph Preview -->
  <section class="hud-panel">
    <h3 class="panel-title">ğŸ“ˆ Graph Preview</h3>
    <p class="small text-muted">
      <span class="pill">source: codex_reports/graphs/imports.svg</span>
      <span class="pill">preview: imports.svgï¼ˆã‚¯ãƒªãƒƒã‚¯ã§åŸå¯¸ï¼‰</span>
    </p>
    <a href="/static/codex_reports/graphs/imports.svg" target="_blank" style="text-decoration:none;">
      <img src="/static/codex_reports/graphs/imports.svg"
           alt="Imports Graph Preview"
           style="max-width:100%; height:auto; display:block; border:1px solid var(--panel-border); border-radius:10px;" />
    </a>
    <!-- PNGã®è»½é‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½¿ã„ãŸã„å ´åˆã¯ä¸‹è¨˜ã«åˆ‡æ›¿
    <a href="/static/codex_reports/graphs/imports.svg" target="_blank" style="text-decoration:none;">
      <img src="/static/codex_reports/graphs/imports_preview.png"
           alt="Imports Graph Preview (PNG)"
           style="max-width:100%; height:auto; display:block; border:1px solid var(--panel-border); border-radius:10px;" />
    </a>
    -->
    <div class="mt-2 small">
      <a class="hud-link" href="/static/codex_reports/graphs/imports.svg" target="_blank"><i class="fas fa-external-link-alt"></i> åŸå¯¸SVGã‚’é–‹ã</a>
      &nbsp;|&nbsp;
      <a class="hud-link" href="/static/codex_reports/graphs/imports_preview.png" target="_blank"><i class="fas fa-image"></i> PNGãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>
    </div>
  </section>

  <!-- ğŸ›¡ Allowed Scope & Related Tests -->
  <section class="hud-panel">
    <h3 class="panel-title">ğŸ›¡ Allowed Scope &amp; Related Tests</h3>
    <p class="small text-muted">
      <span class="pill">dir: codex_reports/context/</span>
      <span class="pill">policy: allowed_files.txt</span>
    </p>

    <div class="grid2">
      <div>
        <h4 class="mt-0">Allowed Files</h4>
        <ul id="allowed-files" class="mono small" style="margin-bottom:.5rem;"></ul>
      </div>
      <div>
        <h4 class="mt-0">Context Pack</h4>
        <p class="small">
          <a class="hud-link" href="/static/codex_reports/context/context_pack.json" target="_blank">
            <i class="fas fa-file-code"></i> context_pack.json
          </a>
        </p>
        <details>
          <summary class="small">ä¸­èº«ã‚’ã¡ã‚‰è¦‹</summary>
          <pre id="context-pack-preview" class="surface scrollbox mono" style="max-height:220px;"></pre>
        </details>
      </div>
    </div>

    <script>
      (function(){
        // Allowed files
        fetch('/static/codex_reports/context/allowed_files.txt', {cache:'no-store'})
          .then(r => r.ok ? r.text() : '')
          .then(t => {
            const ul = document.getElementById('allowed-files');
            if (!ul) return;
            const lines = t.split(/\r?\n/).filter(Boolean);
            if (lines.length === 0) {
              const li = document.createElement('li');
              li.textContent = '(no allowed files)';
              ul.appendChild(li);
              return;
            }
            lines.forEach(f => {
              const li = document.createElement('li');
              li.textContent = f;
              ul.appendChild(li);
            });
          })
          .catch(()=>{});

        // Context pack preview (å…ˆé ­æ•°è¡Œã ã‘æ•´å½¢)
        fetch('/static/codex_reports/context/context_pack.json', {cache:'no-store'})
          .then(r => r.ok ? r.json() : null)
          .then(js => {
            const pre = document.getElementById('context-pack-preview');
            if (!pre || !js) return;
            // è»½ãæ•´å½¢ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            const preview = {
              version: js.version,
              modules: js.modules,
              allowlist_roots: js.allowlist_roots,
              banned_paths: js.banned_paths,
              critical_files: js.critical_files
            };
            pre.textContent = JSON.stringify(preview, null, 2);
          })
          .catch(()=>{});
      })();
    </script>
  </section>

</div>

{% endblock %}
