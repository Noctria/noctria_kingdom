<!-- noctria_gui/templates/codex.html -->
{% extends "base_hud.html" %}

{% block title %}{{ page_title or "🧪 Codex Mini-Loop" }} - Noctria Kingdom{% endblock %}
{% block header_icon %}<i class="fas fa-vial"></i>{% endblock %}
{% block header_title %}CODEX MINI-LOOP{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}DASHBOARD{% endblock %}

{% block content %}
<div class="hud-section">
  <div class="hud-actions">
    <form action="/codex/run" method="post">
      <button class="hud-button" type="submit">
        <i class="fas fa-play"></i> Run Mini-Loop
      </button>
    </form>
    <span class="text-muted small">pytestは既定 <code>-q</code>。詳細は <code>codex/mini_loop.py</code> を参照。</span>
  </div>
</div>

<div class="grid2">
  <!-- Latest Cycle -->
  <div class="hud-panel">
    <div class="panel-title">Latest Cycle (Markdown)</div>
    {% if reports.latest_cycle %}
      <p class="small">
        <a class="hud-link" href="{{ links.latest_cycle }}" target="_blank">Open file</a>
      </p>
      <pre class="hud-pre">{{ previews.latest_cycle }}</pre>
    {% else %}
      <p class="text-muted small">まだ生成されていません。</p>
    {% endif %}
  </div>

  <!-- Mini-Loop Summary -->
  <div class="hud-panel">
    <div class="panel-title">Mini-Loop Summary</div>
    {% if reports.mini_summary %}
      <p class="small">
        <a class="hud-link" href="{{ links.mini_summary }}" target="_blank">Open file</a>
      </p>
      <pre class="hud-pre">{{ previews.mini_summary }}</pre>
    {% else %}
      <p class="text-muted small">未実行。</p>
    {% endif %}
  </div>

  <!-- Inventor Suggestions -->
  <div class="hud-panel">
    <div class="panel-title">Inventor Suggestions</div>
    {% if reports.inventor %}
      <p class="small">
        <a class="hud-link" href="{{ links.inventor }}" target="_blank">Open file</a>
      </p>
      <pre class="hud-pre">{{ previews.inventor }}</pre>
    {% else %}
      <p class="text-muted small">まだ提案なし。</p>
    {% endif %}
  </div>

  <!-- Harmonia Review -->
  <div class="hud-panel">
    <div class="panel-title">Harmonia Review</div>
    {% if reports.harmonia %}
      <p class="small">
        <a class="hud-link" href="{{ links.harmonia }}" target="_blank">Open file</a>
      </p>
      <pre class="hud-pre">{{ previews.harmonia }}</pre>
    {% else %}
      <p class="text-muted small">まだレビューなし。</p>
    {% endif %}
  </div>
</div>

<!-- Pytest Results Table -->
<div class="hud-panel">
  <div class="panel-title">Pytest Results (tmp.json)</div>
  {% if tests_table and tests_table|length > 0 %}
    <div class="table-wrap">
      <table class="hud-table zebra">
        <thead>
          <tr>
            <th class="col-test">Test</th>
            <th class="col-outcome">Outcome</th>
            <th class="col-duration">Duration (s)</th>
          </tr>
        </thead>
        <tbody>
          {% for t in tests_table %}
          <tr class="
              {% if t.outcome == 'passed' %}is-pass
              {% elif t.outcome == 'failed' %}is-fail
              {% else %}is-other{% endif %}
          ">
            <td class="mono col-test">{{ t.nodeid }}</td>
            <td class="col-outcome">
              {% if t.outcome == "passed" %}
                <span class="badge badge--ok">PASSED</span>
              {% elif t.outcome == "failed" %}
                <span class="badge badge--err">FAILED</span>
              {% else %}
                <span class="badge badge--warn">{{ t.outcome|upper }}</span>
              {% endif %}
            </td>
            <td class="mono col-duration">
              {% if t.duration is not none %}
                {{ "%.4f"|format(t.duration) }}
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if links.tmp_json %}
      <div class="mt-2">
        <a class="hud-link" href="{{ links.tmp_json }}" target="_blank">
          <i class="fas fa-file-code"></i> tmp.json を開く
        </a>
      </div>
    {% endif %}
  {% else %}
    <p class="text-muted small">まだ pytest JSON 結果がありません。</p>
  {% endif %}
</div>
{% endblock %}
