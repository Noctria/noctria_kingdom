<!-- noctria_gui/templates/codex.html -->
{% extends "base_hud.html" %}

{% block title %}{{ page_title or "🧪 Codex Mini-Loop" }} - Noctria Kingdom{% endblock %}
{% block header_icon %}<i class="fas fa-vial"></i>{% endblock %}
{% block header_title %}CODEX MINI-LOOP{% endblock %}
{% block header_nav_href %}/dashboard{% endblock %}
{% block header_nav_text %}DASHBOARD{% endblock %}

{% block extra_head %}
<style>
  .codex-grid { display:grid; grid-template-columns: 1fr; gap: 1rem; }
  @media (min-width: 1100px) { .codex-grid { grid-template-columns: 1fr 1fr; } }
  .hud-card { background: rgba(0,0,0,.35); border:1px solid var(--panel-border, #2b2b2b); border-radius: 12px; padding: 1rem; box-shadow: 0 0 20px rgba(0,255,180,.06) inset; }
  .hud-pre { background: rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.06); padding:.75rem; border-radius:8px; max-height: 420px; overflow:auto; font-size: .9rem; }
  .hud-actions { display:flex; gap:.5rem; align-items:center; }
  .hud-btn { padding:.5rem .9rem; border-radius: 10px; border:1px solid var(--panel-border,#2b2b2b); background: linear-gradient(180deg, rgba(0,255,180,.10), rgba(0,255,180,.02)); cursor:pointer; }
  .hud-btn:hover { filter:brightness(1.1); }
  .hud-small { opacity:.8; font-size:.85rem; }
  .hud-link { color: var(--glow-primary, #0ff); text-decoration: none; }

  table.hud-table { width: 100%; border-collapse: collapse; margin-top: .75rem; font-size: .9rem; }
  table.hud-table th, table.hud-table td { padding: .5rem .6rem; border-bottom: 1px solid var(--panel-border); text-align: left; }
  table.hud-table th { color: var(--text-color-light); font-weight: 700; background: rgba(255,255,255,.05); }
  .outcome-pass { color: #7bf1a8; font-weight: 700; }
  .outcome-fail { color: #ff6b6b; font-weight: 700; }
</style>
{% endblock %}

{% block content %}
<div class="hud-section">
  <div class="hud-actions">
    <form action="/codex/run" method="post">
      <button class="hud-btn" type="submit"><i class="fas fa-play"></i> Run Mini-Loop</button>
    </form>
    <span class="hud-small">pytestは既定 <code>-q</code>。詳細は <code>codex/mini_loop.py</code> を参照。</span>
  </div>
</div>

<div class="codex-grid">
  <div class="hud-card">
    <h3>Latest Cycle (Markdown)</h3>
    {% if reports.latest_cycle %}
      <p class="hud-small"><a class="hud-link" href="/codex_reports/latest_codex_cycle.md" target="_blank">Open file</a></p>
      <pre class="hud-pre">{{ previews.latest_cycle }}</pre>
    {% else %}
      <p class="hud-small">まだ生成されていません。</p>
    {% endif %}
  </div>

  <div class="hud-card">
    <h3>Mini-Loop Summary</h3>
    {% if reports.mini_summary %}
      <p class="hud-small"><a class="hud-link" href="/codex_reports/mini_loop_summary.md" target="_blank">Open file</a></p>
      <pre class="hud-pre">{{ previews.mini_summary }}</pre>
    {% else %}
      <p class="hud-small">未実行。</p>
    {% endif %}
  </div>

  <div class="hud-card">
    <h3>Inventor Suggestions</h3>
    {% if reports.inventor %}
      <p class="hud-small"><a class="hud-link" href="/codex_reports/inventor_suggestions.md" target="_blank">Open file</a></p>
      <pre class="hud-pre">{{ previews.inventor }}</pre>
    {% else %}
      <p class="hud-small">まだ提案なし。</p>
    {% endif %}
  </div>

  <div class="hud-card">
    <h3>Harmonia Review</h3>
    {% if reports.harmonia %}
      <p class="hud-small"><a class="hud-link" href="/codex_reports/harmonia_review.md" target="_blank">Open file</a></p>
      <pre class="hud-pre">{{ previews.harmonia }}</pre>
    {% else %}
      <p class="hud-small">まだレビューなし。</p>
    {% endif %}
  </div>
</div>

{% if tests_table and tests_table|length > 0 %}
<div class="hud-card mt-3">
  <h3>Pytest Results (from tmp.json)</h3>
  <div class="table-wrap">
    <table class="hud-table">
      <thead>
        <tr>
          <th>Test</th>
          <th>Outcome</th>
          <th>Duration (s)</th>
        </tr>
      </thead>
      <tbody>
        {% for row in tests_table %}
        <tr>
          <td>{{ row.nodeid }}</td>
          <td>
            {% if row.outcome == "passed" %}
              <span class="outcome-pass">PASSED</span>
            {% elif row.outcome == "failed" %}
              <span class="outcome-fail">FAILED</span>
            {% else %}
              {{ row.outcome }}
            {% endif %}
          </td>
          <td>{{ row.duration }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}
{% endblock %}
