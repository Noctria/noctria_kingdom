name: Update docs from index

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'scripts/update_docs_from_index.py'
      - '.github/workflows/update_docs.yml'
  workflow_dispatch: {}

# ä¸¦è¡Œå®Ÿè¡Œã®è¡çªã‚’é˜²æ­¢
concurrency:
  group: update-docs-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  update-docs:
    # ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼šBot ã®è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆã§ã¯å®Ÿè¡Œã—ãªã„
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å¤‰æ›´æ¤œçŸ¥ãƒ»å·®åˆ†ã‚³ãƒŸãƒƒãƒˆå‘ã‘

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies (best-effort)
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          elif [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
          else
            # æœ€ä½é™ã€Markdown ç”Ÿæˆã‚„YAMLç­‰ã‚’æ‰±ã†æƒ³å®š
            pip install -q markdown pyyaml jinja2
          fi

      - name: Run updater
        shell: bash
        env:
          # å¿…è¦ãªã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«æ¸¡ã™ç’°å¢ƒå¤‰æ•°ã‚’ã“ã“ã§å®šç¾©
          AUTODOC_ROOT: docs
          AUTODOC_PARTIALS_FULL: docs/_partials_full
          AUTODOC_PARTIALS_APIS: docs/_partials/apis
        run: |
          set -euxo pipefail
          # ä¾‹: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ idempotentï¼ˆå®Ÿè¡Œã—ã¦å·®åˆ†ãŒãªã‘ã‚Œã°ä½•ã‚‚å¤‰ãˆãªã„ï¼‰ã§ã‚ã‚‹ã“ã¨
          python scripts/update_docs_from_index.py

      - name: Detect changes
        id: git_status
        shell: bash
        run: |
          set -e
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit & push changes
        if: ${{ steps.git_status.outputs.changed == 'true' && github.event_name == 'push' }}
        env:
          GIT_AUTHOR_NAME: noctria-bot
          GIT_AUTHOR_EMAIL: noctria-bot@users.noreply.github.com
          GIT_COMMITTER_NAME: noctria-bot
          GIT_COMMITTER_EMAIL: noctria-bot@users.noreply.github.com
        run: |
          set -euxo pipefail
          git status
          git add -A
          git commit -m "ğŸ“„ AutoDoc: update docs from index [skip ci]"
          # [skip ci] ã§ã“ã®ã‚³ãƒŸãƒƒãƒˆã«ã‚ˆã‚‹å†ãƒˆãƒªã‚¬ãƒ¼ã‚’æŠ‘åˆ¶
          git push

      # PRã®å ´åˆã¯ã€Œå·®åˆ†ãŒå‡ºãŸã‚‰å¤±æ•—ã€ã«ã—ã¦æ°—ä»˜ã‘ã‚‹ã‚ˆã†ã«ï¼ˆä»»æ„ï¼‰
      - name: Fail if PR needs regenerated docs
        if: ${{ steps.git_status.outputs.changed == 'true' && github.event_name == 'pull_request' }}
        run: |
          echo "::error ::Docs are outdated. Run the updater and commit the results."
          exit 1
