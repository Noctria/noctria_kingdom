{% extends "base_hud.html" %}

{% block title %}📊 比較分析 - Noctria Kingdom{% endblock %}

{% block header_icon %}<i class="fas fa-chart-bar"></i>{% endblock %}
{% block header_title %}📊 戦略・タグ比較分析{% endblock %}
{% block header_nav %}
<a href="/statistics" class="nav-item-back"><i class="fas fa-angle-left"></i><span>統計ダッシュボード</span></a>
{% endblock %}

{% block content %}
<div class="description-box">
  <p>🧠 複数の戦略やタグを選んで、勝率・ドローダウンを比較します。CSV出力やURL共有も可能です。</p>
</div>

<form method="get" action="/statistics/compare" class="hud-panel mb-4">
  <div class="flex flex-wrap gap-4 items-end">
    <div>
      <label for="mode">📌 モード選択：</label>
      <select id="mode" name="mode" onchange="this.form.submit()" class="hud-input">
        <option value="strategy" {% if mode == "strategy" %}selected{% endif %}>🧠 戦略別</option>
        <option value="tag" {% if mode == "tag" %}selected{% endif %}>🔖 タグ別</option>
      </select>
    </div>

    <div>
      <label>📅 期間：</label><br>
      <input type="date" name="from" value="{{ filter.from }}" class="hud-input">
      〜
      <input type="date" name="to" value="{{ filter.to }}" class="hud-input">
    </div>

    <div>
      <label for="sort">🔽 ソート：</label>
      <select id="sort" name="sort" class="hud-input">
        <option value="score" {% if sort == "score" %}selected{% endif %}>📈 勝率・DD順</option>
        <option value="check" {% if sort == "check" %}selected{% endif %}>🗂 チェック順</option>
      </select>
    </div>
  </div>

  <div class="mt-4">
    <label class="panel-title">{{ "🔖 タグ一覧：" if mode == "tag" else "🧠 戦略一覧：" }}</label>
    <div class="hud-panel" style="max-height: 200px; overflow-y: auto;">
      <button type="button" class="hud-btn" onclick="selectAll(true)">✅ 全選択</button>
      <button type="button" class="hud-btn" onclick="selectAll(false)">❌ 全解除</button>
      <span class="ml-2">✅ 選択数: <span id="selectedCount">0</span></span><br><br>

      {% for k in all_keys %}
        <label style="display: inline-block; margin-right: 1rem;">
          <input type="checkbox" name="{{ mode }}s" value="{{ k }}" {% if k in keys %}checked{% endif %} onchange="updateCount()">
          {{ k }}
        </label>
      {% endfor %}
    </div>
  </div>

  <div class="mt-4 flex gap-2">
    <button type="submit" class="hud-btn">📥 表示</button>
    {% if keys %}
      <a href="/statistics/compare/export?mode={{ mode }}&from={{ filter.from }}&to={{ filter.to }}&sort={{ sort }}&{{ mode }}s={{ keys | join(',') }}" class="hud-btn">📄 CSV出力</a>
    {% endif %}
  </div>
</form>

{% if keys %}
  <div class="hud-panel mb-4">
    <label>🔗 現在のURL（共有可）:</label><br>
    <input id="shareUrl" type="text" readonly class="hud-input" style="width: 90%;" value="{{ request.url }}" />
    <button class="hud-btn mt-2" onclick="copyUrl()">📋 コピー</button>
  </div>
{% endif %}

{% if results %}
  <div class="hud-panel mb-4">
    <h3 class="panel-title">📊 統計サマリ</h3>
    <ul>
      <li>📈 勝率 平均: <strong>{{ summary.avg_win_mean }}</strong>％　| 中央値: <strong>{{ summary.avg_win_median }}</strong>％</li>
      <li>📉 DD 平均: <strong>{{ summary.avg_dd_mean }}</strong>％　| 中央値: <strong>{{ summary.avg_dd_median }}</strong>％</li>
      <li>📦 総件数: <strong>{{ summary.total_count }}</strong></li>
    </ul>
  </div>

  <div class="hud-panel mb-4">
    <label for="chartTypeSelect">📈 表示形式:</label>
    <select id="chartTypeSelect" class="hud-input">
      <option value="bar">棒グラフ</option>
      <option value="line">折れ線グラフ</option>
      <option value="radar">レーダーチャート</option>
    </select>
    <button class="hud-btn ml-4" onclick="downloadCharts()">💾 グラフ画像を保存</button>
  </div>

  <div class="hud-panel overflow-x-auto">
    <table class="hud-table w-full text-sm mb-4">
      <thead>
        <tr>
          <th>比較対象</th>
          <th>平均勝率（%）</th>
          <th>平均DD（%）</th>
          <th>件数</th>
        </tr>
      </thead>
      <tbody>
        {% for row in results %}
        <tr>
          <td>
            <a href="/statistics/detail?mode={{ mode }}&key={{ row.key | urlencode }}&sort_by=date&order=desc" class="hud-link">
              {{ row.key }}
            </a><br>
            {% if mode == 'strategy' %}
              <a href="/strategy/detail?name={{ row.key | urlencode }}" class="hud-sub-link">🔍 詳細</a>
            {% endif %}
          </td>
          <td>{{ row.avg_win }}</td>
          <td>{{ row.avg_dd }}</td>
          <td>{{ row.count }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <canvas id="winChart" height="100"></canvas>
  <canvas id="ddChart" height="100"></canvas>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = {{ results | map(attribute='key') | list | tojson }};
  const winRates = {{ results | map(attribute='avg_win') | list | tojson }};
  const ddRates = {{ results | map(attribute='avg_dd') | list | tojson }};
  let winChartInstance, ddChartInstance;

  const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const chartColors = {
    text: isDark ? '#eee' : '#222',
    grid: isDark ? '#444' : '#ccc',
    win: 'rgba(54, 162, 235, 0.7)',
    winBorder: 'rgba(54, 162, 235, 1)',
    dd: 'rgba(255, 99, 132, 0.7)',
    ddBorder: 'rgba(255, 99, 132, 1)'
  };

  function renderCharts(type) {
    if (winChartInstance) winChartInstance.destroy();
    if (ddChartInstance) ddChartInstance.destroy();

    const options = {
      responsive: true,
      plugins: { legend: { labels: { color: chartColors.text } } },
      scales: type !== 'radar' ? {
        y: { beginAtZero: true, ticks: { color: chartColors.text }, grid: { color: chartColors.grid } },
        x: { ticks: { color: chartColors.text }, grid: { color: chartColors.grid } }
      } : {}
    };

    winChartInstance = new Chart(document.getElementById('winChart'), {
      type,
      data: {
        labels,
        datasets: [{
          label: '平均勝率（%）',
          data: winRates,
          backgroundColor: chartColors.win,
          borderColor: chartColors.winBorder,
          fill: type !== 'line',
          tension: 0.2
        }]
      },
      options
    });

    ddChartInstance = new Chart(document.getElementById('ddChart'), {
      type,
      data: {
        labels,
        datasets: [{
          label: '平均DD（%）',
          data: ddRates,
          backgroundColor: chartColors.dd,
          borderColor: chartColors.ddBorder,
          fill: type !== 'line',
          tension: 0.2
        }]
      },
      options
    });
  }

  function downloadCharts() {
    [winChartInstance, ddChartInstance].forEach((chart, i) => {
      const canvas = chart.canvas;
      const link = document.createElement("a");
      link.href = canvas.toDataURL("image/png");
      link.download = i === 0 ? "win_chart.png" : "dd_chart.png";
      link.click();
    });
  }

  function copyUrl() {
    const input = document.getElementById("shareUrl");
    input.select();
    input.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(input.value).then(() => {
      alert("URLをコピーしました！");
    });
  }

  function selectAll(flag) {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = flag);
    updateCount();
  }

  function updateCount() {
    const count = [...document.querySelectorAll('input[type="checkbox"]')].filter(cb => cb.checked).length;
    document.getElementById("selectedCount").textContent = count;
  }

  window.onload = function () {
    updateCount();
    renderCharts("bar");
    document.getElementById("chartTypeSelect").addEventListener("change", e => renderCharts(e.target.value));
  };
</script>
{% endblock %}
