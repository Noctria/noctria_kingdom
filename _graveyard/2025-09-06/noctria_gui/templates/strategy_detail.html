{% extends "base_hud.html" %}

{% block title %}ğŸ“„ æˆ¦ç•¥è©³ç´° - {{ strategy.strategy }}{% endblock %}
{% block header_icon %}<i class="fas fa-scroll"></i>{% endblock %}
{% block header_title %}æˆ¦ç•¥è©³ç´°ï¼š{{ strategy.strategy }}{% endblock %}
{% block header_nav %}
<a href="/strategies" class="nav-item-back">
  <i class="fas fa-arrow-left"></i><span>æˆ¦ç•¥ä¸€è¦§</span>
</a>
{% endblock %}

{% block content %}
<!-- æ¦‚è¦ -->
<section class="hud-panel">
  <h2 class="panel-title">ğŸ“Š æ¦‚è¦</h2>
  <table class="hud-table">
    <tr><th>å‹ç‡</th><td>{{ strategy.win_rate or "â€•" }}%</td></tr>
    <tr><th>å–å¼•æ•°</th><td>{{ strategy.trade_count or strategy.num_trades or "â€•" }}</td></tr>
    <tr><th>æœ€å¤§ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³</th><td>{{ strategy.max_drawdown or "â€•" }}</td></tr>
    <tr><th>PF</th><td>{{ strategy.profit_factor or "â€•" }}</td></tr>
    <tr>
      <th>ã‚¿ã‚°</th>
      <td>
        {% for tag in strategy.tags %}<span class="hud-tag">{{ tag }}</span>{% endfor %}
      </td>
    </tr>
  </table>
</section>

<!-- æŒ‡æ¨™Ã—ãƒˆãƒ¬ãƒ³ãƒ‰/åˆ†å¸ƒã‚°ãƒ©ãƒ• -->
<section class="hud-panel">
  <h2 class="panel-title">ğŸ“ˆ æŒ‡æ¨™æ¨ç§»ãƒ»åˆ†å¸ƒï¼ˆå±¥æ­´æ·±æ˜ã‚Šï¼‰</h2>
  <div class="metric-switcher" style="display:flex;gap:1.1rem;margin-bottom:1rem;">
    {% for m in dashboard_metrics %}
      <button class="metric-tab{% if loop.first %} active{% endif %}" onclick="switchMetric('{{ m.key }}')">{{ m.label }}</button>
    {% endfor %}
  </div>
  <div class="chart-mode-switcher" style="display:flex;gap:1rem;margin-bottom:.8rem;">
    <button id="tab-trend" class="mode-tab active" onclick="switchChartMode('trend')"><i class="fas fa-chart-line"></i> ãƒˆãƒ¬ãƒ³ãƒ‰</button>
    <button id="tab-dist" class="mode-tab" onclick="switchChartMode('dist')"><i class="fas fa-chart-area"></i> åˆ†å¸ƒ</button>
  </div>
  <div id="trend-canvas-box">
    <canvas id="metricChart" width="900" height="230" style="max-width:100%;background:#181c2b;margin:16px 0;"></canvas>
  </div>
  <div id="dist-canvas-box" style="display:none;">
    <canvas id="distHistogram" width="900" height="180" style="max-width:100%;background:#181c2b;margin:12px 0 0 0;"></canvas>
    <canvas id="distBoxplot" width="900" height="90" style="max-width:100%;background:#1a1f2f;margin:0;"></canvas>
  </div>
  <div class="metric-summary" style="margin-top:1.2rem;color:#aee3fc;font-size:1.05em;">
    <span id="metric-summary-label">å¹³å‡</span>: <span id="metric-avg">-</span>
    ï¼ æœ€å¤§: <span id="metric-max">-</span>
    ï¼ æœ€å°: <span id="metric-min">-</span>
    ï¼ å‰å›å·®åˆ†: <span id="metric-diff">-</span>
    <span id="metric-summary-dist"></span>
  </div>
</section>

<!-- è©•ä¾¡å±¥æ­´ -->
<section class="hud-panel">
  <h2 class="panel-title">ğŸ—‚ è©•ä¾¡å±¥æ­´</h2>
  <div style="overflow-x:auto;">
    <table class="hud-table" style="width:100%;min-width:900px;">
      <thead>
        <tr>
          <th>æ—¥æ™‚</th>
          <th>AI</th>
          <th>Asset</th>
          <th>Type</th>
          {% for m in dashboard_metrics %}<th>{{ m.label }}</th>{% endfor %}
          <th>çµæœ</th>
          <th>æ³¨é‡ˆ</th>
        </tr>
      </thead>
      <tbody>
        {% for s in eval_list %}
        <tr>
          <td style="white-space:nowrap;">{{ s.evaluated_at }}</td>
          <td>{{ s.ai }}</td>
          <td>{{ s.asset or "-" }}</td>
          <td>{{ s.type or "-" }}</td>
          {% for m in dashboard_metrics %}
            <td>
              {% set v = s[m.key] %}
              {% if v is not none %}
                {{ (v * 100)|round(m.dec) if m.unit == '%' and v <= 1.0 else v|round(m.dec) }}
              {% else %}
                -
              {% endif %}
            </td>
          {% endfor %}
          <td>{{ s.result or "-" }}</td>
          <td>{{ s.note or "-" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<!-- ä»–æˆ¦ç•¥ã¨ã®æ¯”è¼ƒã‚°ãƒ©ãƒ• -->
<section class="hud-panel">
  <h2 class="panel-title">ğŸ”— é–¢é€£æˆ¦ç•¥ã¨ã®æŒ‡æ¨™æ¯”è¼ƒ</h2>
  <div class="chart-container-half">
    <canvas id="comparisonChart"></canvas>
  </div>
</section>

<!-- ãƒ­ã‚¸ãƒƒã‚¯èª¬æ˜ -->
<section class="hud-panel">
  <h2 class="panel-title">ğŸ§  ãƒ­ã‚¸ãƒƒã‚¯èª¬æ˜</h2>
  <div class="description-box">
    {{ strategy.description or "èª¬æ˜ãŒã‚ã‚Šã¾ã›ã‚“ã€‚" }}
  </div>
</section>

<div style="margin-top: 2rem; display: flex; gap: 1rem;">
  <a class="hud-btn" href="/strategies/view?name={{ strategy.strategy }}.py">ğŸ“œ ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹</a>
  <a class="hud-btn" href="/strategies">â† æˆ¦ç•¥ä¸€è¦§ã«æˆ»ã‚‹</a>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin-plot@4.0.1/dist/chartjs-chart-box-and-violin-plot.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-histogram@4.0.0/dist/chartjs-chart-histogram.min.js"></script>
<script>
const trendDict = {{ trend_dict | tojson | safe }};
const metricDist = {{ metric_dist | tojson | safe }};
const dashboardMetrics = {{ dashboard_metrics | tojson | safe }};
let selectedMetric = dashboardMetrics[0].key;
let selectedMode = "trend";

function drawTrendChart(metric) {
  const ctx = document.getElementById('metricChart').getContext('2d');
  if (window.metricChartObj) window.metricChartObj.destroy();
  let data = trendDict[metric];
  let conf = dashboardMetrics.find(m => m.key === metric);
  window.metricChartObj = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: conf.label,
        data: data.values,
        borderColor: '#18e1ef',
        backgroundColor: 'rgba(24,225,239,0.10)',
        pointRadius: 3,
        tension: 0.20,
        fill: false
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: "#e6f1ff" } },
        title: { display: true, text: `${conf.label}ãƒˆãƒ¬ãƒ³ãƒ‰`, color: "#e6f1ff" }
      },
      scales: {
        x: { ticks: { color: "#a8b2d1" } },
        y: { ticks: { color: "#a8b2d1" } }
      }
    }
  });
  showSummary(data, conf);
}

function drawDistCharts(metric) {
  const histCtx = document.getElementById('distHistogram').getContext('2d');
  const boxCtx = document.getElementById('distBoxplot').getContext('2d');
  if (window.histChart) window.histChart.destroy();
  if (window.boxChart) window.boxChart.destroy();
  let values = metricDist[metric] || [];
  let conf = dashboardMetrics.find(m => m.key === metric);
  // ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ 
  window.histChart = new Chart(histCtx, {
    type: 'histogram',
    data: {
      datasets: [{
        label: conf.label + ' åˆ†å¸ƒ',
        data: values,
        borderColor: '#18e1ef',
        backgroundColor: 'rgba(24,225,239,0.15)',
        binsNumber: 15
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: "#e6f1ff" } },
        title: { display: true, text: `${conf.label} ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ `, color: "#e6f1ff" }
      },
      scales: {
        x: { ticks: { color: "#a8b2d1" } },
        y: { ticks: { color: "#a8b2d1" } }
      }
    }
  });
  // ç®±ã²ã’
  window.boxChart = new Chart(boxCtx, {
    type: 'boxplot',
    data: {
      labels: [" "],
      datasets: [{
        label: conf.label + ' ç®±ã²ã’',
        data: [values],
        borderColor: '#f2e25c',
        backgroundColor: 'rgba(242,226,92,0.12)',
        outlierColor: '#f56565',
        itemRadius: 3
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { labels: { color: "#e6f1ff" } },
        title: { display: true, text: `${conf.label} ç®±ã²ã’å›³`, color: "#e6f1ff" }
      },
      scales: {
        x: { ticks: { color: "#a8b2d1" } },
        y: { ticks: { color: "#a8b2d1" } }
      }
    }
  });
  // ã‚µãƒãƒªãƒ¼
  if (values && values.length) {
    const sorted = values.slice().sort((a,b)=>a-b);
    const median = quantile(sorted,0.5);
    const q1 = quantile(sorted,0.25);
    const q3 = quantile(sorted,0.75);
    document.getElementById('metric-summary-dist').innerHTML = ` ï¼ ä¸­å¤®å€¤: ${median} ï¼ Q1: ${q1} ï¼ Q3: ${q3}`;
  } else {
    document.getElementById('metric-summary-dist').innerHTML = "";
  }
}

function quantile(arr, q) {
  if (!arr.length) return '-';
  const pos = ((arr.length) - 1) * q;
  const base = Math.floor(pos), rest = pos - base;
  if ((arr[base+1]!==undefined)) {
    return (arr[base] + rest*(arr[base+1]-arr[base])).toFixed(2);
  } else {
    return arr[base].toFixed(2);
  }
}

function showSummary(data, conf) {
  document.getElementById('metric-summary-label').textContent = conf.label;
  document.getElementById('metric-avg').textContent = (data.avg != null) ? data.avg : "-";
  document.getElementById('metric-max').textContent = (data.max != null) ? data.max : "-";
  document.getElementById('metric-min').textContent = (data.min != null) ? data.min : "-";
  document.getElementById('metric-diff').textContent = (data.diff != null ? (data.diff >= 0 ? "+" : "") + data.diff : "-");
  document.getElementById('metric-summary-dist').innerHTML = '';
}

window.switchMetric = function(metric) {
  selectedMetric = metric;
  if(selectedMode === "trend") drawTrendChart(selectedMetric);
  else drawDistCharts(selectedMetric);
  document.querySelectorAll('.metric-tab').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.metric-tab[onclick*="${metric}"]`).classList.add('active');
}
window.switchChartMode = function(mode) {
  selectedMode = mode;
  if (mode === "trend") {
    document.getElementById('trend-canvas-box').style.display = '';
    document.getElementById('dist-canvas-box').style.display = 'none';
    drawTrendChart(selectedMetric);
    document.getElementById('tab-trend').classList.add('active');
    document.getElementById('tab-dist').classList.remove('active');
  } else {
    document.getElementById('trend-canvas-box').style.display = 'none';
    document.getElementById('dist-canvas-box').style.display = '';
    drawDistCharts(selectedMetric);
    document.getElementById('tab-trend').classList.remove('active');
    document.getElementById('tab-dist').classList.add('active');
  }
}

window.onload = () => {
  drawTrendChart(selectedMetric);
};

// é–¢é€£æˆ¦ç•¥æ¯”è¼ƒã‚°ãƒ©ãƒ•ï¼ˆæ—¢å­˜ã®Barå½¢å¼ï¼‰ã‚‚ãã®ã¾ã¾
const labels = ["å‹ç‡", "å–å¼•æ•°", "æœ€å¤§DD"];
const datasets = [
  {
    label: "{{ strategy.strategy }}",
    data: [
      {{ strategy.win_rate or 0 }},
      {{ strategy.trade_count or strategy.num_trades or 0 }},
      {{ strategy.max_drawdown or 0 }}
    ],
    backgroundColor: "rgba(0, 229, 255, 0.6)"
  },
  {% for s in related_strategies %}
  {
    label: "{{ s.strategy }}",
    data: [
      {{ s.win_rate or 0 }},
      {{ s.trade_count or s.num_trades or 0 }},
      {{ s.max_drawdown or 0 }}
    ],
    backgroundColor: "rgba({{ 60 + loop.index0 * 30 }}, 150, 255, 0.4)"
  }{% if not loop.last %},{% endif %}
  {% endfor %}
];

const ctx = document.getElementById('comparisonChart');
new Chart(ctx, {
  type: 'bar',
  data: { labels, datasets },
  options: {
    responsive: true,
    plugins: {
      legend: {
        labels: {
          color: '#cceeff',
          font: {
            family: 'Roboto Mono',
            size: 14
          }
        }
      },
      tooltip: {
        backgroundColor: 'rgba(0, 30, 60, 0.8)',
        borderColor: '#00e5ff',
        borderWidth: 1
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        ticks: { color: '#a8b2d1' },
        grid: { color: 'rgba(0, 229, 255, 0.2)' }
      },
      x: {
        ticks: { color: '#a8b2d1' },
        grid: { color: 'rgba(0, 229, 255, 0.05)' }
      }
    }
  }
});
</script>
{% endblock %}
