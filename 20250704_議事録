ğŸ“œ Noctria Kingdom é–‹ç™ºå¼•ãç¶™ãæ›¸
æ›´æ–°æ—¥ï¼š2025å¹´7æœˆ4æ—¥
æ‹…å½“è€…ï¼šå¤§ç¦é›…ä¹‹
å¯¾è±¡ç’°å¢ƒï¼šWSL2 + Docker (Airflow, PostgreSQL, Redis)
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆï¼š/mnt/d/noctria_kingdom

âœ… æ¦‚è¦
Noctria Kingdom ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ v3.0 æ§‹æˆã«æº–æ‹ ã—ã¦å†æ§‹ç¯‰ã—ãŸã€‚

å…¨ä½“ã®ãƒ‘ã‚¹ç®¡ç†ã¯ core/path_config.py ã«é›†ç´„ã€‚

tools/structure_refactor.py ã«ã‚ˆã‚Šãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‘ã‚¹ã®è‡ªå‹•ç½®æ›ã¨æ§‹é€ ç›£æŸ»ã‚’å®Ÿæ–½ã€‚

Airflowã®Dockerã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒã«ã¦ DBåˆæœŸåŒ–ãƒ»ãƒ¦ãƒ¼ã‚¶ä½œæˆãƒ»DAGè¡¨ç¤ºã®ä¸å…·åˆå¯¾å¿œã‚’å®Ÿæ–½ã€‚

.env ãŠã‚ˆã³ docker-compose.yaml ã®ãƒ‘ã‚¹ãƒ»ãƒã‚¦ãƒ³ãƒˆæ•´åˆæ€§ã‚’å®Œå…¨çµ±ä¸€ã€‚

Dockerfileå†…ã® COPY è¨˜è¿°ãƒŸã‚¹ã«ã‚ˆã‚‹ãƒ“ãƒ«ãƒ‰å¤±æ•—ã‚’ä¿®æ­£ã€‚

ğŸ”§ æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸»ãªä¿®æ­£
1. .env
env
ã‚³ãƒ”ãƒ¼ã™ã‚‹
# ğŸ“ ãƒ›ã‚¹ãƒˆãƒ‘ã‚¹å®šç¾©
HOST_DAGS_PATH=/mnt/d/noctria_kingdom/airflow_docker/dags
HOST_LOGS_PATH=/mnt/d/noctria_kingdom/airflow_docker/logs
HOST_PLUGINS_PATH=/mnt/d/noctria_kingdom/airflow_docker/plugins

# Airflowç”¨
PYTHONPATH=/opt/airflow
AIRFLOW__CORE__DAGS_FOLDER=/opt/airflow/airflow_docker/dags
AIRFLOW__LOGGING__BASE_LOG_FOLDER=/opt/airflow/airflow_docker/logs
2. docker-compose.yamlï¼ˆãƒã‚¦ãƒ³ãƒˆæ•´åˆæ¸ˆã¿ï¼‰
yaml
ã‚³ãƒ”ãƒ¼ã™ã‚‹
volumes:
  - ${HOST_DAGS_PATH}:/opt/airflow/airflow_docker/dags
  - ${HOST_LOGS_PATH}:/opt/airflow/airflow_docker/logs
  - ${HOST_PLUGINS_PATH}:/opt/airflow/airflow_docker/plugins
3. Dockerfileï¼ˆãƒ‘ã‚¹ä¿®æ­£ï¼‰
dockerfile
ã‚³ãƒ”ãƒ¼ã™ã‚‹
COPY requirements_airflow.txt /requirements_airflow.txt
COPY requirements_extra.txt /requirements_extra.txt
COPY constraints.txt /tmp/constraints.txt
âŒ COPY docker/xxx ã¯å‰Šé™¤æ¸ˆã¿ã€‚Docker contextãŒ airflow_docker/docker/ ã§ã‚ã‚‹ãŸã‚ã€‚

ğŸ›  è‡ªå‹•ãƒ‘ã‚¹å¤‰æ›ã¨æ§‹é€ ç›£æŸ»
å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ï¼š
bash
ã‚³ãƒ”ãƒ¼ã™ã‚‹
PYTHONPATH=/mnt/d/noctria_kingdom python3 tools/structure_refactor.py
æˆæœï¼š
20ãƒ•ã‚¡ã‚¤ãƒ«ä»¥ä¸Šã« /opt/airflow/... æ§‹æ–‡ã§ã®ãƒ‘ã‚¹æ›´æ–°ã‚’é©ç”¨ã€‚

structure_audit.json ã«ä»¥ä¸‹ã®ç›£æŸ»çµæœã‚’è¨˜éŒ²ï¼š

json
ã‚³ãƒ”ãƒ¼ã™ã‚‹
[
  {
    "type": "too_many_directories",
    "path": ".",
    "count": 75
  },
  {
    "type": "unnecessary_file",
    "path": "/mnt/d/noctria_kingdom/strategies/veritas_generated/dammy"
  },
  ...
]
ğŸ˜ DBã¨Airflowã®åˆæœŸåŒ–ã‚¹ãƒ†ãƒƒãƒ—
bash
ã‚³ãƒ”ãƒ¼ã™ã‚‹
docker compose down -v --remove-orphans
docker compose build --no-cache
docker compose up -d
docker compose exec airflow-webserver airflow db init
docker compose exec airflow-webserver airflow users create \
  --username admin --password admin --firstname admin --lastname admin --role Admin --email admin@example.com
ğŸ ãƒˆãƒ©ãƒ–ãƒ«å¯¾å¿œä¸€è¦§
å•é¡Œå†…å®¹	å¯¾å¿œå†…å®¹
Broken DAG ã‚¨ãƒ©ãƒ¼ï¼ˆIndentationErrorï¼‰	veritas_refactor_dag.py ã® if __name__ == '__main__': ãƒ–ãƒ­ãƒƒã‚¯å†…ã« pass ã‚’è¿½è¨˜
Dockerãƒ“ãƒ«ãƒ‰æ™‚ã« COPY docker/... ãŒå¤±æ•—	Dockerfile ã® COPY è¡Œã‚’æ­£ã—ã„ç›¸å¯¾ãƒ‘ã‚¹ã«ä¿®æ­£
DAGãŒAirflowã«è¡¨ç¤ºã•ã‚Œãªã„	.env ã¨ docker-compose.yaml ã®ãƒã‚¦ãƒ³ãƒˆå®šç¾©ã‚’å®Œå…¨ä¸€è‡´ã•ã›è§£æ±º
/opt/airflow/... ã«PermissionError	.env ã®ãƒã‚¦ãƒ³ãƒˆæ§‹æˆã¨ structure_auditor.py ã®å‡ºåŠ›å…ˆã‚’èª¿æ•´ã—è§£æ±º
veritas_refactor_dag.py ã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼	if __name__ == '__main__': ã«å¯¾ã—ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ­£ã—ãã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã—ä¿®æ­£

ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹çµ±åˆ¶ã¨ãƒ«ãƒ¼ãƒ«ï¼ˆv3.0ï¼‰
ã‚«ãƒ†ã‚´ãƒª	ãƒ‘ã‚¹	å‚™è€ƒ
DAGs	/opt/airflow/airflow_docker/dags	.env ãŠã‚ˆã³ docker-compose.yaml ä¸¡æ–¹ã§çµ±ä¸€
Logs	/opt/airflow/airflow_docker/logs	Airflowãƒ­ã‚°ã¨å…±é€š
Plugins	/opt/airflow/airflow_docker/plugins	å¿…è¦ã«å¿œã˜ã¦æ‹¡å¼µ
Core Modules	/opt/airflow/core	path_config.py, logger.py ãªã©
Strategies	/opt/airflow/strategies	veritas_generated/, official/ ãªã©æˆ¦ç•¥é…ç½®
Scripts	/opt/airflow/scripts	ãƒãƒƒãƒè©•ä¾¡ã€Gité€£æºãªã©è£œåŠ©ãƒ­ã‚¸ãƒƒã‚¯
Veritas	/opt/airflow/veritas	è‡ªå‹•æˆ¦ç•¥ç”ŸæˆAI
Tools	/opt/airflow/tools	ãƒ‘ã‚¹å¤‰æ›ã€æ§‹é€ ç›£æŸ»ãªã©ã®ç®¡ç†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

âœ… æ¬¡ã®æ¨å¥¨ä½œæ¥­
 Airflow Web UI ã«ãƒ­ã‚°ã‚¤ãƒ³ã— DAG ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

 ãƒ†ã‚¹ãƒˆDAGã‚’ veritas_eval_dag.py ç­‰ã§å‹•ä½œç¢ºèª

 GUIã¾ãŸã¯FastAPIã‚µãƒ¼ãƒã¨ã®é€£æºãƒã‚§ãƒƒã‚¯

 structure_audit.json ã®ä¸è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰©ç†å‰Šé™¤

ğŸ“Œ å‚™è€ƒ
core/path_config.py ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ãƒ»ã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ã®å®Ÿè¡Œãƒ‘ã‚¹ã‹ã‚‰å‹•çš„ã« BASE_DIR ã‚’åˆ¤å®šã™ã‚‹æ–¹å¼ã«æ›´æ–°æ¸ˆã¿ã€‚

structure_refactor.py ã¯ logs/structure_audit.json ã¸ã®ãƒ­ã‚°å‡ºåŠ›ã¨åŒæ™‚ã«ã€core/path_config.py ã®å­˜åœ¨å‰æã§å®‰å…¨ã«å‡¦ç†å¯èƒ½ã€‚

ä»¥ä¸ŠãŒã€Noctria Kingdom ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® v3.0 å¯¾å¿œãƒ»Airflowç¨¼åƒæ•´å‚™ã®å®Œäº†è¨˜éŒ²ã¨ãªã‚Šã¾ã™ã€‚
